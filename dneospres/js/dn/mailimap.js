/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
(function(a){desknets.sp.mailimap={MODULE_API_ZRWEML:"zrwimapeml",MODULE_API_ZRWRICH:"zrwimaprich",CMD_MAILACCOUNTS:"mailaccountentry",CMD_MAILFOLDERS:"mailfolderlistexp",CMD_MAILNOTIFICATION:"mailnotification",CMD_MAILSEARCH:"mailsearch",CMD_MAILSEARCHSTOP:"mailsearchstop",CMD_MAILDOWNLOADATTACH:"mailimapdownloadattach",CMD_MAILDISPATTACHE:"mailimapdispattache",init:function(){desknets.sp.mobjPages["account-page"]=desknets.sp.mailimap.AccountList;desknets.sp.mobjPages["folder-page"]=desknets.sp.mailimap.FolderList;desknets.sp.mobjPages["d-folderadd-page"]=desknets.sp.mailimap.FolderAdd;desknets.sp.mobjPages["foldermod-page"]=desknets.sp.mailimap.FolderMod;desknets.sp.mobjPages["d-folderdel-page"]=desknets.sp.mailimap.FolderDel;desknets.sp.mobjPages["folderselect-page"]=desknets.sp.mailimap.FolderSelect;desknets.sp.mobjPages["maillist-page"]=desknets.sp.mailimap.MailList;desknets.sp.mobjPages["mailsrch-page"]=desknets.sp.mailimap.MailSrch;desknets.sp.mobjPages["mailref-page"]=desknets.sp.mailimap.MailRef;desknets.sp.mobjPages["d-mailmove-page"]=desknets.sp.mailimap.MailMove;desknets.sp.mobjPages["d-maildel-page"]=desknets.sp.mailimap.MailDel;desknets.sp.mobjPages["d-mailmark-page"]=desknets.sp.mailimap.MailMark;desknets.sp.mobjPages["d-mailclose-page"]=desknets.sp.mailimap.MailClose;desknets.sp.mobjPages["d-mailnotify-page"]=desknets.sp.mailimap.MailNotify;desknets.sp.mobjPages["mailentry-page"]=desknets.sp.mailimap.MailEntry;desknets.sp.mobjPages["d-mailsave-page"]=desknets.sp.mailimap.MailSave;desknets.sp.mobjPages["d-mailsendconf-page"]=desknets.sp.mailimap.MailSendConf;desknets.sp.mobjPages["d-mailsendconfvalue-page"]=desknets.sp.mail.MailSendConfValue;desknets.sp.mobjPages["d-maildelattconf-page"]=desknets.sp.mailimap.MailDelAttConf;desknets.sp.mobjPages["mailsetsrch-page"]=desknets.sp.mail.MailSetSrch;desknets.sp.mobjPages["d-mailreply-page"]=desknets.sp.mail.MailReply;desknets.sp.mobjPages["d-externallinkconf-page"]=desknets.sp.mail.MailExternalLinkConf;desknets.sp.mobjPages["d-mailaddaddrconf-page"]=desknets.sp.mail.MailAddAddrConf;desknets.sp.mobjPages["addrselect-page"]=desknets.sp.mail.AddrSelect;desknets.sp.mobjPages["userselect-page"]=desknets.sp.mail.UserSelect;desknets.sp.mobjPages["d-mailaddrselect-page"]=desknets.sp.mail.MailAddrSelect;desknets.sp.mobjPages["neotwi-page"]=desknets.sp.Neotwi;desknets.sp.mobjPages["addrentry-page"]=desknets.sp.addr.AddrEntry;var b=[];b[b.length]="mailentry-page";desknets.sp.initSetEvents(b)},getRequestURL:function(){return desknets.getUrl(desknets.sp.mailimap.MODULE_API_ZRWEML)}};desknets.page(desknets.sp.mailimap,"util",desknets.sp.mail.util,{getReferRequestURL:function(){return desknets.sp.mailimap.getRequestURL()}});desknets.page(desknets.sp.mailimap,"AccountList",desknets.sp.ComPage,{showing:function(){var b=this;b.callBase("showing");b.$mRootElement.find(".jmail-list").hide();b.$mRootElement.find(".jmail-nolist").show()}});desknets.page(desknets.sp.mailimap,"FolderList",desknets.sp.mail.FolderList,{mboDispInbox:false,initMailChangePage:function(b){var c=this;c.mboDispInbox=true},_checkAccId:function(){},getListRequestURL:function(){return desknets.sp.mailimap.getRequestURL()},getRequestOption:function(){var b=this;var c=b.callBase("getRequestOption");c.success=function(f,e,g){if(b.mboDispInbox){var d=a(f).find(":first > list > item");d.each(function(l,j){var k=a(j);var m=k.attr("sysid");if(m==desknets.sp.mail.VAL_FOLDERTYPE_INBOX){b.mboDispInbox=false;desknets.sp.mobjPages["maillist-page"].setAccFld(null,null,k.attr("id"),null,false);desknets.sp.changePage("maillist")}})}else{var h=[];f=a(f);h=f.find("item");b.executeOnItemsGot(f,h,"append");b.pageViewEnd()}};c.error=function(f,e,d){if(f.status=="-6201192"){desknets.sp.changePage("account",{transition:"none"});return}if(e!="abort"){desknets.sp.ajax.onError(f.status,d)}if(b.$mRootElement!==null){b.$noItemsContainerElement.show();b.$mRootElement.find(".jco-chg").addClass("mailimap-chg")}};return c},getListRequestData:function(d,e){var b=this;var c={};c=b.callBase("getListRequestData",d,e);c.cmd=desknets.sp.mailimap.CMD_MAILFOLDERS;return c},executeOnItemsGot:function(d,e,c){var b=this;b.mboExecRecv=false;b.callBase("executeOnItemsGot",d,e,c)},setUpListItem:function(e,c){var b=this;if(b.mboSet){var f=e.attr("sysid");if(f===desknets.sp.mail.VAL_FOLDERTYPE_INBOX||f===desknets.sp.mail.VAL_FOLDERTYPE_SENT||f===desknets.sp.mail.VAL_FOLDERTYPE_TRASH||f===desknets.sp.mail.VAL_FOLDERTYPE_DRAFT){var d=a('<li class="co-li-folder"><h3></h3></li>');c.after(d).remove();c=d;b.$listElement.listview("refresh")}}b.callBase("setUpListItem",e,c);c.data("ftype",e.attr("sysid"))},});desknets.page(desknets.sp.mailimap,"FolderAdd",desknets.sp.mail.FolderAdd,{getSubmitRequestURL:function(){return desknets.sp.mailimap.getRequestURL()}});desknets.page(desknets.sp.mailimap,"FolderMod",desknets.sp.mail.FolderMod,{getSubmitRequestURL:function(){return desknets.sp.mailimap.getRequestURL()}});desknets.page(desknets.sp.mailimap,"FolderDel",desknets.sp.mail.FolderDel,{getSubmitRequestURL:function(){return desknets.sp.mailimap.getRequestURL()}});desknets.page(desknets.sp.mailimap,"FolderSelect",desknets.sp.mail.FolderSelect,{getListRequestURL:function(){return desknets.sp.mailimap.getRequestURL()},getListRequestData:function(d,e){var b=this;var c={};c=b.callBase("getListRequestData",d,e);c.cmd=desknets.sp.mailimap.CMD_MAILFOLDERS;return c},});desknets.page(desknets.sp.mailimap,"MailList",desknets.sp.mail.MailList,{init:function(c){var b=this;b.callBase("init",c);b.$mRootElement.find(".jmailimap-folder").bind("vclick",function(d){d.preventDefault();desknets.sp.mobjPages["folder-page"].setAccId(null);desknets.sp.changePage("folder")})},replaceMailAccIdItems:function(){},getListRequestURL:function(){return desknets.sp.mailimap.getRequestURL()},getListRequestData:function(c,d){var b=this;var e={};b.mboAllInbox=false;e=b.callBase("getListRequestData",c,d);return e},executeOnItemsGot:function(d,f,c){var b=this;b.callBase("executeOnItemsGot",d,f,c);var e=d.find("folder").attr("val")||"";b.$mRootElement.find(".co-bar-msg").html(desknets.tmpl.escapeWord(e))},});desknets.page(desknets.sp.mailimap,"MailSrch",desknets.sp.mail.MailSrch,{mboInit:false,mboStop:false,getMailAccountList:function(){var b=this;b.marAccInfo=""},saveAccountList:function(b){},getListRequestData:function(d,e){var b=this;var c=b.callBase("getListRequestData",d,e);if(b.mboInit){c.cmd=desknets.sp.mailimap.CMD_MAILSEARCH}c.fid="";if(c.target=="0"||c.target=="1"){c.from="1"}if(c.target=="0"||c.target=="2"){c.tocc="1"}if(c.target=="0"||c.target=="3"){c.subject="1"}if(c.target=="0"||c.target=="4"){c.body="1"}delete c.target;return c},getRequestOption:function(d){var c=this;var e=c.callBase("getRequestOption");var f=(d=="prepend")?-c.miPerPage:c.getItemCount();var b=Math.max(f+c.miStartIndex,0);var g=c.miPerPage+Math.min(f+c.miStartIndex,0);e.success=function(i,h,k){c.pageViewEnd();if(c.mboInit){c.mboInit=false;var j=function(){c.onSrchStop()};desknets.sp.msg.srchview(j);setTimeout(function(){c.addItems("append")},3000)}else{if(a(".ui-page-active").attr("id")=="dialog-page"){desknets.sp.msg.$mRootElement.dialog("close")}if(!c.mboJson){i=a(i)}var l=c.getAjaxSuccessList(i,b,g);c.executeOnItemsGot(i,l,d)}};e.error=function(j,i,h){c.pageViewEnd();c.mboInit=false;if(!!j.responseXML&&a(j.responseXML).find("errorno").text()=="1"){if(!c.mboStop){setTimeout(function(){c.addItems("append")},3000)}return}if(i!="abort"){c.pageViewEnd();desknets.sp.ajax.onError(j.status,h)}};return e},onSrchStop:function(){var b=this;var e=b.getAjaxId();if(e!=""){neo.ajax.abort(e,true)}var c={};c.cmd=desknets.sp.mailimap.CMD_MAILSEARCHSTOP;b.mboStop=true;var d={url:b.getListRequestURL(),data:c,dataType:"xml",success:function(g,f,h){},complete:function(h,f,g){b.mboStop=false},};desknets.sp.ajax.rest(d)},chkSearch:function(){var b=this;var c=b.callBase("chkSearch");if(c){b.mboInit=true}return c},setSrch:function(b){var c=this;c.callBase("setSrch",b);c.mboInit=true},getListRequestURL:function(){return desknets.sp.mailimap.getRequestURL()}});desknets.page(desknets.sp.mailimap,"MailRef",desknets.sp.mail.MailRef,{mboback:false,changeFolder:function(b){var c=this;c.mboback=false;c.callBase("changeFolder",b)},changeFolderSetBack:function(){var b=this;b.mboback=true},setPage:function(d,c){var b=this;b.mboback=false;b.callBase("setPage",d,c)},replaceItems:function(){var b=this;if(b.mboback){b.mboback=false;history.back()}else{b.callBase("replaceItems")}},openMailRefPage:function(b,d,c){desknets.sp.mailimap.util.openMail(b,d,null)},getReferRequestURL:function(){return desknets.sp.mailimap.getRequestURL()},getReferRequestMailSetURL:function(){return desknets.sp.getUrl(desknets.sp.mailimap.MODULE_API_ZRWRICH)},getMailDownloadAttachCmd:function(){return desknets.sp.mailimap.CMD_MAILDOWNLOADATTACH},getReferRequestData:function(c,d){var b=this;var e={};e=b.callBase("getReferRequestData",c,d);delete e.sp;return e},_getNotifySetting:function(){var b=this;if(b.mobjNotifySettingList!==null){b._funcNext();return}var c={dataType:"xml",url:b.getReferRequestURL(),data:{cmd:desknets.sp.mailimap.CMD_MAILNOTIFICATION},success:function(e,d,f){b.mobjNotifySettingList=a(e).find("recv").text();b._funcNext()},dialogback:true};desknets.sp.ajax.rest(c)},_getFlgConfirmBeforeSendNotification:function(c){var b=this;if(b.mobjNotifySettingList==="2"){return true}return false},getAttObj:function(b){var c=this;var d={};d=c.callBase("getAttObj",b);d.encoding=b.children("encoding").text();return d},getAttDispUrl:function(e,d,b){var c=e+"?"+d+"&file="+b.id+"&mimetype="+desknets.encodeURIComponentNeo(b.mimetype)+"&efname="+encodeURIComponent(b.attachdisp).replace(/'/g,"%27")+"&encoding="+desknets.encodeURIComponentNeo(b.encoding);return c}});desknets.page(desknets.sp.mailimap,"MailMove",desknets.sp.mail.MailMove,{getSubmitRequestURL:function(){return desknets.sp.mailimap.getRequestURL()},completeToSendEntries:function(){var b=this;desknets.sp.mobjPages["mailsrch-page"].mboInit=true;b.callBase("completeToSendEntries");desknets.sp.mobjPages["mailref-page"].changeFolderSetBack()},});desknets.page(desknets.sp.mailimap,"MailDel",desknets.sp.mail.MailDel,{completeToSendEntries:function(){var b=this;desknets.sp.mobjPages["mailsrch-page"].mboInit=true;b.callBase("completeToSendEntries")},getSubmitRequestURL:function(){return desknets.sp.mailimap.getRequestURL()}});desknets.page(desknets.sp.mailimap,"MailMark",desknets.sp.mail.MailMark,{getSubmitRequestURL:function(){return desknets.sp.mailimap.getRequestURL()}});desknets.page(desknets.sp.mailimap,"MailClose",desknets.sp.mail.MailClose,{getSubmitRequestURL:function(){return desknets.sp.mailimap.getRequestURL()}});desknets.page(desknets.sp.mailimap,"MailEntry",desknets.sp.mail.MailEntry,{init:function(c){var b=this;b.callBase("init",c)},openMailEntryPage:function(b,c){desknets.sp.mailimap.util.openMail(b,null,null)},getReferRequestURL:function(){return desknets.sp.mailimap.getRequestURL()},getMailDownloadAttachCmd:function(){return desknets.sp.mailimap.CMD_MAILDISPATTACHE},getEntriesFrom:function(d){var c=this;var b={};b=c.callBase("getEntriesFrom",d);delete b.accid;return b},_getAccountListRequestData:function(){var b=this;var c={cmd:desknets.sp.mailimap.CMD_MAILACCOUNTS,};return c},_saveAccountList:function(d){var l=this;var n=a(d);var c=l.$mRootElement.find('select[name="accid"]').empty();var b="dmy0";var e=n.find("Name").text();var j=n.find("Mail").text();var k=neo.mailaddress.createMailbox(e,j);if(!neo.isSet(e,{blank:false})){k="<"+k+">"}c.append('<option value="'+b+'">'+desknets.tmpl.escapeWord(k)+"</option>");var f=b;if(!!l.mobjEntries&&!!l.mobjEntries.accid){f=l.mobjEntries.accid}if(c.children('[value="'+f+'"]').length==0){f=c.children("option:first").val()}c.val(f).selectmenu("refresh");var g=l.$mRootElement.find('select[name="accid"] option:selected').text();var h=l.$mRootElement.find('select[name="accid"]').closest(".ui-select");h.hide();var m=h.closest("li");var i=m.find(".mail-entry-from");if(neo.isSet(i)){i.remove()}m.append('<div class="mail-entry-from">'+desknets.tmpl.escapeWord(g)+"</div>")},getEntriesFromReferItem:function(){var b=this;var c={};var c=b.callBase("getEntriesFromReferItem");delete c.accid;return c},completeToSendEntries:function(){var b=this;desknets.sp.mobjPages["mailsrch-page"].mboInit=true;b.callBase("completeToSendEntries")}});desknets.page(desknets.sp.mailimap,"MailSave",desknets.sp.mail.MailSave,{getSubmitRequestURL:function(){return desknets.sp.mailimap.getRequestURL()}});desknets.page(desknets.sp.mailimap,"MailSendConf",desknets.sp.mail.MailSendConf,{getSubmitRequestURL:function(){return desknets.sp.mailimap.getRequestURL()},completeToSendEntries:function(){var b=this;desknets.sp.mobjPages["mailsrch-page"].mboInit=true;b.callBase("completeToSendEntries")}});desknets.page(desknets.sp.mailimap,"MailNotify",desknets.sp.mail.MailNotify,{getSubmitRequestURL:function(){return desknets.sp.mailimap.getRequestURL()}});desknets.page(desknets.sp.mail,"MailSendConfValue",desknets.sp.mail.MailSendConfValue,{getReferRequestURL:function(){return desknets.sp.mailimap.getRequestURL()},completeToSendEntries:function(){var b=this;desknets.sp.mobjPages["mailsrch-page"].mboInit=true;b.callBase("completeToSendEntries")},_getCmdDownLoadAttache:function(){return desknets.sp.mailimap.CMD_MAILDISPATTACHE}});desknets.page(desknets.sp.mailimap,"MailDelAttConf",desknets.sp.mail.MailDelAttConf,{getSubmitRequestURL:function(){return desknets.sp.mailimap.getRequestURL()}});desknets.sp.mailimap.init()})(jQuery);