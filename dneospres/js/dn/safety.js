/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
(function(a){desknets.safety={MODULE_API_SAFETY:"zrsafety",CMD_SAFETYLIST:"safetycmdlist",CMD_SAFETYCMDINPUT:"safetycmdinput",CMD_SAFETYCMDCONTENTRY:"safetycmdcontentry",CMD_SAFETYCMDEMERGENCYCONTACT:"safetycmdemergencycontact",CMD_SAFETYDISASTERINFO:"safetycmddisasterinfolist",CMD_SAFETYCMDDISASTERPREPLINK:"safetycmddisasterpreplink",CMD_SAFETYCMDEVACUATIONROUTELIST:"safetycmdevacuationroutelist",CMD_SAFETYCMDEVACUATIONROUTEINFO:"safetycmdevacuationrouteinfo",getMapAPIUrl:function(d,f,e,b,i,m,h){b=neo.isSet(b)?b:"";i=neo.isSet(b)?i:"";m=neo.isSet(b)?m:"";h=neo.isSet(b)?h:"";var g=new RegExp("\\$START","ig");var l=new RegExp("\\$GOAL","ig");var k=new RegExp("\\$SLAT","ig");var c=new RegExp("\\$SLON","ig");var j=new RegExp("\\$DLAT","ig");var n=new RegExp("\\$DLON","ig");f=desknets.encodeURIComponentNeo(f);e=desknets.encodeURIComponentNeo(e);b=desknets.encodeURIComponentNeo(b);i=desknets.encodeURIComponentNeo(i);m=desknets.encodeURIComponentNeo(m);h=desknets.encodeURIComponentNeo(h);d=d.replace(g,function(o,p,q){return f}).replace(l,function(o,p,q){return e}).replace(k,function(o,p,q){return b}).replace(c,function(o,p,q){return i}).replace(j,function(o,p,q){return m}).replace(n,function(o,p,q){return h});return d}};desknets.sp.safety={CMD_SAFETYCONTACTINFO:"safetycmdcontactinfo",CMD_SAFETYCONFACTIVE:"safetycmdconfactive",CMD_SAFETYMSETDELIVERYMAIL:"safetymsetcmddeliverymail",CMD_SAFETYMSETDELIVERYMAILCONF:"safetymsetcmddeliverymailconf",CMD_SAFETYMSETDELIVERYMAILTRY:"safetymsetcmddeliverymailtry",CMD_SAFETYMSETDELIVERYMAILTRYCONF:"safetymsetcmddeliverymailtryconf",CMD_SAFETYMSETDELIVERYMAILLIST:"safetymsetdeliverymaillist",VAL_SAFETYSENDTYPEMAIL:"1",VAL_SAFETYDELIVERYMAILSTS:"1",mboAllManage:null,init:function(){desknets.sp.mobjPages["safetyindex-page"]=desknets.sp.safety.SafetyIndex;desknets.sp.mobjPages["safetydislist-page"]=desknets.sp.safety.SafetyDisList;desknets.sp.mobjPages["safetyconfentry-page"]=desknets.sp.safety.SafetyConfEntry;desknets.sp.mobjPages["safetyconfindex-page"]=desknets.sp.safety.SafetyConfIndex;desknets.sp.mobjPages["safetyconflist-page"]=desknets.sp.safety.SafetyConfList;desknets.sp.mobjPages["safetygroup-page"]=desknets.sp.safety.SafetyGroup;desknets.sp.mobjPages["safetycontact-page"]=desknets.sp.safety.SafetyContact;desknets.sp.mobjPages["safetyprepare-page"]=desknets.sp.safety.SafetyPrepare;desknets.sp.mobjPages["safetyevroute-page"]=desknets.sp.safety.SafetyEvRoute;desknets.sp.mobjPages["safetyhomeroute-page"]=desknets.sp.safety.SafetyHomeRoute;desknets.sp.mobjPages["safetydeliverymaillist-page"]=desknets.sp.safety.SafetyDeliveryMailList;desknets.sp.mobjPages["d-safetydeliverymailconf-page"]=desknets.sp.safety.SafetyDeliveryMailConf;desknets.sp.mobjPages["d-safetydeliverymailconfmsg-page"]=desknets.sp.safety.SafetyDeliveryMailConfMsg;desknets.sp.mobjPages["safetydeliverymailseltarget-page"]=desknets.sp.safety.SafetyDeliveryMailSelTarget;desknets.sp.mobjPages["d-safetydeliverymaildeseltarget-page"]=desknets.sp.safety.SafetyDeliveryMailDeSelTarget;desknets.sp.mobjPages["neotwi-page"]=desknets.sp.Neotwi;desknets.sp.initSetEvents()},getRequestURL:function(){return desknets.sp.getUrl(desknets.safety.MODULE_API_SAFETY)},getGroupRequestURL:function(){return desknets.sp.getUrl("zrconst")},getSafetyConfIndex:function(c){var b={url:desknets.sp.safety.getRequestURL(),data:{cmd:desknets.safety.CMD_SAFETYLIST,row:0,num:1,gid:""},error:function(f,e,d){if(e!="abort"){desknets.sp.ajax.onError(f.status,d,true)}},success:function(e,d,f){if(a.isFunction(c)){c(e)}},dialogback:true};desknets.sp.ajax.rest(b)}};desknets.page(desknets.sp.safety,"SafetyIndex",desknets.sp.ComPage,{miPerInfo:3,$listContainerElement:null,$listElement:null,$emgcontactElement:null,$emgcontactDispElement:null,$noItemsContainerElement:null,$_disInfoTemplateElement:null,$_disMoreTemplateElement:null,init:function(c){var b=this;b.callBase("init",c);b.$listContainerElement=b.$mRootElement.find(".jco-list-items");b.$listElement=b.$mRootElement.find("ul.jco-list-itemdata");b.$emgcontactElement=b.$mRootElement.find(".jsafety-emgcontact-container");b.$emgcontactDispElement=b.$emgcontactElement.find(".jsafety-contact");b.$noItemsContainerElement=b.$mRootElement.find(".jsafety-disinfo-noitem-container");b.$_disInfoTemplateElement=b.$listElement.find(".jco-list-template").removeClass("jco-list-template").remove();b.$_disMoreTemplateElement=b.$mRootElement.find(".jsafety-list-more").remove();b.setUpButtons()},replaceItems:function(){var b=this;var c="dnsp-safetyindex";if(c!=""){neo.ajax.abort(c,true)}b.clearItems();b.getDeliveryGroupList();b.addTopInfo()},clearItems:function(){var b=this;if(b.$mRootElement!=null){b.$listContainerElement.hide();b.$listElement.empty()}},addTopInfo:function(){var b=this;desknets.sp.ajax.rest({url:desknets.sp.safety.getRequestURL(),data:b.getDisInfoRequestData(),success:function(d,c,e){var f=desknets.sp.ajax.getJsonItems(d[0]);b.executeTopInfoItemsGot(d[0],f);b.setUpContactIcon(d[1]);b.setUpConfActive(d[2]);b.pageViewEnd()},dialogback:true,detectMultiError:true})},getDisInfoRequestData:function(){var b=this;var c={};var e={};var g={cmd:desknets.safety.CMD_SAFETYDISASTERINFO,num:b.miPerInfo};var f={cmd:desknets.sp.safety.CMD_SAFETYCONTACTINFO};var d={cmd:desknets.sp.safety.CMD_SAFETYCONFACTIVE};c[0]=g;c[1]=f;c[2]=d;e=desknets.ajax.arrayToMultiCmdData(c);return e},executeTopInfoItemsGot:function(c,d){var b=this;b.addDisInfoListElements(d);b.updateContainerElement(c,d)},addDisInfoListElements:function(e){var c=this;for(var d=0;d<e.length;d++){var b=null;b=c.$_disInfoTemplateElement.clone();c.$listElement.append(b).listview("refresh");c.setUpDisInfoListItem(e[d],b)}c.$listElement.find("li:last").addClass("ui-corner-bottom");c.$listElement.enhanceWithin()},updateContainerElement:function(d,g){var b=this;var f=g.length;var c=(f>0)?"show":"hide";b.$listContainerElement[c]();var e=(f<=0)?"show":"hide";b.$noItemsContainerElement[e]();if(d.allcnt>3){b.$_disMoreTemplateElement.appendTo(b.$listElement);b.$_disMoreTemplateElement.show();b.$mRootElement.find(".jsafety-list-more").on("vclick",function(h){h.preventDefault();desknets.sp.changePage("safetydislist")})}},setUpDisInfoListItem:function(e,c){var b=this;var f="";c.data("id",e.id);f=desknets.tmpl.escapeWord(e.Group);c.find(".jsafety-disinfo-group").html(f);f=desknets.tmpl.escapeWord(e.entryname);c.find(".jsafety-disinfo-entryname").html(f);f=desknets.tmpl.escapeWordLF(e.memo);c.find(".jsafety-disinfo-memo").html(f);var d=desknets.dateTime.dispDateTime(e.date,{type:"list"});c.find(".date").html(d)},setUpContactIcon:function(c){var b=this;if(c.Tel.length>0&&c.Mail.length>0){b.$mRootElement.find("li.jsafety-menubtn-contact.empty").hide();b.$mRootElement.find("li.jsafety-menubtn-contact.set").show();b.$mRootElement.find(".jsafety-menu-list").addClass("_nest")}else{b.$mRootElement.find("li.jsafety-menubtn-contact.empty").show();b.$mRootElement.find("li.jsafety-menubtn-contact.set").hide();b.$mRootElement.find(".jsafety-menu-list").removeClass("_nest")}b.$mRootElement.find(".jsafety-menu-list").listview("refresh")},setUpConfActive:function(c){var b=this;b.$mRootElement.find(".jsafety-menubtn-confentry").data("id",c.userconfflg)},getDeliveryGroupList:function(e){var c=this;var b=null;desknets.sp.safety.mboAllManage=null;var d={url:desknets.sp.safety.getRequestURL(),data:{cmd:desknets.sp.safety.CMD_SAFETYMSETDELIVERYMAILLIST},success:function(g,f,h){b=g;if(neo.isSet(b.group,{blank:false})){desknets.sp.safety.mboAllManage=true}else{desknets.sp.safety.mboAllManage=false}},error:function(h,g,f){if(h.status!="403"&&g!="abort"){desknets.sp.ajax.onError(h.status,f)}},complete:function(i,f,g){var h=desknets.sp.ajax.getJsonItems(b);var j=h.length;if(j>0){c.$mRootElement.find(".managing").show();c.$mRootElement.find(".no-managing").hide()}else{c.$mRootElement.find(".managing").hide();c.$mRootElement.find(".no-managing").show()}},dialogback:true};desknets.sp.ajax.rest(d)},setUpButtons:function(){var b=this;b.$emgcontactElement.collapsible({expand:function(c){c.preventDefault();b.displayEmgContact(c)}});b.$mRootElement.find(".jsafety-menubtn-deliverymaillist").on("vclick",function(c){c.preventDefault();desknets.sp.mobjPages["safetydeliverymaillist-page"].invalidate();desknets.sp.changePage("safetydeliverymaillist")});b.$mRootElement.find(".jsafety-deliverymailconf").on("vclick",function(c){c.preventDefault();desknets.sp.mobjPages["d-safetydeliverymailconf-page"].setPage(desknets.sp.safety.VAL_SAFETYSENDTYPEMAIL,"",[]);desknets.sp.changePage("d-safetydeliverymailconf")});b.$mRootElement.find(".jsafety-menubtn-confentry").on("vclick",function(c){c.preventDefault();desknets.sp.safety.SafetyConfEntry.setPage(desknets.sp.getLoginUid(),"",a(this).data("id"));desknets.sp.changePage("safetyconfentry")});b.$mRootElement.find(".jsafety-menubtn-confindex").on("vclick",function(c){c.preventDefault();desknets.sp.safety.SafetyConfIndex.clearStatus();desknets.sp.changePage("safetyconfindex")});b.$mRootElement.find(".jsafety-menubtn-contact").on("vclick",function(c){c.preventDefault();desknets.sp.safety.SafetyContact.setPage("");desknets.sp.changePage("safetycontact")});b.$mRootElement.find(".jsafety-menubtn-prepare").on("vclick",function(c){c.preventDefault();desknets.sp.safety.SafetyPrepare.setPage("");desknets.sp.changePage("safetyprepare")});b.$mRootElement.find(".jsafety-menubtn-route").on("vclick",function(c){c.preventDefault();desknets.sp.safety.SafetyEvRoute.setPage("");desknets.sp.changePage("safetyevroute")});b.$mRootElement.find(".jsafety-menubtn-homeroute").on("vclick",function(c){c.preventDefault();desknets.sp.safety.SafetyHomeRoute.setPage("");desknets.sp.changePage("safetyhomeroute")})},displayEmgContact:function(c){var b=this;if(b.$emgcontactDispElement.html().length>0){return}desknets.sp.ajax.rest({url:desknets.sp.safety.getRequestURL(),data:b.getEmgContactRequestData(),success:function(e,d,f){b.executeEmgContactGot(e,c)},})},getEmgContactRequestData:function(){return{cmd:desknets.safety.CMD_SAFETYCMDEMERGENCYCONTACT}},executeEmgContactGot:function(c,e){var b=this;if(neo.isSet(c.memo,{blank:false})){var d=desknets.convertToSafeHtml(c.memo);b.$emgcontactDispElement.html(d);b.$emgcontactDispElement.detectHref({convertPhone:true});desknets.sp.setUpMailLink(b.$emgcontactDispElement)}else{b.$emgcontactDispElement.html(desknets.Resource.safety.safetySettingInfoNothing)}}});desknets.page(desknets.sp.safety,"SafetyDisList",desknets.sp.ListPage,{getListRequestURL:function(){return desknets.sp.safety.getRequestURL()},getListRequestData:function(c,d){var b=this;return{cmd:desknets.safety.CMD_SAFETYDISASTERINFO,row:c,num:d}},getAjaxId:function(){return"dnsp-safetydislist"},setUpListItem:function(e,c){var b=this;c.data("id",e.id);str=desknets.tmpl.escapeWord(e.Group);c.find(".jsafety-disinfo-group").html(str);str=desknets.tmpl.escapeWord(e.entryname);c.find(".jsafety-disinfo-entryname").html(str);str=desknets.tmpl.escapeWordLF(e.memo);c.find(".jsafety-disinfo-memo").html(str);var d=desknets.dateTime.dispDateTime(e.date,{type:"list"});c.find(".date").html(d)},openListItem:function(b,c){}});desknets.page(desknets.sp.safety,"SafetyConfEntry",desknets.sp.EntryPage,{msDairiName:"",msConfFlag:"",replaceItems:function(){var b=this;b.setUpReferItemFromEntries();b.pageViewEnd()},clearItems:function(){var b=this;b.callBase("clearItems");a(".jsafety-confentry-dairi").hide()},setUpReferItemFromEntries:function(){var b=this;if(neo.isSet(b.msId)&&b.msId!=desknets.sp.getLoginUid()){var c=desknets.Resource.safety.safetyEntryDairiMessage;c=c.replace("{{dairiuname}}",b.msDairiName);a(".jsafety-confentry-dairi").html(c);a(".jsafety-confentry-dairi").show()}b.$mRootElement.find("#status_01").prop("checked",true).checkboxradio("refresh");b.$mRootElement.find("#status_02").prop("checked",false).checkboxradio("refresh");b.$mRootElement.find("#status_03").prop("checked",false).checkboxradio("refresh");b.$mRootElement.find('textarea[name="memo"]').val("");b.$mRootElement.find('textarea[name="dmy"]').val("");b.setConfActive()},getEntriesFromReferItem:function(){var b=this;var c={};c.cmd=desknets.safety.CMD_SAFETYCMDINPUT;c.status=b.$mRootElement.find('input[name="status"]:checked').val();c.memo=b.$mRootElement.find('textarea[name="memo"]').val();c.SID_USER=b.msId;return c},getSubmitRequestURL:function(){return desknets.sp.safety.getRequestURL()},completeToSendEntries:function(){var b=this;desknets.sp.safety.SafetyConfIndex.invalidate();desknets.sp.safety.SafetyConfList.invalidate();desknets.sp.safety.SafetyIndex.invalidate();b.callBase("completeToSendEntries")},setPage:function(c,e,d){var b=this;b.msId=c;b.msDairiName=e;b.msConfFlag=d;b.invalidate()},setConfActive:function(){var b=this;if(b.msConfFlag=="1"){b.$mRootElement.find(".jco-ok").show();b.$mRootElement.find(".safety-txt-area").show();b.$mRootElement.find(".safety-txt-areadmy").hide()}else{b.$mRootElement.find(".jco-ok").hide();b.$mRootElement.find(".safety-txt-area").hide();b.$mRootElement.find(".safety-txt-areadmy").show()}},_getErrorPlace:function(b){var c=this;if(b!==""&&b=="memo"){return c.$mRootElement.find(".jco-input-"+b).data("memoname")}return""}});desknets.page(desknets.sp.safety,"SafetyConfIndex",desknets.sp.RefPage,{msGid:"",mboDeliveryMailMsg:true,mboDeliveryMailMsgDlg:true,initPage:function(){var b=this;b.callBase("initPage");b.$mRootElement.find(".jco-back").off("vclick").on("vclick",function(c){c.preventDefault();desknets.sp.safety.SafetyGroup.invalidate();desknets.sp.changePage("safetyindex",{reverse:true})});b.$mRootElement.find(".jsafety-confindex").on("vclick",function(c){c.preventDefault();desknets.sp.safety.SafetyConfList.setStatus(b.msGid,a(this).data("status"));desknets.sp.changePage("safetyconflist")});b.$mRootElement.find(".jsafety-chg").on("vclick",function(c){c.preventDefault();desknets.sp.changePage("safetygroup")})},getReferRequestURL:function(){return desknets.sp.safety.getRequestURL()},getReferRequestData:function(){var b=this;var c={cmd:desknets.safety.CMD_SAFETYLIST,row:0,num:1,gid:b.msGid};return c},getRequestOption:function(){var b=this;var c=b.callBase("getRequestOption");c.success=function(e,d,f){b.setUpReferItem(e);b.pageViewEnd();var d="";if(neo.isSet(e.mailstatus,{blank:false})){d=e.mailstatus}if(d==desknets.sp.safety.VAL_SAFETYDELIVERYMAILSTS&&b.mboDeliveryMailMsgDlg==true){desknets.sp.mobjPages["d-safetydeliverymailconfmsg-page"].setPage(e);desknets.sp.changePage("d-safetydeliverymailconfmsg")}};return c},showingPage:function(){var b=this;b.callBase("showingPage");b.$mRootElement.find(".co-error-bg").hide()},setUpReferItem:function(f){var d=this;var b=["nomessage","answered","safe","wounded","bad"];var g=0;var c="";var e="";if(neo.isSet(f.mailstatus,{blank:false})){c=f.mailstatus}if(neo.isSet(f.contactmessage,{blank:false})){e=f.contactmessage}if(c==desknets.sp.safety.VAL_SAFETYDELIVERYMAILSTS){d.$mRootElement.find(".co-error-box").html(e);d.$mRootElement.find(".co-error-bg").show()}else{if(e.length!=0&&d.mboDeliveryMailMsg&&d.msGid.length==0){d.$mRootElement.find(".co-error-box").html(e);d.$mRootElement.find(".co-error-bg").show()}else{d.$mRootElement.find(".co-error-bg").hide()}}d.$mRootElement.find(".co-subtitle").html(desknets.tmpl.escapeWord(f.evgname));d.msGid=f.gid;if(f.confflg=="1"){d.$mRootElement.find(".jco-list-noitems").hide();d.$mRootElement.find(".jco-list-itemdata").show()}else{d.$mRootElement.find(".jco-list-noitems").show();d.$mRootElement.find(".jco-list-itemdata").hide();return}a.each(b,function(j,l){var k=".jsafety-confindex."+l;var h=f.statuscnt[l];d.$mRootElement.find(k).find(".ui-li-count").text(h)});g=Number(f.statuscnt["nomessage"])+Number(f.statuscnt["answered"]);d.$mRootElement.find(".jsafety-confindex.all").find(".ui-li-count").text(g)},clearStatus:function(){var b=this;b.invalidate();b.msGid="";b.mboDeliveryMailMsg=true;b.mboDeliveryMailMsgDlg=true},setPage:function(d,e,b){var c=this;c.msGid=d;c.mboDeliveryMailMsg=e;c.mboDeliveryMailMsgDlg=b}});desknets.page(desknets.sp.safety,"SafetyConfList",desknets.sp.ListPage,{msStatus:"",mSrchKey:"",msGid:"",_tmplSIconAccess:'<img src="'+desknets.sp.msImgPath+'safety/safety-ic_access.gif" width="18" height="16" class="ui-li-icon">',_tmplSIconDeputy:'<img src="'+desknets.sp.msImgPath+'safety/safety-ic_dairi_comment.gif" width="18" height="16" class="ui-li-icon">',init:function(c){var b=this;b.mboChk=false;b.callBase("init",c);b.$mRootElement.find(".jco-srch").on("vclick",function(d){d.preventDefault();b.mSrchKey=b.$mRootElement.find('input[name="srch_key"]').val();b.reload()})},setStatus:function(d,c){var b=this;b.msStatus=c;b.mSrchKey="";b.msGid=d;b.invalidate()},getListRequestURL:function(){return desknets.sp.safety.getRequestURL()},getListRequestData:function(c,d){var b=this;return{cmd:desknets.safety.CMD_SAFETYLIST,status:b.msStatus,row:c,num:d,gid:b.msGid,srch_key:b.mSrchKey}},getAjaxId:function(){return"dnsp-safetyconflist"},setUpListItem:function(g,d){var c=this;var f="";var b="";var e="";this.callBase("setUpListItem",g,d);if(g.ansuser!=g.id&&g.ansuser.length>0){f=c._tmplSIconDeputy}else{if(g.status!="noaccess"){f=c._tmplSIconAccess}}d.find("h3").html(" "+desknets.tmpl.escapeWord(g.Name));a(f).prependTo(d.children("a"));d.find(".jsafety-conflist-memo").html(" "+desknets.tmpl.escapeWordLF(g.memo));d.find(".co-li-time").html(" "+desknets.dateTime.dispDateTime(g.accdate,{type:"list"}));if(g.status=="safe"){b=desknets.Resource.safety.safetyLabelSafe;e="safety-label-safe"}else{if(g.status=="wounded"){b=desknets.Resource.safety.safetyLabelWounded;e="safety-label-lwa"}else{if(g.status=="bad"){b=desknets.Resource.safety.safetyLabelBad;e="safety-label-critical"}else{b=""}}}if(b.length>0){d.find(".jsafety-label-status").text(" "+b).addClass(e)}else{d.find(".jsafety-label-status").remove()}},openListItem:function(c,d){var b=this;desknets.sp.safety.SafetyConfEntry.setPage(d,c.find("h3").html(),"1");desknets.sp.changePage("safetyconfentry")}});desknets.page(desknets.sp.safety,"SafetyGroup",desknets.sp.FolderPage,{getListRequestURL:function(){return desknets.sp.safety.getGroupRequestURL()},getListRequestData:function(d,e){var b=this;var f="";if(b.mobjParent!=null){f=b.mobjParent.id}var c={cmd:"constructugroups",pgid:f,area:"2"};return c},getAjaxId:function(){return"dnsp-safetygroup"},setUpListItem:function(d,c){var b=this;b.callBase("setUpListItem",d,c);c.find("h3").html(desknets.tmpl.escapeWord(d.Name));if(!neo.isSet(d.children)||Number(d.children)<=0){c.removeClass("ui-li-has-alt").find(".jco-listsub").remove()}},openListItem:function(c,d){var b=this;desknets.sp.safety.SafetyConfIndex.invalidate();desknets.sp.safety.SafetyConfIndex.setPage(d,false,false);desknets.sp.changePage("safetyconfindex")},invalidate:function(){var b=this;b.callBase("invalidate");b.mobjParent=null},executeOnItemsGot:function(e,f,c){var b=this;var d=b.executeOnSafetyUnassignGroup(e,f);b.callBase("executeOnItemsGot",e,d,c)},executeOnSafetyUnassignGroup:function(c,e){var b=this;var d="";if(b.mobjParent!=null){d=b.mobjParent.id}if(neo.isSet(c)&&!neo.isSet(d,{blank:false})){e.push({id:"0",children:"0",parent:"",Name:desknets.Resource.chooser.unassignGroupName})}return e}});desknets.page(desknets.sp.safety,"SafetyContact",desknets.sp.EntryPage,{clearItems:function(){var b=this;b.callBase("clearItems");b.$mRootElement.find('input[name="mail"]').val("");b.$mRootElement.find('input[name="tel"]').val("")},replaceItems:function(){var b=this;b.clearItems();desknets.sp.ajax.rest({url:this.getReferRequestURL(),data:this.getReferRequestData(),success:function(d,c,e){b.setUpReferItem(d);b.pageViewEnd()}})},getReferRequestURL:function(){return desknets.sp.safety.getRequestURL()},getReferRequestData:function(){var b=this;var c={cmd:desknets.sp.safety.CMD_SAFETYCONTACTINFO};return c},setUpReferItem:function(c){var b=this;b.callBase("setUpReferItem",c);b.mobjEntries=b.getEntriesFrom(c);b.setUpReferItemFromEntries()},setUpReferItemFromEntries:function(){var b=this;b.$mRootElement.find('input[name="mail"]').val(b.mobjEntries.Mail);b.$mRootElement.find('input[name="tel"]').val(b.mobjEntries.Tel)},getEntriesFromReferItem:function(){var b=this;var c={};c.cmd=desknets.safety.CMD_SAFETYCMDCONTENTRY;c.mail=b.$mRootElement.find('input[name="mail"]').val();c.tel=b.$mRootElement.find('input[name="tel"]').val();c.id=desknets.sp.getLoginUid();return c},getSubmitRequestURL:function(){return desknets.sp.safety.getRequestURL()},completeToSendEntries:function(){var b=this;desknets.sp.safety.SafetyIndex.invalidate();b.callBase("completeToSendEntries")}});desknets.page(desknets.sp.safety,"SafetyPrepare",desknets.sp.RefPage,{getReferRequestURL:function(){return desknets.sp.safety.getRequestURL()},getReferRequestData:function(){var b=this;var c={cmd:desknets.safety.CMD_SAFETYCMDDISASTERPREPLINK};return c},setUpReferItem:function(e){var b=this;if(neo.isSet(e.memo,{blank:false})){var d=desknets.convertToSafeHtml(desknets.rte.convertForShow(e.memo));var c=b.$mRootElement.find(".jsafety-prepare-info");c.html(d);c.detectHref({convertPhone:true});desknets.sp.setUpMailLink(c)}else{b.$mRootElement.find(".jsafety-prepare-info").html(desknets.Resource.safety.safetySettingInfoNothing)}}});desknets.page(desknets.sp.safety,"SafetyEvRoute",desknets.sp.RefPage,{initPage:function(){var b=this;b.callBase("initPage");b.$mRootElement.find(".safety-route-btn .jco-ok").on("click",function(d){d.preventDefault();var c=b.$mRootElement.find("[name=routeurl]").val();window.open(c,"SafetyEvRoute")});b.$mRootElement.find(".jsafety-evroute").on("change",function(c){c.preventDefault();b._getRouteInfo(a(c.target).val())})},getReferRequestURL:function(){return desknets.sp.safety.getRequestURL()},getReferRequestData:function(){var b=this;var c={cmd:desknets.safety.CMD_SAFETYCMDEVACUATIONROUTELIST};return c},setUpReferItem:function(e){var c=this;var b=[];var d=null;var g="";var h=desknets.ajax.getJsonItems(e);if(h.length>0){var f=c.$mRootElement.find("select.jsafety-evroute");f.html("");for(iCnt=0;iCnt<h.length;iCnt++){d=h[iCnt];g='<option value="'+d.id+'">'+desknets.tmpl.escapeWord(d.Name)+"</option>";b[b.length]=g;if(iCnt==0){c._getRouteInfo(d.id)}}f.append(a(b.join(""))).enhanceWithin();f.selectmenu("refresh");c.$mRootElement.find(".safety-company-spot-list").show();c.$mRootElement.find(".safety-company-spot-nolist").hide()}else{c.$mRootElement.find(".safety-company-spot-list").hide();c.$mRootElement.find(".safety-company-spot-nolist").show()}},_getRouteInfo:function(d){var b=this;var c=b.getReferRequestURL();desknets.sp.ajax.rest({url:c,data:{cmd:desknets.safety.CMD_SAFETYCMDEVACUATIONROUTEINFO,id:d},success:function(f,e,g){b._setHtmlRouteInfo(f)}})},_setHtmlRouteInfo:function(e){var b=this;var f=desknets.escape(e.start);f=desknets.escapeValue(f);f=desknets.escapeSpace(f);var d=desknets.escape(e.goal);d=desknets.escapeValue(d);d=desknets.escapeSpace(d);b.$mRootElement.find(".safety-route-start").html(f);b.$mRootElement.find(".safety-route-goal").html(d);b.$mRootElement.find("input[name=routeurl]").val(e.Url);var c=e.Url;c=desknets.safety.getMapAPIUrl(e.Url,e.start,e.goal,e.slat,e.slon,e.dlat,e.dlon);a(".safety-route-btn input").val(c)}});desknets.page(desknets.sp.safety,"SafetyHomeRoute",desknets.sp.safety.SafetyEvRoute,{initPage:function(){var b=this;b.callBase("initPage");b.$mRootElement.find(".safety-route-btn .jco-ok").off().on("click",function(i){i.preventDefault();var j=b.$mRootElement.find("input[name=start]").val();var d=b.$mRootElement.find("input[name=goal]").val();var e=b.$mRootElement.find("input[name=slat]").val();var g=b.$mRootElement.find("input[name=slon]").val();var f=b.$mRootElement.find("input[name=dlat]").val();var h=b.$mRootElement.find("input[name=dlon]").val();var c=b.$mRootElement.find("input[name=routeurl]").val();c=desknets.safety.getMapAPIUrl(c,j,d,e,g,f,h);window.open(c,"SafetyEvRoute")});b.$mRootElement.find("#jsafety-evroute").on("change",function(c){c.preventDefault();b._getRouteInfo(a(c.target).val())})},_setHtmlRouteInfo:function(d){var b=this;if(d.map=="g"){a(".jsafety-map-slat").hide();a(".jsafety-map-slon").hide();a(".jsafety-map-dlat").hide();a(".jsafety-map-dlon").hide()}else{a(".jsafety-map-slat").show();a(".jsafety-map-slon").show();a(".jsafety-map-dlat").show();a(".jsafety-map-dlon").show();a('input[name="slat"]').val(d.slat);a('input[name="slon"]').val(d.slon);a('input[name="dlat"]').val(d.dlat);a('input[name="dlon"]').val(d.dlon)}a('input[name="start"]').val(d.start);a('input[name="goal"]').val(d.goal);a("input[name=routeurl]").val(d.Url);var c=d.Url;a(".safety-route-btn input").val(c)}});desknets.page(desknets.sp.safety,"SafetyDeliveryMailList",desknets.sp.ComPage,{setSelTargets:function(e,f,b,g){var c=this;var d;d=c.$mRootElement.find(b);c.editSelTargetGroups(e,f,d);c.setSelTargetsParentID(d,g);c.clearSafetySelTargetGroups(d,false)},editSelTargetGroups:function(f,g,c){var b=this;var e="";var d;if(!neo.isSet(g,{blank:false})){g="targrt"}a.each(f,function(j,k){var i=desknets.tmpl.escapeWord(k.val);var h='<a href="#" class="jsafety-entry-tsel">'+i+'<input type="hidden" value="'+k.id+'" name="'+g+'"></a>';e=e+h});c.find(".co-input-selected").html(e)},setSelTargetsParentID:function(d,e){var c=this;var b=c.$mRootElement.find('input[name="gid"]');if(b.length>0){b.val(e)}},clearSafetySelTargetGroups:function(c,d){var b=this;var f=0;var e=c.find(".co-input-selected");if(d==false){f=e.find(".jsafety-entry-tsel").length}if(f==0){e.html(desknets.Resource.safety.safetySendAllGroup);b.$mRootElement.find('input[name="gid"]').val("")}},init:function(d){var c=this;c.callBase("init",d);var b=c.$mRootElement.find(".jsafety-input-target");c.$mRootElement.find(".jsafety-deliverymailseltarget").on("vclick",function(e){e.preventDefault();desknets.sp.mobjPages["safetydeliverymailseltarget-page"].setPage(c.getSafetySelTargetGroups(b,true));desknets.sp.changePage("safetydeliverymailseltarget")});c.$mRootElement.find(".jsafety-input-target").on("vclick",".jsafety-entry-tsel",function(e){e.preventDefault();desknets.sp.mobjPages["d-safetydeliverymaildeseltarget-page"].setPage(a(this));desknets.sp.changePage("d-safetydeliverymaildeseltarget")});c.$mRootElement.find(".jsafety-deliverymailconf").on("vclick",function(f){f.preventDefault();var e=c.$mRootElement.find('input[name="gid"]').val();var g=c.$mRootElement.find('input[name="sendtype"]:checked').val();desknets.sp.mobjPages["d-safetydeliverymailconf-page"].setPage(g,e,c.getSafetySelTargetGroups(b,false));desknets.sp.changePage("d-safetydeliverymailconf")})},getSafetySelTargetGroups:function(d,e){var c=this;var b=[];var f=d.find(".jsafety-entry-tsel");f.each(function(i){var h=a(this);if(e==true){b[i]=h.find("input").val()}else{var g={};g.id=h.find("input").val();g.name=h.text();b[i]=g}});return b},clearItems:function(){var b=this;b.callBase("clearItems");b.$mRootElement.find("#sendtype_01").prop("checked",true).checkboxradio("refresh");b.$mRootElement.find("#sendtype_02").prop("checked",false).checkboxradio("refresh");b.clearSafetySelTargetGroups(b.$mRootElement.find(".jsafety-input-target"),true)}});desknets.page(desknets.sp.safety,"SafetyDeliveryMailConf",desknets.sp.EntryPage,{msSendTypeMail:null,moDeliveryGroups:[],moDeliveryGroupIDs:[],msParentID:"",setPage:function(c,d,f){var b=this;b.msSendTypeMail=c;b.msParentID=d;b.moDeliveryGroups=f;var g=b.moDeliveryGroups.length;if(g>0){var e;for(e=0;e<g;e++){b.moDeliveryGroupIDs[e]=b.moDeliveryGroups[e].id}}b.invalidate()},replaceItems:function(){var b=this;b.callBase("replaceItems");b.confSafetyDeliveryMail()},confSafetyDeliveryMail:function(){var b=this;var d={};if(b.msSendTypeMail==desknets.sp.safety.VAL_SAFETYSENDTYPEMAIL){d.cmd=desknets.sp.safety.CMD_SAFETYMSETDELIVERYMAILCONF}else{d.cmd=desknets.sp.safety.CMD_SAFETYMSETDELIVERYMAILTRYCONF}var e=b.moDeliveryGroups.length;if(e>0){d.sendtype="2";d.id=b.moDeliveryGroupIDs}else{d.sendtype="1"}d.gid=b.msParentID;var c={url:b.getSubmitRequestURL(),data:d,error:function(h,g,f){if(g!="abort"){desknets.sp.ajax.onError(h.status,f,true)}},dialogback:true};desknets.sp.ajax.rest(c)},showingPage:function(){var b=this;b.callBase("showingPage");b.editSafetyDeliveryMailConfDlg()},editSafetyDeliveryMailConfDlg:function(){var c=this;var h="";var d="";var b="";var f="";if(c.msSendTypeMail==desknets.sp.safety.VAL_SAFETYSENDTYPEMAIL){h=desknets.Resource.safety.safetyContactDeliveryDiaTitle;d=desknets.Resource.Message.safetySendGrpConfirm}else{h=desknets.Resource.safety.safetyContactDeliveryDiaRegTitle;d=desknets.Resource.Message.safetyTrgSendGrpConfirm}var g=c.moDeliveryGroups.length;if(g>0){b=desknets.Resource.safety.safetySendConfDeliGrp;d=desknets.tmpl.replaceWordHtml(d,"gname",b);var e;for(e=0;e<g;e++){if(e==0){f=desknets.tmpl.escapeWord(c.moDeliveryGroups[e].name)}else{f=f+","+desknets.tmpl.escapeWord(c.moDeliveryGroups[e].name)}}}else{b=desknets.Resource.safety.safetySendAllGroup;d=desknets.tmpl.replaceWordHtml(d,"gname",b);f=b}c.$mRootElement.find("#jsafety-deliverymailconf-title").html(h);c.$mRootElement.find("#jsafety-deliverymailconf-msg").html(d);c.$mRootElement.find("#jsafety-deliverymailconf-target").html(f)},getEntriesFromReferItem:function(){var b=this;var c={};if(b.msSendTypeMail==desknets.sp.safety.VAL_SAFETYSENDTYPEMAIL){c.cmd=desknets.sp.safety.CMD_SAFETYMSETDELIVERYMAIL}else{c.cmd=desknets.sp.safety.CMD_SAFETYMSETDELIVERYMAILTRY}var d=b.moDeliveryGroups.length;if(d>0){c.sendtype="2";c.id=b.moDeliveryGroupIDs}else{c.sendtype="1"}c.gid=b.msParentID;return c},getSubmitRequestURL:function(){return desknets.sp.safety.getRequestURL()},completeToSendEntries:function(){var b=this;desknets.sp.mobjPages["safetyconfindex-page"].invalidate();desknets.sp.mobjPages["safetyconflist-page"].invalidate();desknets.sp.mobjPages["safetyindex-page"].invalidate();var c=function(e){var d="";if(neo.isSet(e.contactmessage,{blank:false})){d=e.contactmessage}if(d.length==0){desknets.sp.mobjPages["safetyconfindex-page"].clearStatus();desknets.sp.mobjPages["safetyconfindex-page"].setPage("",false,false);desknets.sp.changePage("safetyconfindex")}else{desknets.sp.mobjPages["d-safetydeliverymailconfmsg-page"].setPage(e);desknets.sp.changePage("d-safetydeliverymailconfmsg")}};desknets.sp.safety.getSafetyConfIndex(c)}});desknets.page(desknets.sp.safety,"SafetyDeliveryMailConfMsg",desknets.sp.ComPage,{msDeliveryMailMsg:"",msDeliveryMailSts:"",moIntervals:null,setPage:function(c){var b=this;if(neo.isSet(c.mailstatus)){b.msDeliveryMailSts=c.mailstatus}if(neo.isSet(c.contactmessage)){b.msDeliveryMailMsg=c.contactmessage}},init:function(c){var b=this;b.callBase("init",c);b.$mRootElement.find(".jsafety-deliverymailconfmsg-close").on("vclick",function(d){d.preventDefault();if(b.moIntervals!=null){clearInterval(b.moIntervals);b.moIntervals=null}desknets.sp.mobjPages["safetyconfindex-page"].clearStatus();desknets.sp.mobjPages["safetyconfindex-page"].setPage("",b.isDispSafetyDeliveryMailMsg(),false);desknets.sp.changePage("safetyconfindex")});b.$mRootElement.find('div:jqmData(role="header")').find("a").off();b.$mRootElement.find('div:jqmData(role="header")').find("a").on("vclick",function(d){d.preventDefault();if(b.moIntervals!=null){clearInterval(b.moIntervals);b.moIntervals=null}desknets.sp.mobjPages["safetyconfindex-page"].clearStatus();desknets.sp.mobjPages["safetyconfindex-page"].setPage("",b.isDispSafetyDeliveryMailMsg(),false);desknets.sp.changePage("safetyconfindex")})},isDispSafetyDeliveryMailMsg:function(){var b=this;if(b.msDeliveryMailSts==desknets.sp.safety.VAL_SAFETYDELIVERYMAILSTS){return true}return false},showing:function(){var b=this;b.callBase("showing");b.editSafetyDeliveryMailConfMsgDlg()},editSafetyDeliveryMailConfMsgDlg:function(){var b=this;var d="";var c="";if(b.msDeliveryMailSts==desknets.sp.safety.VAL_SAFETYDELIVERYMAILSTS){d=desknets.Resource.messageDefaultTitle}else{d=desknets.Resource.errorDefaultTitle}c=b.msDeliveryMailMsg;b.$mRootElement.find("#jsafety-deliverymailconfmsg-title").html(d);b.$mRootElement.find(".co-dialog-msg").html(c)},show:function(){var b=this;b.callBase("show");setTimeout(function(){b.checkSafetyDeliveryMailStatus()},200)},checkSafetyDeliveryMailStatus:function(){var b=this;b.moIntervals=setInterval(function(){var c=function(d){b.setPage(d);if(b.msDeliveryMailSts!=desknets.sp.safety.VAL_SAFETYDELIVERYMAILSTS){clearInterval(b.moIntervals);b.moIntervals=null}if(b.msDeliveryMailMsg.length==0){clearInterval(b.moIntervals);b.moIntervals=null;desknets.sp.mobjPages["safetyconfindex-page"].clearStatus();desknets.sp.mobjPages["safetyconfindex-page"].setPage("",false,false);desknets.sp.changePage("safetyconfindex")}else{b.editSafetyDeliveryMailConfMsgDlg()}};desknets.sp.safety.getSafetyConfIndex(c)},1000)}});desknets.page(desknets.sp.safety,"SafetyDeliveryMailSelTarget",desknets.sp.safety.SafetyGroup,{moSelTargetGroupIDs:[],setPage:function(c){var b=this;b.moSelTargetGroupIDs=c;b.invalidate()},init:function(c){var b=this;b.mboChk=true;b.mboSet=true;b.callBase("init",c);b.$mRootElement.find(".jsafety-parent").on("vclick",function(d){d.preventDefault();if(!neo.isSet(b.mobjParent,{blank:false})){history.back()}b.mobjParent=b.marFolderList.pop();b.reload()});b.$mRootElement.find(".jsafety-target-ok").on("vclick",function(f){f.preventDefault();var e=[];var d=b.$listElement.find("input[type=checkbox]:checked");d.each(function(j){var i={};var h=a(this);i.id=h.closest("li").data("id");i.val=h.closest("li").find('input[name="targetset"]').val();e[j]=i});var g="";if(b.mobjParent!=null){g=b.mobjParent.id}b.openMultiItems(e,g)})},openMultiItems:function(d,c){var b=this;desknets.sp.mobjPages["safetydeliverymaillist-page"].setSelTargets(d,"target",".jsafety-input-target",c);history.back()},getListRequestURL:function(){var b=this;if(desknets.sp.safety.mboAllManage){return b.callBase("getListRequestURL")}else{return desknets.sp.safety.getRequestURL()}},getListRequestData:function(d,e){var b=this;var c={};if(desknets.sp.safety.mboAllManage){c=b.callBase("getListRequestData",d,e)}else{c={cmd:desknets.sp.safety.CMD_SAFETYMSETDELIVERYMAILLIST}}return c},openListItem:function(b,c){},executeOnSafetyUnassignGroup:function(c,d){var b=this;if(desknets.sp.safety.mboAllManage){return b.callBase("executeOnSafetyUnassignGroup",c,d)}else{return d}},setUpListItem:function(d,c){var b=this;b.callBase("setUpListItem",d,c);if(!desknets.sp.safety.mboAllManage){c.find("h3").html(desknets.tmpl.escapeWord(d.tgname))}c.find('input[name="targetset"]').val(d.Name);c.find("input[type=checkbox]").attr("id",b.getListID()+d.id);c.find("label").attr("for",b.getListID()+d.id);if(a.inArray(d.id,b.moSelTargetGroupIDs)>=0){c.find("input[type=checkbox]").prop("checked",true)}},getListID:function(){return"jsafety-chk-list-"},});desknets.page(desknets.sp.safety,"SafetyDeliveryMailDeSelTarget",desknets.sp.ComPage,{moTargetGroup:null,moTargetGroupArea:null,setPage:function(c){var b=this;b.moTargetGroup=c;b.moTargetGroupArea=c.closest(".jsafety-input-target")},init:function(c){var b=this;b.callBase("init",c);b.$mRootElement.find(".jco-ok").on("vclick",function(d){d.preventDefault();if(b.moTargetGroup){b.moTargetGroup.remove();desknets.sp.mobjPages["safetydeliverymaillist-page"].clearSafetySelTargetGroups(b.moTargetGroupArea,false)}b.$mRootElement.dialog("close")})},});desknets.sp.safety.init()})(jQuery);