/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
(function(a){desknets.sp.addr={MODULE_API_ZRWEML:"zrweml",MODULE_API_ZRWRICH:"zrwrich",CMD_GETLOGIN:"getlogin",CMD_SETMODULESMOBILE:"setmodulesmobile",CMD_PSETGEN:"psetgen",CMD_ADDRSEARCHLIST:"addrsearchlist",CMD_ADDRINDEX:"addrindex",CMD_ADDRENTRY:"addrentry",CMD_ADDRCMDENTRY:"addrcmdentry",CMD_ADDRDEL:"addrdel",mboUset:null,mboWebmail:null,mboImap:null,init:function(){if(!a("body").hasClass("func_addr")){return}desknets.sp.mobjPages["addrsrch-page"]=desknets.sp.addr.AddrSrch;desknets.sp.mobjPages["addrref-page"]=desknets.sp.addr.AddrRef;desknets.sp.mobjPages["addrentry-page"]=desknets.sp.addr.AddrEntry;desknets.sp.mobjPages["d-addrdel-page"]=desknets.sp.addr.AddrDel;desknets.sp.mobjPages["addruset-page"]=desknets.sp.addr.UsetList;desknets.sp.mobjPages["addrusetref-page"]=desknets.sp.addr.UsetRef;desknets.sp.mobjPages["neotwi-page"]=desknets.sp.Neotwi;desknets.sp.mobjPages["mailentry-page"]=desknets.sp.mail.MailEntry;desknets.sp.mobjPages["d-mailsave-page"]=desknets.sp.mail.MailSave;desknets.sp.mobjPages["d-mailsendconf-page"]=desknets.sp.mail.MailSendConf;desknets.sp.mobjPages["addrselect-page"]=desknets.sp.mail.AddrSelect;desknets.sp.mobjPages["userselect-page"]=desknets.sp.mail.UserSelect;desknets.sp.mobjPages["d-mailaddrselect-page"]=desknets.sp.mail.MailAddrSelect;desknets.sp.initSetEvents()},getRequestURL:function(){return desknets.sp.getUrl(desknets.sp.addr.MODULE_API_ZRWEML)},getModules:function(d){var b=this;if(b.mboWebmail!==null){if(a.isFunction(d)){d()}return}var c={dataType:"xml",url:desknets.sp.getUrl(desknets.sp.addr.MODULE_API_ZRWRICH),data:{cmd:desknets.sp.addr.CMD_SETMODULESMOBILE},success:function(f,e,g){b._saveModules(a(f));if(a.isFunction(d)){d()}}};desknets.sp.ajax.rest(c)},_saveModules:function(b){var d=this;d.mboWebmail=false;d.mboUset=false;var c=b.find(":first > list > item");c.each(function(g,e){var f=a(e);if(f.attr("id")=="10"){d.mboWebmail=true}else{if(f.attr("id")=="24"){d.mboUset=true}else{if(f.attr("id")=="28"){d.mboImap=true}}}})},setUpMailLink:function(e,f,d,c){var k=this;var g=e.find(f);var i=g.closest("li");if(typeof(d)=="string"&&d.length>0){var b="";var j=d;var h=desknets.sp.getLoginMailLink();if(h=="2"&&k.mboWebmail!==true){h="0"}if(h=="3"&&k.mboImap!==true){h="0"}if(h=="1"){b='<a href="mailto:{{valurl}}">{{val}}</a>'}else{if(h=="2"||h=="3"){b='<a href="#" class="jaddr-mailnew">{{val}}</a>'}else{b="{{val}}"}}b=desknets.tmpl.replaceWord(b,"val",j);b=desknets.tmpl.replaceWord(b,"valurl",desknets.encodeURIComponentNeo(j));g.html(b);i.removeClass("none")}else{if(typeof(c)=="string"){g.html(c);i.removeClass("none")}else{i.addClass("none")}}},getDestinationText:function(d,c){d=d.replace(/\\/g,"\\\\");d=d.replace(/'/g,"\\'");d=d.replace(/"/g,'\\"');var b='"'+d+'"<'+c+">";return b},setUpTelLink:function(c){var b=this;var d={convertMail:false,convertPhone:false,convertPhoneOnly:true,convertURL:false,};c.detectHref(d)}};desknets.page(desknets.sp.addr,"AddrSrch",desknets.sp.SearchPage,{mboIndexKana:true,mboSrchModeKey:true,initPage:function(){var c=this;c.mboJson=false;var b=function(){if(!desknets.sp.addr.mboUset){var d=c.$mRootElement.find(".co-search-input");d.removeClass("addr-search-input");d.find(".ui-select").hide()}};desknets.sp.addr.getModules(b);if(c.$mRootElement.find(".jaddr-index").length>0){c.$mRootElement.addClass("co-bgaddr")}c.getDefSrch(true);c.$mRootElement.find(".jco-srch").bind("vclick",function(d){d.preventDefault();a(this).focus();if(c.chkSearch()){c.clearItems();c.getDefSrch(false);c.mbItemRetrieved=true;c.mboSrchModeKey=true;c.$noItemsContainerElement.find(".addr-noitems-searchkey").show();c.$noItemsContainerElement.find(".addr-noitems-key").hide();c.$mRootElement.find(".jaddr-index>li").removeClass("selected");c.mobjSrch.srch_key=c.$mRootElement.find('input[name="srch_key"]').val();c.reload()}});c.$mRootElement.find(".jaddr-srch a").bind("vclick",function(e){e.preventDefault();a(this).focus();c.clearItems();c.getDefSrch(false);c.mbItemRetrieved=true;c.mboSrchModeKey=false;c.$noItemsContainerElement.find(".addr-noitems-searchkey").hide();c.$noItemsContainerElement.find(".addr-noitems-key").show();c.$mRootElement.find('input[name="srch_key"]').val("").searchkeychg();c.$mRootElement.find(".jaddr-index>li").removeClass("selected");var d=a(e.target).closest("li");d.addClass("selected");c.mobjSrch.indexname=d.attr("data-indexname");c.mobjSrch.wide=d.hasClass("jaddr-wide");c.reload()});c.$mRootElement.find(".jaddr-change a").bind("vclick",function(d){d.preventDefault();c.mboIndexKana=!a(d.target).closest("li").hasClass("jaddr-kana");c._changeIndex(c.mboIndexKana)});c.$mRootElement.find(".jaddr-add").bind("vclick",function(d){d.preventDefault();desknets.sp.addr.AddrEntry.setEntries({});desknets.sp.changePage("addrentry")});c.$mRootElement.find("#jaddr-addrchg").on("change",function(d,e){if(a(this).val()=="uset"){desknets.sp.changePage("addruset");c.$mRootElement.find('select[name="addrchg"]').val("addr").selectmenu("refresh")}})},pageViewEnd:function(){var b=this;b._changeIndex(b.mboIndexKana);b.callBase("pageViewEnd")},_changeIndex:function(c){var b=this;if(c===false){b.$mRootElement.find(".jaddr-kana").hide();b.$mRootElement.find(".jaddr-alp").show()}else{b.$mRootElement.find(".jaddr-kana").show();b.$mRootElement.find(".jaddr-alp").hide()}b.callBase("pageViewEnd")},chkSearch:function(){var d=this;if(d.$mRootElement.find('input[name="srch_key"]').val()==""){var b=desknets.Resource.searchcond;var c="";var e=desknets.tmpl.replaceWordHtml(desknets.Resource.Message.com_search_required,"item",b);desknets.sp.msg.view(c,"W:"+e,false);return false}return true},getListRequestURL:function(){return desknets.sp.addr.getRequestURL()},getAjaxId:function(){return"dnsp-addrsrch"},getRequestOption:function(){var b=this;var c=b.callBase("getRequestOption");c.dataType="xml";return c},getListRequestData:function(c,d){var b=this;var e={};if(b.mboSrchModeKey){e={cmd:desknets.sp.addr.CMD_ADDRSEARCHLIST,key:b.mobjSrch.srch_key||"",share:"1",personal:"1",name:"1","const":"1",mail:"1",domain:"1",kana:"1",row:c,num:d}}else{e={cmd:desknets.sp.addr.CMD_ADDRINDEX,area:"3",kind:"1",no:b.mobjSrch.indexname||"",row:c,num:d};if(b.mobjSrch.wide==true){e.noall="all"}}return e},setUpListItem:function(e,c){var b=this;b.callBase("setUpListItem",e,c);var d=c.data("id");if(parseInt(d)>0){c.find(".addr-label").addClass("share")}c.find("h3").html(desknets.tmpl.escapeWord(e.children("Name").text()))},openListItem:function(c,d){var b=this;desknets.sp.addr.AddrRef.setPage(d);desknets.sp.changePage("addrref")}});desknets.page(desknets.sp.addr,"AddrRef",desknets.sp.RefPage,{mboAdmin:null,initPage:function(){var b=this;b.callBase("initPage");b.mboJson=false;b.$mRootElement.find(".jaddr-mod").bind("vclick",function(c){c.preventDefault();desknets.sp.addr.AddrEntry.setPage(b.msId);desknets.sp.changePage("addrentry")});b.$mRootElement.find(".jaddr-del").bind("vclick",function(c){c.preventDefault();desknets.sp.addr.AddrDel.setPage(b.msId,false);desknets.sp.changePage("d-addrdel",{changeHash:false})})},showing:function(){var b=this;b.callBase("showing");if(!b.mbItemRetrieved){b.$mRootElement.find(".jaddr-mod").hide();b.$mRootElement.find(".jaddr-footer-del").hide();b.$mRootElement.find(".jaddr-footer-def").show()}},replaceItems:function(){var b=this;b.clearItems();b._getInitData()},getRefData:function(){var b=desknets.sp.addr.AddrRef;b.callBase("replaceItems")},getReferRequestURL:function(){return desknets.sp.addr.getRequestURL()},getRequestOption:function(){var b=this;var c=b.callBase("getRequestOption");c.dataType="xml";return c},getReferRequestData:function(c,d){var b=this;return{cmd:desknets.sp.addr.CMD_ADDRENTRY,id:b.msId}},_getInitData:function(){var b=this;b._getLoginInfo()},_getLoginInfo:function(){var b=this;if(b.mboAdmin!==null){b.getRefData();return}var c={dataType:"xml",url:desknets.sp.getUrl(desknets.sp.addr.MODULE_API_ZRWRICH),data:{cmd:desknets.sp.addr.CMD_GETLOGIN},success:function(e,d,f){b.mboAdmin=a(e).find("addritemacckind").text()=="15"?true:false;b.getRefData()},dialogback:true};desknets.sp.ajax.rest(c)},setUpReferItem:function(g){var d=this;g=a(g);var e=g.find("result > Name").text();var f=d.$mRootElement.find(".jaddr-mod");var h=d.$mRootElement.find(".jaddr-footer-del");var b=d.$mRootElement.find(".jaddr-footer-def");var i=parseInt(d.msId);if(i>0&&d.mboAdmin!==true){f.hide();h.hide();b.show()}else{f.show();b.hide();h.show()}d.setUpText(".jaddr-name",e,"");d.setUpText(".jaddr-kana",g.find("Kana").text(),"");desknets.sp.addr.setUpMailLink(d.$mRootElement,".jaddr-mail",g.find("Mail").text(),"");desknets.sp.addr.setUpMailLink(d.$mRootElement,".jaddr-mailprivate",g.find("mailprivate").text(),"");desknets.sp.addr.setUpMailLink(d.$mRootElement,".jaddr-mailmobile",g.find("mailmobile").text(),"");d.setUpText(".jaddr-company",g.find("Company").text(),"");d.setUpText(".jaddr-companykana",g.find("CompanyKana").text(),"");d.setUpText(".jaddr-tel1",g.find("Tel1").text(),"");d.setUpText(".jaddr-telhome",g.find("TelHome").text(),"");d.setUpText(".jaddr-telhand",g.find("TelHand").text(),"");d.$mRootElement.find(".jaddr-mailnew").bind("vclick",function(o){o.preventDefault();var n={};var l=a(o.target).text();n.to=desknets.sp.addr.getDestinationText(e,l);var m="";var k=desknets.sp.getLoginMailLink();if(k=="3"){m="mailimapindex"}else{m="mailindex"}var j=desknets.sp.getUrl("dneosp");j=j+"?cmd="+m+"&to="+n.to+"#mailentry-page";desknets.sp.execLocation(j)});var c=d.$mRootElement.find(".addr-tel");desknets.sp.addr.setUpTelLink(c)}});desknets.page(desknets.sp.addr,"AddrEntry",desknets.sp.EntryPage,{init:function(c){var b=this;b.callBase("init",c)},getReferRequestURL:function(){return desknets.sp.addr.getRequestURL()},getRequestOption:function(){var b=this;var c=b.callBase("getRequestOption");c.dataType="xml";return c},getReferRequestData:function(){var b=this;var c={cmd:desknets.sp.addr.CMD_ADDRENTRY,id:b.msId,};return c},getEntriesFrom:function(e){var d=this;var c=a(e);var b={};b.Name=c.find("result > Name").text();b.Kana=c.find("Kana").text();b.Mail=c.find("Mail").text();b.mailprivate=c.find("mailprivate").text();b.mailmobile=c.find("mailmobile").text();b.Company=c.find("Company").text();b.CompanyKana=c.find("CompanyKana").text();b.Tel1=c.find("Tel1").text();b.TelHome=c.find("TelHome").text();b.TelHand=c.find("TelHand").text();return b},setUpReferItemFromEntries:function(){var b=this;b.$mRootElement.find('input[name="Name"]').val(b.mobjEntries.Name);b.$mRootElement.find('input[name="Kana"]').val(b.mobjEntries.Kana);b.$mRootElement.find('input[name="Mail"]').val(b.mobjEntries.Mail);b.$mRootElement.find('input[name="mailprivate"]').val(b.mobjEntries.mailprivate);b.$mRootElement.find('input[name="mailmobile"]').val(b.mobjEntries.mailmobile);b.$mRootElement.find('input[name="Company"]').val(b.mobjEntries.Company);b.$mRootElement.find('input[name="CompanyKana"]').val(b.mobjEntries.CompanyKana);b.$mRootElement.find('input[name="Tel1"]').val(b.mobjEntries.Tel1);b.$mRootElement.find('input[name="TelHome"]').val(b.mobjEntries.TelHome);b.$mRootElement.find('input[name="TelHand"]').val(b.mobjEntries.TelHand)},getSendRequestOption:function(){var b=this;var c=b.callBase("getSendRequestOption");c.dataType="xml";return c},getEntriesFromReferItem:function(){var b=this;var c={};c.cmd=desknets.sp.addr.CMD_ADDRCMDENTRY;c.Name=b.$mRootElement.find('input[name="Name"]').val();c.Mail=b.$mRootElement.find('input[name="Mail"]').val();c.mailprivate=b.$mRootElement.find('input[name="mailprivate"]').val();c.mailmobile=b.$mRootElement.find('input[name="mailmobile"]').val();c.Company=b.$mRootElement.find('input[name="Company"]').val();c.Tel1=b.$mRootElement.find('input[name="Tel1"]').val();c.TelHome=b.$mRootElement.find('input[name="TelHome"]').val();c.TelHand=b.$mRootElement.find('input[name="TelHand"]').val();c.sp="1";if(!!b.msId&&b.msId!==""){c.id=b.msId}if(b.$mRootElement.find('input[name="Kana"]').length>0){c.Kana=b.$mRootElement.find('input[name="Kana"]').val();c.CompanyKana=b.$mRootElement.find('input[name="CompanyKana"]').val()}else{if(!neo.isSet(b.msId,{blank:false})){c.Kana="*****"}}var d=parseInt(b.msId);c.area=(d>0)?"2":"1";return c},completeToSendEntries:function(){var b=this;desknets.sp.addr.AddrSrch.invalidate();desknets.sp.addr.AddrRef.invalidate();b.callBase("completeToSendEntries")},});desknets.page(desknets.sp.addr,"AddrDel",desknets.sp.DelPage,{delCloseId:function(){return"addrref"},setInvalidate:function(){desknets.sp.addr.AddrSrch.invalidate()},getEntriesFromReferItem:function(){var b=this;var c=b.callBase("getEntriesFromReferItem");c.cmd=desknets.sp.addr.CMD_ADDRDEL;return c},getSubmitRequestURL:function(){return desknets.sp.addr.getRequestURL()},getSendRequestOption:function(){var b=this;var c=b.callBase("getSendRequestOption");c.dataType="xml";return c}});desknets.page(desknets.sp.addr,"UsetList",desknets.sp.UsetList,{init:function(c){var b=this;b.callBase("init",c);b.$mRootElement.find("#jaddr-addrchg-uset").on("change",function(d,e){if(a(this).val()=="addr"){desknets.sp.changePage("addrsrch");b.$mRootElement.find('select[name="addrchg"]').val("uset").selectmenu("refresh")}})},setUpListItem:function(d,c){var b=this;b.callBase("setUpListItem",d,c);if(neo.isSet(d.children,{blank:false})){c.addClass("co-li-folder");c.find("h3").html(desknets.tmpl.escapeWord(d.Name))}else{c.find("h3").html(desknets.tmpl.escapeWord(d.Name))}},openListItem:function(c,d){var b=this;if(c.hasClass("co-li-folder")){b.grpChangeId(c,d)}else{desknets.sp.addr.UsetRef.setPage(d);desknets.sp.changePage("addrusetref")}},});desknets.page(desknets.sp.addr,"UsetRef",desknets.sp.RefPage,{getReferRequestURL:function(){return desknets.sp.getUrl("zrconst")},getReferRequestData:function(){var b=this;var c={cmd:"constructcmduserinfo",id:b.msId,};return c},setUpReferItem:function(h){var l=this;l.setUpText(".co-user-name",h.Name);l.setUpText(".co-user-kana",h.Kana);var k=desknets.sp.changePath(h.attach);var b=l.$mRootElement.find(".co-user-img").remove();if(neo.isSet(k,{block:false})){var i='<img class="co-user-img" src="{{src}}">';i=desknets.tmpl.replaceWordHtml(i,"src",k);l.$mRootElement.find(".co-user-prof").prepend(i)}desknets.sp.addr.setUpMailLink(l.$mRootElement,".jaddr-Mail",h.Mail);desknets.sp.addr.setUpMailLink(l.$mRootElement,".jaddr-mailmobile",h.mailmobile);desknets.sp.addr.setUpMailLink(l.$mRootElement,".jaddr-mailprivate",h.mailprivate);desknets.sp.addr.setUpMailLink(l.$mRootElement,".jaddr-mailother",h.mailother);l.$mRootElement.find(".jaddr-mailnew").bind("vclick",function(r){r.preventDefault();var q={};var o=a(r.target).text();q.to=desknets.sp.addr.getDestinationText(l.$mRootElement.find(".co-user-name").text(),o);var p="";var n=desknets.sp.getLoginMailLink();if(n=="3"){p="mailimapindex"}else{p="mailindex"}var m=desknets.sp.getUrl("dneosp");m=m+"?cmd="+p+"&to="+q.to+"#mailentry-page";desknets.sp.execLocation(m)});l.$mRootElement.find(".jaddr-level").closest("li").removeClass("none");if(!h.level){l.setUpText(".jaddr-level","")}else{if(h.level=="1"){l.$mRootElement.find(".jaddr-level-admin").show();l.$mRootElement.find(".jaddr-level-normal").hide()}else{l.$mRootElement.find(".jaddr-level-admin").hide();l.$mRootElement.find(".jaddr-level-normal").show()}}l.setUpText(".jaddr-user-group",h.Group);var j=l.$mRootElement.find(".jaddr-user-assigngroup").closest("li");var c=desknets.refDialog.editGroups(h.assigngrp);if(c=="&nbsp;"){j.addClass("none")}else{j.removeClass("none");l.$mRootElement.find(".jaddr-user-assigngroup").html(c)}l.setUpText(".jaddr-Office",h.Office);l.setUpText(".jaddr-Dept1",h.Dept1);l.setUpText(".jaddr-Dept2",h.Dept2);if(!!h.postcode){var d="";if(!!h.Post){d=h.Post}d=d+"("+h.postcode+")";l.setUpText(".jaddr-Post","");l.setUpText(".jaddr-postcode",d)}else{l.setUpText(".jaddr-Post",h.Post);l.setUpText(".jaddr-postcode","")}l.setUpText(".jaddr-Tel1",h.Tel1);l.setUpText(".jaddr-Tel2",h.Tel2);l.setUpText(".jaddr-Naisen",h.Naisen);l.setUpText(".jaddr-TelHand",h.TelHand);l.setUpText(".jaddr-TelFax",h.TelFax);l.setUpText(".jaddr-TelHome",h.TelHome);l.setUpText(".jaddr-TelOther",h.TelOther);var f=l.$mRootElement.find(".jaddr-gender").closest("li");if(h.gender=="m"){f.removeClass("none");l.$mRootElement.find(".jaddr-gender-m").show();l.$mRootElement.find(".jaddr-gender-f").hide()}else{if(h.gender=="f"){f.removeClass("none");l.$mRootElement.find(".jaddr-gender-m").hide();l.$mRootElement.find(".jaddr-gender-f").show()}else{f.addClass("none")}}var g=l.$mRootElement.find(".jaddr-birthday").closest("li");if(typeof(h.birthday)=="string"&&h.birthday.length>0){l.$mRootElement.find(".jaddr-birthday").html(desknets.dateTime.dispDateTime(h.birthday,"shortDateFormat"));g.removeClass("none")}else{g.addClass("none")}l.setUpText(".jaddr-zipcode",h.zipcode);l.setUpBody(".jaddr-address",h.address);l.$mRootElement.find(".co-listdsp.addr-mail").each(function(){var m=a(this);if(m.find("li").not(".none").length==0){m.closest(".co-infoggle").hide();m.closest(".co-page-info").hide()}else{m.closest(".co-infoggle").show();m.closest(".co-page-info").show()}});var e=l.$mRootElement.find(".addr-tel");desknets.sp.addr.setUpTelLink(e)},});desknets.sp.addr.init()})(jQuery);