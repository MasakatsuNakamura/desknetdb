/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
(function(a){desknets.sp.cal={init:function(){desknets.cal.tmpl.init()},getMonthText:function(d){var b=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];var c=d.getMonth();return b[c]},getWeekText:function(c,b){var d=c.getDay();return this.getWeekArray(d,b)},getWeekArray:function(d,c){var b=[];if(!c){b=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]}else{b=["SUNDAY","MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY","SATURDAY"]}return b[d]},getWeekStart:function(d){var b=d.getDay();if(b==0){b=7}var c=b-1;return neo.dateTime.moveDate(d,c*-1)}};desknets.sp.cal.settings={};a.extend(desknets.sp.cal.settings,desknets.cal.settings,{isSet:function(b){if(!this._settings[b]){return false}return true},initSetting:function(b){if(!desknets.sp.cal.settings.isSet(desknets.sp.sch.util.getPageParams("moduleId"))){this._initCalSetting(b)}else{if(a.isFunction(b)){b()}}},_initCalSetting:function(e){var b=this;var d={cmd:desknets.sp.sch.util.getPageParams("psetcmd")};var c={url:desknets.sp.sch.getRequestURL(),data:d,success:function(h,f,i){var g=desknets.cal.settings.of(desknets.sp.sch.util.getPageParams("moduleId"));a.each(desknets.sp.sch.util.getPageParams("settingKeys"),function(j,k){g[k]=h[k]});if(a.isFunction(e)){e()}}};desknets.sp.ajax.rest(c)},});a.extend(desknets.cal.tmpl,{getItemHtml:function(j,k){var b=a.extend({term:"",attrs:""},k);var e=this._itemTmpl;var c=!!b.term?b.term+" ":"";var d=!!b.termTip?b.termTip+" ":"";var i=!!b.noicon?b.noicon:false;var h="&nbsp;";var f=this.getIconsAsText(j);var g=j.getSubject();if(!f&&!g){g=j.event}if(!neo.isSet(g,{blank:false})&&!!i){g="--"}e=desknets.tmpl.replaceWordHtml(e,"term",c);e=desknets.tmpl.replaceWordHtml(e,"termTip",d);e=desknets.tmpl.replaceWordHtml(e,"attrs",this._getAttrs(j));e=desknets.tmpl.replaceWordHtml(e,"classes",this.getItemClasses(j));e=desknets.tmpl.replaceWord(e,"iconText",f);e=desknets.tmpl.replaceWord(e,"subject",g);if(!i){h=this.getIconsAsHtml(j)}e=desknets.tmpl.replaceWordHtml(e,"iconHtml",h);return e}});desknets.sp.cal.FullTimeList=function(b){this.init(b);return this};desknets.sp.cal._fullTimeListInst={$root:a(),maxIndex:0,_$body:a(),init:function(b){this.$root=b;this._$body=b.find(".cal-timebar-allday-body");this._initRange(b);this._executeOnChangeDate.push(function(){desknets.cal.selection.unselect(this)})},_initRange:function(b){this._$arrow=b.find(".cal-curtime");this._updateArrowVisibility();this._executeOnChangeDate=[this._updateArrowVisibility]},addItems:function(b){var e=[];for(var d=0;d<b.length;d++){var c=desknets.cal.tmpl.getItemHtml(b[d],{term:this._getDateTimeText(b[d])});e.push(c)}this._$body.html(e.join(""))}};desknets.sp.cal.FullTimeList.prototype=a.extend({},desknets.cal.FullTimeList.prototype,desknets.sp.cal._fullTimeListInst);desknets.sp.cal.TimeDaycal=function(b){this.init(b);return this};desknets.sp.cal._timeDaycalInst={selectStep:21,maxIndex:23,pixelPerUnit:60,_lines:desknets.cal.Lines.prototype,init:function(b){this.$root=b;this._lines=new desknets.cal.Lines();this._initRange(b);this._executeOnChangeDate.push(function(){desknets.cal.selection.unselect(this)})},_initRange:function(b){this._$arrow=b.find(".cal-curtime");this._updateArrowVisibility();this._executeOnChangeDate=[this._updateArrowVisibility]},};desknets.sp.cal.TimeDaycal.prototype=a.extend({},desknets.cal.TimeVertical.prototype,desknets.sp.cal._timeDaycalInst);desknets.sp.cal.DateWeekcal=function(d,c,b){this.init(d,c,b);return this};desknets.sp.cal._dateWeekCalInst={_boxHeight:50,_barHeight:0,maxIndex:6,maxItems:0,_dayFormat:"d {{w}}",_lines:desknets.cal.Lines.prototype,_overDays:[],_barsList:{days:[],length:[]},init:function(d,c,b){this.$root=d;this._lines=new desknets.cal.Lines();this._initDirection(d);this._initRange(d,c);this._executeOnChangeDate.push(this._beginToUpdateDateCells);this._executeOnChangeDate.push(this._reselectCell)},getItemHtml:function(d,b){var c=desknets.cal.tmpl.getItemHtml(d,{term:this._getDateTimeText(d)});return a('<div class="cal-item-box sch-bar" />').html(c)},_initRange:function(d,b){var c=desknets.cal.settings.of(!!b?b:"sch");this._showHoliday=c.holiday=="1";this._showHolidayName=c.holiday=="1";this._executeOnChangeDate=[];this._$dateCells=d.find(".cal-day")},_addCalendarItems:function(d){this._overDays=[];this._barsList.days=[];this._barsList.length=[];for(var e=0;e<d.length;e++){var c=this._getRange(d[e]);if(!!c){var b=this.getItemHtml(d[e],c);this._addItem(b,c,this._lines)}}this._setItemsToHtml(this.$root,this._lines);this._setItemsAddMore(this.$root,d)},_setItemsToHtml:function(g,b){var c=this;var e='<a class="cal-item-none" href="#">&nbsp;</a>';g.find(".cal-h-bars-data-inner").remove();g.find(".cal-item-box").remove();g.find(".cal-item-none").remove();g.find(".cal-item-morelist").remove();c._setBarsParts(g,b);c._setListParts(g,b);c._resetLists();b.clear();var f=g.find("div.cal-h-bars-data-inner").children();a.each(f,function(h,j){if(h>1){c._pushOverListBars(a(this));a(this).remove()}});var d=g.find(".cal-day");a.each(d,function(l,h){var k=a(this);var n=k.find(".cal-item-box");if(!n||n.length==0){return true}var j=k.offset().top;var m=n.filter(function(){return a(this).offset().top-j>=c._boxHeight});if(m&&m.length>0){m.remove()}});if(desknets.browser.android){g.find(".cal-day").filter(function(){return a(this).find(".cal-item-box").length==0}).find(".cal-h-list-data").append(e);g.find(".cal-padding-box").append(e)}},_pushOverListBars:function(g){var d=this;var f;var j=g.find(".cal-item").data("date");var c=a.inArray(j,d._barsList.days);if(c<0){return}d._overDays.push(j.toString());var h=d._barsList.length[c];for(f=1;f<h;f++){var e=neo.dateTime.parse(j);var b=neo.dateTime.moveDate(e,f);d._overDays.push(neo.dateTime.format("yyyyMMdd",b))}},_setItemsAddMore:function(e,c){var b=this;var d=e.find(".cal-day");a.each(d,function(j,f){var k=[];var h=a(this);var g=h.find('input[name="caldate"]').val();a.each(c,function(l,m){if(m.startdate<=g&&g<=m.enddate){k.push(m)}if(k.length>b.maxItems){return false}});if(k.length>b.maxItems||b._isOverBarItem(g)){h.find(".cal-h-list-data").append('<div class="cal-item-morelist"><div></div></div>')}})},_updateDateCell:function(h,e,g){var i=this._date.getTime();var d=new Date(i+e*86400000);var b=neo.dateTime.format("yyyyMMdd",d);var c=neo.dateTime.format(this._dayFormat,d);c=desknets.tmpl.replaceWordChk(c,"w",desknets.sp.cal.getWeekText(d));var f=this._getDateCellClasses(d,b,g);h.data("date",d);h.addClass(f);h.find(".cal-day-text").text(c);h.find('input[name="caldate"]').val(b)},_isOverBarItem:function(b){return a.inArray(b,this._overDays)>=0},_addItem:function(e,d,b){var c=this,f=e.children(".holiday").length>0;if(d.length>1||f){c._setPosition(e,d);b.addItem(e,d);c._barsList.days.push(e.find(".cal-item").data("date"));c._barsList.length.push(d.length)}else{if(d.start<c._numCols&&(c.maxItems==0||c._lists[d.start].length<c.maxItems)){c._lists[d.start]=c._lists[d.start].add(e)}}},_reselectCell:function(b){if(!!b){var c=(b.getTime()-this._date.getTime())/86400000;desknets.cal.selection.shiftSelection(this,c)}}};desknets.sp.cal.DateWeekcal.prototype=a.extend({},desknets.cal.DateHorizontal.prototype,desknets.sp.cal._dateWeekCalInst);desknets.sp.cal.DateMonthcalWeek=function(c,b){this.init(c,b);return this};desknets.sp.cal._dateMonthcalWeekInst={_barHeight:17,maxItems:2,headerHeight:0,_dayFormat:"d",_state:true,_dayHeight:34,getState:function(){return this._state},getItemHtml:function(d,b){var c=desknets.cal.tmpl.getItemHtml(d,{noicon:true});return a('<div class="cal-item-box sch-bar" />').html(c)},setStateAndDate:function(c,b){if(c){this._state=true;this.$root.show();this.setDate(b)}else{this._state=false;this.$root.hide()}},_setListParts:function(d,b){var c=this;d.find(".cal-h-list-data").each(function(e){var h=a(this);var i=c._lists[e];if(i&&i.length>0){var f=c._getTopPadding(e,b);if(f>0){if(f>c._dayHeight){f=c._dayHeight}var g=a('<div class="cal-item-box cal-padding-box" />');g.css("height",f+"px").appendTo(h)}if(f<c._dayHeight){h.append(i)}else{c._overDays.push(h.siblings('input[name="caldate"]').val())}}else{var f=c._getTopPadding(e,b);if(f>0){var g=a('<div class="cal-item-box cal-padding-box" />');g.css("height",c._dayHeight+"px").appendTo(h)}}})}};desknets.sp.cal.DateMonthcalWeek.prototype=a.extend({},desknets.sp.cal.DateWeekcal.prototype,desknets.cal._monthCalendarWeekInst,desknets.sp.cal._dateMonthcalWeekInst);desknets.sp.cal.DateMonthcal=function(c,b){this.init(c,b);return this};desknets.sp.cal._dateMonthcalInst={_weeks:[],_month:new Date(),_startTime:0,_module:"",_firstWeek:0,_$days:a(),init:function(d,b){var c=desknets.cal.settings.of(!!b?b:"sch");this.$root=d;this._weeks=[];this._module=b;this._firstWeek=Number(!!c.sunday?c.sunday:"0");this._$days=d.find("div").find(desknets.cal.SEL_DAY);this._initDateHeader(d);this._initDateCells(d);this.setDate(new Date())},setCalPerUnit:function(){var c=this;var b=c.$root.find(".cal-h-bars-data:first");var e=b.prev().outerWidth();var f=e/b.outerWidth()*100;for(var d=0;d<c._weeks.length;d++){c._weeks[d]._percentPerUnit=f}},_initDateHeader:function(c){var b=this;c.find("div.sch-pmonth-week>div").each(function(e){var f=a(this);var d=(e+b._firstWeek)%7;f.text(desknets.sp.cal.getWeekArray(d,false));if(d==0){f.addClass(desknets.cal.CLASS_SUNDAY)}else{if(d==6){f.addClass(desknets.cal.CLASS_SATURDAY)}}})},_initDateCells:function(c){var b=this;c.find(".cal-h-week").each(function(){b._weeks.push(new desknets.sp.cal.DateMonthcalWeek(a(this),b._module))})},set6WeekContents:function(b){for(var d=0;d<b.length;d++){var c=neo.dateTime.parse(b[d].id);this._setContentForDay(c,"6-weeksp",b[d].Name)}},};desknets.sp.cal.DateMonthcal.prototype=a.extend({},desknets.cal._monthCalendarInst,desknets.sp.cal._dateMonthcalInst);desknets.sp.cal.WeekCalDay=function(d,c,b){this.init(d,c,b);return this};desknets.sp.cal._weekCalDayInst={_numDays:1,maxItems:0,_showHoliday:false,$pLink:'<div class="sch-more"><a href="#" class="ui-link">&nbsp;</a></div>',init:function(e,d,c){var b=this;b.$root=e;b._lines=new desknets.cal.Lines();b._initDirection(e);if(c&&c.maxItems){b.maxItems=c.maxItems}b._initRange(e);b._executeOnChangeDate.push(b._beginToUpdateDateCells);b._executeOnChangeDate.push(b._reselectCell)},_initRange:function(c){var b=this;b._executeOnChangeDate=[];b._$dateCells=c},_setItemsToHtml:function(c,b){c.find(".cal-h-bars-data-inner").remove();c.find(".cal-item-box").remove();c.find(".sch-more").remove();this._setBarsParts(c,b);this._setListParts(c,b);this._resetLists();b.clear()},_setItemsAddMore:function(c,b){},_setBarsParts:function(d,b){var c=b.getElement();c.attr("class","cal-h-bars-data-inner");d.find(".cal-h-bars-data").empty().append(c)},_addItem:function(e,d,b){var c=this;if(c.maxItems!=0&&c._lists[d.start].length==c.maxItems){c._lists[d.start]=c._lists[d.start].add(c.$pLink)}else{if(c.maxItems==0||c._lists[d.start].length<c.maxItems){c._lists[d.start]=c._lists[d.start].add(e)}}},};desknets.sp.cal.WeekCalDay.prototype=a.extend({},desknets.sp.cal.DateWeekcal.prototype,desknets.sp.cal._weekCalDayInst);desknets.sp.cal.WeekCalender=function(c,b){this.init(c,b);return this};desknets.sp.cal._weekCalenderInst={_today:null,_module:"",_$days:a(),init:function(f,d,c){var b=this;var e=desknets.cal.settings.of(!!d?d:"sch");b.$root=f;b._days=[];b._module=d;b._today=new Date(c);b._$days=f.find("div").find(desknets.cal.SEL_DAY);b._initDateCells(f)},setDate:function(b){if(neo.isSet(this._days)){for(var c=0;c<this._days.length;c++){this._days[c].setDate(neo.dateTime.moveDate(b,c))}}},replaceItems:function(b){for(var c=0;c<this._days.length;c++){this._days[c].replaceItems(b)}},_initDateCells:function(c){var b=this;b._$days.each(function(){var d={maxItems:5};b._days.push(new desknets.sp.cal.WeekCalDay(a(this),b._module,d))})}};desknets.sp.cal.WeekCalender.prototype=desknets.sp.cal._weekCalenderInst;desknets.sp.cal.init()})(jQuery);