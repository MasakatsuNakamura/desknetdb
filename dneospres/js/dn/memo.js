/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
(function(a){desknets.memo={CMD_MEMORECEINDEX:"memoreceindex",CMD_MEMOSENDINDEX:"memosendindex",CMD_MEMORECEREFER:"memocmdreferreceive",CMD_MEMOSENDREFER:"memocmdrefersend",CMD_MEMOENTRY:"memocmdentry",CMD_MEMORECEDELETE:"memocmddelreceive",CMD_MEMOSENDDELETE:"memocmddelsend",CMD_MEMOTAGSET:"memocmdtag",CMD_MEMOWHEREREFER:"memowhererefer",CMD_MEMOWHEREENTRY:"memocmdwhereentry",VAL_MEMO_TAGDELCOLOR:"0",VAL_MEMO_TAGADDCOLOR:"3",};desknets.sp.memo={CMD_MEMOWSTATUS:"memowstatuslist",CMD_MEMOWCONTACTINFO:"memopsetcmdwcontactinfo",VAL_WMODEAUTO:"1",VAL_WMODEHAND:"2",init:function(){desknets.sp.mobjPages["top-page"]=desknets.sp.memo.TopPage;desknets.sp.mobjPages["wentry-page"]=desknets.sp.memo.WEntry;desknets.sp.mobjPages["recelist-page"]=desknets.sp.memo.ReceList;desknets.sp.mobjPages["sendlist-page"]=desknets.sp.memo.SendList;desknets.sp.mobjPages["ref-page"]=desknets.sp.memo.MRefer;desknets.sp.mobjPages["mentry-page"]=desknets.sp.memo.MEntry;desknets.sp.mobjPages["d-senddel-page"]=desknets.sp.memo.SendDel;desknets.sp.mobjPages["d-recedel-page"]=desknets.sp.memo.ReceDel;desknets.sp.mobjPages["d-reftag-page"]=desknets.sp.memo.RefTag;desknets.sp.mobjPages["d-reqsel-page"]=desknets.sp.memo.ReqSel;desknets.sp.mobjPages["usersel-page"]=desknets.sp.memo.MEntryUser;desknets.sp.mobjPages["profile-page"]=desknets.sp.UserProfile;desknets.sp.mobjPages["d-userdeselect-page"]=desknets.sp.UserDeselect;desknets.sp.mobjPages["neotwi-page"]=desknets.sp.Neotwi;var c=[];var b=desknets.sp.getPrm();if(neo.isSet(b.id)){c=["ref-page"]}desknets.sp.initSetEvents(c)},getRequestURL:function(){return desknets.sp.getUrl(desknets.MODULE_API_MAIN)},};desknets.page(desknets.sp.memo,"TopPage",desknets.sp.RefPage,{boEntry:false,wList:["event","place","contact"],_tmplOpts:{sameDateDisp:false,dateTimeDisp:true},initPage:function(){var b=this;b.callBase("initPage");b.$mRootElement.find(".jmemo-wentry").bind("vclick",function(d){d.preventDefault();desknets.sp.memo.WEntry.setPage("wId");desknets.sp.changePage("wentry")});b.$mRootElement.find("#memo-mode").change(function(d){b.boEntry=true;setTimeout(function(){b.replaceItems()},50)});var c=b.$mRootElement.find("ul.jmemo-listdef");c.bind("vclick",function(e){e.preventDefault();var d=a(e.target).closest("a").closest("li");b._changeMemoList(d.data("id"))})},_changeMemoList:function(c){var b=this;if(c=="0"){desknets.sp.memo.ReceList.invalidate();desknets.sp.changePage("recelist")}else{if(c=="1"){desknets.sp.memo.SendList.invalidate();desknets.sp.changePage("sendlist")}else{if(c=="2"){desknets.sp.memo.MEntry.setEntries({});desknets.sp.changePage("mentry")}}}},setUpReferItem:function(c){var b=this;if(b.boEntry){b._getWRefer(c[1])}else{b._getWRefer(c)}b.boEntry=false},_getWRefer:function(h){var c=this;var i;var b=[desknets.sp.memo.VAL_WMODEAUTO,desknets.sp.memo.VAL_WMODEHAND];var g=c.$mRootElement.find(".memo-wdisp");if(h.wmode==desknets.sp.memo.VAL_WMODEHAND){i="on";c.$mRootElement.find(".jmemo-hand").show();c.setUpText(".jmemo-wsts",h.where,"&nbsp;");c.setUpText(".jmemo-date",h.date,"&nbsp;")}else{if(h.wmode==desknets.sp.memo.VAL_WMODEAUTO){i="off";var f=[];var d="";c.$mRootElement.find(".jmemo-hand").hide();if(neo.isSet(h.list)){f=desknets.ajax.getItems(h.list.item)}if(f.length>0){var e=f[0];h.event=desknets.cal.getSubject(e.event,e.detail);h.place=desknets.cal.getSubject(e.place,e.other);d=desknets.cal.tmplList.getRowHtml("{{date}}",e,c._tmplOpts);h.memo=e.memo}c.$mRootElement.find(".jmemo-date").html(d)}}a.each(c.wList,function(j,k){c.setUpText(".jmemo-"+k,h[k],"&nbsp;")});c.setUpBody(".jmemo-memo",h.memo,"&nbsp;");if(a.inArray(h.wmode,b)<0){i="off"}c.$mRootElement.find("#memo-mode").val(i).selectmenu("refresh")},getReferRequestData:function(){var b=this;var c={};var g={cmd:desknets.memo.CMD_MEMOWHEREREFER};if(b.boEntry){var d={};var f=b.$mRootElement.find("#memo-mode").val();var e;if(f=="on"){e=desknets.sp.memo.VAL_WMODEHAND}else{e=desknets.sp.memo.VAL_WMODEAUTO}d["0"]={cmd:desknets.memo.CMD_MEMOWHEREENTRY,wmode:e};d["1"]=g;c=desknets.sp.ajax.arrayToMultiCmdData(d)}else{a.extend(c,g)}return c},getRequestOption:function(){var b={};if(this.boEntry){b.detectMultiError=true}return b},getReferRequestURL:function(){return desknets.sp.memo.getRequestURL()},});desknets.page(desknets.sp.memo,"WEntry",desknets.sp.EntryPage,{boInitEntry:true,getReferRequestURL:function(){return desknets.sp.memo.getRequestURL()},getReferRequestData:function(){var b={};var c={};c["0"]={cmd:desknets.memo.CMD_MEMOWHEREREFER};if(!!this.boInitEntry){c["1"]={cmd:desknets.sp.memo.CMD_MEMOWSTATUS};c["2"]={cmd:desknets.sp.memo.CMD_MEMOWCONTACTINFO}}b=desknets.sp.ajax.arrayToMultiCmdData(c);return b},getRequestOption:function(){return{detectMultiError:true}},setUpReferItem:function(c){var b=this;var d=c["0"];b.callBase("setUpReferItem",d);b.setUpStatusItem(c);b.setUpContactItem(c);if(!!b.boInitEntry){b.boInitEntry=false}},setUpReferItemFromEntries:function(){var b=this;b.$mRootElement.find('input[name="event"]').val(b.mobjEntries.event);b.$mRootElement.find('input[name="place"]').val(b.mobjEntries.place);b.$mRootElement.find('input[name="date"]').val(b.mobjEntries.date);b.$mRootElement.find(".jmemo-wmemo").val(b.mobjEntries.memo).keyup()},setUpStatusItem:function(d){var m=this;var b=d["0"];var f=d["1"];var g=m.$mRootElement.find('select[name="where"]');if(neo.isSet(f)){var c=[];var k=null;var i="";var e=desknets.ajax.getJsonItems(f);if(e.length>0){for(var j=0;j<e.length;j++){k=e[j];i='<option value="'+k.id+'">'+desknets.tmpl.escapeWord(k.Name)+"</option>";c[c.length]=i}g.append(a(c.join(""))).enhanceWithin()}}if(neo.isSet(b.where,{blank:false})){var l=desknets.escape(b.where);l=desknets.escapeSpace(l);var h=g.find("option").filter(function(){return a(this).html()==l});if(h.length>0){g.val(h.val())}}else{g.val("--")}g.selectmenu("refresh")},setUpContactItem:function(e){var c=this;var d=e["0"];var b=e["2"];var g=c.$mRootElement.find("select#memo-tel");if(neo.isSet(b)){var f={"1":"Tel1","2":"Naisen","3":"TelHand"};g.find("option:not(.jmemo-notel)").each(function(j,k){var h=a(this);h.text(h.text()+b[f[h.val()]])})}g.val(d.contactflg).selectmenu("refresh")},getEntriesFromReferItem:function(){var b=this;var c={};c.cmd=desknets.memo.CMD_MEMOWHEREENTRY;c.wmode=desknets.sp.memo.VAL_WMODEHAND;c.event=b.$mRootElement.find('input[name="event"]').val();c.place=b.$mRootElement.find('input[name="place"]').val();c.date=b.$mRootElement.find('input[name="date"]').val();c.memo=b.$mRootElement.find(".jmemo-wmemo").val();c.contactflg=b.$mRootElement.find('select[name="contactflg"]').val();var d="";if(c.where!="--"){d=b.$mRootElement.find('select[name="where"]').val()}c.where=d;c.contact="";return c},completeToSendEntries:function(){var b=this;desknets.sp.memo.TopPage.invalidate();b.callBase("completeToSendEntries")}});desknets.page(desknets.sp.memo,"ReceList",desknets.sp.ListSetPage,{init:function(c){var b=this;b.callBase("init",c);b.initMemoPage()},initMemoPage:function(){var b=this;b.$mRootElement.find(".jmemo-listdel").on("vclick",function(e){e.preventDefault();var f=a(this).data("pid");var c=desknets.sp.mobjPages["d-"+f+"del-page"];var d=b.getChkId(true);if(d!==false){c.setPage(d,true);desknets.sp.changePage("d-"+f+"del")}});b.$mRootElement.find(".jmemo-backtop").on("vclick",function(c){c.preventDefault();desknets.sp.memo.TopPage.invalidate();desknets.sp.changePage("top",{reverse:true})});b.$mRootElement.find(".jmemo-changelist").on("vclick",function(d){d.preventDefault();var e=a(this).data("pid");var c=desknets.sp.mobjPages[e+"list-page"];c.invalidate();desknets.sp.changePage(e+"list",{transition:"fade"})});b.$mRootElement.find(".memo-nav-new").on("vclick",function(c){c.preventDefault();desknets.sp.memo.MEntry.setEntries({});desknets.sp.changePage("mentry")})},getListRequestURL:function(){return desknets.sp.memo.getRequestURL()},getListRequestData:function(b,c){return{cmd:desknets.memo.CMD_MEMORECEINDEX,cnd:"0",row:b,num:c}},setUpListItem:function(d,c){var b=this;this.callBase("setUpListItem",d,c);c.find("h3").html(desknets.tmpl.escapeWord(d.request));c.find("span.jmemo-whom").html(desknets.tmpl.escapeWord(d.whom));c.find("p.jmemo-time").html(desknets.dateTime.dispDateTime(d.updtime,{type:"list"}));c.find("input[type=checkbox]").attr("id",b.getListID()+d.id);c.find("label").attr("for",b.getListID()+d.id);if(d.readed&&d.readed!="1"){c.addClass("new")}},getListID:function(){return"memo-chk-list-"},openListItem:function(c,d){var b=this;c.removeClass("new");desknets.sp.memo.MRefer.setMRefPage(d,false);desknets.sp.changePage("ref")},});desknets.page(desknets.sp.memo,"SendList",desknets.sp.memo.ReceList,{getListRequestData:function(b,c){return{cmd:desknets.memo.CMD_MEMOSENDINDEX,row:b,num:c}},getListID:function(){return"memo-chk-sendlist-"},openListItem:function(c,d){var b=this;if(b.mboSet){}else{desknets.sp.memo.MRefer.setMRefPage(d,true);desknets.sp.changePage("ref")}}});desknets.page(desknets.sp.memo,"MRefer",desknets.sp.RefPage,{msTag:"0",boSend:false,initPage:function(){var b=this;b.callBase("initPage");if(!neo.isSet(b.msId,{blank:false})){var c=desknets.sp.getPrm();if(neo.isSet(c.id)){desknets.sp.memo.MRefer.setPage(c.id)}else{desknets.sp.resetPage()}}b.$mRootElement.find(".jmemo-mod").bind("vclick",function(d){d.preventDefault();desknets.sp.memo.MEntry.setPage(b.msId);desknets.sp.changePage("mentry")});b.$mRootElement.find(".jmemo-del").bind("vclick",function(d){d.preventDefault();if(b.boSend){desknets.sp.memo.SendDel.setPage(b.msId);desknets.sp.changePage("d-senddel",{changeHash:false})}else{desknets.sp.memo.ReceDel.setPage(b.msId);desknets.sp.changePage("d-recedel",{changeHash:false})}});b.$mRootElement.find(".jmemo-tag").bind("vclick",function(d){d.preventDefault();desknets.sp.memo.RefTag.setPage(b.msId,b.msTag);desknets.sp.changePage("d-reftag")})},setMRefPage:function(d,c){var b=this;if(neo.isSet(c)&&c==true){b.boSend=true}else{b.boSend=false}b.callBase("setPage",d)},showing:function(){var b=this;b.callBase("showing");if(b.boSend==true){b.$mRootElement.find(".jmemo-send").show();b.$mRootElement.find(".jmemo-rece").hide()}else{b.$mRootElement.find(".jmemo-send").hide();b.$mRootElement.find(".jmemo-rece").show()}},getReferRequestURL:function(){return desknets.sp.memo.getRequestURL()},getReferRequestData:function(){var b=this;var d;if(b.boSend==true){d=desknets.memo.CMD_MEMOSENDREFER}else{d=desknets.memo.CMD_MEMORECEREFER}var c={cmd:d,id:b.msId,};return c},setUpReferItem:function(d){var c=this;c.msTag=d.tagcolor;c.setUpText(".jmemo-whom",d.whom,"&nbsp;");c.setUpText(".jmemo-request",d.request,"&nbsp;");c.setUpText(".jmemo-Tel",d.Tel,"&nbsp;");c.setUpText(".jmemo-entry",d.entry,"&nbsp;");c.$mRootElement.find(".jmemo-otherto").html(desknets.tmpl.dispItems(d.othertolist,d.readlist));c.setUpBody(".jmemo-memo",d.memo,"&nbsp;");c.$mRootElement.find(".jmemo-updtime").html(desknets.dateTime.dispDateTime(d.updtime,"dateTimeFormat"));var b={convertMail:false,convertPhone:true,convertPhoneOnly:false,convertURL:false,};c.$mRootElement.find(".jmemo-memo").detectHref(b);var e={convertMail:false,convertPhone:false,convertPhoneOnly:true,convertURL:false,};c.$mRootElement.find(".jmemo-Tel").detectHref(e)}});desknets.page(desknets.sp.memo,"MEntry",desknets.sp.EntryPage,{init:function(c){var b=this;b.callBase("init",c);b.$mRootElement.find(".jmemo-entry-user").on("vclick",function(d){d.preventDefault();desknets.sp.memo.MEntryUser.invalidate();desknets.sp.changePage("usersel")});b.$mRootElement.find(".jmemo-req-sel").on("vclick",function(d){d.preventDefault();if(!!b.boInitReq){desknets.sp.memo.ReqSel.setInitSel();b.boInitReq=false}desknets.sp.changePage("d-reqsel")})},getReferRequestURL:function(){return desknets.sp.memo.getRequestURL()},getReferRequestData:function(){var b={cmd:desknets.memo.CMD_MEMOSENDREFER,id:this.msId};return b},setUpReferItemFromEntries:function(){var b=this;if(neo.isSet(b.mobjEntries.othertolist)){b.setSelUsers(desknets.ajax.getItems(b.mobjEntries.othertolist.item))}b.$mRootElement.find('input[name="whom"]').val(b.mobjEntries.whom);b.$mRootElement.find('input[name="request"]').val(b.mobjEntries.request);b.$mRootElement.find('input[name="Tel"]').val(b.mobjEntries.Tel);b.$mRootElement.find(".jmemo-memo").val(b.mobjEntries.memo).keyup()},getEntriesFromReferItem:function(){var d=this;var c=[];var e={};e.cmd=desknets.memo.CMD_MEMOENTRY;e.whom=d.$mRootElement.find('input[name="whom"]').val();e.reqdetail=d.$mRootElement.find('input[name="request"]').val();e.Tel=d.$mRootElement.find('input[name="Tel"]').val();e.memo=d.$mRootElement.find(".jmemo-memo").val();e.reqid="";var b=d.$mRootElement.find('input[name="otherto"]');b.each(function(){c[c.length]=a(this).val()});e.otherto=c;if(!!d.msId&&d.msId!==""){e.id=d.msId}return e},getSendRequestOption:function(){var b=this;var c={};c.success=function(e,d,f){b.execAfterajaxStop();if(e.noticeerror){desknets.sp.memo.ReceList.invalidate();desknets.sp.memo.SendList.invalidate();desknets.sp.memo.MRefer.invalidate();desknets.sp.msg.view(0,e.noticeerror,true)}else{b.completeToSendEntries()}};return c},completeToSendEntries:function(){var b=this;desknets.sp.memo.ReceList.invalidate();desknets.sp.memo.SendList.invalidate();desknets.sp.memo.MRefer.invalidate();b.callBase("completeToSendEntries")},setEntries:function(b){var c=this;c.callBase("setEntries",b);c.boInitReq=true},setRequestString:function(b){var c=this;c.$mRootElement.find('input[name="request"]').val(b)}});desknets.page(desknets.sp.memo,"ReceDel",desknets.sp.DelPage,{mPageId:"rece",delCloseId:function(){return"ref"},setInvalidate:function(){desknets.sp.mobjPages[this.mPageId+"list-page"].invalidate()},getEntriesFromReferItem:function(){var b=this;var c=b.callBase("getEntriesFromReferItem");c.cmd=b.getMemoDelCmd();return c},getSubmitRequestURL:function(){return desknets.sp.memo.getRequestURL()},getMemoDelCmd:function(){return desknets.memo.CMD_MEMORECEDELETE}});desknets.page(desknets.sp.memo,"SendDel",desknets.sp.memo.ReceDel,{mPageId:"send",getMemoDelCmd:function(){return desknets.memo.CMD_MEMOSENDDELETE}});desknets.page(desknets.sp.memo,"RefTag",desknets.sp.TagPage,{mTagColor:"0",init:function(c){var b=this;b.callBase("init",c);b.$mRootElement.find(".jmemo-tagok").bind("vclick",function(d){d.preventDefault();b.mTagColor=a(this).data("tcolor");b.sendEntries()})},showingPage:function(){var b=this;if(b.mboTagSet){b.mboTagSet=false;if(b.msTag==""){b.msTag=desknets.memo.VAL_MEMO_TAGDELCOLOR}if(b.msTag==desknets.memo.VAL_MEMO_TAGADDCOLOR){b.$mRootElement.find(".jmemo-tagset").hide();b.$mRootElement.find(".jmemo-tagdel").show()}else{b.$mRootElement.find(".jmemo-tagdel").hide();b.$mRootElement.find(".jmemo-tagset").show()}}},setInvalidate:function(){var b=this;desknets.sp.memo.ReceList.invalidate()},getEntriesFromReferItem:function(){var b=this;var c={};c.id=b.msId;c.tagcolor=b.mTagColor;c.cmd=desknets.memo.CMD_MEMOTAGSET;return c},getSubmitRequestURL:function(){return desknets.sp.memo.getRequestURL()},completeToSendEntries:function(){var b=this;b.completeTag(b.mTagColor);b.$mRootElement.dialog("close")},completeTag:function(c){var b=this;desknets.sp.memo.MRefer.msTag=c}});desknets.page(desknets.sp.memo,"ReqSel",desknets.sp.ComPage,{init:function(c){var b=this;b.callBase("init",c);b.initPage()},initPage:function(){var b=this;b.$mRootElement.find(".jco-ok").on("vclick",function(c){c.preventDefault();var d=b.$mRootElement.find('select[name="request"] option:selected').val();if(d=="--"){d=""}desknets.sp.memo.MEntry.setRequestString(d);history.back()})},setInitSel:function(){var b=this;if(b.$mRootElement){var c=b.$mRootElement.find('select[name="request"]');c.val("--").selectmenu("refresh")}}});desknets.page(desknets.sp.memo,"MEntryUser",desknets.sp.UserSelPage,{openMultiItems:function(c){var b=this;if(c.length>0){desknets.sp.memo.MEntry.setSelUsers(c,"otherto")}history.back()}});desknets.sp.memo.init()})(jQuery);