/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
(function(a){desknets.sp.portal={MODULE_API_CREPORT:"zrcreport",MODULE_API_INFO:"zrinfo",MODULE_API_FLOW:"zrflow",CMD_SCH:"schprivate",CMD_TODO:"todocmdlistsearch",CMD_MEMO:"memoreceindex",CMD_CREPORT:"creportcmdindex",CMD_INFO:"infocmdindex",CMD_FLOW:"flowcmdindex",PAGE_SCH:"sch",PAGE_TODO:"todoindex",PAGE_MEMO:"memoindex",PAGE_CREPORT:"creportindex",PAGE_INFO:"infoindex",NUM_MAXCNT:5,init:function(){desknets.sp.mobjPages["portal-page"]=desknets.sp.portal.PortalPage;desknets.sp.mobjPages["neotwi-page"]=desknets.sp.Neotwi;desknets.cal.tmpl.init();desknets.sp.initSetEvents()},};desknets.page(desknets.sp.portal,"PortalPage",desknets.sp.ComPage,{$mTmplSch:null,$mTmplToDo:null,$mTmplMemo:null,$mTmplFlow:null,$mTmplCreport:null,$mTmplCreportDay:"",$mTmplInfo:null,$mNoSch:null,$mNoToDo:null,$mNoMemo:null,$mNoFlow:null,$mNoCreport:null,$mNoInfo:null,$mTitleSch:null,$mTitleToDo:null,$mTitleMemo:null,$mTitleFlow:null,$mTitleCreport:null,$mTitleInfo:null,arMenu:["sch","plant","todo","mail","mailimap","memo","flow","creport","info","addr","memp","cab","safety","setting"],arTopView:[],mViewEnd:"0",init:function(c){var b=this;b.callBase("init",c);b.getTmpl();b.setClick();b.makePage();b.$mRootElement.find(".jportal-reload").bind("vclick",function(d){location.reload()});b.$mRootElement.find(".jco-logout").bind("vclick",function(d){d.preventDefault();desknets.sp.logout()});b.$mRootElement.delegate(".jtopmenu-sch-def","vclick",function(e){e.preventDefault();var d=a(this).attr("href");d=d+b.getSchDefPage();desknets.sp.execLocation(d)});a(document).bind("ajaxStart",function(){b.execBeforAjaxStart()});a(document).bind("ajaxStop",function(){b.pageViewEnd()});a(window).on("pageshow",function(){if(b.mViewEnd=="1"){location.reload()}});a(window).on("pagehide",function(){if(a("#neotwi-page").css("display")=="block"){b.mViewEnd="2"}else{if(b.mViewEnd=="2"){b.mViewEnd="0"}else{b.mViewEnd="1"}}})},clearItems:function(){var b=this},replaceItems:function(){var c=this;c.pageViewEnd();var b=c.arTopView.length;for(var d=0;d<b;d++){if(c.arTopView[d]=="sch"){c.getSch()}else{if(c.arTopView[d]=="todo"){c.getToDo()}else{if(c.arTopView[d]=="memo"){c.getMemo()}else{if(c.arTopView[d]=="flow"){c.getFlow()}else{if(c.arTopView[d]=="creport"){c.getCreport()}else{if(c.arTopView[d]=="info"){c.getInfo()}}}}}}}},getTmpl:function(){var b=this;b.$mTmplSch=b.$mRootElement.find(".jtopmenu-sch.tmpl").removeClass("tmpl").remove();b.$mTmplToDo=b.$mRootElement.find(".jtopmenu-todo.tmpl").removeClass("tmpl").remove();b.$mTmplMemo=b.$mRootElement.find(".jtopmenu-memo.tmpl").removeClass("tmpl").remove();b.$mTmplFlow=b.$mRootElement.find(".jtopmenu-flow.tmpl").removeClass("tmpl").remove();b.$mTmplCreport=b.$mRootElement.find(".jtopmenu-creport.tmpl").removeClass("tmpl").remove();b.$mTmplInfo=b.$mRootElement.find(".jtopmenu-info.tmpl").removeClass("tmpl").remove();b.$mNoSch=b.$mRootElement.find(".jtopmenu-sch.nodata").removeClass("nodata").remove();b.$mNoToDo=b.$mRootElement.find(".jtopmenu-todo.nodata").removeClass("nodata").remove();b.$mNoMemo=b.$mRootElement.find(".jtopmenu-memo.nodata").removeClass("nodata").remove();b.$mNoFlow=b.$mRootElement.find(".jtopmenu-flow.nodata").removeClass("nodata").remove();b.$mNoCreport=b.$mRootElement.find(".jtopmenu-creport.nodata").removeClass("nodata").remove();b.$mNoInfo=b.$mRootElement.find(".jtopmenu-info.nodata").removeClass("nodata").remove();b.$mTitleSch=b.$mRootElement.find(".jtopmenu-sch.title").removeClass("title").remove();b.$mTitleToDo=b.$mRootElement.find(".jtopmenu-todo.title").removeClass("title").remove();b.$mTitleMemo=b.$mRootElement.find(".jtopmenu-memo.title").removeClass("title").remove();b.$mTitleFlow=b.$mRootElement.find(".jtopmenu-flow.title").removeClass("title").remove();b.$mTitleCreport=b.$mRootElement.find(".jtopmenu-creport.title").removeClass("title").remove();b.$mTitleInfo=b.$mRootElement.find(".jtopmenu-info.title").removeClass("title").remove();b.mTmplCreportDay=b.$mTmplCreport.find(".jtopmenu-creportfrom").html();b.$mTmplCreport.find(".jtopmenu-creportfrom").html("")},setClick:function(){var c=this;var b=c.$mRootElement.find(".topmenu-listview");b.delegate("li.data","vclick",function(e){e.preventDefault();var f=a(this);var d=f.find("a").attr("href");d=d+"&id="+f.data("id");d=d+"#"+f.data("pageid");desknets.sp.execLocation(d)})},makePage:function(){var j=this;var c=j.$mRootElement.find(".topmenu-menu");var d=j.$mRootElement.find(".topmenu-listview");var i=0;var h=0;var f="";var e=j.arMenu.length;h=1;for(i=0;i<e;i++){if(h>5){h=1}if(h==1){f="a"}else{if(h==2){f="b"}else{if(h==3){f="c"}else{if(h==4){f="d"}else{if(h==5){f="e"}}}}}var b=j.arMenu[i];if(b!="setting"&&!desknets.sp.menu.boView(b)){continue}h++;if(j.chkViewTop(b)){j.arTopView[j.arTopView.length]=b;if(b=="sch"){d.append(j.$mTitleSch)}else{if(b=="todo"){d.append(j.$mTitleToDo)}else{if(b=="memo"){d.append(j.$mTitleMemo)}else{if(b=="flow"){d.append(j.$mTitleFlow)}else{if(b=="creport"){d.append(j.$mTitleCreport)}else{if(b=="info"){d.append(j.$mTitleInfo)}}}}}}}var g=j.$mRootElement.find(".topmenu-link-"+b).removeClass("topmenu-link-"+b);g.addClass("ui-block-"+f);if(b=="sch"){g.find("a").addClass("jtopmenu-sch-def")}g.appendTo(c)}},chkViewTop:function(f){var b=this;var d=["sch","todo","memo","flow","creport","info"];if(a.inArray(f,d)<0){return false}var c=neo.storage.local(desknets.sp.COOKIENAME_SETTING);var e="spmenu_"+f;if(neo.isSet(c)&&neo.isSet(c[e])&&c[e]=="off"){return false}return true},getSchDefPage:function(){var b=this;var d="";var c=neo.storage.local(desknets.sp.COOKIENAME_SETTING);if(neo.isSet(c)&&neo.isSet(c.schToppage)){if(c.schToppage=="schday"){d="#day-page"}else{if(c.schToppage=="schweek"){d="#week-page"}else{if(c.schToppage=="schmonth"){d="#month-page"}else{if(c.schToppage=="schyear"){d="#year-page"}}}}}return d},getSch:function(){var b=this;var c={cmd:desknets.sp.portal.CMD_SCH,proc:"d",date:neo.dateTime.format("yyyyMMdd",desknets.dateTime.current),num:desknets.sp.portal.NUM_MAXCNT};var d={url:desknets.sp.getUrl(desknets.MODULE_API_MAIN),data:c,success:function(f,e,g){b.setSch(f)},};desknets.sp.ajax.rest(d)},setSch:function(f){var m=this;var i=desknets.cal.tmplList.getJsonItems(f);var d=i.length;if(d>0){for(var k=0;k<d;k++){var c=neo.dateTime.format("yyyyMMdd",desknets.dateTime.current);if(i[k]["startdate"]==i[k]["enddate"]&&!!i[k]["starttime"]&&!!i[k]["endtime"]&&i[k]["starttime"]>i[k]["endtime"]){i[k]["enddate"]=desknets.dateTime.moveDate(i[k]["enddate"],1)}if(i[k]["startdate"]>c||i[k]["enddate"]<c){continue}var h=m.$mTmplSch.clone();var j=desknets.cal.getSubject(i[k]["event"],i[k]["detail"]);if(j==""){j="--"}h.find("h3").html(desknets.tmpl.escapeWord(j));h.data("id",i[k]["sid"]);h.data("pageid","schref-page");var e="";if(i[k]["startdate"]!=i[k]["enddate"]){e=desknets.dateTime.dispDateTime(i[k]["startdate"]+i[k]["starttime"],{type:"list"})+" - "+desknets.dateTime.dispDateTime(i[k]["enddate"]+i[k]["endtime"],{type:"list"})}else{e=desknets.dateTime.dispDateTime(i[k]["startdate"]+i[k]["starttime"],{type:"list"});if(i[k]["endtime"]!=""){var l=neo.dateTime.parse(i[k]["enddate"]+i[k]["endtime"]);e=e+" - "+neo.dateTime.format("HH:mm",l)}}h.find(".co-li-time").html(e);var g="{{iconHtml}}";g=desknets.tmpl.replaceWordHtml(g,"iconHtml",desknets.cal.tmpl.getIconsAsHtml(i[k]));h.find(".jtopmenu-schicon").html(g);h.find("img").attr("align","absmiddle");h.insertAfter(m.$mRootElement.find(".jtopmenu-sch:last"))}}else{var b=m.$mNoSch.clone();b.insertAfter(m.$mRootElement.find(".jtopmenu-sch:last"))}},getToDo:function(){var b=this;var c={cmd:desknets.sp.portal.CMD_TODO,srch_limdate_e:neo.dateTime.format("yyyyMMdd",desknets.dateTime.current),complete:"0",num:desknets.sp.portal.NUM_MAXCNT};var d={url:desknets.sp.getUrl(desknets.MODULE_API_MAIN),data:c,success:function(f,e,g){b.setToDo(f)},};desknets.sp.ajax.rest(d)},setToDo:function(h){var d=this;var i=desknets.sp.ajax.getJsonItems(h);var c=i.length;if(c>0){for(var e=0;e<c;e++){var b=d.$mTmplToDo.clone();b.find("h3").html(desknets.tmpl.escapeWord(i[e]["memo"]));b.data("id",i[e]["id"]);b.data("pageid","todoref-page");b.find(".jtopmenu-todolabel").html(desknets.tmpl.escapeWord(i[e]["labelname"]));var f="";if(neo.isSet(i[e]["limdate"],{blank:false})){f=desknets.Resource.kara+"&nbsp;"}b.find(".co-li-time").html(f+desknets.dateTime.dispDateTime(i[e]["limdate"]+i[e]["limtime"],{type:"list"}));b.insertAfter(d.$mRootElement.find(".jtopmenu-todo:last"))}}else{var g=d.$mNoToDo.clone();g.insertAfter(d.$mRootElement.find(".jtopmenu-todo:last"))}},getMemo:function(){var b=this;var c={cmd:desknets.sp.portal.CMD_MEMO,num:desknets.sp.portal.NUM_MAXCNT,cnd:"1"};var d={url:desknets.sp.getUrl(desknets.MODULE_API_MAIN),data:c,success:function(f,e,g){b.setMemo(f)},};desknets.sp.ajax.rest(d)},setMemo:function(g){var d=this;var h=desknets.sp.ajax.getJsonItems(g);var c=h.length;if(c>0){for(var e=0;e<c;e++){var b=d.$mTmplMemo.clone();b.find("h3").html(desknets.tmpl.escapeWord(h[e]["request"]));b.data("id",h[e]["id"]);b.data("pageid","ref-page");b.find(".jtopmenu-memowhom").html(desknets.tmpl.escapeWord(h[e]["whom"]));b.find(".co-li-time").html(desknets.dateTime.dispDateTime(h[e]["updtime"],{type:"list"}));b.insertAfter(d.$mRootElement.find(".jtopmenu-memo:last"))}}else{var f=d.$mNoMemo.clone();f.insertAfter(d.$mRootElement.find(".jtopmenu-memo:last"))}},getFlow:function(){var b=this;var c={cmd:desknets.sp.portal.CMD_FLOW,num:desknets.sp.portal.NUM_MAXCNT,stsid:"0"};var d={url:desknets.sp.getUrl(desknets.sp.portal.MODULE_API_FLOW),data:c,success:function(f,e,g){b.setFlow(f)},};desknets.sp.ajax.rest(d)},setFlow:function(g){var d=this;var h=desknets.sp.ajax.getJsonItems(g);var c=h.length;if(c>0){for(var e=0;e<c;e++){var b=d.$mTmplFlow.clone();if(h[e]["importance"]=="1"){b.find(".co-importance.high").remove();b.find(".co-importance.low").remove()}else{if(h[e]["importance"]=="2"){b.find(".co-importance.haste").remove();b.find(".co-importance.low").remove()}else{if(h[e]["importance"]=="4"){b.find(".co-importance.haste").remove();b.find(".co-importance.high").remove()}else{b.find(".co-importance").remove()}}}b.find("h3").html(desknets.tmpl.escapeWord(h[e]["Name"]));b.find(".jflow-user").html(desknets.tmpl.escapeWord(h[e]["applicant"]));b.data("pageid","flowref-page");b.data("id",h[e]["id"]);b.insertAfter(d.$mRootElement.find(".jtopmenu-flow:last"))}}else{var f=d.$mNoFlow.clone();f.insertAfter(d.$mRootElement.find(".jtopmenu-flow:last"))}},getCreport:function(){var b=this;var c={cmd:desknets.sp.portal.CMD_CREPORT,num:desknets.sp.portal.NUM_MAXCNT,folder:"-1"};var d={url:desknets.sp.getUrl(desknets.sp.portal.MODULE_API_CREPORT),data:c,success:function(f,e,g){b.setCreport(f)},};desknets.sp.ajax.rest(d)},setCreport:function(d){var l=this;var j=desknets.sp.ajax.getJsonItems(d);var c=j.length;if(c>0){for(var k=0;k<c;k++){var g=l.$mTmplCreport.clone();g.find("h3").html(desknets.tmpl.escapeWord(j[k]["subject"]));g.data("id",j[k]["id"]);g.data("pageid","creportref-page");g.find(".jtopmenu-creportfrom").html(desknets.tmpl.escapeWord(j[k]["fromname"]));var f="";var h=j[k]["perioddays"];var e=j[k]["periodalert"]=="1";if(!neo.isSet(h,{blank:false})){}else{if(h=="0"){f+=" ";if(e){f+='<span class="creport-closedate-alert">'}f+="("+desknets.Resource.creport.byToday+")";if(e){f+="</span>"}}else{f+=" ";if(e){f+='<span class="creport-closedate-alert">'}f+="("+h+desknets.Resource.creport.daySymbol+")";if(e){f+="</span>"}}}var i="";if(neo.isSet(j[k]["period"],{blank:false})){i=desknets.Resource.kara+"&nbsp;"}g.find(".co-li-time").html(i+desknets.dateTime.dispDateTime(j[k]["period"],{type:"list"})+f);g.insertAfter(l.$mRootElement.find(".jtopmenu-creport:last"))}}else{var b=l.$mNoCreport.clone();b.insertAfter(l.$mRootElement.find(".jtopmenu-creport:last"))}},getInfo:function(){var b=this;var c={cmd:desknets.sp.portal.CMD_INFO,num:desknets.sp.portal.NUM_MAXCNT,status:"1"};var d={url:desknets.sp.getUrl(desknets.sp.portal.MODULE_API_INFO),data:c,success:function(f,e,g){b.setInfo(f)},};desknets.sp.ajax.rest(d)},setInfo:function(h){var d=this;var i=desknets.sp.ajax.getJsonItems(h);var c=i.length;if(c>0){for(var e=0;e<c;e++){var b=d.$mTmplInfo.clone();if(i[e]["priority"]=="1"){b.find(".co-importance.high").remove();b.find(".co-importance.low").remove()}else{if(i[e]["priority"]=="2"){b.find(".co-importance.haste").remove();b.find(".co-importance.low").remove()}else{if(i[e]["priority"]=="4"){b.find(".co-importance.haste").remove();b.find(".co-importance.high").remove()}else{b.find(".co-importance").remove()}}}b.find("h3").append(desknets.tmpl.escapeWord(i[e]["subject"]));b.data("id",i[e]["id"]);b.data("pageid","inforef-page");b.find(".jtopmenu-infoentry").html(desknets.tmpl.escapeWord(i[e]["entryname"]));var f="";if(neo.isSet(i[e]["startdate"],{blank:false})){f="&nbsp;"+desknets.Resource.kara}b.find(".co-li-time").html(desknets.dateTime.dispDateTime(i[e]["startdate"],{type:"list"})+f);b.insertAfter(d.$mRootElement.find(".jtopmenu-info:last"))}}else{var g=d.$mNoInfo.clone();g.insertAfter(d.$mRootElement.find(".jtopmenu-info:last"))}},});desknets.sp.portal.init()})(jQuery);