/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
$.ui.plugin.add("resizable","alsoResize",{start:function(){var a=$(this).data("resizable"),b=a.options;$(b.alsoResize).each(function(){var c=$(this);c.data("ui-resizable-alsoresize",{width:parseInt(c.width(),10),height:parseInt(c.height(),10),left:parseInt(c.css("left"),10),top:parseInt(c.css("top"),10)})})},resize:function(b,d){var a=$(this).data("resizable"),e=a.options,c=a.originalSize,g=a.originalPosition,f={height:(a.size.height-c.height)||0,width:(a.size.width-c.width)||0,top:(a.position.top-g.top)||0,left:(a.position.left-g.left)||0};$(e.alsoResize).each(function(){var j=$(this),k=$(this).data("ui-resizable-alsoresize"),i={},h=j.parents(d.originalElement[0]).length?["width","height"]:["width","height","top","left"];$.each(h,function(l,n){var m=(k[n]||0)+(f[n]||0);if(m&&m>=0){i[n]=m||null}});j.css(i)})},stop:function(){$(this).removeData("ui-resizable-alsoresize")}});var NeoEditor={};(function(b,c,a){NeoEditor={init:function(){var d=this;d.NEOEDITOR_MAX_HISTORY_COUNT=20;d.NEOEDITOR_MAX_HISTORY_BYTE=1*1024*1024;d.NEOEDITOR_MAX_IMAGE_PX=100000;d.NEOEDITOR_MAX_EDIT_OBJECT=10;b.fn.hasScrollBar=function(){return this.get(0).scrollHeight>this.height()};if(typeof Object.keys==="undefined"){Object.keys=function(e){return b.map(e,function(g,f){return f})}}d.NEOEDITOR_LTE_IE9=document.uniqueID&&typeof window.matchMedia=="undefined";d.NEOEDITOR_RANGE_CHANGE="input change";d.NEOEDITOR_RANGE_CHANGE_MOD="input.mod change.mod";if(d.NEOEDITOR_LTE_IE9){d.NEOEDITOR_RANGE_CHANGE="keyup.ie9";d.NEOEDITOR_RANGE_CHANGE_MOD="keyup.ie9.mod"}d.grobalEditActive=false;d.grobalInterval;d.grobalTimeout;d.grobalBeforeCanvas},createEditor:function(o){var n=this;var i=o.dialog;var m=o.url;var g=o.lang;var k=i.find("canvas")[0];if(!k||!m){return null}n.setEvent(i);i.find(".jsIedCpicker").each(n.setColorPicler);i.find(".jsIedSelect").each(n.setSelect);i.find(".jsIedImageSelect").each(n.setImageSelect);var h=new fabric.Canvas(k);if(h.getContext){var f=h.getContext("2d")}var e=n.getInstance({$dialog:i,imageUrl:m,lang:g,canvas:h});e.resetCanvas(true);var d=i.find(".ied-edit-menu").on("click","a",function(p){p.preventDefault();if(!b(this).is(".off")){b(this).trigger("iedClickMenu")}}).on("iedClickMenu",".btn_reset",function(p){if(confirm(e.lang.confReset)){e.resetCanvas()}}).on("iedClickMenu",".btn_zoomout",function(p){e.zoomCanvas(-20)}).on("iedClickMenu",".btn_zoomin",function(p){e.zoomCanvas(20)}).on("iedClickMenu",".btn_moveff",function(p){e.setSelectedObjects({action:function(q){e.removeBalloonPointer(q);h.bringToFront(q);h.renderAll()}})}).on("iedClickMenu",".btn_movef",function(p){e.setSelectedObjects({stopExec:function(q,s,t){var u=q[q.length-1];var r=t?t.item(t._objects.length-1):null;return u===s||u===r},action:function(q){e.removeBalloonPointer(q);h.bringForward(q);h.renderAll()},flgReverseLoop:true})}).on("iedClickMenu",".btn_moveb",function(p){e.setSelectedObjects({stopExec:function(q,r,s){var t=q[0];var u=s?s.item(0):null;return t===r||t===u},action:function(q){e.removeBalloonPointer(q);h.sendBackwards(q);h.renderAll()}})}).on("iedClickMenu",".btn_movebb",function(p){e.setSelectedObjects({action:function(q){e.removeBalloonPointer(q);h.sendToBack(q);h.renderAll()},flgReverseLoop:true})}).on("iedClickMenu",".btn_remove",function(p){e.setSelectedObjects({action:function(q){h.discardActiveGroup();if(q.neotype!=="bgimage"){h.remove(q)}h.renderAll();i.find(".ied-edit-tools").find("li").trigger("iedTrunSelectOff")}})}).on("iedClickMenu",".btn_rotatel",function(r){var p=h.getActiveObject();var q=h.getActiveGroup();e.setSelectedObjects({action:function(s){s.setAngle(s.getAngle()+-90);h.renderAll()}});if(p||q){if(p){e.setBalloonPointer({target:p,e:r})}else{q.setCoords();h.renderAll()}}}).on("iedClickMenu",".btn_rotater",function(r){var p=h.getActiveObject();var q=h.getActiveGroup();e.setSelectedObjects({action:function(s){s.setAngle(s.getAngle()+90);h.renderAll()}});if(p||q){if(p){e.setBalloonPointer({target:p,e:r})}else{q.setCoords();h.renderAll()}}}).on("iedClickMenu",".btn_flipv",function(r){var p=h.getActiveObject();var q=h.getActiveGroup();e.setSelectedObjects({action:function(s){s.setFlipY(!s.getFlipY());h.renderAll()}});if(p||q){if(p){e.setBalloonPointer({target:p,e:r})}else{q.setCoords();h.renderAll()}}}).on("iedClickMenu",".btn_fliph",function(r){var p=h.getActiveObject();var q=h.getActiveGroup();e.setSelectedObjects({action:function(s){s.setFlipX(!s.getFlipX());h.renderAll()}});if(p||q){if(p){e.setBalloonPointer({target:p,e:r})}else{q.setCoords();h.renderAll()}}}).on("iedClickMenu",".btn_dup",function(t){var s=[];var p=0;var r=0;var q=h.getActiveGroup();if(h.getActiveObject()){p=1}else{if(q){p=q._objects.length}else{return}}e.setSelectedObjects({action:function(u){e.addClone(u,function(v){s.push(v);r++;if(p===r){h.discardActiveGroup();h.discardActiveObject();if(s.length===1){h.setActiveObject(s[0])}else{h.setActiveGroup(new fabric.Group(s))}h.renderAll()}})},flgSetActiveGroup:false})}).on("iedClickMenu",".btn_undo",function(p){e.loadHistory(-1)}).on("iedClickMenu",".btn_redo",function(p){e.loadHistory(1)}).on("iedClickMenu",".btn_bglock",function(p){b(this).is(".on")?e.unlockBgImg():e.lockBgImg()});var l=i.find(".ied-edit-side");l.on("mousedown touchstart",function(){NeoEditor.grobalEditActive=true}).on("mouseup touchend",function(){NeoEditor.grobalEditActive=false});var j=i.find(".ied-edit-tools");j.on("click",".btn",function(p){p.preventDefault();var q=b(this).closest("li");j.find("li.on").not(q).trigger("iedTurnToolOff");j.find("li").trigger("iedTrunSelectOff");if(q.hasClass("select")){q.trigger("iedTurnToolOn")}else{if(q.is(".on")){q.trigger("iedTurnToolOff");j.find(".select>.btn").trigger("click")}else{q.trigger("iedTurnToolOn")}}});j.on("iedTurnToolOn",function(r,p){var s=b(r.target);s.addClass("on");var q=p?p:false;if(!q){h.discardActiveGroup();h.discardActiveObject()}if(!s.hasClass("select")){e.disableEdit();d.find("a").filter(".jsToggleEditMenu").addClass("off");d.find(".btn_bglock").not(".on").trigger("iedClickMenu")}else{e.enableEdit()}}).on("iedTurnToolOff",function(p){var q=b(p.target);q.removeClass("on");d.find("a").filter(".jsToggleEditMenu").removeClass("off")});j.find(".jsSyncSizeLine").on("iedSettingSyncOn",function(r,q,p){j.find(".jsSyncSizeLine").not(q).val(p)});j.find(".jsSyncSizeText").on("iedSettingSyncOn",function(r,p,q){j.find(".jsSyncSizeText").not(p).val(q)});(function(){var s=j.children(".freehand");var q=s.find(".size");var r=n.getInputValue(q);var p=function(t){r=t;h.freeDrawingBrush.width=r;q.trigger("iedSettingSyncOn",[q,r])};q.on(n.NEOEDITOR_RANGE_CHANGE,{callback:p},n.ied_inputChangeValue);s.on("iedTurnToolOn",function(t){r=n.getInputValue(q);h.isDrawingMode=true;h.freeDrawingBrush.color=e.toolColor;h.freeDrawingBrush.width=r}).on("iedTurnToolOff",function(t){h.isDrawingMode=false;h._isCurrentlyDrawing=false}).on("iedTrunSelectOn",function(x,w){s.addClass("paletteon");var t;q.val(w.strokeWidth);var v=function(z){h.renderAll();var y=e.getObjectLayerIndex(w);e.addHistory("object",z,e.neoClone(w),y)};var u=function(y){t=e.neoClone(w);w.strokeWidth=y;v(t)};q.on(n.NEOEDITOR_RANGE_CHANGE_MOD,{callback:u},n.ied_inputChangeValue)}).on("iedTrunSelectOff",function(t){s.removeClass("paletteon");q.off(NeoEditor.NEOEDITOR_RANGE_CHANGE_MOD)})}());(function(){var w=j.children(".rect");var t=null;var r=w.find(".size");var v=n.getInputValue(r);var q=function(x){v=x;r.trigger("iedSettingSyncOn",[r,v])};r.on(n.NEOEDITOR_RANGE_CHANGE,{callback:q},n.ied_inputChangeValue);var u=w.find(".radius");var p=n.getInputValue(u);var s=function(x){p=x};u.on(n.NEOEDITOR_RANGE_CHANGE,{callback:s},n.ied_inputChangeValue);w.on("iedTurnToolOn",function(z){v=n.getInputValue(r);e.setGraphicCursor();var A=false;var x={x:0,y:0};var y={x:0,y:0};h.on("mouse:down",function(C){A=true;var B=h.getPointer(C.e);x.x=B.x;x.y=B.y;y.x=B.x;y.y=B.y;var D=new fabric.Rect({neotype:"rect",guid:e.getGUID(),left:x.x,top:x.y,width:(y.x-x.x),height:(y.y-x.y),stroke:e.toolColor,strokeWidth:v,fill:e.toolBgColor,rx:p,ry:p});h.add(D);t=D});h.on("mouse:move",function(D){if(A){var C=h.getPointer(D.e);y.x=C.x;y.y=C.y;var B={width:Math.abs(y.x-x.x),height:Math.abs(y.y-x.y),};if(y.x-x.x<0){B.left=y.x}if(y.y-x.y<0){B.top=y.y}t.set(B);h.renderAll()}});h.on("mouse:up",function(C){if(!t){return}if(t.width===0&&t.height===0){t.set({width:100,height:100})}h.remove(t);h.add(t);h.setActiveObject(t);h.renderAll();var B=e.getObjectLayerIndex(t);e.addHistory("object","",e.neoClone(t),B);A=false})}).on("iedTurnToolOff",function(x){h.off("mouse:down");h.off("mouse:move");h.off("mouse:up");e.enableEdit();e.setDefaultCursor()}).on("iedTrunSelectOn",function(B,A){w.addClass("paletteon");var x;r.val(A.strokeWidth);u.val(A.rx);var y=function(E){h.renderAll();var D=e.getObjectLayerIndex(A);e.addHistory("object",E,e.neoClone(A),D)};var z=function(D){x=e.neoClone(A);A.strokeWidth=D;y(x)};r.on(n.NEOEDITOR_RANGE_CHANGE_MOD,{callback:z},n.ied_inputChangeValue);var C=function(E){x=e.neoClone(A);var D=E;A.rx=D;A.ry=D;y(x)};u.on(n.NEOEDITOR_RANGE_CHANGE_MOD,{callback:C},n.ied_inputChangeValue)}).on("iedTrunSelectOff",function(x){w.removeClass("paletteon");r.off(n.NEOEDITOR_RANGE_CHANGE_MOD);u.off(n.NEOEDITOR_RANGE_CHANGE_MOD)})}());(function(){var t=j.children(".circle");var r=null;var q=t.find(".size");var s=n.getInputValue(q);var p=function(u){s=u;q.trigger("iedSettingSyncOn",[q,s])};q.on(n.NEOEDITOR_RANGE_CHANGE,{callback:p},n.ied_inputChangeValue);t.on("iedTurnToolOn",function(w){s=n.getInputValue(q);e.setGraphicCursor();var x=false;var u={x:0,y:0};var v={x:0,y:0};h.on("mouse:down",function(z){x=true;var y=h.getPointer(z.e);u.x=y.x;u.y=y.y;v.x=y.x;v.y=y.y;var A=new fabric.Circle({neotype:"circle",guid:e.getGUID(),left:u.x,top:u.y,radius:0,stroke:e.toolColor,strokeWidth:s,fill:e.toolBgColor});h.add(A);r=A});h.on("mouse:move",function(A){if(x){var z=h.getPointer(A.e);v.x=z.x;v.y=z.y;var y={radius:Math.max(Math.abs(v.x-u.x),Math.abs(v.y-u.y))/2};y.left=(v.x-u.x<0)?u.x-2*y.radius:u.x;y.top=(v.y-u.y<0)?u.y-2*y.radius:u.y;r.set(y);h.renderAll()}});h.on("mouse:up",function(z){if(!r){return}if(r.radius===0){r.set("radius",50)}h.remove(r);h.add(r);h.setActiveObject(r);h.renderAll();var y=e.getObjectLayerIndex(r);e.addHistory("object","",e.neoClone(r),y);x=false})}).on("iedTurnToolOff",function(u){h.off("mouse:down");h.off("mouse:move");h.off("mouse:up");e.enableEdit();e.setDefaultCursor()}).on("iedTrunSelectOn",function(y,x){t.addClass("paletteon");var u;q.val(x.strokeWidth);var v=function(A){h.renderAll();var z=e.getObjectLayerIndex(x);e.addHistory("object",A,e.neoClone(x),z)};var w=function(z){u=e.neoClone(x);x.strokeWidth=z;v(u)};q.on(n.NEOEDITOR_RANGE_CHANGE_MOD,{callback:w},n.ied_inputChangeValue)}).on("iedTrunSelectOff",function(u){t.removeClass("paletteon");q.off(n.NEOEDITOR_RANGE_CHANGE_MOD)})}());(function(){var s=j.children(".balloon");var r=null;var p=[[68,126],[46,163],[92,126]];var t="M"+p[0][0]+","+p[0][1]+" L"+p[1][0]+","+p[1][1]+" L"+p[2][0]+","+p[2][1];var q={pop:t+" a10,10 0 1,0 54,0 a12,10 0 1,0 46,-13 a15,10 0 1,0 27,-23 a15,10 0 1,0 0,-27 a15,10 0 1,0 -27,-23 a12,10 0 1,0 -46,-13 a10,10 0 1,0 -53,0 a12,10 0 1,0 -46,13 a15,10 0 1,0 -26,23 a15,10 0 1,0 0,27 a15,10 0 1,0 47,36",zigzag:t+" l27,30 l27,-30 l32,20 l14,-33 l32,3 l-5,-26 l20,-13 l-20,-14 l5,-26 l-32,3 l-14,-33 l-32,20 l-27,-30 l-27,30 l-32,-20 l-14,33 l-32,-3 l5,26 l-20,14 l20,13 l-5,40 l54,-4 ",rrect:t+" l135,0 a10,10 0 0,0 10,-10 l0,-105 a10,10 0 0,0 -10,-10 l-215,0 a10,10 0 0,0 -10,10 l0,105 a10,10 0 0,0 10,10 l56,0",rect:t+" l145,0 l0,-125 l-235,0 l0,125 l66,0"};var u=s.find(".type");var w=u.filter(":checked").val();u.on("change",function(){w=b(this).val()});var z=s.find(".size");var D=n.getInputValue(z);var C=function(E){D=E;z.trigger("iedSettingSyncOn",[z,D])};z.on(n.NEOEDITOR_RANGE_CHANGE,{callback:C},n.ied_inputChangeValue);var y=s.find(".tsize");var A=n.getInputValue(y);var B=function(E){A=E;y.trigger("iedSettingSyncOn",[y,A])};y.on(n.NEOEDITOR_RANGE_CHANGE,{callback:B},n.ied_inputChangeValue);var v=s.find(".direction");var x=v.val();v.on("change",function(){x=b(this).val()});s.on("iedTurnToolOn",function(G){D=n.getInputValue(z);A=n.getInputValue(y);e.setGraphicCursor();var H=false;var E={x:0,y:0};var F={x:0,y:0};h.on("mouse:down",function(J){H=true;var I=h.getPointer(J.e);E.x=I.x;E.y=I.y;F.x=I.x;F.y=I.y;var K=new fabric.Path(q[w]||q.rect,{neotype:"balloon",guid:e.getGUID(),fill:e.toolBgColor,stroke:e.toolColor,strokeWidth:D,strokeLineCap:"round",left:I.x,top:I.y,scaleX:0,scaleY:0});K.initialState={width:K.width,height:K.height};h.add(K);r=K});h.on("mouse:move",function(M){if(H){var L=h.getPointer(M.e);F.x=L.x;F.y=L.y;var K=Math.abs(F.x-E.x)/r.width;var I=Math.abs(F.y-E.y)/r.height;var J={strokeWidth:r.originalState.strokeWidth/((K+I)/2),scaleX:K,scaleY:I};if(F.x-E.x<0){J.left=F.x}if(F.y-E.y<0){J.top=F.y}r.set(J);h.renderAll()}});h.on("mouse:up",function(J){if(!r){return}if(r.scaleX<0.1&&r.scaleY<0.1){r.set({strokeWidth:D,scaleX:1,scaleY:1})}var M=r.getCenterPoint();var L=e.lang.msgInputHere;var I=new fabric.Text(L,{neotype:"text",guid:e.getGUID(),left:M.x,top:M.y,fontFamily:e.toolFont,fontSize:A,textAlign:"left",strokeWidth:1,stroke:e.toolColor,fontWeight:"bold",fill:e.toolBgColor,direction:x,originX:"left",originY:"top"});h.remove(r);h.add(r);var K=e.getObjectLayerIndex(r);e.addHistory("object","",e.neoClone(r),K);if(x==1){h.add(I.set({left:I.left-I.height/2,top:I.top-I.width/2*1.3}))}else{h.add(I.set({left:I.left-I.width/2,top:I.top-I.height/2}))}h.renderAll();h.setActiveObject(I);h.fire("object:dbclick",{e:J,target:I});H=false;s.trigger("iedTurnToolOff");i.find(".ied-edit-tools").find("li.select").trigger("iedTurnToolOn")})}).on("iedTurnToolOff",function(E){h.off("mouse:down");h.off("mouse:move");h.off("mouse:up");e.enableEdit();e.setDefaultCursor()}).on("iedTrunSelectOn",function(I,H){s.addClass("paletteon");var E;z.val(H.strokeWidth);var F=function(K){h.renderAll();var J=e.getObjectLayerIndex(H);e.addHistory("object",K,e.neoClone(H),J)};var G=function(J){E=e.neoClone(H);H.strokeWidth=J;F(E)};z.on(n.NEOEDITOR_RANGE_CHANGE_MOD,{callback:G},n.ied_inputChangeValue)}).on("iedTrunSelectOff",function(E){s.removeClass("paletteon");z.off(n.NEOEDITOR_RANGE_CHANGE_MOD)})}());(function(){var u=j.children(".arrow");var t=null;var B=u.find(".size");var C=n.getInputValue(B);var D=function(E){C=E;B.trigger("iedSettingSyncOn",[B,C])};B.on(n.NEOEDITOR_RANGE_CHANGE,{callback:D},n.ied_inputChangeValue);var r=u.find(".left");var s=r.filter(":checked").val();r.on("change",function(){s=b(this).val()});var z=u.find(".right");var A=z.filter(":checked").val();z.on("change",function(){A=b(this).val()});var p=u.find(".style");var q=p.val();p.on("change",function(){q=b(this).val()});var y=function(I,K,H,J,F,E){var G=function(L){switch(L){case"1":return null;case"2":return[1,2*C];case"3":return[2*C,2*C];default:return null}};return new fabric.Line([I,K,H,J],{fill:e.toolBgColor,stroke:e.toolColor,strokeWidth:F,strokeLineCap:"round",strokeDashArray:G(E),originX:"center",originY:"center",neoStyleType:E})};var w=function(I,H,G,F){var K,J,E;if(I==="1"){K=[H+(4+4*F),G-(2+2*F),H,G,H+(4+4*F),G+(2+2*F)];J="M"+K[0]+","+K[1]+"L"+K[2]+","+K[3]+"L"+K[4]+","+K[5];E=new fabric.Path(J,{left:H,top:G,originX:"left",originY:"center",fill:e.toolBgColor,stroke:e.toolColor,strokeWidth:F,strokeLineCap:"round",neoStyleType:I})}else{if(I==="2"){E=new fabric.Circle({left:H,top:G,radius:F,fill:e.toolBgColor,stroke:e.toolColor,strokeWidth:F,originX:"center",originY:"center",neoStyleType:I})}else{E=new fabric.Circle({left:H,top:G,radius:0,fill:e.toolBgColor,stroke:e.toolColor,strokeWidth:F,originX:"center",originY:"center",neoStyleType:I})}}return E};var x=function(K,H,F,E){var J,I,G;if(K==="1"){J=[H-(4+4*E),F-(2+2*E),H,F,H-(4+4*E),F+(2+2*E)];I="M"+J[0]+","+J[1]+"L"+J[2]+","+J[3]+"L"+J[4]+","+J[5];G=new fabric.Path(I,{left:H,top:F,originX:"right",originY:"center",fill:e.toolBgColor,stroke:e.toolColor,strokeWidth:E,strokeLineCap:"round",neoStyleType:K})}else{if(A==="2"){G=new fabric.Circle({left:H,top:F,radius:E,fill:e.toolBgColor,stroke:e.toolColor,strokeWidth:E,originX:"center",originY:"center",neoStyleType:K})}else{G=new fabric.Circle({left:H,top:F,radius:0,fill:e.toolBgColor,stroke:e.toolColor,strokeWidth:E,originX:"center",originY:"center",neoStyleType:K})}}return G};u.on("iedTurnToolOn",function(K){C=n.getInputValue(B);e.setGraphicCursor();var P=false;var G={x:0,y:0};var I={x:0,y:0};var H,L,J,N,F,M;var O=fabric.util.rotatePoint;var E=fabric.util.degreesToRadians;h.on("mouse:down",function(S){P=true;var Q=h.getPointer(S.e);G.x=Q.x;G.y=Q.y;I.x=Q.x;I.y=Q.y;var U=y(G.x,G.y,I.x,I.y,C,q);var R=w(s,G.x,G.y,C);var T=x(A,G.x,G.y,C);h.add(U);e.disableEdit(U);h.add(R);e.disableEdit(R);h.add(T);e.disableEdit(T);t=[U,R,T]});h.on("mouse:move",function(R){if(P){var Q=h.getPointer(R.e);I.x=Q.x;I.y=Q.y;J=new fabric.Point(G.x+C,G.y);N=new fabric.Point(I.x-C,I.y);H=e.getAngle(G.x,G.y,I.x,I.y);L=E(H);F=O(J,G,L);M=O(N,I,L);t[0].set({x1:F.x,y1:F.y,x2:M.x,y2:M.y});t[1].set({angle:H});t[2].set({angle:H,left:I.x,top:I.y});h.renderAll()}});h.on("mouse:up",function(U){if(!t){return}for(var S=0,Q=t.length;S<Q;S++){e.enableEdit(t[S])}var T=(new fabric.Group(t)).set({neotype:"arrow",guid:e.getGUID(),fill:e.toolBgColor});h.add(T);h.setActiveObject(T);for(var S=0,Q=t.length;S<Q;S++){h.remove(t[S])}h.renderAll();var R=e.getObjectLayerIndex(T);e.addHistory("object","",e.neoClone(T),R);t=null;P=false})}).on("iedTurnToolOff",function(E){h.off("mouse:down");h.off("mouse:move");h.off("mouse:up");e.enableEdit();e.setDefaultCursor()}).on("iedTrunSelectOn",function(J,I){u.addClass("paletteon");var E;var H=I.guid;var F=function(M){var K=(new fabric.Group(M)).set({neotype:"arrow",guid:H,top:I.top,left:I.left,scaleX:I.scaleX,scaleY:I.scaleY,flipX:I.flipX,flipY:I.flipY,angle:I.getAngle(),originX:I.getOriginX(),originY:I.getOriginY(),fill:e.toolBgColor});h.add(K);h.setActiveObject(K);h.remove(I);h.renderAll();var L=e.getObjectLayerIndex(K);e.addHistory("object",E,e.neoClone(K),L)};if(!h.getActiveObject()){return}B.val(I.item(0).getStrokeWidth());r.filter("[value="+I.item(1).neoStyleType+"]").trigger("change");z.filter("[value="+I.item(2).neoStyleType+"]").trigger("change");p.filter("[value="+I.item(0).neoStyleType+"]").trigger("change");var G=function(M){E=e.neoClone(I);var K=M;var L=v(I,K,I.item(0).neoStyleType,I.item(1).neoStyleType,I.item(2).neoStyleType);F(L)};B.on(n.NEOEDITOR_RANGE_CHANGE_MOD,{callback:G},n.ied_inputChangeValue);r.on("change.mod",function(){E=e.neoClone(I);var L=b(this).val();var K=v(I,n.getInputValue(B),I.item(0).neoStyleType,L,I.item(2).neoStyleType);F(K)});z.on("change.mod",function(){E=e.neoClone(I);var K=b(this).val();var L=v(I,n.getInputValue(B),I.item(0).neoStyleType,I.item(1).neoStyleType,K);F(L)});p.on("change.mod",function(){E=e.neoClone(I);var K=b(this).val();var L=v(I,n.getInputValue(B),K,I.item(1).neoStyleType,I.item(2).neoStyleType);F(L)})}).on("iedTrunSelectOff",function(E){u.removeClass("paletteon");B.off(n.NEOEDITOR_RANGE_CHANGE_MOD);r.off("change.mod");z.off("change.mod");p.off("change.mod")});var v=function(N,S,H,M,P){var F={x:0,y:0};var J={x:0,y:0};S=parseInt(S,10);var O=N.getCenterPoint();F.x=O.x+N.item(1).getLeft();F.y=O.y+N.item(1).getTop();J.x=O.x+N.item(2).getLeft();J.y=O.y+N.item(2).getTop();var L=new fabric.Point(F.x+S,F.y);var T=new fabric.Point(J.x-S,J.y);var I=e.getAngle(F.x,F.y,J.x,J.y);var R=fabric.util.degreesToRadians(I);var E=fabric.util.rotatePoint(L,F,R);var U=fabric.util.rotatePoint(T,J,R);var K=y(E.x,E.y,U.x,U.y,S,H);var Q=w(M,F.x,F.y,S);Q.set({angle:I});var G=x(P,J.x,J.y,S);G.set({angle:I});return[K,Q,G]}}());(function(){var v=j.children(".mosaic");var s=null;var u={};var r=v.find(".jsIedMsg");var q=v.find(".size");var t=n.getInputValue(q);var p=function(w){t=w};q.on(n.NEOEDITOR_RANGE_CHANGE,{callback:p},n.ied_inputChangeValue);v.on("iedTurnToolOn",function(x){e.setPointerCursor();var y=false;h.on("mouse:down",function(z){y=true;s=[];u={}});var w={x:0,y:0};h.on("mouse:move",function(H){var D=h.getPointer(H.e);if(y&&(Math.abs(D.x-w.x)>=t||Math.abs(D.y-w.y)>=t)){w=D;var K=w.x;var I=w.y;var B=0;var G=0;var J=0;K=K-(K%t);I=I-(I%t);if(K+"_"+I in u){return}if(Object.keys(u).length===500){r.text("モザイク数が500を超えました。処理が重くなる可能性があります。")}var E=f.getImageData(K,I,t,t).data;var C=E.length;for(var A=0;A<C;A+=4){B+=E[A];G+=E[A+1];J+=E[A+2]}var z=C/4;B=Math.floor(B/z);G=Math.floor(G/z);J=Math.floor(J/z);var F=new fabric.Rect({left:K,top:I,width:t,height:t,fill:"rgba("+B+","+G+","+J+",1)",});h.add(F);e.disableEdit(F);s.push(F);u[K+"_"+I]=true}});h.on("mouse:up",function(E){if(!s){return}for(var A=0,z=s.length;A<z;A++){e.enableEdit(s[A])}var D=new fabric.Group(s);var C=D.left;var B=D.top;fabric.Image.fromURL(D.toDataURL(),function(J){var G=J.set({neotype:"mosaic",guid:e.getGUID(),left:C,top:B});h.add(G);for(var I=0,F=s.length;I<F;I++){h.remove(s[I])}h.setActiveObject(G);h.renderAll();var H=e.getObjectLayerIndex(G);e.addHistory("object","",G,H);y=false});r.empty()})}).on("iedTurnToolOff",function(w){h.off("mouse:down");h.off("mouse:move");h.off("mouse:up");e.enableEdit();e.setDefaultCursor()}).on("iedTrunSelectOn",function(x,w){v.addClass("paletteon")}).on("iedTrunSelectOff",function(w){v.removeClass("paletteon")})}());(function(){var w=j.children(".text");var r=null;var q=w.find(".size");var s=n.getInputValue(q);var p=function(x){s=x;q.trigger("iedSettingSyncOn",[q,s])};q.on(n.NEOEDITOR_RANGE_CHANGE,{callback:p},n.ied_inputChangeValue);var t=w.find(".direction");var u=t.val();t.on("change",function(){u=b(this).val()});var v=e.lang.msgInputHere;w.on("iedTurnToolOn",function(x){s=n.getInputValue(q);e.setTextCursor();h.on("mouse:down",function(y){setTimeout(function(){var z=h.getPointer(y.e);r=new fabric.Text(v,{neotype:"text",guid:e.getGUID(),left:z.x,top:z.y,fontFamily:e.toolFont,fontSize:s,textAlign:"left",strokeWidth:1,stroke:e.toolColor,fontWeight:"bold",fill:e.toolBgColor,direction:u,originX:"left",originY:"top"});h.add(r);h.setActiveObject(r);h.fire("object:dbclick",{e:y,target:r})},50)})}).on("iedTurnToolOff",function(x){h.off("mouse:down");e.enableEdit();e.setDefaultCursor()}).on("iedTrunSelectOn",function(C,B){w.addClass("paletteon");var x,A;if(B.type==="group"){b.each(B.getObjects(),function(D,E){A=E.getFontSize();return false})}else{A=B.getFontSize()}q.val(A);var y=function(E){h.renderAll();var D=e.getObjectLayerIndex(B);e.addHistory("object",E,e.neoClone(B),D)};var z=function(E){x=e.neoClone(B);if(B.type==="group"){var F=[];b.each(B.getObjects(),function(G,H){H.setFontSize(E);F.push(H)});var D=new fabric.Group(F);D.set({neotype:"text",guid:x.guid,top:x.top,left:B.left,scaleX:x.scaleX,scaleY:x.scaleY,flipX:x.flipX,flipY:x.flipY,angle:x.angle,originX:"right",originY:"top"});h.remove(B);h.add(D).setActiveObject(D);B=D}else{B.setFontSize(E)}y(x)};q.on(n.NEOEDITOR_RANGE_CHANGE_MOD,{callback:z},n.ied_inputChangeValue)}).on("iedTrunSelectOff",function(x){w.removeClass("paletteon");q.off(n.NEOEDITOR_RANGE_CHANGE_MOD)})}());(function(){var t=j.children(".filter");var r=fabric.Image.filters;var s=false;var p;var q=function(){h.remove(p);h.off("mouse:move");h.off("mouse:up");e.applyFilter(e.filterIndexes.spotlight,false);s=false;e.enableEdit()};t.find(".ied-image-select>li").on("iedFilterOn",function(z,v){var y=b(v);var w=y.attr("class");var x=y.data("checked");if(w.indexOf("grayscale")>=0){e.applyFilter(e.filterIndexes.grayscale,x&&new r.Grayscale())}else{if(w.indexOf("sepia")>=0){e.applyFilter(e.filterIndexes.sepia,x&&new r.MySepia())}else{if(w.indexOf("noise")>=0){e.applyFilter(e.filterIndexes.noise,x&&new r.Noise({noise:50}))}else{if(w.indexOf("emboss")>=0){e.applyFilter(e.filterIndexes.emboss,x&&new r.Convolute({matrix:[1,1,1,1,0.7,-1,-1,-1,-1]}))}else{if(w.indexOf("antique")>=0){e.applyFilter(e.filterIndexes.antique,x&&new r.Antique())}else{if(w.indexOf("vintage")>=0){e.applyFilter(e.filterIndexes.vintage,x&&new r.Vintage())}else{if(w.indexOf("pixelate")>=0){e.applyFilter(e.filterIndexes.pixelate,x&&new r.Pixelate({blocksize:4}))}else{if(w.indexOf("brightness")>=0){e.applyFilter(e.filterIndexes.brightness,x&&new r.Brightness({brightness:100}))}else{if(w.indexOf("spotlight")>=0){var B={};var u=0;var A=0;if(x){s=true;u=80;A=30;p=new fabric.Circle({left:(h.width-u)/2,top:(h.height-u)/2,strokeWidth:0,radius:u,fill:"#fff",opacity:0.7,originX:"center",originY:"center",hasControls:false});h.add(p);h.renderAll();h.on("mouse:move",function(C){B=h.getPointer(C.e);p.set({left:B.x,top:B.y});h.renderAll()});h.on("mouse:up",function(D){h.remove(p);h.off("mouse:down");h.off("mouse:move");h.off("mouse:up");var C=e.bgimg;e.applyFilter(e.filterIndexes.spotlight,new r.Spotlight({spotx:(B.x-C.left)/C.scaleX,spoty:(B.y-C.top)/C.scaleY,radius:u/(C.scaleX+C.scaleY)*2,blur:A/(C.scaleX+C.scaleY)*2}));s=false;e.enableEdit()})}else{q()}}}}}}}}}}});t.find(".ied-image-selected").on("iedFilterOn",".ied-filter-status",function(x,z){var C=b(z);var y=C.attr("class");var B=C.data("checked");if(y.indexOf("pixelate-value")>=0){var A=n.getInputValue(C);i.find("."+C.attr("class")).not(C).val(A);if(t.find(".ied-image-selected").find(".pixelate")){e.applyFilterValue(e.filterIndexes.pixelate,"blocksize",A)}}else{if(y.indexOf("brightness-value")>=0){var A=n.getInputValue(C);i.find("."+C.attr("class")).not(C).val(A);if(t.find(".ied-image-selected").find(".brightness")){e.applyFilterValue(e.filterIndexes.brightness,"brightness",A)}}else{if(y.indexOf("spotlight-radius")>=0){var A=n.getInputValue(C);i.find("."+C.attr("class")).not(C).val(A);if(t.find(".ied-image-selected").find(".spotlight")){var u=e.bgimg;var w=Math.abs(A)/(u.scaleX+u.scaleY)*2;if(p&&s){p.set("radius",w);h.renderAll()}else{e.applyFilterValue(e.filterIndexes.spotlight,"radius",w)}}}else{if(y.indexOf("spotlight-blur")>=0){var A=n.getInputValue(C);i.find("."+C.attr("class")).not(C).val(A);if(t.find(".ied-image-selected").find(".spotlight")){var u=e.bgimg;var v=Math.abs(A)/(u.scaleX+u.scaleY)*2;if(p&&s){}else{e.applyFilterValue(e.filterIndexes.spotlight,"blur",v)}}}}}}});t.on("iedTurnToolOff",function(v){var u=t.find(".spotlight");if(p&&s&&u.is(":checked")){u.prop("checked",false).removeClass("checked");q()}j.find(".ied-image-selected").children(".ied-popover").remove();e.enableEdit()})}());(function(){var u=j.children(".crop");var t=null;var s=NeoEditor.NEOEDITOR_MAX_IMAGE_PX;var r=-s;var q=0;var y=0;var p=h.width;var x=h.height;var B=u.find(".x1");var w=u.find(".y1");var A=u.find(".x2");var v=u.find(".y2");var z=function(D,F,C,E){q=(q!=parseInt(q,10)||q<r||q>s)?0:D;y=(y!=parseInt(y,10)||y<r||y>s)?0:F;p=(p!=parseInt(p,10)||p<r||p>s)?0:C;x=(x!=parseInt(x,10)||x<r||x>s)?0:E;q=Math.round(q);y=Math.round(y);p=Math.round(p);x=Math.round(x);if(q>p){q=[p,p=q][0]}if(y>x){y=[x,x=y][0]}if(p-q===0){p=q+1}if(x-y===0){x=y+1}B.val(q);w.val(y);A.val(p);v.val(x);if(!t){return}t[0].set({left:q,top:y,width:p-q,height:x-y,scaleX:1,scaleY:1});t[0].setCoords();t[1].set({height:y});t[1].setCoords();t[2].set({top:y,width:q,height:x-y});t[2].setCoords();t[3].set({left:p,top:y,width:h.width-p,height:x-y});t[3].setCoords();t[4].set({top:x,height:h.height-x});t[4].setCoords();h.renderAll()};B.on("change",function(){q=parseInt(b(this).val(),10);z(q,y,p,x)});w.on("change",function(){y=parseInt(b(this).val(),10);z(q,y,p,x)});A.on("change",function(){p=parseInt(b(this).val(),10);z(q,y,p,x)});v.on("change",function(){x=parseInt(b(this).val(),10);z(q,y,p,x)});u.on("iedTurnToolOn",function(E){e.setCropCursor();z(0,0,h.width,h.height);var F=false;var C={x:0,y:0};var D={x:0,y:0};h.on("mouse:down",function(K){F=true;C=h.getPointer(K.e);q=C.x;y=C.y;p=C.x;x=C.y;var J=new fabric.Rect({left:q,top:x,width:p-q,height:x-y,stroke:"#369",strokeWidth:1,fill:null,isCropper:true});var I=new fabric.Rect({left:0,top:0,width:h.width,height:y,strokeWidth:0,fill:"#000",opacity:0.25});var L=new fabric.Rect({left:0,top:y,width:q,height:x-y,strokeWidth:0,fill:"#000",opacity:0.25});var H=new fabric.Rect({left:p,top:y,width:h.width-p,height:x-y,strokeWidth:0,fill:"#000",opacity:0.25});var G=new fabric.Rect({left:0,top:x,width:h.width,height:h.height-x,strokeWidth:0,fill:"#000",opacity:0.25});h.add(J);e.disableEdit(J);h.add(I);e.disableEdit(I);h.add(L);e.disableEdit(L);h.add(H);e.disableEdit(H);h.add(G);e.disableEdit(G);t=[J,I,L,H,G]});h.on("mouse:move",function(G){if(F){D=h.getPointer(G.e);z(C.x,C.y,D.x,D.y)}});h.on("mouse:up",function(G){if(!t){return}e.enableEdit(t[0]);h.remove(t[0]);h.add(t[0]);h.setActiveObject(t[0]);h.renderAll();F=false;h.off("mouse:down");h.off("mouse:move");h.off("mouse:up");t[0].on({moving:function(I){var H=t[0];z(H.left,H.top,H.left+H.width,H.top+H.height)},scaling:function(I){var H=t[0];z(H.left,H.top,H.left+(H.width*H.scaleX),H.top+(H.height*H.scaleY))}})})}).on("click",".btn_crop",function(F){var D;if(b(this).is("._auto")){h.discardActiveGroup();h.discardActiveObject();var H,E=h.getObjects();if(E.length===1){H=E[0];H={left:H.left,top:H.top,width:(H.width+H.strokeWidth)*H.scaleX,height:(H.height+H.strokeWidth)*H.scaleY}}else{var G,C=new fabric.Group(h.getObjects());h.setActiveGroup(C);G=C.oCoords;H={left:G.tl.x,top:G.tl.y,width:G.br.x-G.tl.x,height:G.br.y-G.tl.y}}D={left:H.left,top:H.top,width:H.width,height:H.height};h.discardActiveGroup();e.enableEdit();h.renderAll()}else{D=t?t[0]:{left:q,top:y,width:p-q,height:x-y}}if(!D){return}h.deactivateAll();e.canvas_width=D.width;e.canvas_height=D.height;h.setDimensions({width:e.canvas_width,height:e.canvas_height});h.getObjects().forEach(function(I){I.set({left:I.left-D.left,top:I.top-D.top});I.setCoords()});h.renderAll();u.trigger("iedTurnToolOff");i.find(".ied-edit-tools").find("li.select").trigger("iedTurnToolOn");e.addHistory("canvas")}).on("click",".btn_crop_cancel",function(C){u.trigger("iedTurnToolOff");i.find(".ied-edit-tools").find("li.select").trigger("iedTurnToolOn")}).on("iedTurnToolOff",function(E){if(t){for(var D=0,C=t.length;D<C;D++){h.remove(t[D])}}h.renderAll();h.off("mouse:down");h.off("mouse:move");h.off("mouse:up");e.enableEdit();e.setDefaultCursor()})}());return e},setEvent:function(e){var d=this;d.setRadioCheck(e)},setRadioCheck:function(d){var e=d.find(".ied-check").find("input");e.each(function(){b(this).toggleClass("checked",b(this).is(":checked"))}).on("change",function(){if(b(this).is(":checked")){if(b(this).is('[type="radio"]')){d.find('[name="'+b(this).attr("name")+'"]').removeClass("checked")}b(this).addClass("checked")}else{b(this).removeClass("checked")}})},setColorPicler:function(){var m=b(this);var l=m.children();var d=m.attr("name");var q=b('<div class="ied-cpicker"/>');var o=b('<a href="#"/>').attr("title",m.attr("title"));var h=b("<div/>");var p="";var f=m.attr("class");for(var g=0,j=l.length;g<j;g++){var k=l.eq(g);var e=k.val();var n="";if(k.is(":selected")){o.css("background-color",e);n=" checked"}p+='<input type="radio" name="'+d+'" class="'+f+'" id="'+d+e+'" value="'+e+'"'+n+">";p+='<label for="'+d+e+'" style="background-color:'+e+'" title="'+k.text()+'"></label>'}o.click(function(i){h.toggle();i.preventDefault()});q.bind("hover",null,function(){h.hide()});h.on("change","[type=radio]",function(){o.css("background-color",b(this).val());h.hide()});q.append(o).append(h.html(p));m.after(q).remove()},setSelect:function(){var o=b(this);var l=o.children();var d=o.attr("name");var s=b('<div class="ied-select"/>');var q=b('<a href="#"/>');var h=b("<div/>");var r="";var f=o.attr("class");for(var g=0,j=l.length;g<j;g++){var k=l.eq(g);var e=k.val();var n=k.text();var m=k.attr("title")||n;var p="";if(k.is(":selected")){q.text(n).attr({name:d+g,title:m});p=" checked"}r+='<input type="radio" name="'+d+'" class="'+f+'" id="'+d+g+'" value="'+e+'"'+p+">";r+='<label for="'+d+g+'" title="'+m+'">'+n+"</label>"}q.click(function(i){h.toggle();i.preventDefault()});s.bind("hover",null,function(){h.hide()});h.on("change","[type=radio]",function(){var i=b(this).next();q.text(i.text()).attr({name:i.attr("for"),title:i.attr("title")||i.text()});h.hide()});s.addClass(d).append(q).append(h.html(r));o.after(s).remove()},setImageSelect:function(){var i=b(this);var f=i.find(".ied-dropdown-button");var e=i.find(".ied-image-select");var h=i.next();f.on("showToggle",function(j){g();e.toggle()});var g=function(){var j=h.children(".ied-filter-type");j.each(function(){b(this).data("visibleSetting",false);b(this).find(".ied-filter-select-item-setting-wrap").removeClass("visible")});h.children(".ied-popover").remove()};var d=function(){var k=0;var j=0;e.children().each(function(){if(!b(this).data("selected")){k++}j=b(this).outerHeight()});if(k===0){f.addClass("disabled")}else{if(k<=3){f.removeClass("disabled");e.height(j*k)}else{f.removeClass("disabled");e.height(j*4)}}};f.click(function(j){if(!f.hasClass("disabled")){f.trigger("showToggle",j)}j.preventDefault()});e.children().on("click",function(l,k){var m=b(this);m.data("selected",true);var j=m.find(".ied-filter-type").clone();j.data("checked",true);if(!k){m.trigger("iedFilterOn",j)}m.hide();d();h.append(j);e.hide()});h.on({mouseenter:function(){var j=b(this);var k=j.find(".ied-filter-select-item-setting-wrap");if(!j.data("visibleSetting")){g();k.addClass("visible")}},mouseleave:function(){var j=b(this);var k=j.find(".ied-filter-select-item-setting-wrap");if(!j.data("visibleSetting")){k.removeClass("visible")}}},".ied-filter-type");h.on("click",".ied-filter-select-item-setting-wrap>.btn-close",function(m,l){var j=b(this).closest(".ied-filter-type");var k=j.attr("class");var n=e.find("[class='"+k+"']").closest("li");n.data("selected",false);h.children(".ied-popover").remove();j.data("checked",false);if(!l){n.trigger("iedFilterOn",j)}n.show();d();j.remove()});h.on("click",".ied-filter-select-item-setting-wrap>.btn-setting",function(q){var u=b(this).closest(".ied-filter-type");var x=u.position();var l=u.outerHeight();var s=i.closest(".palette");var w=s.outerHeight();var v=s.outerWidth();var j=s.scrollTop();var p=s.prop("scrollWidth");var n=u.find(".ied-popover").clone();var m=u.find(".ied-filter-select-item-setting-wrap");if(u.data("visibleSetting")){u.data("visibleSetting",false);h.children(".ied-popover").remove()}else{u.data("visibleSetting",true);var r=function(y){h.find(y.closest(".ied-filter-status")).trigger("iedFilterOn",y)};n.on(NeoEditor.NEOEDITOR_RANGE_CHANGE,"input",{callback:r,resultObject:true},NeoEditor.ied_inputChangeValue);n.appendTo(h);var t;var k=20;if(x.top<w/2){t=x.top+j+l}else{var o=n.show().height();n.hide();t=(x.top+j)-(o-l+20);n.removeClass("bottom").addClass("top")}if(p<v){k=5}n.css({top:t,left:k});n.show()}})},getInstance:function(d){return b.extend(d,{preview:function(){var f=this;var g=f.canvas||null;if(!g){return}var j=a.open("about:blank");var k=c.createElement("title");var i=c.createElement("div");k.text=f.lang.titlePreview;i.appendChild(k.cloneNode(true));var e=c.createElement("img");var h=c.createElement("div");e.src=f.getImageData();h.appendChild(e.cloneNode(true));j.document.write(i.innerHTML);j.document.write(h.innerHTML);j.document.close()},resetCanvas:function(j){var e=this;var h=e.canvas||null;var g=e.imageUrl||null;var i=e.$dialog||null;var f=j?j:false;if(!h||!g||!i){return}h.clear();e.canvas_scale=100;i.find(".ied-edit-menu .scale").text("100%");this.setCanvasEvent();h.isDrawingMode=false;$tools=e.$dialog.find(".ied-edit-tools");$tools.children().trigger("iedTurnToolOff");$tools.find("li.select").trigger("iedTurnToolOn");$tools.find("li").trigger("iedTrunSelectOff");e.clearHistory();e.resetFilterPalette();e.setBgImg(f)},resetFilterPalette:function(){this.$dialog.find(".jsIedImageSelect").next().find(".ied-filter-select-item-setting-wrap>.btn-close").trigger("click",true)},bgimg:null,setBgImg:function(h){var e=this;var g=e.canvas;var f=e.imageUrl;if(!g||!f){return}fabric.Image.fromURL(f,function(k){k=e.bgimg=k;g.add(k.set("neotype","bgimage")).sendToBack(k);var j=g.width/k.width;var i=g.height/k.height;e.canvas_width=k.width;e.canvas_height=k.height;g.setDimensions({width:e.canvas_width,height:e.canvas_height}).setScroll();g.setBackgroundColor(e.$toolCvColor.filter(":checked").val());g.renderAll();e.lockBgImg();NeoEditor.grobalBeforeCanvas=d.getCanvasJSON()},{centeredScaling:true,strokeWidth:0,padding:0})},lockBgImg:function(){this.$dialog.find(".btn_bglock").addClass("on");this.canvas.discardActiveObject();var e=this.bgimg;e.evented=false;e.hasBorders=false;e.hasControls=false;e.hasRotatingPoint=false;e.selectable=false;e.lockMovementX=true;e.lockMovementY=true;e.lockRotation=true;e.lockScalingX=true;e.lockScalingY=true},unlockBgImg:function(){this.$dialog.find(".btn_bglock").removeClass("on");this.enableEdit(this.bgimg);var e=this.bgimg;e.evented=true;e.hasBorders=true;e.hasControls=true;e.hasRotatingPoint=true;e.selectable=true;e.lockMovementX=false;e.lockMovementY=false;e.lockRotation=false;e.lockScalingX=false;e.lockScalingY=false},isCanvasInitialized:false,setCanvasEvent:function(e){var f=this;var h=f.canvas;if(!f.isCanvasInitialized){b(c).off("keydown.imgeditor").on("keydown.imgeditor",function(i){if(i.ctrlKey){if(i.keyCode===65){if(h._isCurrentlyDrawing){return}if(NeoEditor.NEOEDITOR_LTE_IE9){if(b(c.activeElement).is("input[type=text], input[type=range], textarea")){return}}else{if(b(c.activeElement).is("input[type=text], textarea")){return}}h.fire("mouse:up",{e:i});f.$dialog.find(".ied-edit-tools").children().trigger("iedTurnToolOff");f.$dialog.find(".ied-edit-tools").children("li.select").trigger("iedTurnToolOn");h.deactivateAll();h.setActiveGroup(new fabric.Group(h.getObjects().filter(function(j){return j.neotype!=="bgimage"})));h.renderAll();i.preventDefault()}}}).off("keyup.imgeditor").on("keyup.imgeditor",function(i){if(f.$dialog.find(".ied-edit-tools").children(".on").not("li.select").length===0&&b(h.wrapperEl).children(".itext").length===0){if(NeoEditor.NEOEDITOR_LTE_IE9){if(b(c.activeElement).is("input[type=text], input[type=range], textarea")){return}}else{if(b(c.activeElement).is("input[type=text], textarea")){return}}if(i.keyCode==46||i.keyCode==8){f.$dialog.find(".btn_remove").trigger("click")}}});var g=(/Firefox/i.test(navigator.userAgent))?"DOMMouseScroll":"mousewheel";b(h.wrapperEl).off(g).on(g,function(j){if(f.$dialog.find(".btn_bglock").is(".on")){return}var i=f.bgimg;var k=j.originalEvent.wheelDelta/1200||j.originalEvent.detail/-30;if(i){i.scaleX+=k;i.scaleY+=k;if(i.scaleX<0.1){i.scaleX=0.1;i.scaleY=0.1}if(i.scaleX>10){i.scaleX=10;i.scaleY=10}i.setCoords();h.renderAll();f.addHistory("canvas");return false}});fabric.StaticCanvas.prototype.setDimensions=(function(){var i=fabric.StaticCanvas.prototype.setDimensions;return function(k,j){f.$dialog.find(".spotlight-radius, .spotlight-blur").attr("max",Math.min(k.width,k.height));i.call(this,k,j);return this}})();fabric.StaticCanvas.prototype.setScroll=function(){var i=b(h.wrapperEl).closest(".ied-canvas-wrapper");if(i.hasScrollBar()){i.scrollLeft((f.bgimg.width-i.width())/2);i.scrollTop((f.bgimg.height-i.height())/2)}return this};f.setObjEditor();f.isCanvasInitialized=true}},$toolFont:null,toolFont:null,$toolColor:null,toolColor:null,$toolBgColor:null,toolBgColor:null,$toolCvColor:null,toolCvColor:null,setObjEditor:function(){var g=this;var h=g.canvas;var i=g.$dialog.find(".ied-edit-colors");var j;fabric.Object.prototype.toObject=(function(k){return function(){return fabric.util.object.extend(k.call(this),{neotype:this.neotype,guid:this.guid,neoStyleType:this.neoStyleType,isDragger:this.isDragger,isCropper:this.isCropper,initialState:this.initialState})}})(fabric.Object.prototype.toObject);fabric.StaticCanvas.prototype.toJSON=function(p){var k=this._toObjectMethod("toObject",p);var o=k.objects;var n=g.canvas_scale/100;for(var m=o.length-1;m>=0;m--){var l=o[m];if(l.neotype===undefined){o.splice(m,1);continue}l.scaleX=l.scaleX/n;l.scaleY=l.scaleY/n;l.left=l.left/n;l.top=l.top/n}return k};fabric.Path.prototype.initialize=(function(k){return function(m,l){k.call(this,m,l);if(this.initialState){this.setWidth(this.initialState.width);this.setHeight(this.initialState.height)}}})(fabric.Path.prototype.initialize);g.setPencilBrush();g.setItext();g.addImageFilters();g.balloon_point=new fabric.Circle({fill:"#369",stroke:"#fff",strokeWidth:5,radius:10,originX:"center",originY:"center",isDragger:true}).on({moving:function(p){var o=this.target;var l=this.getCenterPoint();var n=o.getPointByOrigin("left","top");var k=o.getCenterPoint();var q=-fabric.util.degreesToRadians(o.angle);var m={x:l.x,y:l.y};if(o.flipX){m.x=2*k.x-m.x}if(o.flipY){m.y=2*k.y-m.y}if(o.flipX^o.flipY){m=fabric.util.rotatePoint(new fabric.Point(m.x,m.y),k,-2*q)}m=fabric.util.rotatePoint(new fabric.Point(m.x,m.y),n,q);m.x=(m.x-n.x)/o.scaleX;m.y=(m.y-n.y)/o.scaleY;o.path[1]=["L",m.x,m.y];h.renderAll()}});var e=function(l){var k=l.target;if(!k){return}k.newClickTime=+new Date();if(k.newClickTime-k.lastClickTime<500){h.fire("object:dbclick",l);k.fire("dbclick",l)}k.lastClickTime=k.newClickTime};var f=true;h.on({"object:added":function(l){var k=l.target;if(k.isDragger){k.hasControls=false;k.hasRotatingPoint=false;k.lockRotation=true;k.lockScalingX=true;k.lockScalingY=true}if(k.isCropper){k.hasRotatingPoint=false;k.lockRotation=true}},"object:modified":function(k){g.addHistory("canvas");g.setBalloonPointer(k);f=true},"path:created":function(m){if(m.path){var l=m.path;if(l.neotype){var k=d.getObjectLayerIndex(l);g.addHistory("object","",d.neoClone(l),k)}}},"object:selected":function(k){g.setBalloonPointer(k);g.setToolValue(k);g.showToolPalette(k)},"object:scaling":function(k){if(f){g.removeBalloonPointer(k);f=false}},"object:moving":function(k){if(f){g.removeBalloonPointer(k);f=false}},"object:rotating":function(k){if(f){g.removeBalloonPointer(k);f=false}},"mouse:over":function(k){h.on("mouse:down",e)},"mouse:out":function(k){h.off("mouse:down",e)},"object:dbclick":function(k){g.setITextEditable(k)},"selection:cleared":function(k){g.removeBalloonPointer(k);g.onblurObject(k)}});g.fontFamilies={Normal:"'Hiragino Sans', ’ヒラギノ角ゴシック’,'Hiragino Kaku Gothic Pro W3','ヒラギノ角ゴ Pro W3','ＭＳ Ｐゴシック', 'MS P Gothic', Arial, sans-serif",Clean:"'Hiragino Mincho Pro W6', 'ヒラギノ明朝 Pro W6', 'ＭＳ 明朝', 'MS Mincho', 'Times New Roman', serif",Pop:"'メイリオ', Meiryo, 'Hiragino Maru Gothic Pro', 'ヒラギノ丸ゴ Pro', Verdana, sans-serif",Impact:"Impact, sans-serif",Computer:"'Courier New', monospace, sans-serif"};g.$toolFont=i.find("[name=text_font]").on("change",function(m,l){var l=l||{};var k=g.toolFont=g.fontFamilies[b(this).val()]||fontFamilies.Normal;if(l.flgNotUpdateObj){return}g.setSelectedObjects({action:function(n){if(n.type==="text"){n.set("fontFamily",k);h.renderAll()}},flgSetObjInGrp:true})});g.$toolFont.filter(":checked").trigger("change");g.$toolColor=i.find("[name=lncolor]").on("change",function(m,l){var l=l||{};var k=g.toolColor=b(this).val();if(l.flgNotUpdateObj){return}g.setSelectedObjects({action:function(n){n.set("stroke",k);h.renderAll()},flgSetObjInGrp:true});h.freeDrawingBrush.color=k});g.$toolColor.filter(":checked").trigger("change");g.$toolBgColor=i.find("[name=bgcolor]").on("change",function(m,l){var l=l||{};var k=g.toolBgColor=b(this).val();if(l.flgNotUpdateObj){return}g.setSelectedObjects({action:function(n){n.set("fill",k);h.renderAll()},flgSetObjInGrp:true,flgSetGrp:true})});g.$toolBgColor.filter(":checked").trigger("change");g.$toolCvColor=i.find("[name=cvcolor]").on("change",function(l){var k=g.toolCvColor=b(this).val();h.setBackgroundColor(k,h.renderAll.bind(h));g.addHistory("canvas")})},setBalloonPointer:function(k){var o=this;var g=o.canvas;o.removeBalloonPointer(k);if(g.getActiveObject()===k.target&&k.target.target){k.target=k.target.target;g.discardActiveObject().setActiveObject(k.target)}if(k.target.neotype==="balloon"){var m=k.target;var n=m.path[1];var l=m.getPointByOrigin("left","top");var j=m.getCenterPoint();var h=fabric.util.degreesToRadians(m.angle);var f={x:n[1]>0?n[1]*m.scaleX+l.x:l.x,y:n[2]>0?n[2]*m.scaleY+l.y:l.y};var i=m._parseDimensions();if(i.left<0){f.x+=i.left*m.scaleX}if(i.top<0){f.y+=i.top*m.scaleY}f=fabric.util.rotatePoint(new fabric.Point(f.x,f.y),l,h);if(m.flipX^m.flipY){f=fabric.util.rotatePoint(f,j,-2*h)}if(m.flipX){f.x=2*j.x-f.x}if(m.flipY){f.y=2*j.y-f.y}g.getObjects().forEach(function(e){if(e.isDragger===true&&e.target===m){g.remove(e)}});g.insertAt(o.balloon_point.set({left:f.x,top:f.y,group:null,target:m}),d.getObjectLayerIndex(m)+1);g.renderAll()}},removeBalloonPointer:function(h){var f=this;var g=f.canvas;if(!h.target||h.target&&h.target.neotype!==undefined){g.getObjects().forEach(function(e){if(e.isDragger===true){g.remove(e)}})}},onblurObject:function(g){var f=this;if(g.e&&g.e!==undefined){f.$dialog.find(".ied-edit-tools").find("li").trigger("iedTrunSelectOff")}},setToolValue:function(m){var n=this;var k=m.target;if(k._objects&&k._objects.length>0){k=k._objects[0]}var h=k.fontFamily;var j=k.stroke;var o=k.fill;var g=Object.keys(n.fontFamilies).filter(function(e){return n.fontFamilies[e]===h})[0];var f=h&&n.$toolFont.filter(function(){return b(this).val()===g});if(f&&f.length===1){f.eq(0).prop("checked","checked").trigger("change",{flgNotUpdateObj:true})}var i=j&&n.$toolColor.filter(function(){return b(this).val()===j});if(i&&i.length===1){i.eq(0).prop("checked","checked").trigger("change",{flgNotUpdateObj:true})}var l=o&&n.$toolBgColor.filter(function(){return b(this).val()===o});if(l&&l.length===1){l.eq(0).prop("checked","checked").trigger("change",{flgNotUpdateObj:true})}},showToolPalette:function(j){var f=this;var i=j.target;var h=f.$dialog.find(".ied-edit-tools");var g=f.canvas.getActiveGroup();if(!g){if(i.neotype){h.find("li.on").trigger("iedTurnToolOff");h.find("li.select").trigger("iedTurnToolOn",true);h.find("li").trigger("iedTrunSelectOff");h.find("."+i.neotype).trigger("iedTrunSelectOn",i)}}else{h.find("li").trigger("iedTrunSelectOff")}},setITextEditable:function(m){var q=this;var f=q.canvas;var j=m.target;var n=j.guid;if(j.neotype!=="text"){return}if(j.type==="group"){var h,p=[],k;j.getObjects().forEach(function(e){p.push(e.text.replace(/\n/g,""))});k=j.item(0);h=k.clone().set({text:p.join("\n"),left:j.left,top:j.top,width:(j.width+10)*j.scaleX,height:(j.height+5)*j.scaleY,scaleX:j.scaleX,scaleY:j.scaleY,flipX:j.flipX,flipY:j.flipY,angle:j.angle,});f.remove(j);f.add(h);f.setActiveObject(h);f.fire("object:dbclick",{e:m,target:h})}else{var i=q.$dialog.find(".ied-edit-tools").children(".text");var g,o,l;q.$itext=b("<textarea/>").addClass("itext");g=j.left;if(g<0){g=0}if(g>f.width){g=f.width}o=j.top;if(o<0){o=0}if(o>f.height){o=f.height}f.remove(j);q.$itext.css({left:g,top:o,width:(j.width+10)*j.scaleX,height:(j.height+5)*j.scaleY,"line-height":j.lineHeight,"font-family":j.fontFamily,"font-size":Math.floor(j.fontSize*Math.min(j.scaleX,j.scaleY))+"px","font-weight":j.fontWeight,"font-style":j.fontStyle,color:j.fill}).val(j.text).on("focusout",function(x){var s=+new Date();if(desknets.browser.ipad&&s-l<750){b(this).focus().select();return}var t=b(this).val();b(this).remove();if(j.direction=="1"){var w=[],r;var v=j.top;var u=j.left;b.each(t.split("\n"),function(y,e){var z=j.clone().set({text:e.replace(/  /g," ").split("").join("\n"),left:u,top:v,textAlign:"center",scaleX:1,scaleY:1,flipX:false,flipY:false,angle:0});if(y>0){e===""?z.set("left",z.left-z.getHeight()/1.3*1.1):z.set("left",z.left-z.getWidth()*1.1)}u=z.left;w.push(z)});r=j;j=new fabric.Group(w);j.set({neotype:"text",guid:n,left:j.left-w[0].getWidth()+j.getWidth(),scaleX:r.scaleX,scaleY:r.scaleY,flipX:r.flipX,flipY:r.flipY,angle:r.angle,originX:"right",originY:"top"})}else{j.set("text",t)}f.add(j).setActiveObject(j);f.renderAll();d.addHistory("canvas")}).appendTo(b(f.wrapperEl).closest(".ied-canvas-wrapper"));setTimeout(function(){l=+new Date();q.$itext.focus().select()},1)}},setPencilBrush:function(){fabric.PencilBrush.prototype.createPath=function(f){var e=new fabric.Path(f,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeLineJoin:this.strokeLineJoin,originX:"center",originY:"center",guid:d.getGUID(),neotype:"freehand"});if(this.shadow){this.shadow.affectStroke=true;e.setShadow(this.shadow)}return e}},setItext:function(){fabric.Text.prototype.toObject=(function(e){return function(){return fabric.util.object.extend(e.call(this),{direction:this.direction})}})(fabric.Text.prototype.toObject)},canvasUndos:[],canvasRedos:[],addHistory:function(k,m,g,h){var o=this;var e=o.canvas;var f=o.canvasUndos;var n;var l=m?m:"";var i=g?g:"";var j=h?h:0;if(k==="object"){n={type:"object",before:l,after:i,layer:j};f.push(n)}else{if(k==="canvas"){n={type:"canvas",before:d.neoClone(NeoEditor.grobalBeforeCanvas),after:d.getCanvasJSON()};f.push(n)}else{return}}if(f.length>NeoEditor.NEOEDITOR_MAX_HISTORY_COUNT||JSON.stringify(f).length>NeoEditor.NEOEDITOR_MAX_HISTORY_BYTE){f.shift()}o.canvasRedos=[];o.$dialog.find(".btn_undo").toggleClass("none",o.canvasUndos.length<=0);o.$dialog.find(".btn_redo").toggleClass("none",o.canvasRedos.length<=0);NeoEditor.grobalBeforeCanvas=d.getCanvasJSON()},clearHistory:function(){var e=this;e.canvasUndos=[];e.canvasRedos=[];e.$dialog.find(".btn_undo").addClass("none");e.$dialog.find(".btn_redo").addClass("none")},loadHistory:function(h){var f=this;var g=f.canvas;var k=null;var j=null;var e=f.canvasUndos;var l=f.canvasRedos;if(h<0){if(e.length>0){k=e.pop();l.push(k)}}else{if(l.length>0){k=l.pop();e.push(k)}}if(!k){return}$tools=f.$dialog.find(".ied-edit-tools");$tools.children().trigger("iedTurnToolOff");$tools.find("li.select").trigger("iedTurnToolOn");$tools.find("li").trigger("iedTrunSelectOff");if(k.type=="object"){j=d.getObjectById(k.after.guid);g.remove(j);if(h<0&&k.before){g.insertAt(k.before,k.layer)}else{if(h>0&&k.after){g.insertAt(k.after,k.layer)}}g.renderAll()}else{var i;g.clear();if(h<0&&k.before){i=k.before}else{if(h>0&&k.after){i=k.after}}d.canvas_width=i.width;d.canvas_height=i.height;g.setDimensions({width:i.width,height:i.height});if(i.objects.filter(function(m){return m.neotype==="bgimage"})[0].filters.filter(function(m){return !!m}).length>0){f.showLoadingImage()}g.loadFromJSON(JSON.stringify(i),function(){var m=f.canvas_scale;f.canvas_scale=100;f.zoomCanvas(m-100);g.renderAll();g.calcOffset()},function(n,m){f.resetBgImg.call(f,n,m)})}f.$dialog.find(".btn_undo").toggleClass("none",f.canvasUndos.length<=0);f.$dialog.find(".btn_redo").toggleClass("none",f.canvasRedos.length<=0);f.hideLoadingImage();setTimeout(function(){NeoEditor.grobalBeforeCanvas=d.getCanvasJSON()},50)},getCanvasJSON:function(){var e=this;var f;f=e.canvas.toJSON();f.width=e.canvas_width;f.height=e.canvas_height;f.scale=e.canvas_scale;return f},resetBgImg:function(l,k){var f=this;var h=f.canvas;if(k.neotype==="bgimage"){f.bgimg=k;f.lockBgImg();f.resetFilterPalette();var m=f.filterIndexes;for(var j=0,e=k.filters.length;j<e;j++){j=parseInt(j,10);if(!k.filters[j]){continue}var g=Object.keys(m).filter(function(i){return m[i]===j});if(g){this.$dialog.find(".jsIedImageSelect").find(".ied-image-select ."+g).closest("li").trigger("click",true)}}k.applyFilters(function(){h.renderAll()})}},setSelectedObjects:function(r){var p=this;var g=p.canvas;var k=g._objects.filter(function(s){return !s.isDragger});var e=g.getActiveObject();var h=g.getActiveGroup();var r=r||{};var f=r.stopExec||function(){return false};var n=r.action||null;var l=false;var o=r.flgSetObjInGrp||false;var m=r.flgSetGrp||false;var j=r.flgReverseLoop||false;var i=true;if(r.flgSetActiveGroup===false){i=false}if(e){if(e.isDragger){e=e.target;g.discardActiveObject();g.setActiveObject(e)}if(f(k,e,h)){return}if(o&&e.type==="group"){if(m){n(e);l=true}e.getObjects().forEach(function(s){n(s);l=true})}else{if(e.neotype!==undefined){n(e);l=true}}}else{if(h){var q=h.getObjects();q.forEach(function(u){if(u.isDragger){h.removeWithUpdate(u);if(q.indexOf(u.target)<0){var t=k.indexOf(u.target);h.addWithUpdate(u.target);for(var v=0,s=q.length;v<s;v++){if(t<k.indexOf(q[v])){h.insertAt(u.target,v);break}}h._objects.pop();h.addWithUpdate()}}});q=h.getObjects();if(q.length>NeoEditor.NEOEDITOR_MAX_EDIT_OBJECT){alert(p.lang.errTooManyObjectSelected.replace("{{count}}",NeoEditor.NEOEDITOR_MAX_EDIT_OBJECT));return}if(f(k,e,h)){return}if(j){q=q.reverse()}b.each(q,function(t,s){if(o&&s.type==="group"){s.getObjects().forEach(function(u){n(u);l=true})}else{n(s);l=true}});if(i){g.discardActiveGroup().setActiveGroup(new fabric.Group(q)).renderAll()}}}if(l){p.addHistory("canvas")}},disableEdit:function(g){var e=this;var f=e.canvas;if(!g){f.getObjects().forEach(function(h){e.disableEdit(h)})}else{if(g!==e.bgimg&&!g.isDragger){g.evented=false;g.hasBorders=false;g.hasControls=false;g.hasRotatingPoint=false;g.selectable=false;g.lockMovementX=true;g.lockMovementY=true;g.lockRotation=true;g.lockScalingX=true;g.lockScalingY=true}}f.selection=false;return g},enableEdit:function(g){var e=this;var f=e.canvas;if(!g){f.getObjects().forEach(function(h){e.enableEdit(h)})}else{if(g!==e.bgimg&&!g.isDragger){g.evented=true;g.hasBorders=true;g.hasControls=true;g.hasRotatingPoint=true;g.selectable=true;g.lockMovementX=false;g.lockMovementY=false;g.lockRotation=false;g.lockScalingX=false;g.lockScalingY=false}}f.selection=true;return g},getAngle:function(h,j,g,i){var f=g-h;var e=i-j;var l=Math.PI;var k=l*2;return(Math.atan2(e,f)+k)%k*180/l},setGraphicCursor:function(){var e=this;var f=e.canvas;f.defaultCursor="crosshair";f.hoverCursor="crosshair";f.moveCursor="crosshair"},setTextCursor:function(){var e=this;var f=e.canvas;f.defaultCursor="text";f.hoverCursor="text";f.moveCursor="text"},setCropCursor:function(){var e=this;var f=e.canvas;f.defaultCursor="crosshair";f.hoverCursor="move";f.moveCursor="move"},setPointerCursor:function(){var e=this;var f=e.canvas;f.defaultCursor="pointer";f.hoverCursor="pointer";f.moveCursor="pointer"},setDefaultCursor:function(){var e=this;var f=e.canvas;f.defaultCursor="default";f.hoverCursor="move";f.moveCursor="move"},filterIndexes:{grayscale:0,sepia:1,noise:2,pixelate:3,emboss:4,brightness:5,vintage:6,antique:7,spotlight:8},addImageFilters:function(){var e=this;var f=function(m,s){var s=s||{};var g=s.grayscale||false;var q=s.brightness||0;var l=s.contrast||0;var h=s.colorize||[0,0,0];var o=Math.pow((l+100)/100,2);for(var n=0,p=m.length;n<p;n+=4){var j=m[n];var k=m[n+1];var r=m[n+2];if(g){j=k=r=(j+k+r)/3}j+=q;k+=q;r+=q;j/=255;j-=0.5;j*=o;j+=0.5;j*=255;k/=255;k-=0.5;k*=o;k+=0.5;k*=255;r/=255;r-=0.5;r*=o;r+=0.5;r*=255;j+=h[0];k+=h[1];r+=h[2];m[n]=j;m[n+1]=k;m[n+2]=r}return m};fabric.Image.filters.Vintage=fabric.util.createClass(fabric.Image.filters.BaseFilter,{type:"Vintage",applyTo:function(h){var g=h.getContext("2d"),j=g.getImageData(0,0,h.width,h.height),i=j.data;i=f(i,{brightness:15,contrast:-25,colorize:[-10,-5,-15]});g.putImageData(j,0,0)}});fabric.Image.filters.Vintage.fromObject=function(g){return new fabric.Image.filters.Vintage(g)};fabric.Image.filters.Antique=fabric.util.createClass(fabric.Image.filters.BaseFilter,{type:"Antique",applyTo:function(h){var g=h.getContext("2d"),j=g.getImageData(0,0,h.width,h.height),i=j.data;i=f(i,{brightness:0,contrast:-30,colorize:[75,50,25]});g.putImageData(j,0,0)}});fabric.Image.filters.Antique.fromObject=function(g){return new fabric.Image.filters.Antique(g)};fabric.Image.filters.Boost=fabric.util.createClass(fabric.Image.filters.BaseFilter,{type:"Boost",applyTo:function(h){var g=h.getContext("2d"),j=g.getImageData(0,0,h.width,h.height),i=j.data;i=f(i,{brightness:0,contrast:-35,colorize:[25,25,25]});g.putImageData(j,0,0)}});fabric.Image.filters.Boost.fromObject=function(g){return new fabric.Image.filters.Boost(g)};fabric.Image.filters.MySepia=fabric.util.createClass(fabric.Image.filters.BaseFilter,{type:"MySepia",applyTo:function(h){var g=h.getContext("2d"),j=g.getImageData(0,0,h.width,h.height),i=j.data;i=f(i,{grayscale:true,brightness:-10,contrast:-20,colorize:[60,30,-15]});g.putImageData(j,0,0)}});fabric.Image.filters.MySepia.fromObject=function(g){return new fabric.Image.filters.MySepia(g)};fabric.Image.filters.Spotlight=fabric.util.createClass(fabric.Image.filters.BaseFilter,{type:"Spotlight",initialize:function(g){g=g||{};this.spotx=g.spotx||1;this.spoty=g.spoty||1;this.radius=g.radius||1;this.blur=g.blur||1},applyTo:function(m){var h=m.getContext("2d"),v=h.getImageData(0,0,m.width,m.height),A=v.data,r=v.height,w=v.width,n,u,s,o,q,g,y;var B=this.spotx;var z=this.spoty;var l=this.radius;var t=this.blur;var p=new fabric.Point(B,z);var x=-60;var C=20;for(u=0;u<r;u++){for(s=0;s<w;s++){n=(u*4)*w+(s*4);var k=p.distanceFrom({x:s,y:u});if(k>l+t){y=x}else{if(k>l){y=C+(x-C)*(k-l)/t}else{y=C}}A[n]+=y;A[n+1]+=y;A[n+2]+=y}}h.putImageData(v,0,0)},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"),{spotx:this.spotx,spoty:this.spoty,radius:this.radius,blur:this.blur})}});fabric.Image.filters.Spotlight.fromObject=function(g){return new fabric.Image.filters.Spotlight(g)}},$loadingImage:b('<div class="ied-loading"/>'),showLoadingImage:function(){this.$loadingImage.appendTo(b(this.canvas.wrapperEl).closest(".ied-edit-wrap"));alert(this.lang.msgStartApplyFilter)},hideLoadingImage:function(){this.$loadingImage.remove()},applyFilter:function(g,h){var e=this;var f=e.canvas;var i=e.bgimg;e.showLoadingImage();i.filters[g]=h;i.applyFilters(function(){f.renderAll();e.hideLoadingImage();d.addHistory("canvas")})},applyFilterValue:function(g,j,h){var e=this;var f=e.canvas;var i=e.bgimg;e.showLoadingImage();i.filters[g][j]=h;i.applyFilters(function(){f.renderAll();e.hideLoadingImage();d.addHistory("canvas")})},addClone:function(i,k){var e=this.canvas;var h;var g;if(i.group){h=i.originalLeft+10;g=i.originalTop+10}else{h=i.left+10;g=i.top+10}if(fabric.util.getKlass(i.type).async){var f=[];if(i.neotype==="bgimage"){f=i.filters;i.filters=[]}i.clone(function(l){l.set({left:h,top:g});if(l.neotype==="bgimage"){l.set("neotype","image")}e.add(l);k(l)});if(f.length>0){i.filters=f}}else{var j=i.clone().set({left:h,top:g});e.add(j);k(j)}},neoClone:function(f){var e;if(!f||typeof f==="undefined"){return null}if(f.type&&fabric.util.getKlass(f.type).async){f.clone(function(g){e=g})}else{if(typeof f=="object"){if(f.neotype){e=f.clone()}else{e=b.extend(true,{},f)}}else{e=b.extend(true,{},f)}}return e},getImageData:function(){var e=this;var f=e.canvas;var g="png";if(!f){return}e.$dialog.find(".ied-edit-tools").children().trigger("iedTurnToolOff");f.discardActiveGroup();f.discardActiveObject();f.getObjects().forEach(function(h){if(h.neotype==="bgimage"){g=h.getSrc().split(".").pop()}});return f.toDataURL({format:g,multiplier:100/e.canvas_scale})},zoomCanvas:function(h){if(h===0){return}var r=this;var e=r.canvas;var f=r.canvas_scale;if(h<0&&f<=20){alert(r.lang.errCanvasSizeLimitSmall);return}var k=f+h||0;if(h>0&&k>200){alert(r.lang.errCanvasSizeLimitLarge);return}r.canvas_scale=k;r.$dialog.find(".ied-edit-menu .scale").text(k+"%");var q=k/f;e.setDimensions({width:e.width*q,height:e.height*q});var p=e.getObjects();var g=e.getActiveGroup(),n;var o=[];if(g){n=g.getObjects();e.discardActiveGroup()}for(var l=p.length-1;l>=0;l--){var j=p[l];j.scaleX*=q;j.scaleY*=q;j.left*=q;j.top*=q;j.setCoords();if(g){var m=n.indexOf(j);if(m>=0){n[m]=j}}}if(g){e.setActiveGroup(new fabric.Group(n));e.renderAll()}e.renderAll()},getGUID:function(){return Math.random().toString(36).slice(-8)},getObjectById:function(h){var e=this;var f=e.canvas;if(typeof h==="undefined"){return f.getObjects()}var g=f.getObjects().filter(function(i){return i.guid===h});if(g.length==1){return g[0]}},getObjectLayerIndex:function(k){var g=this;var h=g.canvas;if(typeof k==="undefined"){return null}var f=h.getObjects();var e=f.length;for(var j=0;j<e;j++){if(k===f[j]){return j}}}})},getInputValue:function(d){var i=d;var g=i.val();var e=parseInt(g,10);var f=parseInt(i.attr("min"),10);var h=parseInt(i.attr("max"),10);if(e!=g||e<f||e>h){e=Math.floor((f+h)/2);i.val(e)}return e},ied_inputChangeValue:function(i){var f=this;var d;var k=i.data.callback;var j=i.data.resultObject?i.data.resultObject:false;var g=b(this);if(NeoEditor.NEOEDITOR_LTE_IE9){clearTimeout(NeoEditor.grobalTimeout);var h=+new Date();NeoEditor.grobalTimeout=setTimeout(function(){if(+new Date()-h>800){if(j){d=g}else{d=NeoEditor.getInputValue(g)}k(d)}},810)}else{clearInterval(NeoEditor.grobalInterval);if(j){d=b(this)}else{d=NeoEditor.getInputValue(b(this))}NeoEditor.grobalInterval=setInterval(function(){if(!NeoEditor.grobalEditActive){k(d);clearInterval(NeoEditor.grobalInterval);return}},100)}}};NeoEditor.init()})(jQuery,document,window);