/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
(function(a){a.widget("ui.formSetUp",{_SEND_DATE_FORMAT:"yy-mm-dd",_NOT_VALIDATE_TYPES:["hidden","file","submit","image","reset","button"],options:{date:true,required:true,validateDate:true,validateOn:"blur.formSetUp"},_init:function(){var b=this;b.options.validateDate=b.options.date&&b.options.validateDate;b.options.validate=b.options.required||b.options.validateDate;if(b.options.date&&a.isFunction(a.fn.datepicker)){b._initDate(b.element.find('input[type="date"]'))}if(b.options.validate){if(b.element.is("form")){b._initForm(b.element)}b._initValidation(b._getToValidate(b.element))}},validate:function(){this._validateForm(this.element)},destroy:function(){var b=this;if(b.options.date&&a.isFunction(a.fn.datepicker)){b._destroyDate(b.element.find('input[data-type="date"]'))}if(b.options.validate){if(b.element.is("form")){b._destroyForm(b.element)}b._destroyValidation(b._getToValidate(b.element))}},_initForm:function(c){var b=this;b.element.bind("submit.formSetUp",function(d){if(!d.isDefaultPrevented()){return b._validateForm(a(this))}});b.element.bind("form-submit-validate.formSetUp",function(g,d,e,h,f){f.veto=!b._validateForm(e)})},_initValidation:function(c){var b=this;if(b.options.required){b._initRequired(c)}if(!!b.options.validateOn){c.bind(b.options.validateOn,function(d){var e=a(this);if(!e.is(":radio")){b._validate(e)}})}},_initRequired:function(b){b.each(function(){var e=a(this);var c=e.attr("required")||e.attr("aria-required");var d=a.type(c)!="undefined"&&c!==false&&c!=="false";e.attr("aria-required",d);e.removeAttr("required")})},_initDate:function(c){var b=this;c.each(function(){var f=a(this);var d=b._convertDateValue(f.val());var h=b._degradeInput(f).val("");var g=a('<input type="hidden" />').insertAfter(h).attr("name",h.attr("name"));var e=b._getWidgetOptions(h,{maxDate:b._convertDateValue(h.attr("max")),minDate:b._convertDateValue(h.attr("min")),altField:g,altFormat:b._SEND_DATE_FORMAT,onSelect:function(j,i){b._validate(a(this))}});h.removeAttr("name").datepicker(e);if(a.type(d)=="date"){h.datepicker("setDate",d)}h.bind("input.formSetUp",function(i){h.trigger("keyup")})})},_destroyForm:function(b){b.unbind("submit.formSetUp");b.unbind("form-submit-validate.formSetUp")},_destroyValidation:function(c){var b=this;if(!!b.options.validateOn){c.unbind(b.options.validateOn)}},_destroyDate:function(c){var b=this;c.each(function(){a(this).datepicker("destroy").unbind("input.formSetUp")})},_validateForm:function(d){var c=this;var b=true;var f={};var e=c._getToValidate(d);e.each(function(){var h=a(this);var g=h.attr("name");if(h.is(":radio")&&!!g){if(f[g]){return}f[g]=true;h=d.find('input[name="'+g+'"]')}if(!c._validate(h)){h.trigger("invalid");b=false}});return b},_validate:function(c){var d=this;var b=true;if(!c.attr("disabled")){if(d.options.required&&!d._validateRequired(c)){b=false}if(d.options.validateDate&&!d._validateDate(c)){b=false}}d._setInvalidClass(c,"ui-invalid",!b);return b},_validateRequired:function(c){var b=true;if(c.filter("[aria-required=true]").length>0){if(c.is(":checkbox,:radio")){b=c.filter(":checked").length>0}else{b=c.val()!=""}}this._setInvalidClass(c,"ui-invalid-missing",!b);return b},_validateDate:function(l){var h,f,b;var k=true,j=true,c=true;var i=l.val();if(l.attr("data-type")=="date"&&!!i){h=l.datepicker("option","dateFormat");f=l.datepicker("option","minDate");b=l.datepicker("option","maxDate");try{var d=a.datepicker.parseDate(h,i);j=!f||d>=f;c=!b||d<=b}catch(g){k=false}}this._setInvalidClass(l,"ui-invalid-mismatch",!k);this._setInvalidClass(l,"ui-invalid-range-underflow",!j);this._setInvalidClass(l,"ui-invalid-range-overflow",!c);return k&&j&&c},_getToValidate:function(b){var c=this;var d=b.find("input").filter(function(){var e=a(this).attr("type");return a.inArray(e,c._NOT_VALIDATE_TYPES)<0});return d.add(c.element.find("textarea"))},_convertDateValue:function(c){try{c=a.datepicker.parseDate(this._SEND_DATE_FORMAT,c)}catch(b){}return c},_degradeInput:function(e){var d,b;var c=e.attr("type");d=a("<div />").html(e.clone()).html();d=d.replace(/\s+type=/,' type="text" data-type=');e.hide();b=a(d).insertAfter(e);b.attr("data-type",c);e.remove();return b},_setInvalidClass:function(d,c,e){var b=d.add(a(d.data("hint")));if(e){b.addClass(c)}else{b.removeClass(c)}},_getWidgetOptions:function(e,b){var d={};var c=e.data("options");if(!!b&&typeof(b)=="object"){a.extend(d,b)}if(!!c&&typeof(c)=="object"){a.extend(d,c)}return d}})})(jQuery);