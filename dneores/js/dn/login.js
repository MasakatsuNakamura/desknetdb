/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
(function(a){desknets.page(desknets,"login",desknets.PageBase,{CMD_LOGINUSERS:"loginusers",PAGE_LICENSELOGIN:"licenselogin",_TMPL_ITEM:'<span title="{{longName}}"><input type="hidden" name="{{keyName}}" value="{{id}}" />&nbsp;{{name}}</span>',_txtLoginTopMsg:null,_defMsg:false,_$mjPage:null,_chooser:null,_$msg:null,init:function(){var e=this;var d=a(".jco-sel-btn");this.callBase("init");this._$mjPage=a("#inputfrm");this._$msg=desknets.pageframe.getTopMsg();this._txtLoginTopMsg=this._$msg.find(".co-topmsg-text-set").html();if(this._$msg.hasClass("alert")||this._$msg.hasClass("info")){this._defMsg=true}if(d.length>0){this._setupGroupChoser()}else{if((typeof jsonRest)!="undefined"){this._initUserSelect()}else{this._dispLoginTopMsg()}}this._initFormRequestAjax("#inputfrm",{error:function(l,j,k){e._onLoginError(l,j,k)},});a(".jlogin-submit").click(function(j){j.preventDefault();e._$mjPage.submit()});var c=a("#login-picture").find("[name=pics]").val();if(c){c=desknets.msUrl+c;desknets.img.view(c,a("#login-picture"))}var h=true;var b=a("#login-bm");var f=b.find(".login-category-in");if(f.find("a").length>0){b.addClass("login-bkmk-on");a("#login-copy").addClass("login-bkmk-on")}var g=b.find(".more").outerWidth();var i=function(){var j=a("body").width();if(h){var k=a(window).width();f.css({width:"auto"});var l=f.outerWidth();if(k<j){k=j}if(l>k){f.css({width:k-(g+25)+"px"});b.find(".more").show()}else{b.find(".more").hide()}}};a(window).resize(function(){i()});i();b.find(".more").click(function(j){j.preventDefault();h=false;b.find(".more").hide();b.find(".solo").removeClass("solo");f.css({width:"auto"})});desknets.submitform.clearDisabled(e._$mjPage)},onSuccessForm:function(b,c){if(neo.isSet(b.rssid,{blank:false})){a(".jlogin-submit").unbind("click");this._login(b)}else{desknets.submitform.clearDisabled(a("#inputfrm"));desknets.login.repwddlg.init(b)}},getSingleRequest:function(){var b={};b.cmd=this.CMD_LOGINUSERS;b.gid=this._$mjPage.find("input[name=gid]").val();return b},onSuccess:function(b){var d=[];d=desknets.ajax.getJsonItems(b);var c=this._$mjPage.find("input[name=svuid]").val();desknets.htmlparts.setSelectOption(this._$mjPage.find("select[name=uid]"),d,"id","Name",{tval:"",tstr:desknets.Resource.optionSelect,selected:c});if(neo.isSet(b.msgdisplimit)){if(this._defMsg){this._$msg.find(".co-topmsg-text-set").html(this._txtLoginTopMsg+"<br/>"+desknets.tmpl.escapeWord(b.msgdisplimit))}else{this._$msg.find(".co-topmsg-text-set").html(desknets.tmpl.escapeWord(b.msgdisplimit));this._$msg.removeClass("alert");this._$msg.addClass("info")}this._dispLoginTopMsg()}else{if(this._defMsg){this._$msg.find(".co-topmsg-text-set").html(this._txtLoginTopMsg);this._dispLoginTopMsg()}else{desknets.pageframe.closeTopMsg()}}},_setupGroupChoser:function(){var b=this;var c={chooseTarget:["group"],mode:"single",selectedTabIndex:1,unassignGroup:"choosable",defaultGroupId:b._$mjPage.find('input[name="gid"]').val(),module:"zrloginconst"};this._chooser=desknets.chooser.setUpEntry(a("#login-input-wrap"),this._getTarget(),{dialogID:"jlogin-choose-dialog",dialogOptions:c,extraVars:{group:{keyName:"gid"}},template:this._TMPL_ITEM,change:function(){if((typeof jsonRest)!="undefined"&&b._chooser==null){b._initUserSelect();delete jsonRest}else{b._changeGroup()}}})},_getTarget:function(){var d=this;var c=[];var b=d._$mjPage.find(".jco-sel-items").find("span");c.push({id:d._$mjPage.find("input[name=gid]").val(),type:"group",name:b.text(),longName:desknets.escapeValue(b.attr("title"))});return c},_dispLoginTopMsg:function(){if(this._$msg.hasClass("alert")){desknets.pageframe.viewTopMsg("","");a("#jlogin-license-link").click(function(b){b.preventDefault();desknets.submitform.clearDisabled(a("#inputfrm"));desknets.login.licensedlg.init()})}else{if(this._$msg.hasClass("info")){desknets.pageframe.viewTopMsg("","")}}this._$msg.find(".co-btn-close").click(function(b){b.preventDefault()})},_changeGroup:function(){this._sendRequestAjax(desknets.ajax.REQTYPE_SINGLE)},_initUserSelect:function(){this.onSuccess(jsonRest)},_login:function(c){var b=this._$mjPage.find("[name=nexturl]").val();desknets.saveCookie(desknets.COOKIENAME_SESSION_ID,c.rssid);desknets.saveCookie(desknets.COOKIENAME_STOKEN,c.STOKEN);if(neo.isSet(c.dnzSv,{blank:false})){desknets.saveCookieToDisk(desknets.COOKIENAME_LOGIN_SAVE,c.dnzSv)}else{desknets.saveCookieToDisk(desknets.COOKIENAME_LOGIN_SAVE,"")}desknets.saveCookieToDisk(desknets.COOKIENAME_LOGIN_INFO,c.id);if(this._$mjPage.find("input[name=starttab]").val()==desknets.DBVAL_STARTTAB_SHARE){desknets.saveCookieToDisk(desknets.COOKIENAME_PORTAL_TAB,desknets.COOKIEVALUE_STARTTAB_SHARE)}desknets.storage.clearPrivateData();desknets.execLocation(b)},_onLoginError:function(d,b,c){if(d.status!=desknets.ERRORNO_LOGIN_LICENSE1&&d.status!=desknets.ERRORNO_LOGIN_LICENSE2){desknets.ajax.onError(d.status,c);return}desknets.login.licensedlg.init()}});desknets.login.repwddlg={_TMPL_FILENAME:"login/repwd.dialog.html",_DIALOG_ID:"login-repwd-dialog",_$dialog:null,init:function(b){this._initLoginRePwd(b)},destroy:function(){if(this._$dialog){desknets.dialog.deleteById(this._DIALOG_ID);this._$dialog=null}},_initLoginRePwd:function(c){var b=this;this._$dialog=desknets.dialog.make(this._DIALOG_ID,this._getDialogOption(c));desknets.dialog.setFirstDialogOpen(this._$dialog);desknets.tmpl.load(this._$dialog,this._TMPL_FILENAME,function(){var d=b._$dialog.prev().find(".ui-dialog-title");d.attr("title",d.text());b._$dialog.dialog("open")})},_getDialogOption:function(e){var b=this;var d=desknets.Resource;var f=d.loginRePwdTitle+"&nbsp;&gt;&nbsp;"+desknets.tmpl.escapeWord(e.Name);var c=a.extend(desknets.dialog.getDialogOption(),{title:f,width:400,top:100,buttons:{},close:function(g){b.destroy()}});c.buttons[d.modLabel]=function(){desknets.submitform.setDialogDisabled(b._$dialog);b._submitLoginRePwd()};c.buttons[d.CancelButtonLabel]=function(){b._$dialog.dialog("close");b.destroy()};return c},_submitLoginRePwd:function(){var b=this;var d;var c;var e;d=desknets.getUrl(desknets.MODULE_API_MAIN);c=a("#jlogin-repwd-frm").formToArrayEx();e=a("#inputfrm").formToArrayEx();a.extend(e,c);desknets.ajax.rest({url:d,data:e,success:function(g,f,h){desknets.login.onSuccessForm(g)},error:function(h,f,g){desknets.ajax.onError(h.status,g);desknets.submitform.clearDialogDisabled(b._$dialog)}})}};(function(b){desknets.page(desknets.login,"licensedlg",desknets.PageBase,{_$dialog:null,init:function(){if(this._$dialog==null){this._sendRequestAjax(desknets.ajax.REQTYPE_SINGLE,desknets.ajax.RESTYPE_HTML)}else{this._$dialog.dialog("open")}},getSingleRequest:function(){var c={};c.cmd=desknets.login.PAGE_LICENSELOGIN;return c},onSuccess:function(c){var d=desknets.ajax.chkAjaxHtmlError(c);if(d.status!="ok"){var e=desknets.dialog.alert(d.message,{errorNo:d.no});return false}b("#jlogin-license-dlg").dialog("destroy").remove();b("body").append(c);this._onSuccess_Dlg();return true},_onSuccess_Dlg:function(){var c=this;var f={};this._$dialog=b("#jlogin-license-dlg");f[desknets.Resource.addLabel]=function(){desknets.submitform.setDialogDisabled(c._$dialog);c._submitLoginLicense()};f[desknets.Resource.CancelButtonLabel]=function(){c._$dialog.dialog("close")};var e=desknets.dialog.getDialogOption();var d={title:desknets.Resource.loginLicenseTitle,width:500,buttons:f};b.extend(e,d);this._$dialog.dialog(e)},_submitLoginLicense:function(){var c=this;var e="";var d={};e=desknets.getUrl(desknets.MODULE_API_MAIN);d=b("#jlogin-license-frm").formToArrayEx();desknets.ajax.rest({url:e,data:d,success:function(g,f,h){desknets.pageframe.closeTopMsg();desknets.login._defMsg=false;c._$dialog.dialog("close")},complete:function(g,f){desknets.submitform.clearDialogDisabled(c._$dialog)}})}})})(jQuery);app.addInitialAction(function(){desknets.login.init()})})(jQuery);