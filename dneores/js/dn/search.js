/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
(function(a){desknets.search={MODULE_SEARCH:"zsearch",MODULE_API_SEARCH:"zrsearch",MODULEID_SCHEDULE:1,MODULEID_PLANT:3,MODULEID_BOARD:6,MODULEID_WORK:7,MODULEID_FLOW:9,MODULEID_MAIL:10,MODULEID_CREPORT:11,MODULEID_FORUM:13,MODULEID_DOC:14,MODULEID_LUNCH:16,MODULEID_PROJECT:17,MODULEID_PAY:18,MODULEID_STOCK:19,MODULEID_MEMP:22,MODULEID_CABINET:23,MODULEID_ENQUETE:25,MODULEID_AGENDA:26,MODULEID_MAILIMAP:28,PAGE_SEARCHALL:"searchalldisp",CMD_SEARCHINDEX:"searchcmdindex",CMD_SEARCHSTOP:"searchcmdstop",CMD_SEARCHBAT:"searchbat",init:function(){var b=a("#jco-pv-funcid").val();desknets.pageframe.setFuncSel(b);if(b==desknets.search.PAGE_SEARCHALL){desknets.hashobserver.init(desknets.search);desknets.search.searchalldisp.init()}},};desknets.page(desknets.search,"searchalldisp",desknets.PageListBatSearchBase,{_mobjListTemplateHeader:{},_mobjListTemplate:{},_mobjListTemplateFooter:"",_mLastModuleId:"",_mViewList:{},_mFuncName:false,_searchingimap:false,_onStopsearchingimap:false,_searchiStopped:false,_mobjResulet:{},_marMailResulet:[],_marMailImapResulet:[],init:function(){var b=this;a("#dn-main").addClass("search-container");b.boErrBack=true;b.callBase("init")},_initSet:function(){var b=this;a("#search-submitbtn").click(function(d){d.preventDefault();var c=a("#search-key");var e=a.trim(c.val());c.val(e);b._searchiStopped=false;desknets.hsearch.setZsearchExec();desknets.hsearch._runSearch("0",null,null,e)});b.callBase("_initSet")},_initListStart:function(){var b=this;b.callBase("_initListStart");b.$mjTableList.delegate(".jsearch-res-title","click",function(d){var e=a(d.target);var c=e.attr("data-mid");if(c==desknets.search.MODULEID_MAIL){d.preventDefault();desknets.webmail.openMailView(e.attr("data-id"),false)}else{if(c==desknets.search.MODULEID_MAILIMAP){d.preventDefault();desknets.webmailimap.openMailView(e.attr("data-id"),e.attr("data-fid"),false)}}});a('select[name="hmodule"]').find("option").each(function(){var d=a(this);var c=d.val();if(c!=""&&c!="0"){b._mViewList[c]=c}})},_getFuncName:function(g){var c=this;var d="";if(c._mFuncName!=false){if(neo.isSet(c._mFuncName[g])){d=c._mFuncName[g]}return d}var e=a("#dn-h-search");var f=e.find("select[name='hmodule']");var b=f.find("option");c._mFuncName=[];b.each(function(){var h=a(this);c._mFuncName[h.val()]=h.text()});if(neo.isSet(c._mFuncName[g])){d=c._mFuncName[g]}return d},_initListStartTemplate:function(){var m=this;var c={};var p={};var u="";c[desknets.search.MODULEID_SCHEDULE]='<li class="sch"><h3>'+m._getFuncName("sch")+'</h3><ol class="search-res">';var i=m.$mjListPage.find(".jsearch-temp-sch");p[desknets.search.MODULEID_SCHEDULE]=i.html();i.remove();c[desknets.search.MODULEID_WORK]='<li class="todo"><h3>'+m._getFuncName("todo")+'</h3><ol class="search-res">';var e=m.$mjListPage.find(".jsearch-temp-todo");p[desknets.search.MODULEID_WORK]=e.html();e.remove();c[desknets.search.MODULEID_MAIL]='<li class="mail"><h3>'+m._getFuncName("mail")+'</h3><ol class="search-res">';var d=m.$mjListPage.find(".jsearch-temp-mail");p[desknets.search.MODULEID_MAIL]=d.html();d.remove();c[desknets.search.MODULEID_PLANT]='<li class="plant"><h3>'+m._getFuncName("plant")+'</h3><ol class="search-res">';var r=m.$mjListPage.find(".jsearch-temp-plant");p[desknets.search.MODULEID_PLANT]=r.html();r.remove();c[desknets.search.MODULEID_FLOW]='<li class="flow"><h3>'+m._getFuncName("flow")+'</h3><ol class="search-res">';var w=m.$mjListPage.find(".jsearch-temp-flow");p[desknets.search.MODULEID_FLOW]=w.html();w.remove();c[desknets.search.MODULEID_CREPORT]='<li class="circle"><h3>'+m._getFuncName("creport")+'</h3><ol class="search-res">';var k=m.$mjListPage.find(".jsearch-temp-circle");p[desknets.search.MODULEID_CREPORT]=k.html();k.remove();c[desknets.search.MODULEID_AGENDA]='<li class="agenda"><h3>'+m._getFuncName("agenda")+'</h3><ol class="search-res">';var l=m.$mjListPage.find(".jsearch-temp-agenda");p[desknets.search.MODULEID_AGENDA]=l.html();l.remove();c[desknets.search.MODULEID_BOARD]='<li class="info"><h3>'+m._getFuncName("info")+'</h3><ol class="search-res">';var o=m.$mjListPage.find(".jsearch-temp-info");p[desknets.search.MODULEID_BOARD]=o.html();o.remove();c[desknets.search.MODULEID_FORUM]='<li class="forum"><h3>'+m._getFuncName("forum")+'</h3><ol class="search-res">';var t=m.$mjListPage.find(".jsearch-temp-forum");p[desknets.search.MODULEID_FORUM]=t.html();t.remove();c[desknets.search.MODULEID_DOC]='<li class="doc"><h3>'+m._getFuncName("doc")+'</h3><ol class="search-res">';var h=m.$mjListPage.find(".jsearch-temp-doc");p[desknets.search.MODULEID_DOC]=h.html();h.remove();c[desknets.search.MODULEID_LUNCH]='<li class="koubai"><h3>'+m._getFuncName("koubai")+'</h3><ol class="search-res">';var g=m.$mjListPage.find(".jsearch-temp-koubai");p[desknets.search.MODULEID_LUNCH]=g.html();g.remove();c[desknets.search.MODULEID_PROJECT]='<li class="prj"><h3>'+m._getFuncName("prj")+'</h3><ol class="search-res">';var s=m.$mjListPage.find(".jsearch-temp-prj");p[desknets.search.MODULEID_PROJECT]=s.html();s.remove();c[desknets.search.MODULEID_PAY]='<li class="pay"><h3>'+m._getFuncName("pay")+'</h3><ol class="search-res">';var q=m.$mjListPage.find(".jsearch-temp-pay");p[desknets.search.MODULEID_PAY]=q.html();q.remove();c[desknets.search.MODULEID_STOCK]='<li class="stock"><h3>'+m._getFuncName("stock")+'</h3><ol class="search-res">';var v=m.$mjListPage.find(".jsearch-temp-stock");p[desknets.search.MODULEID_STOCK]=v.html();v.remove();c[desknets.search.MODULEID_ENQUETE]='<li class="enquete"><h3>'+m._getFuncName("enq")+'</h3><ol class="search-res">';var j=m.$mjListPage.find(".jsearch-temp-enquete");p[desknets.search.MODULEID_ENQUETE]=j.html();j.remove();c[desknets.search.MODULEID_MEMP]='<li class="memp"><h3>'+m._getFuncName("memp")+'</h3><ol class="search-res">';var n=m.$mjListPage.find(".jsearch-temp-memp");p[desknets.search.MODULEID_MEMP]=n.html();n.remove();c[desknets.search.MODULEID_CABINET]='<li class="cab"><h3>'+m._getFuncName("cab")+'</h3><ol class="search-res">';var b=m.$mjListPage.find(".jsearch-temp-cab");p[desknets.search.MODULEID_CABINET]=b.html();b.remove();c[desknets.search.MODULEID_MAILIMAP]='<li class="mailimap"><h3>'+m._getFuncName("mailimap")+'</h3><ol class="search-res">';var f=m.$mjListPage.find(".jsearch-temp-mailimap");p[desknets.search.MODULEID_MAILIMAP]=f.html();f.remove();u="</ol></li>";m._mobjListTemplateHeader=c;m._mobjListTemplate=p;m._mobjListTemplateFooter=u;m.callBase("_initListStartTemplate")},_initListMain:function(){var c=this;var d="";var b=c._getListAjaxGetId();d=desknets.paramanalyzer.getLocationHash();if(d!==""){c.funcHashObserver()}else{if((typeof jsonRest)!="undefined"){c._getListAjaxSuccess(jsonRest)}else{c._listPage("0")}}},inputModPage:function(c){var b=this;b.inputDispPage(arPrm)},_hashUpdateListPage:function(d){var c=this;var e=d.cmd;var b=desknets.paramanalyzer.getHashParams();if(e==desknets.search.PAGE_SEARCHALL){c._getListAjax(b.row)}c.callBase("_hashUpdateListPage",d)},_execLocation:function(f,g,e,b){var c=this;var d="";d=c._createLocationUrl(g,e,b);if(d.length>0){desknets.execLocation(d)}},_createLocationUrl:function(d,g,e){var i=this;var h=desknets.getUrl(d);var f="cmd="+g;var j={};j.bproc=desknets.getProcUrl(true);var c=desknets.getNeoParam(j);var b=h+"?"+f+e+"&"+c;return b},_createBProcUrl:function(){var c=this;var b=desknets.paramanalyzer.getHashParams();var f=desknets.getNeoParam(b);var e=desknets.getUrl(desknets.search.MODULE_SEARCH)+"?cmd="+c._getListCmd()+"#"+f;var d=e.lastIndexOf("/");if(d>=0){e=e.substring(d+1)}e=encodeURIComponent(e);return e},_isExecBatSearch:function(){var b=this;var c=false;c=desknets.hsearch.getZsearchExec();desknets.hsearch.clearZsearchExec();return c},_getRestModule:function(){return desknets.search.MODULE_API_SEARCH},_getListCmd:function(){return desknets.search.PAGE_SEARCHALL},_getListExecCmd:function(){return desknets.search.CMD_SEARCHINDEX},_getStopBatSearchCmd:function(){return desknets.search.CMD_SEARCHSTOP},_getSearchConditionParams:function(){var b=[];b.push("srch_key");return b},_getListDispCmd:function(){},getListParamToObj:function(){var b=this;var c={};objhash=desknets.paramanalyzer.getHashParams();c.srch_key=objhash.srch_key;c.cmd=b._getListExecCmd();if(b._isExecBatSearch()||b._onSrchExec==true){b._searching=true;c.init="1"}b._onSrchExec=false;return c},_getListAjaxSuccess:function(e){var c=this;if(!c._getListAjaxSuccessCheck(e)){return}c._mobjResulet=e;c._marMailResulet=[];c._marMailImapResulet=[];var b=desknets.paramanalyzer.getHashParams();if(neo.isSet(c._mViewList.mail)&&!c._searchiStopped){var h=function(l,k){var j=new Date();var n=neo.dateTime.moveMonth(j,-1);var m=neo.dateTime.format("yyyy/MM/dd",n).split("/");var i={cmd:"mailsearchlist",key:b.srch_key,accid:l,fid:"-"+l,sfolder:"1",target:"0",getpreview:"1",sday:m[2],smonth:m[1],syear:m[0]};var o={dataType:"xml",url:desknets.getUrl("zrweml"),data:i,success:function(p){var q=a(p);var r=[];q.find("item").each(function(){$row=a(this);var t={};t.title=$row.find("subject").text();t.cretime=desknets.dateTime.dispDateTime($row.find("date").text(),"dateTimeFormat");t.name=$row.find("from").text();var u=$row.attr("id").split("_");t.id=u[1];t.mid=""+desknets.search.MODULEID_MAIL;var s=u[0];t.folder="";if(neo.isSet(k)&&neo.isSet(k[s])){t.folder=k[s]}r[r.length]=t});c._marMailResulet=r;c._getSrchMailImap()}};desknets.ajax.rest(o)};var g=function(l){var k={};var m=function(n,o){n.children("item").each(function(){$row=a(this);k[$row.attr("id")]=o+">"+$row.children("Name").text();$child=$row.children("list");if($child.length>0){m($child,k[$row.attr("id")])}})};var i={cmd:"mailfolders"};var j={dataType:"xml",url:desknets.getUrl("zrweml"),data:i,success:function(o){var p=a(o);var n=p.children("result").children("list");n.children("item").each(function(){$row=a(this);var q=$row.children("Name").text();$child=$row.children("list");if($child.length>0){m($child,q)}});h(l,k)}};desknets.ajax.rest(j)};var d={cmd:"mailaccounts"};var f={dataType:"xml",url:desknets.getUrl("zrweml"),data:d,success:function(j){var k=a(j);var i=k.find("defacc").text();if(neo.isSet(i,{blank:false})){g(k.find("defacc").text())}else{c._getSrchMailImap()}}};desknets.ajax.rest(f)}else{c._getSrchMailImap()}},_getSrchList:function(){var c=this;var e=c._mobjResulet;var d=c._marMailResulet;var f=c._marMailImapResulet;c._closeSearchMessageDialog();var h={};jQuery.each(c._mViewList,function(i){if(i=="sch"||i=="todo"||i=="mail"||i=="plant"||i=="flow"||i=="creport"||i=="agenda"||i=="info"||i=="forum"||i=="doc"||i=="koubai"||i=="prj"||i=="pay"||i=="stock"||i=="enq"||i=="memp"||i=="cab"||i=="mailimap"){h[this]=[]}});h.mail=d;h.mailimap=f;var g=desknets.ajax.getJsonItems(e);while(1){var b=g.pop();if(b==null){break}if(b.mid==desknets.search.MODULEID_SCHEDULE){if(neo.isSet(h.sch)){h.sch[h.sch.length]=b}}else{if(b.mid==desknets.search.MODULEID_WORK){if(neo.isSet(h.todo)){h.todo[h.todo.length]=b}}else{if(b.mid==desknets.search.MODULEID_PLANT){if(neo.isSet(h.plant)){h.plant[h.plant.length]=b}}else{if(b.mid==desknets.search.MODULEID_FLOW){if(neo.isSet(h.flow)){h.flow[h.flow.length]=b}}else{if(b.mid==desknets.search.MODULEID_CREPORT){if(neo.isSet(h.creport)){h.creport[h.creport.length]=b}}else{if(b.mid==desknets.search.MODULEID_AGENDA){if(neo.isSet(h.agenda)){h.agenda[h.agenda.length]=b}}else{if(b.mid==desknets.search.MODULEID_BOARD){if(neo.isSet(h.info)){h.info[h.info.length]=b}}else{if(b.mid==desknets.search.MODULEID_FORUM){if(neo.isSet(h.forum)){h.forum[h.forum.length]=b}}else{if(b.mid==desknets.search.MODULEID_DOC){if(neo.isSet(h.doc)){h.doc[h.doc.length]=b}}else{if(b.mid==desknets.search.MODULEID_LUNCH){if(neo.isSet(h.koubai)){h.koubai[h.koubai.length]=b}}else{if(b.mid==desknets.search.MODULEID_PROJECT){if(neo.isSet(h.prj)){h.prj[h.prj.length]=b}}else{if(b.mid==desknets.search.MODULEID_PAY){if(neo.isSet(h.pay)){h.pay[h.pay.length]=b}}else{if(b.mid==desknets.search.MODULEID_STOCK){if(neo.isSet(h.stock)){h.stock[h.stock.length]=b}}else{if(b.mid==desknets.search.MODULEID_ENQUETE){if(neo.isSet(h.enq)){h.enq[h.enq.length]=b}}else{if(b.mid==desknets.search.MODULEID_MEMP){if(neo.isSet(h.memp)){h.memp[h.memp.length]=b}}else{if(b.mid==desknets.search.MODULEID_CABINET){if(neo.isSet(h.cab)){h.cab[h.cab.length]=b}}}}}}}}}}}}}}}}}}c._makeSrchList(h);c._setItemsHref(c.$mjTableList)},_makeSrchList:function(e){var c=this;var d=0;var b=desknets.paramanalyzer.getHashParams();a("#search-key").val(b.srch_key);c.$mjTableList.empty();c.$mjTableList.show();c.$mjListPage.find(".co-nodata").hide();c.changPage();jQuery.each(e,function(g){var m=e[g];var j=[];var h=[];var f=0;var k=0;var i=c._mcListTemplate;var l="";f=m.length;for(k=0;k<f;k++){j=m[k];h[h.length]=c._listLine(i,j)}h[h.length]=c._listLineEnd();c.$mjTableList.append(h.join(""));d=d+f});if(d==0){c.$mjTableList.hide();c.$mjListPage.find(".co-nodata").show()}},_listLine:function(e,g){var d=this;var c="";var b="";var f=d._mobjListTemplate[g.mid];if(d._mLastModuleId!=g.mid){if(d._mLastModuleId.length>0){b=d._mobjListTemplateFooter}c=d._mobjListTemplateHeader[g.mid];d._mLastModuleId=g.mid}f=b+c+f;return d.callBase("_listLine",f,g)},_listLineEnd:function(){var c=this;var b="";if(c._mLastModuleId.length>0){b=c._mobjListTemplateFooter}c._mLastModuleId="";return b},_setItemsHref:function(b){var c=this;b.find("a.jsearch-res-title").each(function(){var j="#";var e=a(this);var g=e.attr("data-mid");var i=e.attr("data-mname");var f=e.attr("data-mtopcmd");var d=e.attr("data-param");var h=e.attr("data-url");if(g==desknets.search.MODULEID_MAIL){j=desknets.webmail.getUrlMailView(e.attr("data-id"))}else{if(g==desknets.search.MODULEID_MAILIMAP){j=desknets.webmailimap.getUrlMailView(e.attr("data-id"),e.attr("data-fid"))}else{if(h.length>0){j=h}else{j=c._createLocationUrl(i,f,d)}}}e.attr("href",j)})},_getListAjaxSuccessCheck:function(c){var b=this;b._setExecSearchPrm();if(c.searching=="1"){b.observe();b._openSearchMessageDialog();return false}return true},_closeSearchMessageDialog:function(){var b=this;var c=b.$dialogexec;if(!!c&&c.dialog("isOpen")){c.dialog("close")}},onSrchStop:function(){var b=this;b._searchiStopped=true;if(b._searchingimap==true){b._onSrchStopImap()}else{b.callBase("onSrchStop")}},_setSearchingImap:function(b){var c=this;c._searching=!!b;c._searchingimap=!!b},_getSrchMailImap:function(){var b=this;if(neo.isSet(b._mViewList.mailimap)&&!b._searchiStopped){b._checkImapAccount()}else{b._getSrchList()}},_checkImapAccount:function(){var b=this;var c={cmd:"mailaccountentry"};var d={dataType:"xml",url:desknets.getUrl("zrwimapeml"),data:c,success:function(e){var f=a(e);var g=f.find("userid").text();if(neo.isSet(g,{blank:false})){b._getImapFolder()}else{b._getSrchList()}}};desknets.ajax.rest(d)},_getImapFolder:function(){var d=this;var b={cmd:"mailfolders"};var c={dataType:"xml",url:desknets.getUrl("zrwimapeml"),data:b,success:function(g){var h=a(g);var f=h.children("result").children("list");var e={};if(f.length>0){d._makeImapFolderNameList(e,f,null)}d._searchImapMail(e)},error:function(f,e,g){d._getSrchList()}};desknets.ajax.rest(c)},_makeImapFolderNameList:function(d,c,e){var b=this;c.children("item").each(function(){$row=a(this);var f="";if(neo.isSet(e)){f=e+">"}d[$row.attr("id")]=f+$row.children("Name").text();$child=$row.children("list");if($child.length>0){b._makeImapFolderNameList(d,$child,d[$row.attr("id")])}})},_searchImapMail:function(b){var j=this;var e=j.$dialogexec;if(!e||!e.dialog("isOpen")){j._getImapSerchResult(b);return}var i=desknets.paramanalyzer.getHashParams();var f=new Date();var g=neo.dateTime.moveMonth(f,-1);var h=neo.dateTime.format("yyyy-MM-dd",g);var d={cmd:"mailsearch",key:i.srch_key,fid:"",sfolder:"1",from:"1",tocc:"1",subject:"1",body:"1",sdate:h};var c={dataType:"xml",url:desknets.getUrl("zrwimapeml"),data:d,success:function(k){j._getImapSerchResult(b)},error:function(l,k,m){j._setSearchingImap(false);j.onError(l.status,m)}};j._setSearchingImap(true);desknets.ajax.rest(c)},_getImapSerchResult:function(d){var c=this;if(c._onStopsearchingimap==true){return}var b={cmd:"mailsearchlist"};var e={dataType:"xml",url:desknets.getUrl("zrwimapeml"),data:b,success:function(f){c._setSearchingImap(false);if(c._searchiStopped==true){return}var g=a(f);var h=[];g.find("item").each(function(){$row=a(this);var k={};k.title=$row.find("subject").text();k.cretime=desknets.dateTime.dispDateTime($row.find("date").text(),"dateTimeFormat");k.name=$row.find("from").text();var j=$row.attr("id");var l=j.lastIndexOf("_");k.id=j.slice(l+1);k.mid=""+desknets.search.MODULEID_MAILIMAP;var i=j.slice(0,l);k.fid=i;k.folder="";if(neo.isSet(d)&&neo.isSet(d[i])){k.folder=d[i]}h[h.length]=k});c._marMailImapResulet=h;c._getSrchList()},error:function(h,g,i){if(!!h.responseXML){var f=a(h.responseXML).find("errorno").text();if(f=="1"){c._observeImap(d);return}}c._setSearchingImap(false);c.onError(h.status,i)}};desknets.ajax.rest(e)},_observeImap:function(d){var c=this;var b=c._getSearchInterval();if(c._searchingimap==false){return}setTimeout(function(){if(!!c._searchingimap){c._getImapSerchResult(d)}},b)},_onSrchStopImap:function(){var b=this;var c={};b._setSearchingImap(false);b._onStopsearchingimap=true;desknets.submitform.setDialogDisabled(b.$dialogexec);c.cmd="mailsearchstop";desknets.ajax.rest({dataType:"xml",url:desknets.getUrl("zrwimapeml"),data:c,success:function(e,d,f){b._onStopsearchingimap=false;setTimeout(function(){b._getSrchList()},100)},error:function(e,d,f){b.onError(e.status,f)}})},});app.addInitialAction(function(){desknets.search.init()})})(jQuery);