/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
(function(a){a.extend(desknets.menu,{getBProcToList:function(b){return desknets.encodeURIComponentNeo("dneo."+desknets.getExtension()+"?cmd="+b+"#"+window.location.hash)},initListConditionData:function(d,b){for(var c in d){d[c]=a('<input type="hidden" >').appendTo(b)}},updateListConditionData:function(c,d){for(var b in c){if(!!d[b]){c[b].attr("name",b)}else{c[b].removeAttr("name")}}}});desknets.menu.group={$dialog:a(),_$form:a(),_$icon:a(),open:function(e,c,d){var b=this;if(this.$dialog.length<=0){this._createDialog(function(){b._showDialog(e,c,d)})}else{this._showDialog(e,c,d)}},_createDialog:function(e){var b=this;var c=this._getDialogOptions();var d=desknets.dialog.make("jco-menu-group",c);desknets.tmpl.load(d,"set/menu.group.html",function(){b.$dialog=d;b._setUpDialog();e()})},_setUpDialog:function(){var b=this;this._$form=this.$dialog.find("form");this._$icon=this.$dialog.find(".jco-menu-group-icon-entry");desknets.menu.icon.setUp(this._$icon);desknets.ajax.submitForm(this._$form,{url:desknets.getUrl(desknets.MODULE_API_MAIN),dataType:"xml",beforeSubmit:function(){desknets.submitform.setDialogDisabled(b.$dialog)},errorconvmsg:function(c,d){return b._convertErrorMessage(c,d)},success:function(c){b.$dialog.trigger("menuGroupPut",c)},complete:function(){desknets.submitform.clearDialogDisabled(b.$dialog)}})},_showDialog:function(e,c,d){var b=this;this._setFormValues(e,a.extend({id:"",Name:"",icon:"/dneores/images/com/menu/group_yellow.png"},d));this.$dialog.off("menuGroupPut").on("menuGroupPut",function(g,f){c(b._getSavedValues(e,a(f)));b.$dialog.dialog("close")});this.$dialog.dialog("open")},_getDialogOptions:function(){var b=this;var c=desknets.dialog.getDialogOption();a.extend(c,{width:500,buttons:{}});c.buttons[desknets.Resource.OKButtonLabel]=function(){b._$form.submit()};c.buttons[desknets.Resource.CancelButtonLabel]=function(){b.$dialog.dialog("close")};return c},_convertErrorMessage:function(c,d){var b=desknets.getErrField(c,d);if(!!b.fieldid){b.fieldname=desknets.getErrFieName(this._$form,b.fieldid)}return desknets.getErrConvMsg(b)},_setFormValues:function(c,b){var d=desknets.Resource.menu;this._$form.resetForm();this._$form.find('input[name="cmd"]').val(c=="P"?"psetcmdmenugroupentry":"setcmdmenugroupentry");neo.form.setFormValues(this._$form,b);desknets.menu.icon.setInitialValue(this._$icon,b.icon);this.$dialog.dialog("option","title",!!b.id?d.groupModifyTitle:d.groupCreateTitle)},_getSavedValues:function(e,d){var f=d.find("id").text(),c=d.find("menufilename").text();var b=this._$form.find('input[name="Name"]').val();return{id:f,Name:b,icon:c}}};desknets.page(desknets.menu,"PageMenuListBase",desknets.PageInputList,{pageBookmarkList:"",buttonAreas:{bookmark:a()},area:"",kind:"module",_$menuContents:a(),_$select:a(),_tmpls:{},_listData:{kind:a(),folder:a(),srch_key:a()},_initListStart:function(){this.callBase("_initListStart");this._initTemplate();desknets.menu.initListConditionData(this._listData,this.$mjListPage.find(".jco-back-page-data"));this._initBookmarkButtons();this._initKind()},_initListSortable:function(){this.callBase("_initListSortable");this._listSortable.setSortable(false)},_getListSortableOptions:function(c){var b=this;return{dragToExternal:true,draggableOptions:{appendTo:this.$mjListPage,zIndex:2}}},_listMoveScroll:function(){var c=this._getListCmd();var b=this.$mjListPage.find(".co-menu-scroll");desknets.scrollManager.setScrollPosition(c,b,{y:0,delay:10})},_hashUpdateListPage:function(b){this.kind=b.kind||"module";desknets.menu.updateListConditionData(this._listData,b);this.callBase("_hashUpdateListPage",b)},changPage:function(){this.callBase("changPage");if(this._$menuContents.length<=0){this._$menuContents=this.$mjListPage.dneoMenuContents({area:this.area})}this._updateBookmarkButton();this._updateKind()},_getListAjaxSuccess:function(e){this.callBase("_getListAjaxSuccess",e);var d=String(this.kind).indexOf("bookmark")>=0;var b=!e.Name;var f=b&&d?"addClass":"removeClass";if(d){var c=b?"("+desknets.Resource.allLabel+")":desknets.escapeSpace(e.Name,true);this.$mjListPage.find(".jco-menu-folder-name").text(c).attr("title",c)}this.$mjListPage.find(".co-menu-main-pane")[f]("root-folder")},_listLineEnd:function(){if(desknets.browser.msie8){var b=this;var c=this.$mjListPage.find("table.co-table-list");setTimeout(function(){var d,e=c.find("thead > tr."+b.kind+" > :visible").length;c.each(function(){var f=a(this),g=f.children("colgroup").empty();if(g.length<=0){g=a("<colgroup />").prependTo(f)}for(d=0;d<e;d++){g.append("<col />")}})},1)}return""},_formObserveisChanged:function(){var b=this._$menuContents;return b.length>0&&b.dneoMenuContents("isEditing")},_getBeforeUnloadMsg:function(){return desknets.Resource.Message.com_menu_move_without_save},_getRestModule:function(){return desknets.MODULE_API_MAIN},_getMoveExecCmd:function(){return"x"},_initTemplate:function(){var b=this;this.$mjListPage.find("script.jco-list-tmpl").each(function(){var c=a(this);b._tmpls[c.data("kind")]=c.html()})},_initBookmarkButtons:function(){var c=this;var b=desknets.paramanalyzer.getHashParams()||{};for(var d in this.buttonAreas){this.buttonAreas[d]=this.$mjListPage.find(".co-menu-bookmark-btnarea."+d);this.buttonAreas[d].dneoMenuBookmarkButtons({area:d=="bookmark"?"S":"P",folderId:b.folder||"",params:b,change:function(e,f){var g=a.extend({cmd:c._getListCmd(),kind:c.kind},f);c.boChangePageNoHide=true;desknets.paramanalyzer.setLocationHash(g)}})}url=desknets.getUrl("zportalset")+"?cmd="+this.pageBookmarkList;this.$mjListPage.find(".co-menu-link-to-bookmark > a").attr("href",url)},_initKind:function(){var b=this;this._listData.kind.attr("name","kind");this._$select=this.$mjListPage.find(".co-menu-kind-select>select");this._$select.change(function(){for(var c in b.buttonAreas){var d=b.buttonAreas[c].dneoMenuBookmarkButtons("option","area");desknets.chooser.singleGroup.destroy("jmenu-menulist-bookmark-dialog-"+d)}desknets.paramanalyzer.setLocationHash({cmd:b._getListCmd(),kind:b._$select.val()})})},_updateBookmarkButton:function(){var b=desknets.paramanalyzer.getHashParams()||{};if(!!this.buttonAreas[this.kind]){this.buttonAreas[this.kind].dneoMenuBookmarkButtons("setKeyword",b.srch_key||"")}},_updateKind:function(){var b=this;this.$mjListPage.find(".co-menu-main-pane").removeClass("module optmenu bookmark pbookmark").addClass(this.kind);this.$mjListPage.find(".co-tbody-list").data("kind",this.kind);if(this.kind!=this._$select.val()){this._$select.val(this.kind)}}});a.widget("desknets.dneoMenuContents",{_INSERT_RANGE:0.2,widgetEventPrefix:"menucontents",options:{area:"S"},_$list:a(),_$active:a(),_tmplItem:"",_tmplGroupItem:"",_isEditing:false,_create:function(){this._$list=this.element.find(".co-menu-root-list");this._tmplItem=this.element.find("script.jco-menu-tmpl").html();this._tmplGroupItem=this.element.find("script.jco-menu-group-tmpl").html();desknets.menu.bar.setUp(this.element.find(".co-menu-side-pane"));this._initLayout();this._initButtons();this._initItemList()},isEditing:function(){return this._isEditing},_initLayout:function(){var b=this;a(window).on("resize.dneoMenuContents",function(){b._updateHeight()});this._updateHeight();desknets.listviewspliter.create(this.element.find(".co-menu-container"),null,true,{minSize:103,maxSize:desknets.listviewspliter.VAL_LISTVIEWSPLITER_RAYOUTSIZE,west__onopen:function(){b.element.trigger("layoutchange.dneoMenuContents")},west__onclose:function(){b.element.trigger("layoutchange.dneoMenuContents")},west__onresize:function(){b.element.trigger("layoutchange.dneoMenuContents")}})},_initButtons:function(){var b=this;this.element.find(".jco-menu-save-btn").click(function(){b._saveContents()});this.element.find(".jco-menu-add-group").click(function(){b._openGroupDialog()});this.element.find(".jco-menu-mod-group").click(function(){b._openGroupDialog(b._$active)});this.element.find(".jco-menu-del-group").click(function(){b._deleteContentItem(b._$active)})},_initItemList:function(){var b=this;this._setUpRootListItems(this._$list.find("> li > .co-menu-item"));this.element.on("click",".jco-menu-remove-btn",function(c){c.preventDefault();b._deleteContentItem(a(this).closest("li"))});this._$list.on("click","li",function(){b._selectGroup(a(this))});this._$list.droppable({accept:".co-menu-item, .co-tbody-list",tolerance:"pointer",over:function(c,d){b._startToDragItem()},out:function(c,d){b._endToDragItem()},drop:function(c,d){b._onDropOnRootList(d.draggable)}});this.element.find(".co-menu-static-list").droppable({accept:".co-menu-item, .co-tbody-list",tolerance:"pointer",over:function(c,d){b._onDragOnRootList(0)},out:function(c,d){b._cleanInsertTargetElement()},drop:function(c,d){b._onDropOnRootList(d.draggable)}});this.element.find(".co-menu-toggle-btn").droppable({accept:".co-menu-item, .co-tbody-list",tolerance:"pointer",over:function(c,d){b._onDragOnRootList(65535)},out:function(c,d){b._cleanInsertTargetElement()},drop:function(c,d){b._onDropOnRootList(d.draggable)}})},_setUpRootListItems:function(c){var b=this;c.each(function(){var e=a(this),d=c.siblings(".co-menu-list-in-group");e.draggable({handle:".co-handle",appendTo:b._$list.closest(".co-menu-side-pane"),cursorAt:{left:-5,top:0},helper:function(f){return b._createDragHelperInMenu(a(this))},start:function(f){a(this).addClass("jco-menu-item-dragging")},stop:function(f){a(this).removeClass("jco-menu-item-dragging")}});if(d.length>0){d.children("ul").sortable({tolerance:"pointer",placeholder:"co-menu-placeholder",start:function(f){a(this).addClass("co-menu-item-dragging")},stop:function(f){a(this).removeClass("co-menu-item-dragging")},update:function(f){b._trigger("change");b._isEditing=true}});d.appendTo(b.element)}})},_createContentItem:function(d,e){var c=this._tmplItem;var b=a("<li />").attr("data-kind",d).attr("data-did",e.id);if(!!e.hidden){b.addClass("hidden")}c=desknets.tmpl.replaceWordHtml(c,"id",e.id);c=desknets.tmpl.replaceWord(c,"icon",e.icon);c=desknets.tmpl.replaceWord(c,"name",e.Name);return b.html(c)},_deleteContentItem:function(b){var d=b.find(".co-menu-item").data("for");if(!!d){var c=a("#"+d);c.find(".co-menu-sub-list").sortable("destroy");c.remove()}b.draggable("destroy");b.remove();this._updateGroupButton();this._trigger("change");this._isEditing=true},_openGroupDialog:function(c){var b=this,d=null;if(!!c){d={id:c.data("did"),Name:c.find(">.co-menu-item .co-menu-title").text(),icon:c.find(">.co-menu-item .co-menu-icon").attr("src")}}desknets.menu.group.open(this.options.area,function(e){b._createOrModifyGroupItem(e)},d)},_createOrModifyGroupItem:function(c){var b=this._$list.children().filter(function(){var d=a(this);return d.data("kind")=="group"&&d.data("did")==c.id});if(b.length>0){b.find(">.co-menu-item .co-menu-title").text(c.Name);b.find(">.co-menu-item .co-menu-icon").attr("src",c.icon)}else{b=this._createGroupItem(c);this._$list.append(b);this._setUpRootListItems(b.children(".co-menu-item"))}this._trigger("change");this._isEditing=true},_createGroupItem:function(d){var c=this._tmplGroupItem;var b=a("<li />").attr("data-kind","group").attr("data-did",d.id);c=desknets.tmpl.replaceWordHtml(c,"id",d.id);c=desknets.tmpl.replaceWord(c,"icon",d.icon);c=desknets.tmpl.replaceWord(c,"name",d.Name);return b.html(c)},_selectGroup:function(b){this._$list.children(".active").removeClass("active");if(b.children(".jco-menu-group").length>0){b.addClass("active")}this._updateGroupButton()},_updateGroupButton:function(){var b=this.element.find(".jco-menu-mod-group, .jco-menu-del-group");this._$active=this._$list.children(".active");if(this._$active.length>0){b.prop("disabled",false)}else{b.prop("disabled",true)}},_startToDragItem:function(){var b=this;this._$list.on("mousemove.MenuContents",function(c,d){b._onDragOnRootList(c.pageY)})},_endToDragItem:function(){this._$list.off("mousemove.MenuContents");this._cleanInsertTargetElement()},_createDragHelperInMenu:function(b){return a('<div id="co-dragtip" />').text(b.find(".co-menu-title").text())},_cleanInsertTargetElement:function(){this._$list.children(".co-menu-placeholder").remove();this._$list.children(".drag-over").removeClass("drag-over")},_onDragOnRootList:function(c){var b=this._getInsertTarget(c);if(b.item.length<=0){if(this._$list.find(".co-menu-placeholder").length<=0){a('<li class="co-menu-placeholder" />').appendTo(this._$list)}}else{if(b.proc=="-"){if(!b.item.prev().hasClass(".co-menu-placeholder")){this._cleanInsertTargetElement();a('<li class="co-menu-placeholder" />').insertBefore(b.item)}}else{if(b.proc=="+"){if(!b.item.next().hasClass(".co-menu-placeholder")){this._cleanInsertTargetElement();a('<li class="co-menu-placeholder" />').insertAfter(b.item)}}else{if(b.proc==""){if(this._canDropOn(b.item)&&!b.item.hasClass(".drag-over")){this._cleanInsertTargetElement();b.item.addClass("drag-over")}}}}}},_getInsertTarget:function(f){var g=this._$list.children(":not(.co-menu-placeholder)");for(var c=0;c<g.length;c++){var b=g.eq(c);var e=b.offset(),d=b.outerHeight();if(f<=e.top+d*this._INSERT_RANGE){return{item:b,proc:"-"}}else{if(f<=e.top+d*(1-this._INSERT_RANGE)){return{item:b,proc:""}}}}return{item:g.eq(-1),proc:"+"}},_canDropOn:function(b){if(this._$list.find(".jco-menu-item-dragging").hasClass("jco-menu-group")){return false}if(b.children(".jco-menu-group").length<=0){return false}return true},_onDropOnRootList:function(d){var c=this._getItemsToMove(d),b,e;b=this._$list.children(".co-menu-placeholder");if(b.length>0){c.insertBefore(b)}e=this._$list.children(".drag-over").data("did");b=this.element.find("#jco-menu-list-in-group-"+e+"-edit > ul");if(b.length>0){c.appendTo(b)}if(d.hasClass("co-tbody-list")){this._deselectAllInList(d.closest(".co-menu-main-pane"))}this._setUpRootListItems(c.children(".co-menu-item:not(.ui-draggable)"));this._endToDragItem();this._trigger("change");this._isEditing=true},_getItemsToMove:function(d){if(d.hasClass("co-menu-item")){return d.closest("li")}if(d.hasClass("co-tbody-list")){var e=a(),b=this,c=d.data("kind");d.find(".co-tr-selected").each(function(){$this=a(this);e=e.add(b._createContentItem(c,{id:$this.find(".jco-id").val(),Name:$this.find(".jco-menu-name").text(),icon:$this.find(".jco-menu-icon").attr("src"),hidden:Number($this.data("hidden"))>0}))});return e}},_saveContents:function(){var b=this,d=[];var c=this.options.area=="P"?"psetcmdmenulistentry":"setcmdmenulistentry";this._collectMenuContents(d,this._$list,null);desknets.ajax.rest({url:desknets.getUrl(desknets.MODULE_API_MAIN),data:{cmd:c,menu:d},success:function(){b._trigger("save");desknets.menu.reload();b._isEditing=false;desknets.dialog.alert(desknets.Resource.Message.com_setting_changed)}})},_collectMenuContents:function(c,e,d){var b=this;e.children().each(function(){var g=a(this),f=g.data("did");c.push(b._getMenuContentKey(g,f,d));if(g.data("kind")=="group"){var h=b.element.find("#jco-menu-list-in-group-"+f+"-edit > ul");if(h.length>0){b._collectMenuContents(c,h,f)}}})},_getMenuContentKey:function(c,b,d){var g=c.data("id"),e=c.data("kind");var f=!!g?g:b+"@"+e;if(!!d){f+=","+d}return f},_updateHeight:function(){desknets.listviewframe.updateListHeight(this.element.find(".co-setmenu-tab-content"),false,false)},_deselectAllInList:function(b){var c=b.find(".jco-checkbox-all").prop("checked",false);setTimeout(function(){var d=a.Event("click");d.preventDefault();c.trigger(d)},1)}});a.widget("desknets.dneoMenuBookmarkButtons",{widgetEventPrefix:"menucontents",options:{params:{},area:"S",folderId:null},_$searchInput:a(),_propertyChanging:false,_create:function(){var b=this;this._$searchInput=this.element.find(".co-list-search-text");this._filterParams();this.element.find(".jco-menu-folder-btn").click(function(){b._openFolderChooser()});this.element.find(".co-list-search-btn>a").click(function(c){c.preventDefault();b._startKeywordSearch()});desknets.watermark.set(this._$searchInput);desknets.keysearch.setUp(this.options.area,this._$searchInput,function(){b._startKeywordSearch()})},setKeyword:function(b){if(this._$searchInput.val()!=b){this._propertyChanging=true;this._$searchInput.val(b).blur();this._propertyChanging=false}},_filterParams:function(){var b=this,c={};a.each(["folder","srch_key"],function(e,d){if(!!b.options.params[d]){c[d]=b.options.params[d]}});this.options.params=c},_openFolderChooser:function(){var b=this,c=this.options.area;desknets.chooser.open("jmenu-menulist-bookmark-dialog-"+c,{title:desknets.Resource.folderselect.dialogTitleFolderSelect,module:"zrportalset",cmdgroups:c=="S"?"portalcmdfolders":"portalpsetcmdfolders",cmdgrouptree:c=="S"?"portalcmdfoldersroot":"portalpsetcmdfoldersroot",defaultGroupId:this.options.folderId,treePageInstance:desknets.folderSelectTree,leafChoosable:true,mode:"single",chooseTarget:["group"],allGroup:"choosable",load:function(){a(this).addClass("co-sel-single-folder")},choose:function(d){if(d.length>0){var e=d[0].id=="all"?"":String(d[0].id);b._changeParam("folder",e)}}})},_startKeywordSearch:function(){var b=String(this._$searchInput.val());this._changeParam("srch_key",String(this._$searchInput.val()))},_changeParam:function(b,c){if(c.length>0){this.options.params[b]=c}else{if(!!this.options.params[b]){delete this.options.params[b]}}if(!this._propertyChanging){this._trigger("change",null,this.options.params)}}})})(jQuery);