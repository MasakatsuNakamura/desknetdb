/*
 * desknet's NEO
 * https://www.desknets.com/
 * Copyright (C)2012-2016 NEOJAPAN Inc. All Rights Reserved.
 * 本製品は日本国著作権法および国際条約により保護されています。 
 * 本製品の全部または一部を無断で複製したり、無断で複製物を頒 
 * 布すると著作権の侵害となりますのでご注意ください。 
 */
(function(a){desknets.safety={MODULE_API_SAFETY:"zrsafety",CMD_SAFETYLIST:"safetycmdlist",CMD_SAFETYCMDINPUT:"safetycmdinput",CMD_SAFETYCMDCONTENTRY:"safetycmdcontentry",CMD_SAFETYCMDEMERGENCYCONTACT:"safetycmdemergencycontact",CMD_SAFETYDISASTERINFO:"safetycmddisasterinfolist",CMD_SAFETYCMDDISASTERPREPLINK:"safetycmddisasterpreplink",CMD_SAFETYCMDEVACUATIONROUTELIST:"safetycmdevacuationroutelist",CMD_SAFETYCMDEVACUATIONROUTEINFO:"safetycmdevacuationrouteinfo",getMapAPIUrl:function(d,f,e,b,i,m,h){b=neo.isSet(b)?b:"";i=neo.isSet(b)?i:"";m=neo.isSet(b)?m:"";h=neo.isSet(b)?h:"";var g=new RegExp("\\$START","ig");var l=new RegExp("\\$GOAL","ig");var k=new RegExp("\\$SLAT","ig");var c=new RegExp("\\$SLON","ig");var j=new RegExp("\\$DLAT","ig");var n=new RegExp("\\$DLON","ig");f=desknets.encodeURIComponentNeo(f);e=desknets.encodeURIComponentNeo(e);b=desknets.encodeURIComponentNeo(b);i=desknets.encodeURIComponentNeo(i);m=desknets.encodeURIComponentNeo(m);h=desknets.encodeURIComponentNeo(h);d=d.replace(g,function(o,p,q){return f}).replace(l,function(o,p,q){return e}).replace(k,function(o,p,q){return b}).replace(c,function(o,p,q){return i}).replace(j,function(o,p,q){return m}).replace(n,function(o,p,q){return h});return d}};a.extend(desknets.safety,{MODULE_MAIN_SAFETY:"zsafety",CMD_SAFETY:"safety",PAGE_SAFETYLIST:"safetylist",CMD_SAFETYREPORTLIST:"safetycmdreportlist",init:function(){var c=this;var b=a("#jco-pv-funcid").val();if(c.isSafety(b)){desknets.hashobserver.init(desknets.safety);desknets.pageframe.setFuncSel(b)}if(b==desknets.safety.PAGE_SAFETYLIST){desknets.safety.safetylist.init();desknets.safety.safetytop.init()}},isSafety:function(c){var b=this;if(c.indexOf(b.CMD_SAFETY)>=0&&c.indexOf("pset")==-1&&c.indexOf("mset")==-1){return true}return false}});desknets.page(desknets.safety,"disasterinfo",desknets.PageBase,{sId:1,eId:-1,timerInterval:1000*60*3,timerObserver:null,$mjListPage:null,nowLoading:false,bottom_flag:false,noMorePassedInfo:false,htmlListTemplate:'<li class="safety-info-list-item">   <div class="uname">&gt;{{Group}} {{entryname}}</div>   <div class="message">{{memo}}</div>   <div class="date">{{date}}</div></li>',tmplNoInfoData:null,init:function(){var b=this;b.callBase("init");this._initDisasterList()},_initDisasterList:function(){var b=this;b.$mjListPage=a("."+b._getListDataClass());b._pageListData(jsonRest);b._setListObserver()},_getListData:function(c){var j=this;var f=null;var g=null;var b=desknets.getUrl(j._getRestModule());var e=j._getListExecCmd();var i=j._getMaxRow();var h={cmd:e,num:i};var d="";if(j.nowLoading){return}clearTimeout(j.timerObserver);if(c=="new"){d=parseInt(j.eId,10)+1;h.eid=d;g=function(k){j._pageAddList(k,c)}}else{if(c=="old"){d=parseInt(j.sId,10)-1;h.sid=d;g=function(k){j._pageAddList(k,c)}}else{g=function(k){j._pageListData(k)}}}j.nowLoading=true;desknets.ajax.rest({url:b,data:h,type:"POST",success:function(l,k,m){g(l)},complete:function(l,k){j.nowLoading=false;j._setListTimerObserve()}})},_pageListData:function(c){var b=this;var f=desknets.ajax.getJsonItems(c);var e=c.allcnt;var d="";if(f.length<=0){if(b.tmplNoInfoData==null){b.tmplNoInfoData=b.$mjListPage.find(".safety-info-list-item-nodata").clone().remove()}b.$mjListPage.empty();b.$mjListPage.append(b.tmplNoInfoData);b.tmplNoInfoData.show()}else{if(e<=b._getMaxRow()){b.noMorePassedInfo=true}if(b.tmplNoInfoData==null){b.tmplNoInfoData=b.$mjListPage.find(".safety-info-list-item-nodata").clone().remove()}d=b._getListHtml(f);b.$mjListPage.html(d);b.$mjListPage.scrollTop(0)}},_pageAddList:function(c,e){var b=this;var g=desknets.ajax.getJsonItems(c);var d="";var f=c.allcnt;if(e=="old"&&f<=b._getMaxRow()){b.noMorePassedInfo=true}if(g.length<=0){return}else{b.$mjListPage.find(".safety-info-list-item-nodata").remove();d=b._getListHtml(g,e);if(e=="new"){if(b.$mjListPage.find("li").length>0){a(d).insertBefore(b.$mjListPage.find("li:first"))}else{b.$mjListPage.append(d)}if(f>g.length){setTimeout(function(){b._getListData("new")},1000)}}else{b.$mjListPage.append(d)}}},_getListHtml:function(i,h){var d=this;var g,b;var c=[];var f=[];var e=d.htmlListTemplate;b=i.length;for(g=0;g<b;g++){f=i[g];c[c.length]=d._getRowHtml(e,f)}if(neo.isSet(h)&&h=="new"){c.reverse()}return c.join("")},_getRowHtml:function(d,e){var c=this;var b="";if(typeof e=="object"){for(b in e){if(b=="id"){if(c.sId==1||parseInt(c.sId,10)>parseInt(e[b],10)){c.sId=e[b]}if(c.eId==-1||parseInt(c.eId,10)<parseInt(e[b],10)){c.eId=e[b]}}d=c._replaceRowData(d,b,e)}}return d},_replaceRowData:function(b,e,c){if(e=="memo"){b=desknets.tmpl.replaceWordLF(b,e,c[e])}else{if(e=="date"){var d=desknets.dateTime.dispDateTime(c[e],{type:"list"});b=desknets.tmpl.replaceWord(b,e,d)}else{b=desknets.tmpl.replaceWord(b,e,c[e])}}return b},_setListObserver:function(){var b=this;b._setListScrollObserve();b._setListTimerObserve()},_setListScrollObserve:function(){var c=this;var d;var e;var b;var f=function(){c._getListData("old")};c.$mjListPage.scroll(function(g){if(c.noMorePassedInfo){return}d=a(g.target).height();e=a(g.target)[0].scrollHeight;b=a(g.target).scrollTop();if(c.bottom_flag&&(e>b+d)){c.bottom_flag=false}if(c.bottom_flag){return}if(e<b+d+1){c.bottom_flag=true;f();return}})},_setListTimerObserve:function(){var c=this;var b=setTimeout(function(){c._getListData("new")},c.timerInterval);c.timerObserver=b},_getRestModule:function(){return desknets.safety.MODULE_API_SAFETY},_getListExecCmd:function(){return desknets.safety.CMD_SAFETYDISASTERINFO},_getListDataClass:function(){return"safety-info-list"},_getMaxRow:function(){return 10}});desknets.page(desknets.safety,"safetylist",desknets.PageListBase,{training:0,mscrollTop:0,mboSetwatermark:false,_hashUpdatePageView:function(c){var b=this;if(c==desknets.safety.CMD_SAFETYDISASTERINFO){a(".safety-m-tb-item>a").first().click()}},init:function(){var b=this;b.callBase("init");b.setEvent()},_initSet:function(){var b=this;b.callBase("_initSet")},setEvent:function(){var b=this;var d={};desknets.safety.safetyreport.init(d);var e={"$entrySuccessFunc":desknets.safety.safetylist._entrySafetyAnswer};desknets.safety.safetyanswer.init(e);var f={onSelectGroupHide:true,onSelectGroup:function(g){b._chooseGroup(g)}};var c={allGroup:"choosable",unassignGroup:"choosable"};desknets.page.groupSelect.init(f,c);a(".safety-list-side-category a").click(function(g){g.preventDefault();b._clickStatusLink(g)});a(".co-list-search-btn a").click(function(g){g.preventDefault();b._searchKey()});a(".co-list-search-text").keypress(function(g){if(g.keyCode==13){g.preventDefault();b._searchKey()}});desknets.keysearch.setUp("safetysearch",a(".co-list-search-text"),function(){b._searchKey()});b._setListEvent()},_setWaterMark:function(){desknets.watermark.set(a(".co-list-search-text"))},_setListEvent:function(){var b=this;a(".safety-table-list").delegate(".safety-dialog-deputy","click",function(d){d.preventDefault();var e=a(d.target).parent().parent().find("[name=id]").val();var c=a(d.target).text();desknets.safety.safetyanswer.setparam(e,c);desknets.safety.safetyanswer.open()});a(".safety-table-list").delegate(".co-td-num a","click",function(c){c.preventDefault();var d=a(c.target).parent().parent().find("[name=id]").val();desknets.safety.safetyreport.setparam(d);desknets.safety.safetyreport.open()});b._selectedStatus()},_chooseGroup:function(c){var b=this;b.$mjListPage.find(".jco-sel-items").hide();if(c!=undefined&&c.length>0){a("input[name=gid]").val(c);b.$mjListPage.find(".jco-back-page-data").find("input[name=srch_key]").val("");b.$mjListPage.find(".jco-back-page-data").find("input[name=status]").val("");a(".co-list-search-text").val("");a(".co-list-search-text").blur();b._listPage("0")}},_clickStatusLink:function(d){var c=this;var e=a(d.target);var b="";if(e.hasClass("all")){b=""}else{if(e.hasClass("answered")){b="4"}else{if(e.hasClass("safe")){b="1"}else{if(e.hasClass("wounded")){b="2"}else{if(e.hasClass("bad")){b="3"}else{b="5"}}}}}a(".jco-back-page-data").find("[name=status]").val(b);c._selectedStatus();c._listPage("0")},_searchKey:function(){var c=this;var d=a(".co-list-search-text").val();var b=a("[name=srch_key]").val();if(!c.chkListSearchKeyLength(d)){return}if(desknets.escape(d)!=b){a("[name=srch_key]").val(d);c.boChangePageNoHide=true;c._listPage("0")}},_entrySafetyAnswer:function(d){var c=desknets.safety.safetylist;if(d.behalf=="0"){var b=a(".safety-myinfo-status");if(b.hasClass("required")){b.removeClass("required")}}c.setConnecting(false);setTimeout(function(){c._getListAjax(c._getListRow())},10)},_selectedStatus:function(){var c=this;var b=a(".jco-back-page-data [name=status]").val();var d=a(".safety-list-side-category");var e=d.find("a");var f;e.removeClass("on");if(b=="5"){f=e.eq(1)}else{if(b=="4"){f=e.eq(2)}else{if(b=="1"){f=e.eq(3)}else{if(b=="2"){f=e.eq(4)}else{if(b=="3"){f=e.eq(5)}else{f=e.eq(0)}}}}}f.addClass("on")},_replaceListLine:function(c,g,f){var e;if(g=="accdate"){e=desknets.dateTime.dispDateTime(f[g].substring(0,12),{type:"list"})}else{if(g==desknets.user.KEY_ASSIGNGROUP){var d=[];d=desknets.user.getListAssignGroups(f[g].Name);var b="";if(d.assigntitle!==""){e='<span title="'+d.assigntitle+'">'+d.assign+"</span>"}}else{e=desknets.escape(f[g]);e=desknets.escapeValue(e);e=desknets.escapeSpace(e)}}c=desknets.tmpl.replaceWordHtml(c,g,e);return c},_getListAjaxSuccess:function(i){var l=this;var h=desknets.ajax.getJsonItems(i);var k=[];var b=[];var f=0;var j=0;var c=0;var d=l._mcListTemplate;var g=desknets.paramanalyzer.getHashParams();var m=i.contactmessage;var e=i.mailstatus;l._getMailMessageOtherSet(i);l._checkMailStatus(i);if(h.length<=0||(m.length>0&&e=="1")){l.$mjListPage.find(".co-table-list").hide();l.$mjListPage.find(".co-list-sort").hide();l.$mjTableList.empty();if(i.confflg=="1"){l.$mjListPage.find(".co-nodata").show();l.$mjListPage.find(".safety-no-safetyconf").hide()}else{l.$mjListPage.find(".co-nodata").hide();l.$mjListPage.find(".safety-no-safetyconf").show()}l.$mjListPage.find(".jco-pager").hide();c="0"}else{l.$mjListPage.find(".co-table-list").show();l.$mjListPage.find(".co-list-sort").show();l.$mjListPage.find(".co-nodata").hide();l.$mjListPage.find(".safety-no-safetyconf").hide();l.$mjListPage.find(".jco-pager").show();f=h.length;for(j=0;j<f;j++){k=h[j];b[b.length]=l._listLine(d,k)}l.$mjTableList.empty();l.$mjTableList.html(b.join(""));l._setListStyle(i);c=i.row}l.$mjListPage.find(".jco-back-page-data").find('input[name="row"]').val(c);l.$mjListPage.find(".jco-pv-cnt").val(j);l.$mjListPage.find(".jco-pv-all-cnt").val(i.allcnt);l._getListAjaxSuccessOtherSet(i);l._getListAjaxSuccessEnd();l._selectedStatus();clearTimeout(desknets.safety.disasterinfo.timerObserver);desknets.keysearch.fixListWatermark(l.$mjListPage,g)},_listLine:function(d,e){var c=this;var b="";if(typeof e=="object"){for(b in e){d=c._replaceListLine(d,b,e)}}if(e.ansuser!=e.id&&e.ansuser.length>0){var f='<span class="safety-icon-deputy">&nbsp;</span>'}else{f=""}var g=new RegExp("{{DeputyIcon}}","ig");d=d.replace(g,f);return d},_getListAjaxSuccessOtherSet:function(f){var m=this;m.training=f.training;var y=f.statuscnt.nomessage;var p=f.statuscnt.answered;var x=f.statuscnt.safe;var v=f.statuscnt.wounded;var q=f.statuscnt.bad;var j=new RegExp("{{nomessage}}","ig");var t=new RegExp("{{answered}}","ig");var r=new RegExp("{{safe}}","ig");var d=new RegExp("{{wounded}}","ig");var h=new RegExp("{{bad}}","ig");var o=desknets.Resource.safety.unanswered;var s=desknets.Resource.safety.answered;var i=desknets.Resource.safety.safe;var n=desknets.Resource.safety.wounded;var c=desknets.Resource.safety.bad;o=o.replace(j,y);s=s.replace(t,p);i=i.replace(r,x);n=n.replace(d,v);c=c.replace(h,q);var b=a(".safety-list-side-category a");b.eq(1).text(o);b.eq(2).text(s);b.eq(3).text(i);b.eq(4).text(n);b.eq(5).text(c);desknets.page.groupSelect.editSelectedGroup(m.$mjListPage.find(".jco-sel-items"),f,"gid");var e=a(".co-listview-left-title");if(f.entrydate){var l=neo.dateTime.parse(f.entrydate);var u=neo.dateTime.format(desknets.Resource.longDateFormat,l);var g=neo.dateTime.format(desknets.Resource.timeFormat,l);var k=u+" "+g;e.text(k);e.show()}else{e.hide()}if(f.useranswerflg=="1"){var w=a(".safety-myinfo-status");if(w.hasClass("required")){w.removeClass("required");desknets.safety.safetytop.setPlaceholderMsg(desknets.Resource.Message.safetyAnswerTextAreaMsg)}}if(neo.isSet(f.row)){m.$mjListPage.find(".jco-back-page-data").find('input[name="row"]').val(f.row)}m.callBase("_getListAjaxSuccessOtherSet",f)},_getMailMessageOtherSet:function(e){var d=this;var f=null;var c=null;var b=null;var g=desknets.pageframe.getTopMsg();f=e.contactmessage;b=e.mailstatus;if(f.length!=0){if(b=="1"){c="info"}else{c="error"}d.$mjListPage.find("#co-topmsg-text-set").html(f);desknets.pageframe.viewTopMsg(f,c)}else{desknets.pageframe.closeTopMsg()}},_checkMailStatus:function(d){var c=this;var b=null;b=d.mailstatus;if(b=="1"){setTimeout(function(){c._getListAjax(0)},5000)}},changPage:function(){var b=this;if(!b.boChangePageNoHide){a(".jco-page").hide()}else{b.boChangePageNoHide=false}b.$mjListPage.show();if(!desknets.browser.tablet){a("html, body").scrollTop(b.mscrollTop)}if(!b.mboSetwatermark){if(a(".safety-tab-list").css("display")=="block"){b.mboSetwatermark=true;b._setWaterMark()}}},_listMoveScroll:function(){var b=this;b.mscrollTop=a("html, body").scrollTop();return},_getRestModule:function(){return desknets.safety.MODULE_API_SAFETY},_getListCmd:function(){return desknets.safety.PAGE_SAFETYLIST},_getListExecCmd:function(){return desknets.safety.CMD_SAFETYLIST}});desknets.page(desknets.safety,"contactdl",null,{_TMPL_CONTACTDIALOG:"safety/contactdl.html",$root:null,$id:"",$tel:"",$mail:"",$options:{},init:function(b){this.$options=b;if(b.$tmplHtml==undefined){this.$options.$tmplHtml=this._TMPL_CONTACTDIALOG}if(b.$cmd==undefined){this.$options.$cmd=desknets.safety.CMD_SAFETYCMDCONTENTRY}},setparam:function(d,c,b){this.$id=d;this.$tel=c;this.$mail=b},open:function(){if(this.$root==null){this._create()}else{this._show()}},_create:function(){var b=this._getDialogOptions();this.$root=desknets.dialog.make("safety-contacts-dialog co-editarea",b);this._loadContent()},_getDialogOptions:function(){var b=this;var e={};var c=desknets.dialog.getDialogOption();var d={title:desknets.Resource.safety.contactdltitle,buttons:e};a.extend(c,d);e[desknets.Resource.OKButtonLabel]=function(f){b._updateEntryValue()};e[desknets.Resource.CancelButtonLabel]=function(f){a(this).dialog("close")};return c},_loadContent:function(){var b=this;desknets.tmpl.load(b.$root,this.$options.$tmplHtml,function(){b._show()})},_show:function(){var b=this;b._setInputVal();this.$root.dialog("open");desknets.dialog.setFirstDialogOpen(this.$root)},_setInputVal:function(){var b=this;this.$root.find("[name=Tel]").val(this.$tel);this.$root.find("[name=Mail]").val(this.$mail)},_updateEntryValue:function(){var b=this;var g=this.$id;var f=this.$root.find("[name=Tel]").val();var i=this.$root.find("[name=Mail]").val();var h=this.$root;desknets.submitform.setDialogDisabled(h);var d=[];var e={};var c={cmd:b.$options.$cmd,id:g,Tel:f,Mail:i};e={success:function(l,j,m){var k={id:g,Tel:f,Mail:i};b.$options.$entrySuccessFunc(k);h.dialog("close")},error:function(m,k,o){var j="";var l="";var n=desknets.parseErrorInfo(o,m.status);if(n.level!="error"){l=a.parseJSON(m.responseText);j=desknets.getErrFieName(b.$root,l.errmsgadd)}o=j+n.message;desknets.dialog.alert(o,{type:n.level})},complete:function(k,j){desknets.submitform.clearDialogDisabled(h)}};d=a.extend({},e);desknets.safety.safetylist._sendRequestAjax(desknets.ajax.REQTYPE_SINGLE,desknets.ajax.RESTYPE_JSON,c,d)}});desknets.page(desknets.safety,"safetyanswer",null,{_TMPL_SAFETYANSWERDIALOG:"safety/safetyanswer.html",$root:null,$options:{},_strNameTmpl:null,init:function(b){this.$options=b;if(b.tmplHtml==undefined){this.$options.$tmplHtml=this._TMPL_SAFETYANSWERDIALOG}},_openConfirmDialog:function(e,h,b,d){e.preventDefault();var c=this;var g="";if(b!="1"&&b!="2"&&b!="3"){g=desknets.Resource.Message.safetyAnswerNoWriteMsg;var f={type:"warn"};desknets.dialog.alert(g,f);return}g=desknets.Resource.Message.warnSafetyAnswerMsg;c._setAjaxSafetyAnswer(h,b,d)},_setAjaxSafetyAnswer:function(d,e,i){var l=this;var h=d;var k=e;var f=i;if(neo.isSet(l.$root)){desknets.submitform.setDialogDisabled(l.$root)}else{desknets.submitform.setDisabled(a("#frm"))}var m=[];var g={};var j={cmd:desknets.safety.CMD_SAFETYCMDINPUT,SID_USER:d,status:e,memo:i};var c=l._getRestModule();var b=desknets.getUrl(c);desknets.ajax.rest({url:b,data:j,success:function(q,n,r){var o={id:h,status:k,memo:f,behalf:q.behalf};if(a(".co-m-content").find(".safety-tab-list").css("display")!="none"){desknets.safety.safetyanswer.$options.$entrySuccessFunc(o)}else{var p=a(".co-m-content").find(".safety-myinfo-status");if(p.hasClass("required")){p.removeClass("required")}}desknets.safety.safetytop.setPlaceholderMsg(desknets.Resource.Message.safetyAnswerTextAreaMsg);if(neo.isSet(l.$root)){l.$root.dialog("close")}},error:function(p,n,o){desknets.ajax.onError(p.status,o)},errorconvmsg:function(n,o){var p={};p.fieldid=o.errmsgadd;p.msg=o.errormessage;p.fieldname=desknets.Resource.safety.safetyAnswerMemo;return desknets.getErrConvMsg(p)},complete:function(o,n){if(neo.isSet(l.$root)){desknets.submitform.clearDialogDisabled(l.$root)}else{desknets.submitform.clearDisabled(a("#frm"))}}})},setparam:function(c,b){this.$id=c;this.$name=b},open:function(){if(this.$root==null){this._create()}else{this._show()}},_create:function(){var b=this._getDialogOptions();this.$root=desknets.dialog.make("safety-answerbehind-dialog co-editarea",b);this._loadContent()},_getDialogOptions:function(){var b=this;var e={};var c=desknets.dialog.getDialogOption();var d={title:desknets.Resource.safety.safetybehindtitle,buttons:e,width:520};a.extend(c,d);e[desknets.Resource.OKButtonLabel]=function(i){var h=desknets.safety.safetyanswer;var f=h.$root.find("[name=_status]:checked").val();var g=h.$root.find(".safety-myinfo-status-comment").val();h._openConfirmDialog(i,h.$id,f,g)};e[desknets.Resource.CancelButtonLabel]=function(f){a(this).dialog("close")};return c},_loadContent:function(){var b=this;desknets.tmpl.load(b.$root,this.$options.$tmplHtml,function(){b._show()})},_show:function(){var b=this;b._setInputVal();this.$root.dialog("open");desknets.dialog.setFirstDialogOpen(this.$root)},_setInputVal:function(){var b=this;var d=desknets.pageframe.getLoginUid();if(b._strNameTmpl==null){b._strNameTmpl=this.$root.find("._name").text()}var c=desknets.tmpl.replaceWordHtml(b._strNameTmpl,"name",this.$name);this.$root.find("._name").text(c);this.$root.find("[name=_status]").attr("checked",false);this.$root.find("#_status1").attr("checked",true);this.$root.find(".safety-myinfo-status-comment").val("");if(d==this.$id){this.$root.find(".safety-dialog-body-msg").hide()}else{this.$root.find(".safety-dialog-body-msg").show()}},_getRestModule:function(){return desknets.safety.MODULE_API_SAFETY}});desknets.page(desknets.safety,"safetytop",desknets.PageBase,{routeListTmpl:'<option value=""></option>',_msgSafetyMsgEmpty:"",init:function(){var b=this;var e="";if(!a(".safety-myinfo-status").hasClass("required")){e=desknets.Resource.Message.safetyAnswerTextAreaMsg}else{e=desknets.Resource.Message.safetyAnswerTextAreaRequiredMsg}b.setPlaceholderMsg(e);a(".safety-myinfo-status").find(".safety-myinfo-status-comment").addClass("placeholder");b._setSafetyPlaceholder();var c={"$entrySuccessFunc":desknets.safety.safetytop._entryContact};desknets.safety.contactdl.init(c);a(".safety-myinfo-contact a").click(function(h){h.preventDefault();var i=a(".safety-myinfo-contact [name=id]").val();var g=a(".safety-myinfo-contact-tel .tel").text();var f=a(".safety-myinfo-contact-mail .mail").text();desknets.safety.contactdl.setparam(i,g,f);desknets.safety.contactdl.open()});a("[name=safety-answer-btn]").click(function(h){h.preventDefault();var i=a(".safety-myinfo-contact [name=id]").val();var f=a("[name=status]:checked").val();var g="";if(!a(".safety-myinfo-status").find(".safety-myinfo-status-comment").hasClass("placeholder")){g=a(".safety-myinfo-status").find(".safety-myinfo-status-comment").val()}desknets.safety.safetyanswer._openConfirmDialog(h,i,f,g)});a(".safety-myinfo-status-more").click(function(f){f.preventDefault();var g=a(".safety-myinfo-contact [name=id]").val();desknets.safety.safetyreport.setparam(g);desknets.safety.safetyreport.open()});a(".safety-m-tb-item>a").click(function(h){h.preventDefault();if(!b.isConnecting()){var i=a(h.target);if(!i.hasClass("safety-m-tb-item")){i=i.parent()}b._setSelectTab(i);var g=i.find("a").data("url");if(g=="safetycmddisasterinfolist"){b._getDisasterData()}else{if(g=="safetycmdlist"){var f=desknets.getInputDataToUrl(desknets.safety.safetylist.$mjListPage.find(".jco-back-page-data"));desknets.safety.safetylist._setLocationHash(f,true);desknets.safety.safetylist._getListAjax(desknets.safety.safetylist._getListRow());a(".safety-tab-list").show();a(".safety-tab-disaster").hide();a(".safety-tab-prepared").hide()}else{b._getPreparedDisasterData()}}}});a(".safety-content").delegate(".safety-route-select","change",function(g){g.preventDefault();var f=this;desknets.safety.safetytop._getRouteInfo(a(g.target).val())});a(".safety-route-btn .safety-btnlink-blank").click(function(l){l.preventDefault();var g=a("[name=routeurl]").val();var m=a("[name=start]").val();var f=a("[name=goal]").val();var h=a("[name=slat]").val();var j=a("[name=slon]").val();var i=a("[name=dlat]").val();var k=a("[name=dlon]").val();g=desknets.safety.getMapAPIUrl(g,m,f,h,j,i,k);window.open(g)});var d=desknets.paramanalyzer.getHashParams();if(d.cmd==desknets.safety.CMD_SAFETYDISASTERINFO){a(".safety-m-tb-item>a").first().click()}},_entryContact:function(d){var c=d.Tel;c=desknets.escape(c);c=desknets.escapeValue(c);c=desknets.escapeSpace(c);var b=d.Mail;b=desknets.escape(b);b=desknets.escapeValue(b);b=desknets.escapeSpace(b);a(".safety-myinfo-contact-tel .tel").html(c);a(".safety-myinfo-contact-mail .mail").html(b);var e=a(".safety-myinfo-contact-tel");if(c.length>0&&e.hasClass("safety-myinfo-nosetting")){e.removeClass("safety-myinfo-nosetting")}else{if(c.length==0&&!e.hasClass("safety-myinfo-nosetting")){e.addClass("safety-myinfo-nosetting")}}var f=a(".safety-myinfo-contact-mail");if(b.length>0&&f.hasClass("safety-myinfo-nosetting")){f.removeClass("safety-myinfo-nosetting")}else{if(b.length==0&&!f.hasClass("safety-myinfo-nosetting")){f.addClass("safety-myinfo-nosetting")}}var h=desknets.Resource.Message.safetyContactSuccessMsg;var g={type:"message"};desknets.dialog.alert(h,g)},_setSelectTab:function(c){var b=this;a(".safety-m-tb-item").removeClass("on");c.addClass("on")},_getDisasterData:function(){var b=this;var d={};var c={};var g={};g.cmd=desknets.safety.CMD_SAFETYDISASTERINFO;var f={};f.cmd=desknets.safety.CMD_SAFETYCMDEMERGENCYCONTACT;var e={};e.cmd=desknets.safety.CMD_SAFETYCMDEVACUATIONROUTELIST;c["0"]=g;c["1"]=f;c["2"]=e;d.success=function(h){if(h[0]["status"]!=desknets.RES_STATUS_SUCCESS){b.onError(h[0]["errorno"],h[0]["errormessage"])}else{if(h[1]["status"]!=desknets.RES_STATUS_SUCCESS){b.onError(h[1]["errorno"],h[1]["errormessage"])}else{if(h[2]["status"]!=desknets.RES_STATUS_SUCCESS){b.onError(h[1]["errorno"],h[1]["errormessage"])}else{b._initMultiDisasterHtml(h)}}}};b._sendRequestAjax(desknets.ajax.REQTYPE_MULTI,desknets.ajax.RESTYPE_JSON,c,d)},_initMultiDisasterHtml:function(k){var l=this;jsonRest=k[0];desknets.safety.disasterinfo.sId=1;desknets.safety.disasterinfo.eId=-1;desknets.safety.disasterinfo.scrollObserving=false;desknets.safety.disasterinfo.noMorePassedInfo=false;clearTimeout(desknets.safety.disasterinfo.timerObserver);desknets.safety.disasterinfo.init();if(neo.isSet(k[1].memo,{blank:false})){var f=desknets.convertToSafeHtml(desknets.rte.convertForShow(k[1].memo));var e=a(".safety-company-contact .safety-content-body").html(f);desknets.rte.readyForShow(e)}else{var c='<div class="safety-company-contact-nolist">'+desknets.Resource.safety.safetySettingInfoNothing+"</div>";a(".safety-company-contact .safety-content-body").html(c)}var i=a(l.routeListTmpl);var h=desknets.ajax.getJsonItems(k[2]);if(h.length>0){var d=a(".safety-route-select");d.html("");for(var j=0;j<h.length;j++){var g=i.clone();if(j==0){l._setFirstRouteInfo(h[j].id)}g.val(h[j].id);var b=desknets.escape(h[j].Name);b=desknets.escapeValue(b);b=desknets.escapeSpace(b);g.html(b);d.append(g)}a(".safety-company-spot-list").show();a(".safety-company-spot-nolist").hide()}else{a(".safety-company-spot-list").hide();a(".safety-company-spot-nolist").show()}desknets.safety.safetylist._setTitle("&nbsp;&gt;&nbsp;"+l._getSubTitle());a(".safety-tab-list").hide();a(".safety-tab-disaster").show();a(".safety-tab-prepared").hide();a(".co-topmsg-text").hide()},_getRouteInfo:function(f){var b=this;var d=[];var e={};var c={cmd:desknets.safety.CMD_SAFETYCMDEVACUATIONROUTEINFO,id:f};e={success:function(h,g,i){b._setHtmlRouteInfo(h)},error:function(h,g,i){desknets.ajax.onError(h.status,i)}};d=a.extend({},e);b._sendRequestAjax(desknets.ajax.REQTYPE_SINGLE,desknets.ajax.RESTYPE_JSON,c,d)},_setHtmlRouteInfo:function(e){var b=this;var f=desknets.escape(e.start);f=desknets.escapeValue(f);f=desknets.escapeSpace(f);var d=desknets.escape(e.goal);d=desknets.escapeValue(d);d=desknets.escapeSpace(d);a(".safety-route-start").html(f);a(".safety-route-goal").html(d);a(".safety-route-input-start").val(e.start);a(".safety-route-input-goal").val(e.goal);a("[name=routeurl]").val(e.Url);if(e.map=="g"){a(".safety-route-input-slat").hide();a(".safety-route-input-slon").hide();a(".safety-route-input-dlat").hide();a(".safety-route-input-dlon").hide()}else{a(".safety-route-input-slat").show();a(".safety-route-input-slon").show();a(".safety-route-input-dlat").show();a(".safety-route-input-dlon").show();a('input[name="slat"]').val(e.slat);a('input[name="slon"]').val(e.slon);a('input[name="dlat"]').val(e.dlat);a('input[name="dlon"]').val(e.dlon)}var c=desknets.safety.getMapAPIUrl(e.Url,e.start,e.goal,e.slat,e.slon,e.dlat,e.dlon);a(".safety-route-btn input").attr("title",c)},_setFirstRouteInfo:function(d){var b=this;var c=desknets.getUrl(b._getRestModule());desknets.ajax.rest({url:c,data:{cmd:desknets.safety.CMD_SAFETYCMDEVACUATIONROUTEINFO,id:d},success:function(f,e,g){b._setHtmlRouteInfo(f)},error:function(f,e,g){desknets.ajax.onError(f.status,g)}})},_getPreparedDisasterData:function(){var b=this;var d={};var f={};var e={};var c={};f={};f.cmd=desknets.safety.CMD_SAFETYCMDDISASTERPREPLINK;e={};e.cmd=desknets.safety.CMD_SAFETYCMDEVACUATIONROUTELIST;c["0"]=f;c["1"]=e;d.success=function(g){if(g[0]["status"]!=desknets.RES_STATUS_SUCCESS){b.onError(g[0]["errorno"],g[0]["errormessage"])}else{if(g[1]["status"]!=desknets.RES_STATUS_SUCCESS){b.onError(g[1]["errorno"],g[1]["errormessage"])}else{b._initMultiPreparedDisasterHtml(g)}}};b._sendRequestAjax(desknets.ajax.REQTYPE_MULTI,desknets.ajax.RESTYPE_JSON,c,d)},_initMultiPreparedDisasterHtml:function(k){var l=this;clearTimeout(desknets.safety.disasterinfo.timerObserver);if(neo.isSet(k[0].memo,{blank:false})){var f=desknets.convertToSafeHtml(desknets.rte.convertForShow(k[0].memo));var e=a(".safety-provision-link .safety-content-body").html(f);desknets.rte.readyForShow(e)}else{var c='<div class="safety-company-contact-nolist">'+desknets.Resource.safety.safetySettingInfoNothing+"</div>";a(".safety-provision-link .safety-content-body").html(c)}var i=a(l.routeListTmpl);var h=desknets.ajax.getJsonItems(k[1]);if(h.length>0){var d=a(".safety-route-select");d.html("");for(var j=0;j<h.length;j++){var g=i.clone();if(j==0){l._setFirstRouteInfo(h[j].id)}g.val(h[j].id);var b=desknets.escape(h[j].Name);b=desknets.escapeValue(b);b=desknets.escapeSpace(b);g.html(b);d.append(g)}a(".safety-company-spot-list").show();a(".safety-company-spot-nolist").hide()}else{a(".safety-company-spot-list").hide();a(".safety-company-spot-nolist").show()}desknets.safety.safetylist._setTitle("&nbsp;&gt;&nbsp;"+l._getSubTitle());a(".safety-tab-list").hide();a(".safety-tab-disaster").hide();a(".safety-tab-prepared").show();a(".co-topmsg-text").hide()},_setSafetyPlaceholder:function(){var c=this;var b=a(".safety-myinfo-status").find(".safety-myinfo-status-comment");b.blur(function(){if(d()){return}b.val(c._msgSafetyMsgEmpty);b.addClass("placeholder")}).focus(function(){if(d()){return}b.val("");b.removeClass("placeholder")}).blur();function d(){if(b.val()==""){return false}else{if(b.val()==c._msgSafetyMsgEmpty){return false}}return true}},setPlaceholderMsg:function(b){var c=this;c._msgSafetyMsgEmpty=b;a(".safety-myinfo-status").find(".safety-myinfo-status-comment").val(c._msgSafetyMsgEmpty);a(".safety-myinfo-status").find(".safety-myinfo-status-comment").addClass("placeholder");a(".safety-myinfo-status").find('input[name="status"]').attr("checked",false);a(".safety-myinfo-status").find("#status1").attr("checked",true)},_getSubTitle:function(){var b="";b=a(".safety-m-tb-item").filter(function(){if(a(this).hasClass("on")){return true}return false}).find("a").text();return b},_getRestModule:function(){return desknets.safety.MODULE_API_SAFETY}});desknets.page(desknets.safety,"safetyreport",null,{_TMPL_REPORTDIALOG:"safety/report.html",$root:null,$tmpl:null,$id:"",$options:{},init:function(b){this.$options=b;if(b.$tmplHtml==undefined){this.$options.$tmplHtml=this._TMPL_REPORTDIALOG}},setparam:function(b){this.$id=b},open:function(){if(this.$root==null){this._create()}else{this._show()}},_create:function(){var b=this._getDialogOptions();this.$root=desknets.dialog.make("safety-report-dialog",b);this._loadContent()},_getDialogOptions:function(){var b=this;var e={};var c=desknets.dialog.getDialogOption();var d={title:desknets.Resource.safety.reportdltitle,width:650,maxHeight:500,buttons:e};a.extend(c,d);e[desknets.Resource.CancelButtonLabel]=function(f){a(this).dialog("close")};return c},_loadContent:function(){var b=this;desknets.tmpl.load(b.$root,this.$options.$tmplHtml,function(){b.$tmpl=b.$root.clone(true);b._show()})},_show:function(){var b=this;b._setInputVal()},_setInputVal:function(){var b=this;b._getSafetyReport()},_getSafetyReport:function(){var b=this;_id=this.$id;var d=[];var e={};var c={cmd:desknets.safety.CMD_SAFETYREPORTLIST,SID_USER:_id};e={success:function(u,s,m){var w=desknets.ajax.getJsonItems(u);var y=b.$tmpl.find(".safety-history-list");b.$root.find(".safety-history-list").children().remove();for(var n=0;n<w.length;n++){var r=y.html();var g=w[n];var h=g.ansdate;var j=g.ansuser;var v=g.memo;var l=g.status;var p="";var x="";var o="";if(l=="1"){o="safe"}else{if(l=="2"){o="wounded"}else{if(l=="3"){o="bad"}else{if(l=="5"){o="nomessage"}}}}v=desknets.tmpl.escapeWordLF(v);h=desknets.dateTime.dispDateTime(h.substring(0,12),{type:"list"});if(j!=""&&_id!=j){p=" deputy";x='<span class="safety-icon-deputy">&nbsp;</span>'}var t=new RegExp("{{ansdate}}","ig");var z=new RegExp("{{ansuser}}","ig");var k=new RegExp("{{memo}}","ig");var q=new RegExp("{{status}}","ig");var i=new RegExp("{{deputyClass}}","ig");var f=new RegExp("{{deputyIcon}}","ig");r=desknets.tmpl.replaceWordHtml(r,"ansdate",h);r=desknets.tmpl.replaceWordHtml(r,"memo",v);r=desknets.tmpl.replaceWordHtml(r,"status",o);r=desknets.tmpl.replaceWordHtml(r,"deputyClass",p);r=desknets.tmpl.replaceWordHtml(r,"deputyIcon",x);b.$root.find(".safety-history-list").append(a(r))}b.$root.dialog("open");desknets.dialog.setFirstDialogOpen(b.$root)},error:function(g,f,h){desknets.ajax.onError(g.status,h)}};d=a.extend({},e);desknets.safety.safetylist._sendRequestAjax(desknets.ajax.REQTYPE_SINGLE,desknets.ajax.RESTYPE_JSON,c,d)}});app.addInitialAction(function(){desknets.safety.init()})})(jQuery);