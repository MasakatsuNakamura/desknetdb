(function(c){var d=neo.core.readyNamespace("neo.webdb.pg_view.EasyEditor");if(!d){return}var a=neo.webdb.pg_view;var b=neo.webdb.pg_view.EasyEditor=new neo.core.Class({classProperties:{CMD:"dbrecordset",defaultSetting:{},defaultSettingDlgEdit:{buttons:{},dialogClass:"neo-dialog dlg-easy_edit",modal:false,title:"簡易編集"}},properties:{setting:null,_extended:null,_isExtended:function(){return this._extended},_setExtended:function(e){return this._extended=e},_connecting:null,isConnecting:function(){return this._connecting},_setConnecting:function(e){return this._connecting=e},_manipulator:null,_getManipulator:function(){return this._manipulator||this._initManipulator()},_initManipulator:function(){var h=this._getRowId();var f=this._getColId();var g=a.getData(h,f);var e={data:g,page:this._getPage()};return this._manipulator=a.getDataManipulator(e)},_ajax:null,_getAjax:function(){return this._ajax||this._initAjax()},_initAjax:function(){var e={url:neo.webdb.getMainUrl(),getSendData:this.__closure(this.getSendData),onerror:this.__closure(this.onerror),onsuccess:this.__closure(this.onsuccess),onfinish:this.__closure(this.onfinish)};var f=new neo.webdb.Ajax(e);f.initialize();return this._ajax=f},_objImgSizeAdjust:null,_getObjImgSizeAdjust:function(){return this._objImgSizeAdjust||this._initObjImgSizeAdjust()},_initObjImgSizeAdjust:function(){var f={mode:neo.webdb.Record.ImageColumnSizeAdjustment.MODE_EASY_EDIT};var e=new neo.webdb.Record.ImageColumnSizeAdjustment(f);return this._objImgSizeAdjust=e},_errorMessage:null,_getErrorMessage:function(){return this._errorMessage},_setErrorMessage:function(e){return this._errorMessage=e},_connectingBadge:null,_getConnectingBadge:function(){return this._connectingBadge||this._initConnectingBadge()},_initConnectingBadge:function(){var f={elCell:this._getElCell(),page:this._getPage()};var e=new a.ConnectingBadge(f);e.initialize();return this._connectingBadge=e},_errorBadge:null,_getErrorBadge:function(){return this._errorBadge||this._initErrorBadge()},_initErrorBadge:function(){var f={elCell:this._getElCell(),page:this._getPage()};var e=new a.ErrorBadge(f);e.initialize();return this._errorBadge=e},_elCell:null,_getElCell:function(){return this._elCell||this._initElCell()},_initElCell:function(){var i=this._getRowId();var f=this._getColId();var e=this._getElTable();var h=this._getPage();var g=h.getElCellOf(i,f,e);return this._elCell=g},_elDlgEdit:null,_getElDlgEdit:function(){return this._elDlgEdit||this._initElDlgEdit()},_initElDlgEdit:function(){var e=this._buildElDlgEdit();return this._elDlgEdit=e},_setElDlgEdit:function(e){return this._elDlgEdit=e},_elErrorMessageContainer:null,_getElErrorMessageContainer:function(){return this._elErrorMessageContainer||this._initElErrorMessageContainer()},_initElErrorMessageContainer:function(){var e=this._getElDlgEdit();var f=e.find(".easy_edit-error_message-container");return this._elErrorMessageContainer=f},_elFormContainer:null,_getElFormContainer:function(){return this._elFormContainer||this._initElFormContainer()},_initElFormContainer:function(){var e=this._getElDlgEdit();var f=e.find(".easy_edit-form-container");return this._elFormContainer=f},_elBtnOk:null,_getElBtnOk:function(){return this._elBtnOk||this._initElBtnOk()},_initElBtnOk:function(){var e=this._getElDlgEdit();var f=e.find("[name=ok]");return this._elBtnOk=f},_elBtnCancel:null,_getElBtnCancel:function(){return this._elBtnCancel||this._initElBtnCancel()},_initElBtnCancel:function(){var e=this._getElDlgEdit();var f=e.find("[name=cancel]");return this._elBtnCancel=f},_elBtnExtend:null,_getElBtnExtend:function(){return this._elBtnExtend||this._initElBtnExtend()},_initElBtnExtend:function(){var e=this._getElDlgEdit();var f=e.find(".btn-easy_edit-extend");return this._elBtnExtend=f},_elExtension:null,_getElExtension:function(){return this._elExtension||this._initElExtension()},_initElExtension:function(){var e=this._getElDlgEdit();var f=e.find(".easy_edit-buttons-extension");return this._elExtension=f},_elBtnSkip:null,_getElBtnSkip:function(){return this._elBtnSkip||this._initElBtnSkip()},_initElBtnSkip:function(){var e=this._getElDlgEdit();var f=e.find("[name=skip]");return this._elBtnSkip=f},_elSequentially:null,_getElSequentially:function(){return this._elSequentially||this._initElSequentially()},_initElSequentially:function(){var e=this._getElDlgEdit();var f=e.find("[name=sequentially]");return this._elSequentially=f},_elDirection:null,_getElDirection:function(){return this._elDirection||this._initElDirection()},_initElDirection:function(){var f=this._getElDlgEdit();var e=f.find("[name=direction]");return this._elDirection=e},_getElFormPrototype:function(){return c("#easy_edit-prototype")},_elForm:null,_getElForm:function(){return this._elForm},_setElForm:function(e){return this._elForm=e},_getPage:function(){return this.setting.page},_getManager:function(){return this.setting.manager},_getTableId:function(){return this.setting.tableId},_getRowId:function(){return this.setting.rowId},_getColId:function(){return this.setting.colId},_getElTable:function(){return this.setting.elTable},_getCmd:function(){return b.CMD},__constructor:function(e){this.setting=e||{};this._extended=false;this._connecting=false},initialize:function(){this._initSetting()},_initSetting:function(){var e=this._getDefaultSetting();this.setting=c.extend({},e,this.setting)},_getDefaultSetting:function(){return c.extend({},b.defaultSetting)},open:function(k,l){if(this.isConnecting()){return false}this._saveError(null,null);this._updateErrorMessage();var g=this._getManipulator();g.reset();var g=this._getManipulator();var i=g.getElForm();this.__bind(i,"submit");var j=this._getSettingDlgEdit();var f=this._getElDlgEdit();f.webdbDialog(j);f.webdbDialog("open");if(k){this.showExtension(k)}else{this.hideExtension()}var e=this._getObjImgSizeAdjust();e.initialize();e.adjustByResize();var h=this;setTimeout(function(){h._adjustPosition(l)},1);this._adjustPosition(l);return true},openAfterPreparation:function(g,i,h){var f=this;var e=this._getManipulator();e.loadElFormPrototype(function(){var j=f.open(g,h);i(j)})},_updateErrorMessage:function(){var e=this._getErrorMessage();var f=this._getElErrorMessageContainer();if(e){f.text(e).show()}else{f.text("").hide()}},_adjustPosition:function(h){var e=this._getElDlgEdit();var g=[0,0];e.webdbDialog("option","position",g);var f=this._getDialogPos(h);g=[f.left,f.top];e.webdbDialog("option","position",g)},_getDialogPos:function(i){var l=this._getRect();var g;if(i){g=i}else{var j=this._getElCell();var k=neo.webdb.getRect(j,true);g={left:k.left-13,top:k.top-l.height}}var m=document.documentElement.clientWidth;var e=m-l.width;if(g.left>e){if(e>0){g.left=e}else{g.left=0}}var f=document.documentElement.clientHeight;var h=f-l.height;if(g.top>h){if(h>0){g.top=h}else{g.top=0}}return g},_buildElDlgEdit:function(){var i=this._getElFormPrototype();var f=i.clone().removeAttr("id");this._setElDlgEdit(f);var e=this._getManipulator();var g=e.getElForm();this._setElForm(g);var h=this._getElFormContainer();h.append(g);this._hook();return f},_hook:function(){var g;var e=this._getElDlgEdit();var f=this;g=this._getElBtnOk();this.__bind(g,"click","Ok");g=this._getElBtnCancel();this.__bind(g,"click","Cancel");g=this._getElBtnExtend();this.__bind(g,"click","Extend");g=this._getElBtnSkip();this.__bind(g,"click","Skip");g=this._getElSequentially();this.__bind(g,"click","Sequentially");var e=f._getElDlgEdit();e.bind("keypress.ui-dialog",function(j){if(j.keyCode!==c.ui.keyCode.TAB){return}var i=c(":tabbable",this),k=i.filter(":first"),h=i.filter(":last");if(j.target===h[0]&&!j.shiftKey){k.focus();return false}else{if(j.target===k[0]&&j.shiftKey){h.focus();return false}}})},_getSettingDlgEdit:function(){var g=c.extend({},b.defaultSettingDlgEdit);var f=this._getManager();var e=this;g.close=function(){f.finishEditing(e)};return g},close:function(){var e=this._getElDlgEdit();e.webdbDialog("close")},isOpen:function(){var e=this._getElDlgEdit();var f=e.webdbDialog("getInstance");return f.call("isOpen")},submit:function(){if(this._isEditable()){this._buttonOff();this._decide();this._send()}else{this.hideErrorBadge();this._saveError(null,null);if(this._isSequentially()){this._openNext()}else{this.close()}}},_decide:function(){var g=this._getManipulator();g.decide();var f=this._getRowId();var e=this._getPage();e.setRowEdited(f)},_refresh:function(){var f=this._getRowId();var e=this._getPage();var g=this._getManipulator();g.clearForm();e.refreshRow(f)},_send:function(f){var e=this._getManipulator();var f=e.getValues();if(!f){return}var g=this._getAjax();g.sendRequest()},_isEditable:function(){var h=this._getColId();var k=a.getColumn(h);var g=k.type;if(h=="-1"||h=="-2"||h=="-3"||h=="-4"||h=="-5"){return false}var j=["key","relref","numbercal","datetimecal","timespancal"];for(var f=0;f<j.length;f++){if(!j[f]){continue}if(g==j[f]){return false}}var e=this._getElFormContainer();var l=e.find(".layout-item-easyedit_read_only");if(l.length>0){return false}return true},_isSequentially:function(){var e=this._isExtended();var f=this._getElSequentially();var g=f.attr("checked");return e&&g},_openNext:function(k){var j=this._getRowId();var h=this._getColId();var i=this._getDirection();var g=this._getRect();var f=this._getManager();var e=f.startNextEditing(j,h,i,g);if(!e){this.close()}},_getDirection:function(){var e=this._getElDirection();var f=e.val();return f},_saveError:function(e,f){this._setErrorMessage(e)},showExtension:function(i){if(!i){i="down"}var e=this._getElDirection();e.val(i);var h=this._getElExtension();h.show();var f=this._getElBtnExtend();f.hide();this._setExtended(true);var g=this._getRect();this._adjustPosition(g)},hideExtension:function(){var f=this._getElExtension();f.hide();var e=this._getElBtnExtend();e.show();this._setExtended(false)},enableSkip:function(e){var f=this._getElBtnSkip();f.attr("disabled",!e)},skip:function(){var e=this._getManipulator();e.cancel();this._openNext()},showErrorBadge:function(){var e=this._getErrorBadge()},hideErrorBadge:function(){var e=this._getErrorBadge();e.hide()},showConnectingBadge:function(){var e=this._getConnectingBadge();e.show()},hideConnectingBadge:function(){var e=this._getConnectingBadge();e.hide()},updateBadgePos:function(){if(this._errorBadge){var e=this._getErrorBadge();e.updatePos()}if(this._connectingBadge){var e=this._getConnectingBadge();e.updatePos()}},_getRect:function(){var e=this._getElDlgEdit();var g=e.closest(".ui-dialog");var f;if(g.length>0){f=neo.webdb.getRect(g)}return f},getRect:function(){return this._getRect()},_buttonOff:function(){var e;e=this._getElBtnOk();e.attr("disabled","disabled");e=this._getElBtnCancel();e.attr("disabled","disabled");e=this._getElBtnSkip();e.attr("disabled","disabled")},_buttonOn:function(){var e;e=this._getElBtnOk();e.removeAttr("disabled");e=this._getElBtnCancel();e.removeAttr("disabled");e=this._getElBtnSkip();e.removeAttr("disabled")},__bind:neo.jq.bindListener,__closure:neo.core.getClosure,onclickOk:function(e){return this.onsubmit.apply(this,arguments)},onclickCancel:function(e){var f=this._getManipulator();f.cancel();this.close()},onclickExtend:function(e){this.showExtension()},onclickSkip:function(e){this.skip()},onclickSequentially:function(g){var e=this._getElSequentially();var f=e.attr("checked");this.enableSkip(f)},onsubmit:function(e){e.preventDefault();this.submit()},getSendData:function(){var h={cmd:this._getCmd(),recordid:this._getRowId(),tid:this._getTableId(),iseasyedit:true,isupdatesubordinate:true};var e=this._getManipulator();var f=e.getValues();if(!f){return}if(e.getTempNum()){h.tmpnm=e.getTempNum()}var g=neo.core.joinParam(f);h.column_0=neo.core.encode(g);return h},onbeforesend:function(e){this.hideErrorBadge();this._saveError(null,null);this._setConnecting(true);this.showConnectingBadge()},onsuccess:function(e,f){this.hideErrorBadge();this._saveError(null,null);this._updateErrorMessage();if(this._isSequentially()){this._openNext()}else{this.close()}this._refresh()},onerror:function(f,e,g){this._saveError(f,g);this.showErrorBadge();this._updateErrorMessage();return false},onfinish:function(){this._setConnecting(false);this.hideConnectingBadge();this._buttonOn()},banpei:null}})})(jQuery);