(function(b){var c=neo.core.readyNamespace("neo.jQuery.fn.neoBalloon");if(!c){return}var a=neo.jQuery.fn.neoBalloon=new neo.core.Class({classProperties:{CLS_CONTAINER:"neo-balloon-container",CLS_BORDER:"neo-balloon-border",CLS_STROKE:"neo-balloon-stroke",CLS_STROKE_TOP:"neo-balloon-stroke-top",CLS_STROKE_BOTTOM:"neo-balloon-stroke-bottom",showcase:null,defaultSetting:{autoHide:true},__constructor:function(){this.showcase=new neo.core.Showcase()},initialize:function(){neo.jq.bindListener(b("body"),"mousedown",null,this)},getInstance:function(d){return this.showcase.getInstance(d)},setInstance:function(e,d){return this.showcase.set(e,d)},_hideAuto:function(d){var f=this.showcase.getIdList();for(var e=0;e<f.length;e++){var h=f[e];var g=this.showcase.get(h);if(g.isBeHidden(d)){g.hide()}}},onmousedown:function(e){var d=b(e.target);this._hideAuto(d)}},properties:{_showing:null,isShowing:function(){return this._showing},_setShowing:function(d){return this._showing=d},_element:null,toElement:function(){return this._element},_elBalloon:null,_getElBalloon:function(){return this._elBalloon||this._initElBalloon()},_initElBalloon:function(){var d=b("#neo-balloon-prototype");if(d.length<1){throw new Error("neo.jQuery.fn.neoBalloon : The template element is required.")}var e=d.clone().removeAttr("id").css({top:-9999}).appendTo("body");return this._elBalloon=e},_elContainer:null,_getElContainer:function(){return this._elContainer||this._initElContainer()},_initElContainer:function(){var d=this._getElBalloon();var e=d.find("."+a.CLS_CONTAINER);return this._elContainer=e},_elBorder:null,_getElBorder:function(){return this._elBorder||this._initElBorder()},_initElBorder:function(){var e=this._getElBalloon();var d=e.find("."+a.CLS_BORDER);return this._elBorder=d},_elStroke:null,_getElStroke:function(){return this._elStroke||this._initElStroke()},_initElStroke:function(){var d=this._getElBalloon();var e=d.find("."+a.CLS_STROKE);return this._elStroke=e},_elHidden:null,_getElHidden:function(){return this._elHidden},_setElHidden:function(d){return this._elHidden=d},_getElRelation:function(){return this.setting.elRelation},__constructor:function(e,d){if(!e||!(e instanceof jQuery)){throw new Error("jQuery.fn.neoBalloon.__constructor : <element> is not valid.")}this._element=e;this.setting=d[0]||{};this._showing=false;a.setInstance(e,this)},initialize:function(){this._initSetting();this._buildElement()},_initSetting:function(){var d=this._getDefaultSetting();this.setting=b.extend({},d,this.setting)},_getDefaultSetting:function(){return a.defaultSetting},_buildElement:function(){var e=this._getElContainer();var d=this.toElement();e.append(d)},_getDefaults:function(){return b.extend({},a.defaultSetting)},toggle:function(){if(this.isShowing()){this.hide()}else{this.show()}},show:function(){if(this.isShowing()){return}this._setShowing(true);this._hideHindrances();var d=this._getElRelation();var e=d.offset();var f=this._adjustRect(e);this._adjustStroke(e,f)},hide:function(){this._setShowing(false);this._showHindrances();var d=this._getElBalloon();d.css({top:-9999,left:-9999})},isBeHidden:function(d){if(!this.setting.autoHide){return false}if(this._isInsideBalloon(d)){return false}if(this._isInsideNoCloseElement(d)){return false}return true},_isInsideBalloon:function(d){return(d.closest("."+a.CLS_BORDER)[0]==this._getElBorder()[0]||d.closest("."+a.CLS_STROKE)[0]==this._getElStroke()[0])},_isInsideNoCloseElement:function(e){if(typeof this.setting.notClose=="string"){if(e.closest(this.setting.notClose).length>0){return true}}else{if(this.setting.notClose instanceof jQuery){for(var d=e;d.length>0;d=d.parent()){if(d[0]==this.setting.notClose[0]){return true}}}}return false},_adjustRect:function(d){var e=this._getElBalloon();e.css({left:"",top:""}).width("auto").width(e.width());var f=this._calcPos(d);e.css(f);return f},_calcPos:function(d){var e={left:this._calcPosX(d),top:this._calcPosY(d)};return e},_calcPosX:function(j){var g=j.left;var d=this._getElBalloon();var i=d.outerWidth();var e=8;var f=g+i+e;var h=b(window).scrollLeft();var m=document.documentElement.clientWidth||document.body.clientWidth;var k=h+m;var l=f-k;if(l>0){g-=l;if(g<h){g=h}}return g},_calcPosY:function(m){var g=this._getElRelation();var e=g.outerHeight();var p=m.top+e;var d=this._getElBalloon();var j=d.outerHeight();var n=16;var i=8;var k=p+j-n+i;var h=b(window).scrollTop();var l;if(document.compatMode=="CSS1Compat"){l=document.documentElement.clientHeight}else{l=document.body.clientHeight}var f=(h+l);var q=k-f;if(q>0){var o=m.top-j;if(o>=h){p=o}}return p},_adjustStroke:function(d,e){this._adjustStrokeX(d,e);this._adjustStrokeY(d,e)},_adjustStrokeX:function(d,e){var h=this._getElStroke();var g=10;var f=d.left-e.left+g;h.css({left:f})},_adjustStrokeY:function(d,e){var f=this._getElStroke();if(e.top>d.top){f.removeClass(a.CLS_STROKE_BOTTOM).addClass(a.CLS_STROKE_TOP)}else{f.removeClass(a.CLS_STROKE_TOP).addClass(a.CLS_STROKE_BOTTOM)}},_hideHindrances:function(){var e="applet, embed, object, iframe";if(b.browser.msie&&b.browser.version<7){e+=", select"}var h=this._getElBalloon();var g=h.find(e);var f="tmp_neo_balloon_"+(new Date().getTime());g.addClass(f);var d=b(e).not("."+f);var i=b(b.grep(d,function(m,l){var k=b(m);var j=k.css("visibility");return j!="hidden"}));i.css({visibility:"hidden"});this._setElHidden(i);g.removeClass(f)},_showHindrances:function(){var d=this._getElHidden();if(d){d.css({visibility:""})}this._setElHidden(null)},getInstance:function(){return this},option:function(d,e){if(e===undefined){return this.setting[d]}this.setting[d]=e}}});b.fn.neoBalloon=neo.jq.buildPlugin(a);a.__constructor();b(document).ready(function(){a.initialize()})})(jQuery);