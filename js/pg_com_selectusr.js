(function(){if(!neo.core.readyNamespace("neo.webdb.SelectUsr")){return}var a=neo.webdb.SelectUsr=new neo.core.Class({properties:{_objAjaxUpdate:null,_objAjaxToggle:null,_objAjaxSrch:null,callbackBeforeShow:null,callbackOnChange:null,callbackAfterHide:null,_selectedUsers:null,getSelectedUsers:function(){return this._selectedUsers},setSelectedUsers:function(b){return this._selectedUsers=b},_firstSelectedUsers:null,_getFirstSelectedUsers:function(){return this._firstSelectedUsers||[]},_setFirstSelectedUsers:function(b){return this._firstSelectedUsers=b},_getElBtnOpen:function(){return this._elBtnOpen},_setElBtnOpen:function(b){this._elBtnOpen=b},_elBtnOpen:null,_isSingle:function(){return this.options.single},_isSelectedUserVisible:function(){if("selectedUserVisibility" in this.options){return this.options.selectedUserVisibility}else{return true}},_isFreeVisibility:function(){if("freeVisibility" in this.options){return this.options.freeVisibility}else{return true}},_isSelectedUserSearchByName:function(){if("selectedUserSearchByName" in this.options){return this.options.selectedUserSearchByName}else{return false}},__constructor:function(b){this.options=b||{};this._selectSub=false;var c=b.elBtnOpen;if(!c||!c instanceof jQuery||c.length<1){throw new Error("neo.webdb.SelectUsr : options.elBtnOpen is unavailable.")}this._setElBtnOpen(c);if(typeof b.callbackBeforeShow=="function"){this.callbackBeforeShow=b.callbackBeforeShow}if(typeof b.callbackOnChange=="function"){this.callbackOnChange=b.callbackOnChange}if(typeof b.callbackAfterHide=="function"){this.callbackAfterHide=b.callbackAfterHide}this._initialize()},_initialize:function(){var c=this._getElBtnOpen();this.initElBtnOpen();if(this._isSelectedUserVisible()){this.setSelectedUsers(this.options.selectedUsers)}else{var b=$.extend([],this.options.selectedUsers);this._setFirstSelectedUsers(b);this.setSelectedUsers([])}},_onOpenClick:function(b){b.preventDefault();if(this.callbackBeforeShow){this.callbackBeforeShow()}this.open()},initElBtnOpen:function(){var c=this._getElBtnOpen();var b=(function(d){return function(f){d._onOpenClick(f)}})(this);c.click(b)},open:function(){a.instance=this;var b=this._getElDlg();b.webdbDialog("open");if(!a.updated){a.updateLow()}$('input[name="s_key"]').val("");$('input[name="name"]').attr("checked",true);$('input[name="kana"]').attr("checked",true);$('input[name="mail"]').attr("checked",true);$("#usr-srchlist").empty();$("#resizeSelUsrY").find(".Pane").scrollTop("0");a.getElResultPaging().hide();b.find("li.usr-sellist-srch").click();var g=a.getElTreeOrg();var f=g.find(".selectorg-list");f.remove();a.elItem=g;a.updateToggleContent("");if(typeof this.options.updateIdList=="function"){var d=this.getSelectedUsers()||[];var e=this.options.updateIdList(d);if(e!=null){this.setSelectedUsers(e)}}this.setSelectedElements();var c=this._isFreeVisibility();a.setFreeOrg(c)},_getElDlg:function(){return a.getElDlg()},setSelectedElements:function(){var e=$("#usr-sellist");e.empty();var b=this.getSelectedUsers()||[];for(var d=0;d<b.length;d++){var c=b[d];this._addSelectedUser(c.id,neo.core.escape(c.name))}this.setSrchListSelected()},close:function(){var b=this._getElDlg();b.webdbDialog("close")},select:function(b){var d=b.attr("data-id");var c=b.html();if(d==undefined||d==null||d==""){return}this._addSelectedUser(d,c);b.closest("tr").children().removeClass(a.CLS_UNSELECTED).addClass(a.CLS_SELECTED)},_addSelectedUser:function(g,e){if(g==undefined||g==null||g==""){if(this._isSelectedUserSearchByName()){g=""}else{return}}if(this._isSingle()){this.deselectAll()}var f=$("#usr-sellist");var b='<li data-id="'+g+'"><a href="#"  class="'+a.CLS_SELLIST+" "+a.CLS_SELUSRLABEL+'">'+e+"</a></li>";f.append($(b));var d=a.getElDlg();var c=d.find("."+a.CLS_SELUSRLABEL).click(a.onSelLabelClick)},deselectAll:function(){var b=$("#usr-sellist ."+a.CLS_SELUSRLABEL);for(var d=0;d<b.length;d++){var c=b.eq(d);this.deselect(c)}},deselect:function(c){if(this._isSelectedUserSearchByName()){var d=c.text();var b=a.getElDlg();var e=b.find("a.selectusr-usr-sellist-label");for(var f=0;f<e.length;f++){if(e.eq(f).text()==d){e.eq(f).closest("tr").children().removeClass(a.CLS_SELECTED).addClass(a.CLS_UNSELECTED)}}}else{var g=c.parent().attr("data-id");var b=a.getElDlg();var e=b.find("a.selectusr-usr-sellist-label");for(var f=0;f<e.length;f++){if(e.eq(f).attr("data-id")==g){e.eq(f).closest("tr").children().removeClass(a.CLS_SELECTED).addClass(a.CLS_UNSELECTED)}}}c.parent().remove()},setSrchListSelected:function(){var c=$("#usr-sellist").find("li");var e=$("#usr-srchlist .selectusr-usr-sellist-label");$("."+a.CLS_SELECTED).removeClass(a.CLS_SELECTED).addClass(a.CLS_UNSELECTED);var j;var g;if(this._isSelectedUserSearchByName()){j=$.map(e,function(k){return $(k).text()})}else{j=$.map(e,function(k){return $(k).attr("data-id")})}for(var f=0;f<c.length;f++){if(this._isSelectedUserSearchByName()){g=c.eq(f).find("a").text()}else{g=c.eq(f).attr("data-id")}var d=this._getSrchItemIndexOf(g,j);if(d>=0){elseltr=e.eq(d).closest("tr");elseltr.find("td").removeClass(a.CLS_UNSELECTED).addClass(a.CLS_SELECTED)}}var h=this._getFirstSelectedUsers();for(var f=0;f<h.length;f++){if(!h[f]){return}if(this._isSelectedUserSearchByName()){g=h[f].name}else{g=h[f].id}var d=this._getSrchItemIndexOf(g,j);if(d>=0){elseltr=e.eq(d).closest("tr");elseltr.find("td").removeClass(a.CLS_UNSELECTED).addClass(a.CLS_SELECTED)}}var b=a.getElDlg();var c=b.find("."+a.CLS_SELUSRLABEL).click(a.onSelLabelClick)},_getSrchItemIndexOf:function(d,c){for(var b=0;b<c.length;b++){if(d==c[b]){return b}}return -1}},classProperties:{CGI_UPDATE:"vdoc",CMD_UPDATE:"optionusrlist",CMD_TOGGLELIST:"getselectgroups",CMD_USRCHLIST:"getselectusers",ID_NOASSIGNED:"000000000000",CLS_SELECTED:"usr-line-selected",CLS_UNSELECTED:"usr-sellist-srch-reslist-td",CLS_SELLIST:"usr-line-sellist",CLS_SELUSRLABEL:"sellistusr-label",USRCHLIST_MODE_KANA:"1",USRCHLIST_MODE_ORG:"2",USRCHLIST_MODE_KEYWORD:"3",RESULT_SORT_ASK_MARK:"▲",RESULT_SORT_DESK_MARK:"▼",elItem:null,elOpener:null,valsrchkey:null,valsrchkey_name:null,valsrchkey_kana:null,valsrchkey_addr:null,valsrchknno:null,valsrchknno_all:null,valsrchorgid:null,sortfld:null,sortorder:null,pagerow:null,prevsortorder:null,prevsortfld:null,instance:null,updated:false,showing:false,srchmode:null,_data:new neo.core.Strage(),getElSepXSelUsrPage:function(){return $("#resizeSelUsrX")},getElSepYSelUsrPage:function(){return $("#resizeSelUsrY")},getElTreeOrg:function(){return $("#select_users-org_tree-root")},getElFreeItem:function(){var c=this.getElTreeOrg();var b=c.find("[data-id=free]");return b},getElBtnClear:function(){return $(".btn-selusr-clear")},getElTabSrchKey:function(){return $(".usr-sellist-srchkey")},getElTabSrchOrg:function(){return $(".usr-sellist-srchorg")},getElTabMenuSrchKey:function(){return $(".usr-sellist-srch")},getElTabMenuSrchOrg:function(){return $(".usr-sellist-org")},getElResultSort:function(b){return b.find(".usr-sellist-srch-resttl-td").find("a.lt")},getElResultNothing:function(){return $("#select_users-result-nothing")},getElResultPaging:function(){return $("#select_users-result-paging")},getElResultPrevPage:function(){return $("#select_users-result-paging-prev")},getElResultNextPage:function(){return $("#select_users-result-paging-next")},getElDlg:function(){return this._elDlg||this._initElDlg()},_initElDlg:function(){var e={buttons:{},open:a.onOpen,close:a.onClose};var d="OK";e.buttons[d]=a.onBtnOkClick;var c="キャンセル";e.buttons[c]="close";var b=$("#dlg-select_users");var f=neo.webdb.getDialog(b,e);return this._elDlg=b},_elDlg:null,updateLow:function(b){this.updated=true;this._bindActions()},setFreeOrg:function(c){var b=a.getElFreeItem();if(b.length<1){return}var d=b.prev();var e="last";if(c){b.show();d.removeClass(e)}else{b.hide();d.addClass(e)}},_bindActions:function(){var l=this.getElDlg();var m;var e;m=l.find("li.usr-sellist-srch").click(a.onSrchTabClick);m=l.find("li.usr-sellist-org").click(a.onSrchTabClick);e=l.find("a.usr-sellist-srch-kana").click(a.onKanaLabelClick);e=l.find(".usr-sellist-srchbtn").click(a.onBtnSearchClick);e=l.find("a.selectorg-label").click(a.onOrgLabelClick);if($.browser.msie&&$.browser.version<=6){e.mouseover(function(){$(this).addClass("usr-line-hover")}).mouseout(function(){$(this).removeClass("usr-line-hover")})}var k=l.find('input[name="ok"]');k.click(a.onBtnOkClick);var d=l.find('input[name="cancel"]');d.click(a.onBtnCancelClick);var j=function(){$(this).addClass("ui-state-focus")};var b=function(){$(this).removeClass("ui-state-focus")};var f=function(){$(this).addClass("ui-state-hover")};var g=function(){$(this).removeClass("ui-state-hover")};k.add(d).focus(j).blur(b).mouseover(f).mouseout(g);e=l.find(".usr-sellist-srch-reslist-chgrow").click(a.onSrchListPChgClick);var n=a.getElSepXSelUsrPage();n.layout({zIndex:0,size:255,minSize:255,maxSize:400,spacing_open:10,resizerTip:"",closable:false,scrollToBookmarkOnLoad:false});var c=a.getElSepYSelUsrPage();c.layout({zIndex:0,size:270,minSize:100,maxSize:340,spacing_open:10,resizerTip:"",closable:false,scrollToBookmarkOnLoad:false});var h=a.getElBtnClear();h.click(a.onBtnClearClick)},_bindSrchListActions:function(){var b=a.getElDlg();elItems=b.find("a.selectusr-usr-sellist-label").click(a.onUsrLabelClick);elItems=a.getElResultSort(b).click(a.onSrchListSortClick)},onOpen:function(){var b=$(this);a.showing=true},onBtnOkClick:function(d){var c=a.instance;c.close();var b=[];$("#usr-sellist > li").each(function(h,e){var g=$(e);var f={id:g.attr("data-id"),name:g.text()};b.push(f)});c.setSelectedUsers(b);if(c.callbackOnChange){c.callbackOnChange(b)}},onBtnCancelClick:function(c){var b=a.instance;b.close()},onClose:function(c){if(c.keyCode){$(this).dialog("close")}a.showing=false;var b=a.instance;if(!a.adjusting&&b.callbackAfterHide){b.callbackAfterHide()}},onKanaLabelClick:function(b){b.preventDefault();a.updateSrchContent($(b.target))},onBtnSearchClick:function(b){b.preventDefault();a.updateSrchContent($(b.target))},onOrgLabelClick:function(b){b.preventDefault();a.updateSrchContent($(b.target))},onBtnClearClick:function(f){f.preventDefault();var c=a.getElDlg();var d=$("#usr-sellist").find("li");d.remove();var e=c.find("a.selectusr-usr-sellist-label");for(var g=0;g<e.length;g++){e.eq(g).parent().parent().parent().find("td").removeClass(a.CLS_SELECTED).addClass(a.CLS_UNSELECTED)}var b=a.instance;b.setSrchListSelected()},onSrchTabClick:function(j){j.preventDefault();var d="webdb-tabs-selected";var f="usr-sellist-srch";var h=$(j.target).closest(".tab-item");var b=a.getElTabSrchKey();var g=a.getElTabSrchOrg();var c=a.getElTabMenuSrchKey();var k=a.getElTabMenuSrchOrg();if(h.hasClass(d)==true){return}if(h.hasClass(f)==true){b.show();g.hide();c.addClass(d);k.removeClass(d)}else{g.show();b.hide();k.addClass(d);c.removeClass(d)}h.find("a").blur()},onClickTvToggle:function(d){var c=$(d);var b=$(d).find("ul:first");if(b.length>0&&b.hasClass("selectorg-list-dmy")==true&&c.hasClass("collapsable")==true){a.elItem=c;var e=c.attr("data-id");a.updateToggleContent(e);return}},updateToggleContent:function(c){var b=this.getObjAjaxToggleUpdate(c);b.sendRequest()},getObjAjaxToggleUpdate:function(c){var b=this.getOptionsAjaxToggleUpdate(c);this._objAjaxToggle=new neo.webdb.Ajax(b);this._objAjaxToggle.initialize();return this._objAjaxToggle},getOptionsAjaxToggleUpdate:function(c){var b={url:neo.webdb.getMainUrl(),getSendData:function(){var d={cmd:a.CMD_TOGGLELIST,gid:c};return d},onsuccess:a.onAjaxToggleUpdateSuccess};return b},onAjaxToggleUpdateSuccess:function(f){var c=f.result.groupinfo||[];var d=a._buildElOrgList(c);a.updateToggleLow(d);var b=a.instance;var e=b._isFreeVisibility();a.setFreeOrg(e)},_buildElOrgList:function(j){var k=a.getElTreeOrg();if(a.elItem[0]==k[0]){var h={haschildren:0,id:"*",name:"すべて"};j.unshift(h);var c={haschildren:0,id:"free",name:"グループに属さない"};j.push(c)}if(!j){return null}var o=$("#select_users-org_tree-node-prototype");var m=$("#select_users-org_tree-node-dummy-prototype");var g=o.clone().removeAttr("id");var d=g.children();d.remove();for(var e=0;e<j.length;e++){var n=j[e];if(!n){continue}var l=d.clone().removeAttr("id");l.attr("data-id",n.id);var f=l.find("a");f.attr("title",n.name).text(n.name);if(n.haschildren){var b=m.clone().removeAttr("id");l.append(b)}g.append(l)}return g},updateToggleLow:function(j){if(a.elItem!=null){var k=a.elItem.find("ul.selectorg-list-dmy");k.remove();a.elItem.append(j);var h=a.getElTabSrchOrg();var e=h.scrollTop();var g=h.scrollLeft();var d=a.getElTreeOrg().parent();d.find("div.hitarea").remove();d.find("li.expandable").removeClass("expandable");d.find("li.collapsable").removeClass("collapsable");d.find("li.lastExpandable").removeClass("lastExpandable");d.find("li.lastCollapsable").removeClass("lastCollapsable");d.treeview({collapsed:true,unique:true,toggle:function(){a.onClickTvToggle(this)}});var l=a.getElDlg();elItems=l.find("a.selectorg-label").click(a.onOrgLabelClick);var n=a.elItem;while(-1){n.find("div:first").click();n.removeClass("expandable").addClass("collapsable");n.find("div:first").removeClass("expandable-hitarea").addClass("collapsable-hitarea");var c=n.attr("data-id");var b=n.parent().children();var f=false;for(i=0;i<b.length;i++){if($(b[i]).attr("data-id")==c){f=true}}if(f==true&&b.length==i+1){n.removeClass("lastExpandable").addClass("lastCollapsable");n.find("div:first").removeClass("lastExpandable-hitarea").addClass("lastCollapsable-hitarea")}var m=n.parent().parent();if(m.hasClass("expandable")==true){n=m}else{break}}h.scrollTop(e);h.scrollLeft(g)}},updateSrchContent:function(c){if(c!=null){var d=this.validateSrchList(c);if(d==false){return}}var b=this.getObjAjaxSrchListUpdate(c);b.sendRequest()},validateSrchList:function(e){if(e.hasClass("usr-sellist-srchbtn")){var c=$('input[name="name"]').attr("checked")?$('input[name="name"]').val():"0";var d=$('input[name="kana"]').attr("checked")?$('input[name="kana"]').val():"0";var b=$('input[name="mail"]').attr("checked")?$('input[name="mail"]').val():"0";if(c=="0"&&d=="0"&&b=="0"){var f="検索条件を入力してください。";neo.webdb.alert(f);return false}}return true},getObjAjaxSrchListUpdate:function(c){var b=this.getOptionsAjaxSrchListUpdate(c);this._objAjaxSrch=new neo.webdb.Ajax(b);this._objAjaxSrch.initialize();return this._objAjaxSrch},getOptionsAjaxSrchListUpdate:function(c){if(c!=null){delete a.valsrchknno;delete a.valsrchknno_all;delete a.valsrchorgid;delete a.valsrchkey;delete a.valsrchkey_name;delete a.valsrchkey_kana;delete a.valsrchkey_addr;if(c.hasClass("usr-sellist-srch-kana")){a.valsrchknno=c.attr("data-id");a.valsrchknno_all=c.hasClass("srchmode-all")?"all":""}else{if(c.hasClass("selectorg-label")){a.valsrchorgid=c.parent().attr("data-id")}else{a.valsrchkey=$('input[name="s_key"]').val();a.valsrchkey_name=$('input[name="name"]').attr("checked")?$('input[name="name"]').val():"0";a.valsrchkey_kana=$('input[name="kana"]').attr("checked")?$('input[name="kana"]').val():"0";a.valsrchkey_addr=$('input[name="mail"]').attr("checked")?$('input[name="mail"]').val():"0"}}}var b={url:neo.webdb.getMainUrl(),useDefaultXml:false,getSendData:function(){var e={cmd:a.CMD_USRCHLIST};if(a.valsrchknno){e.mode=a.USRCHLIST_MODE_KANA;e.kanano=a.valsrchknno}else{if(a.valsrchorgid){var d=a.valsrchorgid;if(d=="*"){d=""}e.mode=a.USRCHLIST_MODE_ORG;e.gid=d}else{e.mode=a.USRCHLIST_MODE_KEYWORD;e.keyword=a.valsrchkey;e.keywordflag=0|(a.valsrchkey_name<<0)|(a.valsrchkey_kana<<1)|(a.valsrchkey_addr<<2)}}if(a.sortfld){e.sort=a.sortfld;e.order=a.sortorder}if(a.pagerow!=null){e.row=a.pagerow}return e},onsuccess:a.onAjaxSrchListUpdateSuccess};return b},onAjaxSrchListUpdateSuccess:function(c){a.prevsortfld=a.sortfld;a.prevsortorder=a.sortorder;delete a.sortfld;delete a.sortorder;delete a.pagerow;var d=c.result;var e=d.userinfo;var b=a._buildElSearchResult(e);a.updateSrchList(b,d)},_buildElSearchResult:function(g){if(g.length<1){return null}var f=$("#select_users-result-prototype").clone().removeAttr("id");var e=f.find("#select_users-result-row-prototype").remove().clone().removeAttr("id");for(var d=0;d<g.length;d++){var c=g[d];if(!c){continue}var b=e.clone().removeAttr("id");b.find(".selectusr-usr-sellist-label").attr("data-id",c.id).text(c.name);if(c.groups.length>0){b.find(".selectusr-usr-sellist-group").text(c.groups.join(", "))}f.append(b)}return f},updateSrchList:function(g,h){var j=$("#usr-srchlist").empty();$("#resizeSelUsrY").find(".Pane").scrollTop("0");var f=this.getElResultNothing();var e=this.getElResultPaging();if(g){j.append(g);e.show();f.hide();this._updateSrchListSorter(g,h.sort,h.order);e.attr("data-row",h.row);e.attr("data-limit",h.limit);var d=this.getElResultPrevPage();d.toggleClass("paging-nolink",!h.hasprevpage);var c=this.getElResultNextPage();c.toggleClass("paging-nolink",!h.hasnextpage)}else{e.hide();f.show()}var b=a.instance;b.setSrchListSelected();this._bindSrchListActions()},_updateSrchListSorter:function(f,e,c){var h;var d;if(Number(c)>0){h=a.RESULT_SORT_ASK_MARK;d="0"}else{h=a.RESULT_SORT_DESK_MARK;d="1"}var g=this.getElResultSort(f);var b=g.filter('[data-sortfld="'+e+'"]');b.append(h);b.attr("data-sortorder",d)},onSrchListSortClick:function(d){d.preventDefault();var c=$(this);var e=c.attr("data-sortfld");var b=c.attr("data-sortorder");a.sortfld=e;a.sortorder=b;a.updateSrchContent(null)},onUsrLabelClick:function(c){c.preventDefault();var d=$(c.target);if(d.closest("."+a.CLS_SELECTED).length>0){return}var b=a.instance;b.select($(this))},onSelLabelClick:function(d){d.preventDefault();var b=a.instance;var c=$(this);b.deselect(c)},onSrchListPChgClick:function(f){f.preventDefault();var d=a.getElResultPaging();var g=Number(d.attr("data-row"));var b=a.getElResultPrevPage();var e=Number(d.attr("data-limit"));var c;if(this==b[0]){c=g-e}else{c=g+e}a.sortfld=a.prevsortfld;a.sortorder=a.prevsortorder;a.pagerow=c;a.updateSrchContent(null)}}})})();