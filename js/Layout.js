(function(b){var c=neo.core.readyNamespace("neo.webdb.Layout");if(!c){return}var a=neo.webdb.Layout=new neo.core.Class({classProperties:{CLS_LIST_ITEM:"layout-list-item",CLS_ITEM:"layout-item",CLS_ITEM_HOVERED:"layout-item-hover",CLS_DETAIL_SEPARATOR:"layout-detail-separator",PFX_CLS_DETAIL_ROW_HEIGHT:"layout-detail-row-height_lv-",PFX_CLS_DETAIL_ROW_COL_LENGTH:"layout-detail-row-col_length_",MIN_COL_WIDTH:50,DEF_COL_WIDTH:100,MAX_DETAIL_COLS:3,TABLE_TYPE:"l",DETAIL_TYPE:"d",NORMAL_ROW:"n",SEPARATOR_ROW:"s",defaultSetting:{},draggableDefaultSetting:{handle:".layout-grip",revert:true,zIndex:1,start:function(d,e){e.helper.addClass("layout-item-dragging");neo.webdb.showCover("move")},stop:function(d,e){e.helper.removeClass("layout-item-dragging");neo.webdb.hideCover()}},resizeDraggableDefaultSetting:{axis:"x",scroll:false,start:function(d,e){e.helper.addClass("layout-item-resize-dragging");neo.webdb.showCover("e-resize")},stop:function(d,e){e.helper.removeClass("layout-item-resize-dragging");neo.webdb.hideCover()}},droppableDefaultSetting:{accept:".layout-item",activeClass:"droppable-active",hoverClass:"droppable-hover",tolerance:"pointer"},getRowDataKey:function(e,d){var f="l_r_"+e+"_"+d;return f},getColDataKey:function(e,d){var f="l_c_"+e+"_"+d;return f}},properties:{setting:null,_getDraggableSetting:function(){var d=b.extend({},a.draggableDefaultSetting);return d},_getResizeDraggableSetting:function(){var d=b.extend({},a.resizeDraggableDefaultSetting);return d},_getDroppableSetting:function(){var d=b.extend({},a.droppableDefaultSetting);return d},_elAllItems:null,_getElAllItems:function(){return this._elAllItems},_initElAllItems:function(){var e=this._getElHiddenListContainer();var d=e.find(".layout-item");return this._elAllItems=d},_getType:function(){return this.setting.layout.type||a.TABLE_TYPE},_setType:function(d){return this.setting.layout.type=d},_getRows:function(){return this.setting.layout.rows},_getLayout:function(){return this.setting.layout},_getFormat:function(){return this.setting.format},_getLayoutItems:function(){return this.setting.layoutitems},_getLineHeight:function(){return this.setting.lineHeight},_getElTableContainer:function(){return this.setting.elTableContainer},_getElTableHeight:function(){return this.setting.elTableHeight},_getElTable:function(){return this.setting.elTable},_getElTableDummyItem:function(){return this.setting.elTableDummyItem},_getElDetailContainer:function(){return this.setting.elDetailContainer},_getElDetail:function(){return this.setting.elDetail},_getElDetailRowTemplate:function(){return this.setting.elDetailRowTemplate},_getElAddDetailRowBtn:function(){return this.setting.elAddDetailRowBtn},_getElAddDetailSeparatorBtn:function(){return this.setting.elAddDetailSeparatorBtn},_getElRemoveDetailRowBtn:function(){return this.setting.elRemoveDetailRowBtn},_getElJoinDetailColsBtn:function(){return this.setting.elJoinDetailColsBtn},_getElJoinDetailColsVal:function(){return this.setting.elJoinDetailColsVal},_getElSetDetailRowHeightBtn:function(){return this.setting.elSetDetailRowHeightBtn},_getElDetailRowHeightVal:function(){return this.setting.elDetailRowHeightVal},_getElDetailColLen:function(){return this.setting.elDetailColLen},_getElHiddenListContainer:function(){return this.setting.elHiddenListContainer},_getElHiddenList:function(){return this.setting.elHiddenList},_getElDetailRowHeightSettingBalloon:function(){return this.setting.elDetailRowHeightSettingBalloon},_getElOneDetailRowHeightVal:function(){return this.setting.elOneDetailRowHeightVal},__constructor:function(d){this.setting=d||{}},initialize:function(){this._initSetting();this._initElAllItems();this._hook();this._initLayout()},_initSetting:function(){var d=this._getDefaultSetting();this.setting=b.extend({},d,this.setting)},_getDefaultSetting:function(){return b.extend({},a.defaultSetting)},_initLayout:function(){this._initLayoutVisibility();var d=this._getType();if(d==a.TABLE_TYPE){this._initTableLayout()}else{if(d==a.DETAIL_TYPE){this._initDetailLayout()}else{throw new Error('neo.webdb.Layout._initLayout : Unkown layout type : "'+d+'"')}}},_initLayoutVisibility:function(){var f=this._getElTableContainer();var d=this._getElDetailContainer();var e=this._getType();if(e==a.TABLE_TYPE){f.show();d.hide()}else{if(e==a.DETAIL_TYPE){if(b.browser.msie&&b.browser.version>=8){setTimeout(function(){f.hide()},1)}else{f.hide()}d.show()}else{throw new Error('neo.webdb.Layout._initLayoutVisibility : Unkown layout type : "'+e+'"')}}},_initTableLayout:function(){var h=this._getLayout();var j=neo.core.get(h,"rows.0");if(!j){return}var e=this._getElTable();e.attr("data-id",j.id);var d=this._getElTableHeight();d.val(j.height);var g=j.columns;for(var f=0;f<g.length;f++){var k=g[f];this._initTableCol(k)}},_initTableCol:function(i){var h=this._getElTableDummyItem();var e=this._moveToTable(i,h);var f=a.DEF_COL_WIDTH;var d=this._getFormat();var g=d[i];if(g!=undefined){f=g.width}this._setWidth(e,f)},_initDetailLayout:function(){var g=this._getLayout();var h=g.rows||[];this._removeAllDetailRows();var e=this._getElDetail();for(var f=0;f<h.length;f++){var j=h[f];if(!j){continue}this._initDetailRow(j)}var k=g.collen;var d=this._getElDetailColLen();d.val(k)},_initDetailRow:function(e){var d;if(e.type==a.SEPARATOR_ROW){d=this.appendDetailSeparator()}else{d=this.appendDetailRow();this.setDetailRowHeight(d,e.height);this.setDetailColLength(d,e.length);if(e.columns!=null){this._appendDetailCols(e.columns,e.length,d)}}d.attr("data-id",e.id)},_removeAllDetailRows:function(){var e=this._getElDetail();var d=this._getElDetailRowFrom(e);d.remove()},_appendDetailCols:function(g,k,d){var f=this._getElDetailLayoutColFrom(d);for(var e=0;e<k;e++){var j=g[e];if(!j){continue}var h=f.eq(e);this._moveToDetail(j,h)}},_hook:function(){var d;d=this._getElAllItems();var e=this._getDraggableSetting();d.draggable(e);d.hover(this.__closure(this.onhoverin),this.__closure(this.onhoverout));d=this._getElAllRemoveBtns();this.__bind(d,"click","Remove");d=this._getElAllResizeGrips();var e=this._getResizeDraggableSetting();d.draggable(e);this.__bind(d,"dragstart","Resize");this.__bind(d,"dragstop","Resize");d=this._getElAllItems().add(this._getElTableDummyItem()).add(this._getElHiddenList());var e=this._getDroppableSetting();d.droppable(e);this.__bind(d,"drop");this._hookDetail()},_hookDetail:function(){var d;d=this._getElDetail();d.webdbSelectableTable().webdbSortableLayoutTable().webdbSortableLayoutTable("start");d=this._getElAddDetailRowBtn();this.__bind(d,"click","AppendDetailRow");d=this._getElAddDetailSeparatorBtn();this.__bind(d,"click","AppendDetailSeparator");d=this._getElJoinDetailColsBtn();this.__bind(d,"click","JoinDetailCol");d=this._getElSetDetailRowHeightBtn();this.__bind(d,"click","SetDetailRowHeight");d=this._getElRemoveDetailRowBtn();this.__bind(d,"click","RemoveDetailRow");d=this._getElDetailRowHeightSettingBalloon();d.webdbBalloon();this.__bind(d.find("button"),"click","OneDetailRowHeight")},switchType:function(){var e="レイアウト形式を変更すると、設定されているレイアウト設定は破棄されます。\n変更してよろしいですか？";var d={onok:this.__closure(this._switchTypeLow)};neo.webdb.confirm(e,d)},_switchTypeLow:function(){var d=this._getType();if(d==a.TABLE_TYPE){this._switchTypeToDetail()}else{if(d==a.DETAIL_TYPE){this._switchTypeToTable()}else{var e='Unkown layout type : "'+d+'"';throw new Error("neo.webdb.Layout.switchType : "+e)}}},_switchTypeToDetail:function(){var d=this._getVisibleIdListForTable();this._buildDetailRows(d);this._setType(a.DETAIL_TYPE);this._initLayout()},_getVisibleIdListForTable:function(){var g=this._getElTable();var d=this._getElItemFrom(g);var h=[];for(var f=0;f<d.length;f++){var e=d.eq(f);var j=this._getColIdOf(e);h.push(j)}return h},_buildDetailRows:function(f){this._removeAll();var e=this._getLayout();var j=e.rows;var g=[];for(var d=0;d<f.length;d++){var k=f[d];if(!k){continue}var h={};if(j!=undefined){h=j[d]||{}}h.length=1;h.height=0;h.type="n";h.columns=[k];g.push(h)}e.rows=g},_switchTypeToTable:function(){var d=this._getVisibleIdListForDetail();this._buildTableRows(d);this._setType(a.TABLE_TYPE);this._initLayout()},_getVisibleIdListForDetail:function(){var m=this._getElDetail();var o=this._getElDetailRowFrom(m);var k=[];for(var h=0;h<o.length;h++){var d=o.eq(h);var l=this._getElDetailLayoutColFrom(d);for(var g=0;g<l.length;g++){var f=l.eq(g);var n=this._getElItemFrom(f);var e=this._getColIdOf(n);if(e){k.push(e)}}}return k},_buildTableRows:function(d){this._removeAll();var e=this._getRows();if(e.length>0){e[0].columns=d}},_removeAll:function(){var d=this._getLayoutItems();for(var e in d){this.remove(e)}},move:function(g,f){if(this._isElHiddenListContainer(f)){this.remove(g)}else{var e=this._getType();if(e==a.TABLE_TYPE){var d=this._moveToTable(g,f);if(!d.attr("data-width")){this._setWidth(d,a.DEF_COL_WIDTH)}}else{if(e==a.DETAIL_TYPE){this._moveToDetail(g,f)}else{throw new Error('neo.webdb.Layout.move : Unkown layout type : "'+e+'"')}}}var d=this._getElItemOf(g);d.css({left:0,top:-10})},_moveToTable:function(i,g){var h=this._getElListItemOf(i);var f=this._buildElListItem(i);var d=this._getElListItemOf(g);f.insertBefore(d);h.remove();var e=this._getElItemOf(i);e.draggable("option","axis","x");return e},_moveToDetail:function(h,f){var d=this._getElItemFrom(f);if(d.length>0){return}var g=this._getElListItemOf(h);var e=this._getElItemOf(h);f.append(e);g.remove()},remove:function(f){var e=this._getElListItemOf(f);var h=this._getElHiddenList();var g=false;e.parents().each(function(k,j){if(j==h[0]){g=true;return false}});if(g){return}var d=this._getType();if(d==a.TABLE_TYPE){this._removeFromTable(f)}else{if(d==a.DETAIL_TYPE){this._removeFromDetail(f)}else{throw new Error('neo.webdb.Layout.remove : Unkown layout type : "'+d+'"')}}},_removeFromTable:function(g){var f=this._getElListItemOf(g);var e=this._buildElListItem(g);var h=this._getElHiddenList();e.appendTo(h);f.remove();var d=this._getElItemOf(g);d.css({width:""}).draggable("option","axis","");d.removeAttr("data-width")},_removeFromDetail:function(e){var d=this._buildElListItem(e);var f=this._getElHiddenList();d.appendTo(f)},updateResizeGripMovableArea:function(d){var f=d.offset();var e=a.MIN_COL_WIDTH;var i=this._getElResizeGrip(d);var g=i.width();var h=[f.left+e-((g+1)/2),0,document.documentElement.clientWidth,0,];i.draggable("option","containment",h)},resizeByGrip:function(h){var g=neo.webdb.getRect(h,true);var d=this._getElItemFrom(h);var f=d.offset();var e;if(b.browser.msie&&b.browser.version<=6){e=(g.left+g.width)-f.left}else{e=(g.left+(g.width+1)/2)-f.left}this._setWidth(d,e);h.css({left:""})},_setWidth:function(d,e){d.width(e);d.attr("data-width",e)},increaseDetailLayoutCol:function(d){var f=Number(d.attr("data-colLength"));if(f>=a.MAX_DETAIL_COLS){return}var e=f+1;this.setDetailColLength(d,e)},decreaseDetailLayoutCol:function(d){var f=Number(d.attr("data-colLength"));if(f<=1){return}var e=f-1;this.setDetailColLength(d,e)},showDetailRowHeightSetting:function(d){var g=d.attr("data-heightLv");var e=this._getElDetailRowHeightSettingBalloon();e.find("select").val(g);var f=this._getElDetailRowHeightSettingBtn(d);e.webdbBalloon("option","elRelation",f);e.webdbBalloon("show")},setDetailRowHeight:function(e,g){for(var f=0;f<e.length;f++){var d=e.eq(f);this._setDetailRowHeightLow(d,g)}},_setDetailRowHeightLow:function(e,f){if(e.hasClass(a.CLS_DETAIL_SEPARATOR)){return}var h=e.attr("data-heightLv");var g=a.PFX_CLS_DETAIL_ROW_HEIGHT+h;e.removeClass(g);var d=a.PFX_CLS_DETAIL_ROW_HEIGHT+f;e.addClass(d);if(b.browser.msie&&b.browser.version<=7){e.find(".layout-item-block-title-label, .layout-cell_box").hide().show()}e.attr("data-heightLv",f)},appendDetailRow:function(e,i){if(!e){var g=this._getElDetail();e=this._getElDetailRowFrom(g).filter(":last")}if(!i){i=a.NORMAL_ROW}var f;if(i==a.NORMAL_ROW){f=e.attr("data-colLength")||a.MAX_DETAIL_COLS}else{f=1}var h=this._buildElDetailLayoutRow(f);if(i==a.SEPARATOR_ROW){var d=a.CLS_DETAIL_SEPARATOR;h.addClass(d)}h.attr("data-type",i);if(e.length>0){h.insertAfter(e)}else{var g=this._getElDetail();h.appendTo(g)}this._hookDetailRow(h);return h},_buildElDetailLayoutRow:function(e){var f=this._getElDetailRowTemplate();var d=f.clone();this.setDetailColLength(d,e);return d},setDetailColLength:function(e,g){for(var f=0;f<e.length;f++){var d=e.eq(f);this._setDetailColLengthLow(d,g)}},_setDetailColLengthLow:function(e,i){if(e.hasClass(a.CLS_DETAIL_SEPARATOR)){i=1}var j=this._getElDetailLayoutColFrom(e);var g=j.filter(":lt("+(i)+")");g.show();var d=j.filter(":gt("+(i-1)+")");d.hide();var f=this._getElItemFrom(d);if(f.length>0){var h=this._getColIdOf(f);this._removeFromDetail(h)}e.attr("data-colLength",i);if(b.browser.msie&&b.browser.version>=8){var k=a.PFX_CLS_DETAIL_ROW_COL_LENGTH;e.removeClass(k+"1 "+k+"2 "+k+"3").addClass(k+i)}},_hookDetailRow:function(d){var e;if(!d.hasClass(a.CLS_DETAIL_SEPARATOR)){var g=this._getElDetailLayoutColFrom(d);var f=this._getDroppableSetting();g.droppable(f);this.__bind(g,"drop")}this.__bind(d,"click","DetailRow");d.mousedown(function(h){h.preventDefault()})},appendDetailSeparator:function(e){var d=this.appendDetailRow(e,a.SEPARATOR_ROW);return d},removeDetailRow:function(e){var d=this._getElItemFrom(e);this._removeElItems(d);e.remove()},_removeElItems:function(d){for(var e=0;e<d.length;e++){var f=this._getColIdOf(d.eq(e));this.remove(f)}},getData:function(d){d.l_type=this._getType();switch(d.l_type){case a.TABLE_TYPE:this._getTableData(d);break;case a.DETAIL_TYPE:this._getDetailData(d);break}return d},_getTableData:function(h){var e;var f=this._getElTable();var i=this._getRowIdOf(f);e=this._getRowDataKey(0,"id");h[e]=i;var g=[];this._getTableColData(h,g);e=this._getRowDataKey(0,"columns");h[e]=g.join(",");var d=this._getElTableHeight();e=this._getRowDataKey(0,"height");h[e]=d.val();return h},_getTableColData:function(h,l){var m=this._getElTable();var k=this._getElItemFrom(m);var g=[];for(var j=0;j<k.length;j++){var f={};var n=k.eq(j);var e=this._getColIdOf(n);f.id=e;var d=n.attr("data-width")||a.DEF_COL_WIDTH;f.width=Math.max(d,a.MIN_COL_WIDTH);this._appendColData(e,h,f);l.push(e)}return h},_getDetailData:function(e){this._getDetailRowsData(e);var d=this._getElDetailColLen();var f=d.val();e.collen=f;return e},_getDetailRowsData:function(k){var h=this._getElDetail();var e=this._getElDetailRowFrom(h);for(var g=0;g<e.length;g++){var f;var d=e.eq(g);var j=this._getDetailRowData(d);f=this._getRowDataKey(g,"id");k[f]=j.id;f=this._getRowDataKey(g,"type");k[f]=j.type;if(j.type==a.NORMAL_ROW){f=this._getRowDataKey(g,"height");k[f]=j.height;f=this._getRowDataKey(g,"cols");k[f]=String(j.columns.length);f=this._getRowDataKey(g,"columns");k[f]=j.columns.join(",")}}return k},_appendColData:function(j,h,i){if(!j){return h}var e=this._getColDataIndexOf(h,j);if(e<0){var g="Unkown column id: "+j;throw new Error("neo.webdb.Layout._getTableData : "+g)}for(var d in i){var f=this._getColDataKey(e,d);h[f]=i[d]}return h},_getDetailRowData:function(e){var l={};l.id=this._getRowIdOf(e)||"";l.type=e.attr("data-type");if(l.type==a.NORMAL_ROW){var d=this._getElItemFrom(e);if(d.length==0){l.type="e"}l.height=e.attr("data-heightLv");var g=Number(e.attr("data-colLength"));l.columns=new Array(g);var j=this._getElDetailLayoutColFrom(e);for(var h=0;h<g;h++){var k=j.eq(h);var f=this._getElItemFrom(k);l.columns[h]=this._getColIdOf(f)}}return l},_isElHiddenListContainer:function(d){var e=this._getElHiddenList();return(d[0]==e[0])},_getRowDataKey:function(e,d){return a.getRowDataKey(e,d)},_getColDataKey:function(e,d){return a.getColDataKey(e,d)},_getColDataIndexOf:function(g,i){var f=/l_c_(\d+)_id/;for(var h in g){var d=h.match(f);if(d){if(g[h]==i){var e=Number(d[1]);return e}}}return -1},_getRowIdOf:function(d){return d.attr("data-id")},_getColIdOf:function(d){return d.attr("data-id")},_getElItemOf:function(f){var e=this._getElAllItems();var d=e.filter('[data-id="'+f+'"]');return d},_getElItemFrom:function(f){var d="layout-item";var e=f.closest("."+d);if(e.length<1){e=f.find("."+d)}return e},_getElListItemOf:function(g){var d;if(g instanceof jQuery){d=g}else{var f=g;d=this._getElItemOf(f)}var e=d.closest("."+a.CLS_LIST_ITEM);return e},_buildElListItem:function(f){var d=this._getElItemOf(f);var e=b("<li />").addClass(a.CLS_LIST_ITEM).append(d);return e},_getElDetailRowFrom:function(f){var e="layout-detail-row";var d=f.closest("."+e);if(d.length<1){d=f.find("."+e)}return d},_getElDetailLayoutRowFrom:function(f){var e="layout-detail-layout_row";var d=f.closest("."+e);if(d.length<1){d=f.find("."+e)}return d},_getElDetailLayoutColFrom:function(f){var e="layout-detail-layout_col";var d=f.closest("."+e);if(d.length<1){d=f.find("."+e)}return d},_getElDetailRowHeightSettingBtn:function(d){return d.find(".layout-detail-edit_col-set_height")},_getElAllRemoveBtns:function(){var e=this._getElAllItems();var d=e.find(".layout-item-remove");return d},_getElResizeGrip:function(d){var e=d.find(".layout-item-resize");return e},_getElAllResizeGrips:function(){var d=this._getElAllItems();var e=this._getElResizeGrip(d);return e},_getElCheckedDetailRowId:function(){var e=this._getElDetail();var d=e.find(":checked");var f=this._getElDetailRowFrom(d);return f},__bind:neo.jq.bindListener,onhoverin:function(e){var d=b(arguments[arguments.length-1]);this.updateResizeGripMovableArea(d);if(b.browser.msie&&b.browser.version<=6){d.addClass(a.CLS_ITEM_HOVERED)}},onhoverout:function(e){if(b.browser.msie&&b.browser.version<=6){var d=b(arguments[arguments.length-1]);d.removeClass(a.CLS_ITEM_HOVERED)}},onclickRemove:function(f){var g=b(arguments[arguments.length-1]);var d=this._getElItemFrom(g);var e=this._getColIdOf(d);this.remove(e)},ondrop:function(g,h){var e=b(arguments[arguments.length-1]);var d=h.draggable;var f=this._getColIdOf(d);this.move(f,e)},ondragstartResize:function(e,f){if(b.browser.msie&&b.browser.version<=7){var d=this._getElItemFrom(f.helper);d.css({zIndex:999})}},ondragstopResize:function(f,g){if(b.browser.msie&&b.browser.version<=7){var d=this._getElItemFrom(g.helper);d.css({zIndex:""})}var e=g.helper;this.resizeByGrip(e)},onclickDetailRow:function(e){var f=b(e.target);var d=this._getElDetailRowFrom(f);if(f.closest(".layout-detail-edit_col-increase").length>0){this.increaseDetailLayoutCol(d)}else{if(f.closest(".layout-detail-edit_col-decrease").length>0){this.decreaseDetailLayoutCol(d)}else{if(f.closest(".layout-detail-edit_col-set_height").length>0){this.showDetailRowHeightSetting(d)}else{if(f.closest(".layout-detail-edit_col-append_next").length>0){this.appendDetailRow(d)}else{if(f.closest(".layout-detail-edit_col-remove").length>0){this.removeDetailRow(d)}}}}}},onclickAppendDetailRow:function(d){this.appendDetailRow()},onclickAppendDetailSeparator:function(d){this.appendDetailSeparator()},onclickJoinDetailCol:function(g){var e=this._getElCheckedDetailRowId();var d=this._getElJoinDetailColsVal();var f=d.val();this.setDetailColLength(e,f)},onclickSetDetailRowHeight:function(g){var f=this._getElCheckedDetailRowId();var e=this._getElDetailRowHeightVal();var d=e.val();this.setDetailRowHeight(f,d)},onclickRemoveDetailRow:function(e){var d=this._getElCheckedDetailRowId();this.removeDetailRow(d)},onclickOneDetailRowHeight:function(h){h.preventDefault();var g=this._getElDetailRowHeightSettingBalloon();var i=g.webdbBalloon("option","elRelation");var f=this._getElDetailRowFrom(i);var e=this._getElOneDetailRowHeightVal();var d=e.val();this.setDetailRowHeight(f,d);g.webdbBalloon("hide")},banpei:null}})})(jQuery);