(function(a){var c=neo.core.readyNamespace("neo.jQuery.fn.webdbSortableTable");if(!c){return}var b=neo.jQuery.fn.webdbSortableTable=new neo.core.Class({classProperties:{CLS_SORTABLE_TABLE:"webdb-sortable_table-sorting",CLS_TARGET_ROW:"webdb-sortable_table-target",CLS_NOTARGET_ROW:"webdb-sortable_table-notarget",CLS_SELECTED_ROW:"webdb-sortable_table-selected_row",CLS_DRAGGING:"webdb-sortable_table-dragging",CLS_PAGE_AREA:"webdb-sortable_table-other_page_area",CLS_PREV_PAGE_AREA:"webdb-sortable_table-other_page_area-prev",CLS_NEXT_PAGE_AREA:"webdb-sortable_table-other_page_area-next",CLS_HELPER:"webdb-sortable_table-helper",PAGE_NEXT:1,PAGE_PREV:-1,AIM_NEXT:1,AIM_PREV:-1,COOKIE_SORTING:"!sorting",showcase:null,defaultSetting:{},__constructor:function(){this.showcase=new neo.core.Showcase()},getInstance:function(d){return this.showcase.getInstance(d)},setInstance:function(e,d){return this.showcase.set(e,d)}},properties:{setting:null,_sorting:null,isSorting:function(){return this._sorting},_setSorting:function(d){return this._sorting=d},_dragging:null,_isDragging:function(){return this._dragging},_setDragging:function(d){return this._dragging=d},_curPos:null,_getCurPos:function(){return this._curPos},_setCurPos:function(d){this._setPrevPos(this._curPos);return this._curPos=d},_prevPos:null,_getPrevPos:function(){return this._prevPos},_setPrevPos:function(d){return this._prevPos=d},_dragStartedPos:null,_getDragStartedPos:function(){return this._dragStartedPos},_setDragStartedPos:function(d){return this._dragStartedPos=d},_aimDirection:null,_getAimDirection:function(){return this._aimDirection},_setAimDirection:function(d){return this._aimDirection=d},_tmAutoScroll:null,_getTmAutoScroll:function(){return this._tmAutoScroll},_setTmAutoScroll:function(d){return this._tmAutoScroll=d},_acceleration:null,_getAcceleration:function(){return this._acceleration||this._initAcceleration()},_initAcceleration:function(){return this._acceleration={x:0,y:0}},_setAcceleration:function(d){return this._acceleration=d},_element:null,toElement:function(){return this._element},_elPrevPageArea:null,_getElPrevPageArea:function(){return this._elPrevPageArea||this._initElPrevPageArea()},_initElPrevPageArea:function(){var d=a("<div />").addClass(b.CLS_PAGE_AREA+" "+b.CLS_PREV_PAGE_AREA).text("ドロップして前のページへ移動").insertBefore(this.toElement());return this._elPrevPageArea=d},_elNextPageArea:null,_getElNextPageArea:function(){return this._elNextPageArea||this._initElNextPageArea()},_initElNextPageArea:function(){var d=this._getElPrevPageArea();var e=d.clone().removeClass(b.CLS_PREV_PAGE_AREA).addClass(b.CLS_NEXT_PAGE_AREA).text("ドロップして次のページへ移動").insertAfter(this.toElement());return this._elNextPageArea=e},_elGrabedRow:null,_getElGrabedRow:function(){return this._elGrabedRow},_setElGrabedRow:function(d){return this._elGrabedRow=d},_elHoveredRow:null,_getElHoveredRow:function(){return this._elHoveredRow},_setElHoveredRow:function(d){return this._elHoveredRow=d},_elPrevHoveredRow:null,_getElPrevHoveredRow:function(){return this._elPrevHoveredRow},_setElPrevHoveredRow:function(d){return this._elPrevHoveredRow=d},_elTargetRow:null,_getElTargetRow:function(){return this._elTargetRow},_setElTargetRow:function(d){return this._elTargetRow=d},_elLastSelectedRow:null,_getElLastSelectedRow:function(){return this._elLastSelectedRow},_setElLastSelectedRow:function(d){return this._elLastSelectedRow=d},_elHelper:null,_getElHelper:function(){return this._elHelper||this._initElHelper()},_initElHelper:function(){var d=b.CLS_HELPER;var e=a('<div class="'+d+'" />').appendTo("body");return this._elHelper=e},_elAim:null,_getElAim:function(){return this._elAim||this._initElAim()},_initElAim:function(){var d=a('<div class="webdb-sortable_table-aim" />').appendTo("body");return this._elAim=d},__constructor:function(e,d){if(!e||!(e instanceof jQuery)){throw new Error("jQuery.fn.webdbSortableTable.__constructor : <element> is not valid.")}this._element=e;this.setting=d[0]||{};b.setInstance(e,this)},initialize:function(){this._hook();this._setTarget()},_hook:function(){var d=this.toElement();var h=a(document);this.__bind(d,"click");this.__bind(d,"mouseover");this.__bind(h,"mousemove");this.__bind(d,"mouseout");this.__bind(d,"mousedown");this.__bind(h,"mouseup");this.__bind(h,"selectstart");if(parent!=window){var g=a(parent.document);this.__bind(g,"mouseup");this.__bind(g,"selectstart")}var e=this.__closure(this.oncheckall);d.webdbSelectableTable("option","ontoggle",e)},_getDefaults:function(){return a.extend({},b.defaultSetting)},_setTarget:function(){var f=this.toElement();var d=b.CLS_NOTARGET_ROW;var g=f.find(">tr, >*>tr").filter(":not(."+d+")");var e=b.CLS_TARGET_ROW;g.addClass(e)},toggle:function(){if(this.isSorting()){this.stop()}else{this.start()}},start:function(){if(this.isSorting()){return}this._setSorting(true);this._setDragging(false);this._setClass();this._showPagingArea();this._disableButtons();this._findElSelectedRows().addClass(b.CLS_SELECTED_ROW);this._startAutoScrolling();neo.core.setCookie(b.COOKIE_SORTING,"true")},stop:function(){if(!this.isSorting()){return}this._setSorting(false);this._setDragging(false);this._resetClass();this._hidePagingArea();this._enableButtons();this._findElSelectedRows().removeClass(b.CLS_SELECTED_ROW);this._stopAutoScrolling();neo.core.setCookie(b.COOKIE_SORTING,"")},beforeReloadingIsSortMode:function(){return neo.core.getCookie(b.COOKIE_SORTING)=="true"},_setClass:function(){var d=this.toElement();d.addClass(b.CLS_SORTABLE_TABLE)},_resetClass:function(){var d=this.toElement();d.removeClass(b.CLS_SORTABLE_TABLE)},_showPagingArea:function(){if(this.setting.prevPage){var e=this._getElPrevPageArea();e.show()}if(this.setting.nextPage){var d=this._getElNextPageArea();d.show()}},_hidePagingArea:function(){var e=this._getElPrevPageArea();e.hide();var d=this._getElNextPageArea();d.hide()},_disableButtons:function(){var d=this._findElButtonsInTable();d.attr("disabled",true)},_enableButtons:function(){var d=this._findElButtonsInTable();d.attr("disabled",false)},_findElButtonsInTable:function(){var e=this.toElement();var d=e.find(":button, :input");d=a(a.grep(d,function(f){return a(f).closest(".selectable_table-checkbox-cell").length<1}));return d},_findElLinksInTable:function(){var e=this.toElement();var d=e.find("a");return d},toggleSelected:function(d,f){if(!this._isDraggable(d)){return}var e=d.find(".selectable_table-checkbox-cell").find(":checkbox");if(f==undefined){f=!d.hasClass(b.CLS_SELECTED_ROW)}if(f){d.addClass(b.CLS_SELECTED_ROW);e.attr("checked",true)}else{d.removeClass(b.CLS_SELECTED_ROW);e.attr("checked",false)}},_hasEnoughDistance:function(h){var d=this._getDragStartedPos();if(!d){return false}var f=h.left-d.left;var e=h.top-d.top;var g=5;if(f>g||f<-g||e>g||e<-g){return true}else{return false}},_startDragging:function(){var e=this._getElGrabedRow();if(!this._isDraggable(e)){return}this._setElGrabedRow(e);this._setDragging(true);this._startDraggingStyle();var d=this._setupDragTarget();this._showHelper(d);this._showAim()},_startDraggingStyle:function(){a("body").addClass(b.CLS_DRAGGING)},_stopDraggingStyle:function(){a("body").removeClass(b.CLS_DRAGGING)},_stopDragging:function(d){if(d.length>0){if(d.hasClass(b.CLS_PAGE_AREA)){this._movePage(d)}else{this._move(d)}}this._setDragging(false);this._stopDraggingStyle();this._shutdownDragTarget();this._hideHelper();this._hideAim()},_setupDragTarget:function(){var e=this._getElGrabedRow();var d=this._findElSelectedRows();this._setElLastSelectedRow(d);if(e.hasClass(b.CLS_SELECTED_ROW)){this._setElTargetRow(d);return d.length}else{this.toggleSelected(d,false);this.toggleSelected(e,true);this._setElTargetRow(e);return 1}},_shutdownDragTarget:function(){var e=this._getElGrabedRow();this.toggleSelected(e,false);var d=this._getElLastSelectedRow();this.toggleSelected(d,true)},_showHelper:function(d){var e=this._getHelperMessage(d);this._setHelperContent(e)},_getHelperMessage:function(d){var e=d+"件を移動";return e},_hideHelper:function(){var d=this._getElHelper();d.css({top:-9999})},_updateHelperPos:function(){var d=this._getCurPos();this._moveHelper(d)},_moveHelper:function(i){var f=this._getElHelper();var g=a(window);var e=30;var d=-(f.outerHeight()/2);var h={left:i.left+g.scrollLeft()+e,top:i.top+g.scrollTop()+d};f.css(h)},_setHelperContent:function(d){var e=this._getElHelper();e.text(d)},_updateAim:function(){var j=this._getElHoveredRow();if(!this._isDroppable(j)){this._hideAim();return}var i=this._getCurPos();var d=this._getPrevPos();if(!d){this._setPrevPos(i)}else{if(j){var h=j.offset();var f=2;var g=h.top-f;if(i.top!=d.top){if(i.top>d.top){g+=j.height();this._setAimDirection(b.AIM_NEXT)}else{this._setAimDirection(b.AIM_PREV)}var e=this._getElAim();e.css({top:g})}}else{this._hideAim()}}},_showAim:function(){var d=this._getElAim();var e=this.toElement();d.css({left:e.offset().left,width:e.outerWidth()})},_hideAim:function(){var d=this._getElAim();d.css({top:-9999})},_move:function(g){if(!this._isDroppable(g)){return}var d=this._getElTargetRow();if(typeof this.setting.ondrop=="function"){var e=this.getInsertIndex(g,this._getAimDirection());var f={elTargetRow:d,insertIntoIndex:e};this.setting.ondrop({},f)}if(this._getAimDirection()==b.AIM_PREV){d.insertBefore(g)}else{d.insertAfter(g)}},getInsertIndex:function(d,k){var j=this.toElement();var f=j.find(">tr, >tbody>tr").filter(":not(."+b.CLS_NOTARGET_ROW+")");var e=0;for(var g=0;g<f.length;g++){var h=f.eq(g);if(h[0]==d[0]){if(k==b.AIM_NEXT){e++}return e}else{e++}}return -1},_findElSelectedRows:function(){var f=this.toElement();var e=this;var d=a(a.grep(f.find("tr"),function(h){var g=a(h);var i=g.find(">.selectable_table-checkbox-cell :checkbox");return e._isDraggable(g)&&i.attr("checked")}));return d},_movePage:function(h){if(typeof this.setting.ondrop=="function"){var d=this._getElTargetRow();var e;if(h.hasClass(b.CLS_PREV_PAGE_AREA)){e=-(d.length)}else{var f=this._getAvailableRowsLength();e=f+d.length}var g={elTargetRow:this._getElTargetRow(),insertIntoIndex:e,pageMoved:true};this.setting.ondrop({},g)}},_getAvailableRowsLength:function(){var e=this.toElement();var d=e.find(">tr, >tbody>tr").filter(":not(."+b.CLS_NOTARGET_ROW+")");var f=d.length;return f},_isDraggable:function(f){if(!f){return false}if(f.hasClass(b.CLS_NOTARGET_ROW)){return false}var d=f.closest("table");var e=this.toElement();if(d[0]!=e[0]){return false}return true},_isDroppable:function(d){if(!this._isDraggable(d)){return false}if(d.hasClass(b.CLS_SELECTED_ROW)){return false}return true},_startAutoScrolling:function(){var f=10;this._stopAutoScrolling();var e=this;var d=setInterval(function(){e._autoScroll()},f);this._setTmAutoScroll(d)},_stopAutoScrolling:function(){clearInterval(this._getTmAutoScroll());this._setTmAutoScroll(null)},_updateAcceleration:function(e){var d={x:this._getAutoScrollingAccelerationX(e.left),y:this._getAutoScrollingAccelerationY(e.top)};this._setAcceleration(d)},_getAutoScrollingAccelerationX:function(d){var e=document.documentElement.clientWidth;var f=this._getAutoScrollingAcceleration(d,e);return f},_getAutoScrollingAccelerationY:function(f){var d=document.documentElement.clientHeight;var e=this._getAutoScrollingAcceleration(f,d);return e},_getAutoScrollingAcceleration:function(h,d){var f=30;var g;var e;g=h-f;if(g<0){e=Math.max(g,-f)/3;return e}g=h-(d-f);if(g>0){e=Math.min(g,f)/3;return e}return 0},_autoScroll:function(){var d=this._getAcceleration();if(d.x!=0||d.y!=0){window.scrollBy(d.x,d.y)}},_getElRowFrom:function(f){var e=b.CLS_TARGET_ROW;var d=f.closest("."+e);return d},getInstance:function(){return this},option:function(d,e){if(e===undefined){return this.setting[d]}this.setting[d]=e},__bind:neo.jq.bindListener,onclick:function(f){if(this.isSorting()){var e=a(f.target);if(e.closest("a").length>0){f.preventDefault()}if(!this._isDragging()){var d=this._getElRowFrom(e);this.toggleSelected(d)}}},onmouseover:function(e){if(!this.isSorting()){return}var d=this._getElRowFrom(a(e.target));this._setElHoveredRow(d)},onmouseout:function(d){if(!this._isDragging()){return}this._setElHoveredRow(null);this._updateAim()},onmousedown:function(e){if(!this.isSorting()){return}e.preventDefault();var f={left:e.clientX,top:e.clientY};this._setDragStartedPos(f);var d=this._getElRowFrom(a(e.target));this._setElGrabedRow(d)},onmouseup:function(e){if(!this.isSorting()){return}this._setDragStartedPos(null);if(this._isDragging()){var d=this;setTimeout(function(){var g=a(e.target);var f=d._getElRowFrom(g);f=f.add(g.closest("."+b.CLS_PAGE_AREA));d._stopDragging(f)},1)}},onmousemove:function(d){if(!this.isSorting()){return}if(!d.target||!d.target.tagName||d.target.tagName.toLowerCase()=="input"){return}var e={left:d.clientX,top:d.clientY};this._setCurPos(e);if(this._isDragging()){this._updateHelperPos();this._updateAim();this._updateAcceleration(e)}else{if(this._hasEnoughDistance(e)){this._startDragging()}}},oncheckall:function(f,g){if(!this.isSorting()){return}var e=this.toElement();var d=e.find("."+b.CLS_TARGET_ROW);this.toggleSelected(d,g.value);return false},onselectstart:function(d){if(this._getDragStartedPos()||this._isDragging()){d.preventDefault()}},banpei:null}});a.fn.webdbSortableTable=neo.jq.buildPlugin(b);b.__constructor()})(jQuery);