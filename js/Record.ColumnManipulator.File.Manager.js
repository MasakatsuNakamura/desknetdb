(function(c){var d=neo.core.readyNamespace("neo.webdb.Record.ColumnManipulator.File.Manager");if(!d){return}var b=neo.webdb.Record.ColumnManipulator.File;var a=neo.webdb.Record.ColumnManipulator.File.Manager=new neo.core.Class({classProperties:{defaultSetting:{}},properties:{setting:null,_files:null,_initFiles:function(){return this._files=new neo.core.Strage()},_alreadyFiles:null,_initAlreadyFiles:function(){return this._alreadyFiles=new neo.core.Strage()},_removeAlreadyFiles:null,_initRemoveAlreadyFiles:function(){return this._removeAlreadyFiles=new neo.core.Strage()},_getMaxFileCount:function(){return this.setting.maxFileCount},_nowFileCount:"0",_getElPostFormOuter:function(){return this.setting.elPostFormOuter},_getElUploadFiles:function(){return this.setting.elUploadFiles},_getElNotSelect:function(){return this.setting.elNotSelect},_getElIframe:function(){return this.setting.elIframe},_getElSubmit:function(){return this.setting.elSubmit},_elTemplate:null,_getElTemplate:function(){return this._elTemplate||this._initElTemplate()},_initElTemplate:function(){var e=this.setting.elTemplate;if(e.length<1){throw new Error("neo.webdb.Record.ColumnManipulator.File.Manager : The template element is required.")}return this._elTemplate=e},__constructor:function(e){this.setting=e||{};this._initFiles();this._initAlreadyFiles();this._initRemoveAlreadyFiles()},initialize:function(){this._initSetting();this._hookElIframe();this._hookAlreadyFiles()},_initSetting:function(){var e=this._getDefaultSetting();this.setting=c.extend({},e,this.setting)},_getDefaultSetting:function(){return c.extend({},a.defaultSetting)},_setTmpnm:function(e){if(this.setting.callbackOnSetTmpnm){this.setting.callbackOnSetTmpnm(e)}},_getTmpnm:function(){if(!this.setting.callbackOnGetTmpnm){throw new Error("neo.webdb.Record.ColumnManipulator.File.Manager._getTmpnm : The callbackOnGetTmpnm is required.")}return this.setting.callbackOnGetTmpnm()},getDeleteContentsIds:function(){var e=this._removeAlreadyFiles.getIdList();var g="";for(var f=0;f<e.length;f++){g+=(f?",":"")+e[f]}return g},_buildFile:function(g,e,f,l){var h=this._getElTemplate().clone();h.attr("name","upload_file_in_temp");h.attr("file-no",g);var k=this._findElLink(h);k.text(e);k.attr("href",f);var j=this._findElFileSize(h);j.text(l);var m={fileManager:this,elFile:h,id:g};var i=new b(m);i.initialize();return i},_findElLink:function(e){var f='[name="upload_file_link"]';return e.find(f)},_findElFileSize:function(e){var f='[name="upload_file_size"]';return e.find(f)},_hookElIframe:function(){var g=this._getElIframe();this.__bind(g,"load","IframeLoaded");var h=this._getElPostFormOuter();var e=h.find("form");this.__bind(e,"submit","UploadForm");var f=this._getElSubmit();this.__bind(f,"click","Submit")},_hookAlreadyFiles:function(){var o=this._getElUploadFiles();var f=o.find('[name="upload_file"]');for(var l=0;l<f.length;l++){var g=f.eq(l);var k=g.attr("content-id");var p={fileManager:this,elFile:g,contentsId:k};var i=new b(p);i.initialize();i.setting.callbackOnFileDelete=this.__closure(this.callbackOnFileDelete);this._alreadyFiles.set(k,i);this._nowFileCount++}var m=this._getElPostFormOuter();var n=m.find('[name="file_upload_form"]');element=n.find('[name="cid"]');var e=element.val();var h=o.find('[name="upload_file_in_temp"]');for(var l=0;l<h.length;l++){var g=h.eq(l);var j=g.attr("file-no");var p={fileManager:this,elFile:g};var i=new b(p);i.initialize();i.setting.callbackOnFileDelete=this.__closure(this.callbackOnFileDelete);i.isInTemp=true;this._files.set(j,i);i.setting.columnId=e;i.setting.fileNum=j;this._nowFileCount++}this._RefreshDispMode()},_displayPostForm:function(e){},_displayNotSelect:function(e){var f=this._getElNotSelect();if(e){f.css("display","block")}else{f.css("display","none")}},_deleteFile:function(h){if(h.isInTemp){var l=this;var m={callbackOnSuccess:function(){var n=h.getElFile();n.remove();l._nowFileCount--;l._RefreshDispMode();l._files.remove(h.setting.id)}};var f=new neo.webdb.pg_recordEdit.DeleteTempAttach(m);var k=this._getTmpnm();var i=h.setting.fileNum;var e=h.setting.columnId;f.exec(k,i,e)}else{var j=h.setting.contentsId;this._removeAlreadyFiles.set(j,h);this._alreadyFiles.remove(j);var g=h.getElFile();g.remove();this._nowFileCount--;this._RefreshDispMode()}},_RefreshDispMode:function(){if(this._nowFileCount==0){this._displayNotSelect(true)}else{this._displayNotSelect(false)}var e=this._getMaxFileCount();if(!e||!e.length){return}if(this._nowFileCount>=e){this._displayPostForm(false)}else{this._displayPostForm(true)}},__closure:neo.core.getClosure,__bind:neo.jq.bindListener,onsubmitUploadForm:function(e){e.stopPropagation()},onclickSubmit:function(){var f=this._getElPostFormOuter();var e=f.find('[name="tmpnm"]');var g=this._getTmpnm();e.val(g)},onloadIframeLoaded:function(g){var o=this._getElIframe();var h=o[0].contentWindow;var q=h.neo_iframe_file_upload_result;if(!q){return}var p=this._getElPostFormOuter();var r=p.find('[name="file_upload_form"]');o=r.find('[name="attach"]');o.before(c('<input type="file" name="attach" class="input_file_normal" size="33">'));o.remove();if(q.status!="ok"){var i=(q.errormessage||"")+" ["+q.errorno+"]";neo.webdb.alert(i);return}o=r.find('[name="tmpnm"]');o.val(q.tmpnm);o=r.find('[name="cid"]');var f=o.val();var t="dbrecorddownloadtempattach";var m=q.tmpnm;var k=q.fno;var n={cmd:t,tmpnm:m,cid:f,fno:k};var e=neo.webdb.getMainUrl(n);this._setTmpnm(q.tmpnm);var l=q.name;var u=q.dispfilesize;var j=this._buildFile(k,l,e,u);this._files.set(k,j);var s=this._getElUploadFiles();s.append(j.getElFile());j.setting.callbackOnFileDelete=this.__closure(this.callbackOnFileDelete);j.isInTemp=true;j.setting.columnId=f;j.setting.fileNum=k;this._nowFileCount++;this._RefreshDispMode()},callbackOnFileDelete:function(e){this._deleteFile(e)}}})})(jQuery);