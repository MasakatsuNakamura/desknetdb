(function(){if(!neo.core.readyNamespace("neo.webdb.SelectOrg")){return}var a=neo.webdb.SelectOrg=new neo.core.Class({properties:{_objAjaxUpdate:null,callbackBeforeShow:null,callbackOnChange:null,callbackAfterHide:null,boSrch:false,_selectedGroups:null,getSelectedGroups:function(){return this._selectedGroups},setSelectedGroups:function(b){return this._selectedGroups=b},_firstSelectedGroups:null,_getFirstSelectedGroups:function(){return this._firstSelectedGroups||[]},_setFirstSelectedGroups:function(b){return this._firstSelectedGroups=b},_getElBtnOpen:function(){return this._elBtnOpen},_setElBtnOpen:function(b){this._elBtnOpen=b},_elBtnOpen:null,_isSingle:function(){return this.options.single},_isSelectedGroupVisible:function(){if("selectedGroupVisibility" in this.options){return this.options.selectedGroupVisibility}else{return true}},hasAll:function(){if("havingAll" in this.options){return this.options.havingAll}else{return false}},hasFree:function(){if("havingFree" in this.options){return this.options.havingFree}else{return false}},__constructor:function(b){this.options=b||{};this._elSelectedItems=null;this._selectSub=false;var c=b.elBtnOpen;if(!c||!c instanceof jQuery||c.length<1){throw new Error("neo.webdb.SelectOrg : options.elBtnOpen is unavailable.")}this._setElBtnOpen(c);if(typeof b.callbackBeforeShow=="function"){this.callbackBeforeShow=b.callbackBeforeShow}if(typeof b.callbackOnChange=="function"){this.callbackOnChange=b.callbackOnChange}if(typeof b.callbackAfterHide=="function"){this.callbackAfterHide=b.callbackAfterHide}if(b.boSrch!=undefined){this.boSrch=b.boSrch}this._initialize()},_initialize:function(){this.initElBtnOpen();if(this._isSelectedGroupVisible()){this.setSelectedGroups(this.options.selectedGroups)}else{var b=$.extend([],this.options.selectedGroups);this._setFirstSelectedGroups(b);this.setSelectedGroups([])}},initElBtnOpen:function(){var b=this._getElBtnOpen();b.click((function(c){return function(e){e.preventDefault();var d=c;if(d.callbackBeforeShow){d.callbackBeforeShow()}d.open()}}(this)))},open:function(){a.instance=this;var c=this._getElDlg();c.webdbDialog("open");if(!a.updated){a.updated=true;a._bindActions()}var g=a.getElTreeOrg();var f=g.find(".selectorg-list");f.remove();a.elItem=g;a.updateToggleContent("");if(typeof this.options.updateIdList=="function"){var d=this.getSelectedGroups()||[];var e=this.options.updateIdList(d);if(e!=null){this.setSelectedGroups(e)}}this.setSelectedElements();var b=a.instance;a.updateLastItem(b)},_getElDlg:function(){return a.getElDlg()},setSelectedElements:function(){var f=a.getElTreeOrg();var e=a.CLS_SELECTED;f.find("."+e).removeClass(e);var d=$("#org-sellist");d.empty();var b=this.getSelectedGroups()||[];for(var c=0;c<b.length;c++){var g=b[c];if(!g){continue}this._addSelectedGroup(g.id,g.name,g.constid)}this.setSrchListSelected()},close:function(){var b=this._getElDlg();b.webdbDialog("close")},select:function(b){var e=b.parent().attr("data-id");var c=b.html();var d=b.parent().attr("const-id");if(b.hasClass(a.CLS_SELECTED)!=true){b.addClass(a.CLS_SELECTED)}else{return}this._addSelectedGroup(e,c,d)},_addSelectedGroup:function(f,c,e){if(this._isSingle()){this.deselectAll()}if(f==null){return}var d=$("#org-sellist");var b=$('<li><a href="#" data-id="'+f+'" const-id="'+e+'" class="'+a.CLS_SELLIST+" "+a.CLS_SELORGLABEL+'">'+c+"</a></li>");d.append(b);b.find("."+a.CLS_SELORGLABEL).click(a.onSelLabelClick)},deselectAll:function(){var b=$("#org-sellist ."+a.CLS_SELORGLABEL);for(var d=0;d<b.length;d++){var c=b.eq(d);this.deselect(c)}},deselect:function(d){var f=d.attr("data-id");var b=a.getElDlg();var c=b.find("a.selectorg-label");for(var e=0;e<c.length;e++){if(c.eq(e).parent().attr("data-id")==f){c.eq(e).removeClass(a.CLS_SELECTED)}}d.parent().remove()},setSrchListSelected:function(){var c=$("#org-sellist > li");var k=a.getElTreeOrg().find("li");var g=[];for(var e=0;e<k.length;e++){g[e]=k.eq(e).attr("data-id")}for(var e=0;e<c.length;e++){var f=c.eq(e);var d=f.find("a").attr("data-id");var h=this._getSrchItemIndexOf(d,g);if(h>=0){k.eq(h).find("a:first").addClass(a.CLS_SELECTED)}}var j=this._getFirstSelectedGroups();for(var e=0;e<j.length;e++){if(!j[e]){return}var b=j[e].id;var h=this._getSrchItemIndexOf(b,g);if(h>=0){k.eq(h).find("a:first").addClass(a.CLS_SELECTED)}}},_getSrchItemIndexOf:function(d,c){for(var b=0;b<c.length;b++){if(d==c[b]){return b}}return -1}},classProperties:{CGI_UPDATE:"vdoc",CMD_UPDATE:"optionorglist",CMD_TOGGLELIST:"getselectgroups",ID_NOASSIGNED:"000000000000",CLS_SELECTED:"org-line-selected",CLS_SELLIST:"org-line-sellist",CLS_SELORGLABEL:"sellistorg-label",instance:null,updated:false,showing:false,getElSepSelOrgPage:function(){return $("#resizeSelOrgX")},getElOrgBlock:function(){return $("#selgrp-leftpane-inner_block")},getElTreeOrg:function(){return $("#select_groups-org_tree-root")},getElAllItem:function(){var c=this.getElTreeOrg();var b=c.find('[data-id="*"]');return b},getElFreeItem:function(){var c=this.getElTreeOrg();var b=c.find("[data-id=free]");return b},getElBtnClear:function(){return $(".btn-selorg-clear")},getElDlg:function(){return this._elDlg||this._initElDlg()},_initElDlg:function(){var e={buttons:{},open:a.onOpen,close:a.onClose};var d="OK";e.buttons[d]=a.onBtnOkClick;var c="キャンセル";e.buttons[c]="close";var b=$("#dlg-select_groups");neo.webdb.getDialog(b,e);return this._elDlg=b},_elDlg:null,updateContent:function(c){var b=this.getObjAjaxUpdate(c);b.sendRequest()},getObjAjaxUpdate:function(c){if(!this._objAjaxUpdate){var b=this.getOptionsAjaxUpdate(c);this._objAjax=new neo.webdb.Ajax(b);this._objAjax.initialize()}return this._objAjax},getOptionsAjaxUpdate:function(c){var b={url:neo.webdb.getUrl(),getSendData:function(){var d={cmd:a.CMD_UPDATE,jstmpid:c};return d},onsuccess:a.onAjaxUpdateSuccess};return b},updateLow:function(b){this.updated=true;this._bindActions();a.elItem=a.getElTreeOrg();a.updateToggleContent("")},updateLastItem:function(b){var j="last";var h=a.getElTreeOrg();var e=h.find("> .selectorg-list > ."+j);e.removeClass(j);var d=b.hasAll();a.setAllOrg(d);var g=b.hasFree();a.setFreeOrg(g);var f;if(g){f=a.getElFreeItem()}else{var c=a.getElFreeItem();f=c.prev()}f.addClass(j)},setAllOrg:function(c){var b=a.getElAllItem();if(c){b.show()}else{b.hide()}},setFreeOrg:function(c){var b=a.getElFreeItem();if(c){b.show()}else{b.hide()}},_bindActions:function(){var k=this.getElDlg();var d=k.find("div.selectorg-with-path a.selectorg-label").click(a.onOrgLabelClick);if($.browser.msie&&$.browser.version<=6){d.mouseover(function(){$(this).addClass("org-line-hover")}).mouseout(function(){$(this).removeClass("org-line-hover")})}var j=function(){$(this).addClass("ui-state-focus")};var b=function(){$(this).removeClass("ui-state-focus")};var e=function(){$(this).addClass("ui-state-hover")};var g=function(){$(this).removeClass("ui-state-hover")};var f=a.getElSepSelOrgPage();f.layout({zIndex:0,size:150,minSize:240,maxSize:300,spacing_open:10,resizerTip:"",closable:false,scrollToBookmarkOnLoad:false});var c=a.getElTreeOrg();a.setupTreeViewPlugin(c);var h=a.getElBtnClear();h.click(a.onBtnClearClick)},onOpen:function(){var b=$(this);a.showing=true;b.parent().find("div.ui-dialog-buttonpane button:first").blur().end().find("div.ui-dialog-buttonpane button:last").focus().end()},onBtnOkClick:function(d){var b=a.instance;b.close();var c=[];$("#org-sellist > li").each(function(g,e){var f=$(e);var h={id:f.find("a").attr("data-id"),name:f.text(),constid:f.find("a").attr("const-id")};c.push(h)});b.setSelectedGroups(c);if(b.callbackOnChange){b.callbackOnChange(c)}},onBtnCancelClick:function(c){var b=a.instance;b.close()},onClose:function(c){if(c.keyCode){$(this).dialog("close")}a.showing=false;var b=a.instance;if(!a.adjusting&&b.callbackAfterHide){b.callbackAfterHide()}},onOrgLabelClick:function(d){d.preventDefault();var b=a.instance;var c=$(this);b.select(c)},onSelLabelClick:function(d){d.preventDefault();var b=a.instance;var c=$(this);b.deselect(c)},onBtnClearClick:function(e){e.preventDefault();var c=a.getElDlg();var d=$("#org-sellist").find("li");d.remove();var f=c.find(".selectorg-list");f.find("a.selectorg-label").removeClass(a.CLS_SELECTED);var b=a.instance;b.setSrchListSelected()},onAjaxUpdateSuccess:function(b){a._bindActions();return},setupTreeViewPlugin:function(b){b.treeview({collapsed:true,unique:true,toggle:function(){a.onClickTvToggle(this)}})},onClickTvToggle:function(d){var c=$(d);var b=$(d).find("ul:first");if(b.length>0&&b.hasClass("selectorg-list-dmy")==true&&c.hasClass("collapsable")==true){a.elItem=c;var e=c.attr("data-id");a.updateToggleContent(e);return}},updateToggleContent:function(c){var b=this.getObjAjaxToggleUpdate(c);b.sendRequest()},getObjAjaxToggleUpdate:function(c){var b=this.getOptionsAjaxToggleUpdate(c);this._objAjax=new neo.webdb.Ajax(b);this._objAjax.initialize();return this._objAjax},getOptionsAjaxToggleUpdate:function(c){var b={url:neo.webdb.getMainUrl(),getSendData:function(){var d={cmd:a.CMD_TOGGLELIST,gid:c};return d},onsuccess:a.onAjaxToggleUpdateSuccess};return b},onAjaxToggleUpdateSuccess:function(e){var c=e.result.groupinfo||[];var d=a._buildElOrgList(c);a.updateToggleLow(d);var b=a.instance;a.updateLastItem(b)},_buildElOrgList:function(j){var k=a.getElTreeOrg();if(a.elItem[0]==k[0]){var h={haschildren:0,id:"*",name:"すべて",constid:""};j.unshift(h);var c={haschildren:0,id:"free",name:"グループに属さない",constid:""};j.push(c)}if(!j){return null}var o=$("#select_groups-org_tree-node-prototype");var m=$("#select_groups-org_tree-node-dummy-prototype");var g=o.clone().removeAttr("id");var d=g.children();d.remove();for(var e=0;e<j.length;e++){var n=j[e];if(!n){continue}var l=d.clone().removeAttr("id");l.attr("data-id",n.id);l.attr("const-id",n.constid);var f=l.find("a");f.attr("title",n.name).text(n.name);if(n.haschildren){var b=m.clone().removeAttr("id");l.append(b)}g.append(l)}return g},updateToggleLow:function(l){if(a.elItem!=null){var n=a.elItem.find("ul.selectorg-list-dmy");n.remove();var b=$(l);a.elItem.append(b);var j=a.getElOrgBlock();var f=j.scrollTop();var h=j.scrollLeft();var e=a.getElTreeOrg().parent();e.find("div.hitarea").remove();e.find("li.expandable").removeClass("expandable");e.find("li.collapsable").removeClass("collapsable");e.find("li.lastExpandable").removeClass("lastExpandable");e.find("li.lastCollapsable").removeClass("lastCollapsable");a.setupTreeViewPlugin(e);var q=a.elItem;while(-1){q.find("div:first").click();q.removeClass("expandable").addClass("collapsable");q.find("div:first").removeClass("expandable-hitarea").addClass("collapsable-hitarea");var d=q.attr("data-id");var c=q.parent().children();var g=false;for(i=0;i<c.length;i++){if($(c[i]).attr("data-id")==d){g=true}}if(g==true&&c.length==i+1){q.removeClass("lastExpandable").addClass("lastCollapsable");q.find("div:first").removeClass("lastExpandable-hitarea").addClass("lastCollapsable-hitarea")}var o=q.parent().parent();if(o.hasClass("expandable")==true){q=o}else{break}}var m=a.getElDlg();var k=m.find("div.selectorg-with-path a.selectorg-label").click(a.onOrgLabelClick);var p=a.instance;p.setSrchListSelected();j.scrollTop(f);j.scrollLeft(h)}},getSelectedOrgs:function(){var f;var c;var e=new Array();var b=$("#org-sellist").find("li");for(var d=0;d<b.length;d++){c=b.eq(d).find("a");f=[c.attr("data-id"),c.html()];e.push(f)}return e}}})})();